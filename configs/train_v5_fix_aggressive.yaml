# ===================================================================
# DeepLOB V5 ä¿®å¾©é…ç½® - æ¿€é€²ç‰ˆ
# ç›®æ¨™ï¼šä¿®å¾© Class 1 Recall æ¥µä½å•é¡Œï¼ˆR=0.0003 â†’ R>0.50ï¼‰
# ç­–ç•¥ï¼šå¹³è¡¡æ¡æ¨£å™¨ + æ¥µç«¯æ‰‹å‹•æ¬Šé‡ + å¤§å¹…æ“´å®¹ + é«˜å­¸ç¿’ç‡
# è­¦å‘Šï¼šå¯èƒ½å°è‡´æ•´é«”æº–ç¢ºç‡ä¸‹é™ï¼Œä½†ä¸‰é¡æ›´å‡è¡¡
# ===================================================================

# ==================== åŸºç¤é…ç½® ====================
run:
  seed: 42

labels:
  num_classes: 3
  class_names: ["ä¸‹è·Œ", "æŒå¹³", "ä¸Šæ¼²"]
  class_names_en: ["down", "stationary", "up"]
  class_ids: [0, 1, 2]
  format: "v5"

  weight_calculation:
    epsilon: 1.0e-6
    normalize: true

visualization:
  confusion_matrix:
    normalize: true
    dpi: 150
    figsize: [8, 6]
    cmap: "Blues"

data:
  train: "data/processed_v5/npz/stock_embedding_train.npz"
  val: "data/processed_v5/npz/stock_embedding_val.npz"
  test: "data/processed_v5/npz/stock_embedding_test.npz"
  norm_meta: "data/processed_v5/npz/normalization_meta.json"

  v5_labels: true
  y_raw_validation:
    enabled: true
    expected_values: [-1, 0, 1]

  use_sample_weights: true
  weights_normalize: "mean_to_1"
  use_stock_ids: false
  fail_on_missing_keys: true

# ==================== DataLoader é…ç½® - æ¿€é€²ï¼====================
dataloader:
  batch_size: 128  # ğŸ”§ å¤§å¹…ç¸®å°ï¼ˆ256â†’128ï¼Œæœ€å¤§åŒ–æ¢¯åº¦å¤šæ¨£æ€§ï¼‰
  num_workers: 4
  pin_memory: true

  # ğŸ”§ å•Ÿç”¨å¹³è¡¡æ¡æ¨£å™¨
  balance_sampler:
    enabled: true
    strategy: "inv_freq"

# ==================== æ¨¡å‹é…ç½® - å¤§å¹…æ“´å®¹ï¼====================
model:
  arch: "DeepLOB"
  input:
    shape: [100, 20]
  num_classes: 3

  # ğŸ”§ å¤§å¹…æ“´å¤§ç¶²çµ¡å®¹é‡ï¼ˆ32â†’64ï¼‰
  conv1_filters: 48  # âœ… 32â†’48ï¼ˆæ›´å¼·ç‰¹å¾µæå–ï¼‰
  conv2_filters: 48  # âœ… 32â†’48
  conv3_filters: 48  # âœ… 32â†’48
  lstm_hidden_size: 64  # âœ… 32â†’64ï¼ˆæœ€å¼·æ™‚åºå»ºæ¨¡ï¼‰
  fc_hidden_size: 64    # âœ… 32â†’64ï¼ˆæœ€å¼·åˆ†é¡èƒ½åŠ›ï¼‰
  dropout: 0.3          # ğŸ”§ å¤§å¹…é™ä½ï¼ˆ0.5â†’0.3ï¼Œæœ€å°åŒ–ä¿¡æ¯æå¤±ï¼‰

  embeddings:
    enabled: false

# ==================== æå¤±å‡½æ•¸é…ç½® - æ¥µç«¯æ¬Šé‡ï¼====================
loss:
  type: "ce"

  # ğŸ”§ æ¥µç«¯æ‰‹å‹•æ¬Šé‡ï¼ˆå¹¾ä¹å‡ç­‰ï¼Œå¼·è¿«æ¨¡å‹å­¸ç¿’æ‰€æœ‰é¡ï¼‰
  class_weights: "manual"

  # æ¥µç«¯æ¬Šé‡è¨­è¨ˆï¼š
  # - Class 0 (29.4%): 1.1 â† ç•¥é«˜
  # - Class 1 (45.0%): 1.2 â† åè€Œæé«˜ï¼ï¼ˆå¼·è¿«æ¨¡å‹é‡è¦– Class 1ï¼‰
  # - Class 2 (25.6%): 1.3 â† æœ€é«˜
  # ç­–ç•¥ï¼šåå‘æ“ä½œï¼Œçµ¦ Class 1 è¼ƒé«˜æ¬Šé‡ï¼Œå¼·è¿«æ¨¡å‹å­¸ç¿’
  manual_weights: [1.1, 1.2, 1.3]

  label_smoothing:
    global: 0.05  # ğŸ”§ å•Ÿç”¨è¼•å¾®å¹³æ»‘ï¼ˆ0â†’0.05ï¼Œé¿å…éåº¦è‡ªä¿¡ï¼‰
    flat_bonus: 0.00

# ==================== å„ªåŒ–å™¨é…ç½® - æ¿€é€²ï¼====================
optim:
  name: "adamw"
  lr: 0.0003  # ğŸ”§ å¤§å¹…æé«˜ï¼ˆ0.00005â†’0.0003ï¼Œ6å€ï¼ï¼‰
  weight_decay: 0.0001  # ğŸ”§ é™ä½æ­£å‰‡åŒ–ï¼ˆ0.0005â†’0.0001ï¼‰
  grad_clip: 1.5  # ğŸ”§ å¤§å¹…æ”¾å¯¬ï¼ˆ0.5â†’1.5ï¼Œå…è¨±æ›´å¤§æ›´æ–°ï¼‰
  amp: false
  use_bf16: false
  betas: [0.9, 0.999]
  eps: 1.0e-8
  amsgrad: false

# ==================== å­¸ç¿’ç‡èª¿åº¦å™¨ ====================
sched:
  name: "cosine"
  warmup_ratio: 0.05  # ğŸ”§ æ¥µçŸ­é ç†±ï¼ˆ0.15â†’0.05ï¼‰
  eta_min: 3.0e-5     # ğŸ”§ æé«˜æœ€å°LRï¼ˆ5e-6â†’3e-5ï¼‰

# ==================== è¨“ç·´é…ç½® ====================
train:
  epochs: 50  # ğŸ”§ å»¶é•·è¨“ç·´ï¼ˆ40â†’50ï¼Œçµ¦æ¨¡å‹æ›´å¤šæ™‚é–“ï¼‰
  accumulate_steps: 1

  early_stop:
    metric: "val.f1_macro_unweighted"
    patience: 12  # ğŸ”§ å»¶é•·è€å¿ƒï¼ˆ8â†’12ï¼‰
    mode: "max"

# ==================== è©•ä¼°é…ç½® ====================
eval:
  group_split:
    by_stock: true

  metrics:
    unweighted: ["acc", "f1_macro", "per_class_pr_rc", "confusion"]
    weighted: ["f1_macro", "loss"]

  breakdowns: ["reasons", "t_hit_bucket", "ret_quantile", "stock"]
  thit_buckets: [0, 5, 10, 20, 100]
  ret_quantiles: [0.8, 0.9, 0.95]

# ==================== æ ¡æº–é…ç½® ====================
calibration:
  enabled: true
  type: "temperature"
  opt_metric: "weighted_nll"
  lr: 0.01
  max_iter: 50

# ==================== æ¨ç†é…ç½® ====================
inference:
  decision: "argmax"
  cost_matrix:
    path: null
  hold_threshold: 0.0

# ==================== æ—¥èªŒé…ç½® ====================
logging:
  dir: "logs/deeplob_v5_fix_aggressive"
  save_best_by: "val.f1_macro_unweighted"

  artifacts:
    - "model"
    - "norm_meta"
    - "label_mapping"
    - "calibration"
    - "cost_matrix"
    - "metrics_json"
    - "logs_csv"
    - "confmat_png"

  wandb:
    enabled: false

# ==================== å®‰å…¨æª¢æŸ¥ ====================
safety_checks:
  validate_label_set: true
  validate_weights: true
  validate_norm_meta: true
  print_data_summary: true

# ==================== ç¡¬ä»¶é…ç½® ====================
hardware:
  device: "cuda"
  num_workers: 4
  pin_memory: true
  prefetch_factor: 2
  persistent_workers: true

# ==================== çºŒè¨“é…ç½® ====================
resume:
  enabled: false
  checkpoint_path: "checkpoints/v5/deeplob_v5_best.pth"
  load_optimizer: true

# ==================== å…¶ä»–é…ç½® ====================
misc:
  save_last: true
  output_dir: "checkpoints/v5_fix_aggressive"

# ===================================================================
# ä¿®æ”¹ç¸½çµï¼ˆæ¿€é€²ç‰ˆï¼‰âš ï¸
# ===================================================================
# 1. âœ… å•Ÿç”¨å¹³è¡¡æ¡æ¨£å™¨
# 2. âœ… æ¥µç«¯æ‰‹å‹•æ¬Šé‡ [1.1, 1.2, 1.3]ï¼ˆå¹¾ä¹å‡ç­‰ï¼Œç”šè‡³åå‘ Class 1ï¼‰
# 3. âœ… å¤§å¹…æ“´å®¹ï¼ˆConv 32â†’48ï¼ŒLSTM/FC 32â†’64ï¼‰
# 4. âœ… å¤§å¹…é™ä½ dropoutï¼ˆ0.5â†’0.3ï¼‰
# 5. âœ… å­¸ç¿’ç‡ 6 å€æå‡ï¼ˆ0.00005â†’0.0003ï¼‰
# 6. âœ… å¤§å¹…é™ä½æ¬Šé‡è¡°æ¸›ï¼ˆ0.0005â†’0.0001ï¼‰
# 7. âœ… å¤§å¹…æ”¾å¯¬æ¢¯åº¦è£å‰ªï¼ˆ0.5â†’1.5ï¼‰
# 8. âœ… å»¶é•·è¨“ç·´ï¼ˆ40â†’50 epochsï¼‰
# 9. âœ… å•Ÿç”¨è¼•å¾®æ¨™ç±¤å¹³æ»‘ï¼ˆ0â†’0.05ï¼‰
# 10. âœ… ç¸®å° batchï¼ˆ256â†’128ï¼‰
#
# âš ï¸ è­¦å‘Šï¼š
#   - å¯èƒ½å°è‡´è¨“ç·´ä¸ç©©å®šï¼ˆå­¸ç¿’ç‡å¤ªé«˜ï¼‰
#   - å¯èƒ½éæ“¬åˆï¼ˆç¶²çµ¡å®¹é‡å¤§ + dropout ä½ï¼‰
#   - æ•´é«”æº–ç¢ºç‡å¯èƒ½ä¸‹é™ï¼ˆ0.73â†’0.60-0.65ï¼‰
#   - ä½†ä¸‰é¡ Recall æ‡‰è©²æ›´å‡è¡¡ï¼
#
# é æœŸæ•ˆæœï¼š
#   - Class 0 Recall: 0.40-0.60
#   - Class 1 Recall: 0.50-0.70 â† å¤§å¹…æå‡ï¼
#   - Class 2 Recall: 0.40-0.60
#   - æ•´é«” F1: 0.60-0.65ï¼ˆå¯èƒ½é™ä½ï¼Œä½†æ›´å…¬å¹³ï¼‰
#
# ä½¿ç”¨æ–¹æ³•ï¼š
#   python scripts/train_deeplob_v5.py \
#       --config configs/train_v5_fix_aggressive.yaml
#
# å»ºè­°ï¼šå…ˆè©¦ä¿å®ˆç‰ˆå’Œä¸­ç­‰ç‰ˆï¼Œå¦‚æœæ•ˆæœä¸ä½³å†ç”¨æ¿€é€²ç‰ˆ
# ===================================================================
