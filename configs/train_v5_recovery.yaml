# ===================================================================
# DeepLOB V5 æ¢å¾©é…ç½® - åŸºæ–¼ ML Optimal æ–°æ•¸æ“šé›†
# ç›®æ¨™ï¼šä¿®å¾©éæ“¬åˆ + é©—è­‰æå¤±çˆ†ç‚¸å•é¡Œ
# æ•¸æ“šä¾†æºï¼šconfig_pro_v5_ml_optimal.yaml ç”Ÿæˆçš„ processed_v5_fixed
# åƒè€ƒï¼šå¯¦é©— #4 å¤±æ•—ç¶“é©— + åŸå§‹ v5 æˆåŠŸé…ç½®
# ===================================================================

# ==================== åŸºç¤é…ç½® ====================
run:
  seed: 42

labels:
  num_classes: 3
  class_names: ["ä¸‹è·Œ", "æŒå¹³", "ä¸Šæ¼²"]
  class_names_en: ["down", "stationary", "up"]
  class_ids: [0, 1, 2]
  format: "v5"

  weight_calculation:
    epsilon: 1.0e-6
    normalize: true

visualization:
  confusion_matrix:
    normalize: true
    dpi: 150
    figsize: [8, 6]
    cmap: "Blues"

data:
  train: "data/processed_v5_fixed/npz/stock_embedding_train.npz"
  val: "data/processed_v5_fixed/npz/stock_embedding_val.npz"
  test: "data/processed_v5_fixed/npz/stock_embedding_test.npz"
  norm_meta: "data/processed_v5_fixed/npz/normalization_meta.json"

  v5_labels: true
  y_raw_validation:
    enabled: true
    expected_values: [-1, 0, 1]

  use_sample_weights: false  # ğŸ”§ é—œé–‰ï¼æ¬Šé‡ç•°å¸¸ (max=539, Class1è¢«å£“åˆ¶)
  weights_normalize: "mean_to_1"
  use_stock_ids: false
  fail_on_missing_keys: true

# ==================== DataLoader é…ç½® ====================
dataloader:
  batch_size: 512  # ğŸ”§ å¢å¤§ batch (256â†’512) - ç©©å®šæ¢¯åº¦
  num_workers: 4
  pin_memory: true

  # ğŸ”§ ç¦ç”¨å¹³è¡¡æ¡æ¨£å™¨ï¼ˆèˆ‡æ‰‹å‹•æ¬Šé‡è¡çªï¼‰
  balance_sampler:
    enabled: false  # âŒ åªç”¨æ‰‹å‹•æ¬Šé‡
    strategy: "inv_freq"

# ==================== æ¨¡å‹é…ç½® ====================
model:
  arch: "DeepLOB"
  input:
    shape: [100, 20]
  num_classes: 3

  # ğŸ”§ é™ä½å®¹é‡å°æŠ—éæ“¬åˆ
  conv1_filters: 32
  conv2_filters: 32
  conv3_filters: 32
  lstm_hidden_size: 64  # ğŸ”§ é™ä½å®¹é‡ (64â†’48) - æ¸›å°‘éæ“¬åˆ
  fc_hidden_size: 64    # ğŸ”§ é™ä½å®¹é‡ (64â†’48) - æ¸›å°‘éæ“¬åˆ
  dropout: 0.6          # ğŸ”§ å¢å¼·æ­£å‰‡åŒ– (0.5â†’0.6) - é€²ä¸€æ­¥é˜²éæ“¬åˆ

  embeddings:
    enabled: false

# ==================== æå¤±å‡½æ•¸é…ç½® ====================
loss:
  type: "ce"

  # ğŸ”§ ä½¿ç”¨è‡ªå‹•æ¬Šé‡ï¼ˆæ¸¬è©¦ v5 åŸå§‹æ•¸æ“šï¼‰
  class_weights: "auto"  # ğŸ”§ æ”¹ç”¨ autoï¼ˆè®“æ¨¡å‹è‡ªå‹•è¨ˆç®—ï¼Œé©æ‡‰v5æ•¸æ“šï¼‰
  # manual_weights: [2.5, 1.0, 2.8]  # åœç”¨æ‰‹å‹•æ¬Šé‡

  label_smoothing:
    global: 0.15      # ğŸ”§ å¢å¼·å¹³æ»‘ (0.1â†’0.15) - æ¸›å°‘éåº¦è‡ªä¿¡
    flat_bonus: 0.0

# ==================== å„ªåŒ–å™¨é…ç½® ====================
optim:
  name: "adamw"
  lr: 0.00008        # ğŸ”§ é™ä½å­¸ç¿’ç‡ (0.00012â†’0.00008) - æ›´ç©©å®š
  weight_decay: 0.0005  # ğŸ”§ å¢å¼·æ­£å‰‡åŒ– (0.0003â†’0.0005)
  grad_clip: 0.5     # ğŸ”§ åš´æ ¼è£å‰ª (0.8â†’0.5) - æ§åˆ¶æ¢¯åº¦çˆ†ç‚¸
  amp: false
  use_bf16: false
  betas: [0.9, 0.999]
  eps: 1.0e-8
  amsgrad: false

# ==================== å­¸ç¿’ç‡èª¿åº¦å™¨ ====================
sched:
  name: "cosine"
  warmup_ratio: 0.15  # ğŸ”§ å»¶é•·é ç†± (0.1â†’0.15) - æ›´ç©©å®šå•Ÿå‹•
  eta_min: 5.0e-6     # ğŸ”§ é™ä½æœ€å°LR (1e-5â†’5e-6)

# ==================== è¨“ç·´é…ç½® ====================
train:
  epochs: 50         # ğŸ”§ å¯¦ç”¨è¨­å®šï¼ˆè¶³å¤ æ”¶æ–‚ï¼Œearly stop æœƒè‡ªå‹•æ§åˆ¶ï¼‰
  accumulate_steps: 1

  early_stop:
    metric: "val.f1_macro_unweighted"
    patience: 15     # ğŸ”§ æ¨™æº–è€å¿ƒï¼ˆ15 epochs ç„¡æ”¹å–„å‰‡åœæ­¢ï¼‰
    mode: "max"

# ==================== è©•ä¼°é…ç½® ====================
eval:
  group_split:
    by_stock: true

  metrics:
    unweighted: ["acc", "f1_macro", "per_class_pr_rc", "confusion"]
    weighted: ["f1_macro", "loss"]

  breakdowns: ["reasons", "t_hit_bucket", "ret_quantile", "stock"]
  thit_buckets: [0, 5, 10, 20, 100]
  ret_quantiles: [0.8, 0.9, 0.95]

# ==================== æ ¡æº–é…ç½® ====================
calibration:
  enabled: true
  type: "temperature"
  opt_metric: "weighted_nll"
  lr: 0.01
  max_iter: 50

# ==================== æ¨ç†é…ç½® ====================
inference:
  decision: "argmax"
  cost_matrix:
    path: null
  hold_threshold: 0.0

# ==================== æ—¥èªŒé…ç½® ====================
logging:
  dir: "logs/deeplob_v5_fixed"
  save_best_by: "val.f1_macro_unweighted"

  artifacts:
    - "model"
    - "norm_meta"
    - "label_mapping"
    - "calibration"
    - "cost_matrix"
    - "metrics_json"
    - "logs_csv"
    - "confmat_png"

  wandb:
    enabled: false

# ==================== å®‰å…¨æª¢æŸ¥ ====================
safety_checks:
  validate_label_set: true
  validate_weights: true
  validate_norm_meta: true
  print_data_summary: true

# ==================== ç¡¬ä»¶é…ç½® ====================
hardware:
  device: "cuda"
  num_workers: 4
  pin_memory: true
  prefetch_factor: 2
  persistent_workers: true

# ==================== çºŒè¨“é…ç½® ====================
resume:
  enabled: false
  checkpoint_path: "checkpoints/v5_fixed/deeplob_v5_best.pth"
  load_optimizer: true

# ==================== å…¶ä»–é…ç½® ====================
misc:
  save_last: true
  output_dir: "checkpoints/v5_fixed"

# ===================================================================
# ä¿®æ”¹ç¸½çµï¼ˆML Optimal æ•¸æ“šé›†ç‰ˆæœ¬ï¼‰
# ===================================================================
# ğŸ¯ ç›®æ¨™ï¼šä¿®å¾©éæ“¬åˆ + é©—è­‰æå¤±çˆ†ç‚¸
#
# ğŸ“Š æ•¸æ“šä¾†æºï¼š
#   - config_pro_v5_ml_optimal.yaml ç”Ÿæˆ
#   - æ•¸æ“šç›®éŒ„ï¼š./data/processed_v5_fixed
#   - ç‰¹é»ï¼š
#     * respect_day_boundary: trueï¼ˆé˜²è·¨æ—¥æ±¡æŸ“ï¼‰
#     * min_return: 0.0015 (0.15%)
#     * pt_multiplier/sl_multiplier: 3.5Ïƒ
#     * max_holding: 40 barsï¼ˆæ—¥å…§é™åˆ¶ï¼‰
#     * EWMA æ³¢å‹•ç‡ï¼ˆæ¯æ—¥é‡ç½®ï¼‰
#
# ğŸ”§ é—œéµèª¿æ•´ï¼š
# 1. âœ… Batch size 256â†’512ï¼ˆç©©å®šæ¢¯åº¦ï¼‰
# 2. âœ… Dropout 0.3â†’0.6ï¼ˆå¼·æ­£å‰‡åŒ–ï¼‰
# 3. âœ… LR 0.00012â†’0.00008ï¼ˆé™ä½å­¸ç¿’ç‡ï¼‰
# 4. âœ… Weight decay 0.0003â†’0.0005ï¼ˆå¢å¼·L2ï¼‰
# 5. âœ… Grad clip 0.8â†’0.5ï¼ˆæ§åˆ¶æ¢¯åº¦çˆ†ç‚¸ï¼‰
# 6. âœ… Label smoothing 0.0â†’0.15ï¼ˆé˜²æ­¢éåº¦è‡ªä¿¡ï¼‰
# 7. âœ… Warmup 0.1â†’0.15ï¼ˆæ›´ç©©å®šå•Ÿå‹•ï¼‰
# 8. âœ… Class weights: autoï¼ˆè‡ªå‹•é©æ‡‰æ–°æ•¸æ“šåˆ†å¸ƒï¼‰
# 9. âœ… Epochs 50, Patience 15ï¼ˆæ¨™æº–è¨­å®šï¼‰
#
# ğŸ“ˆ é æœŸæ•ˆæœï¼š
#   - é©—è­‰æå¤±æ”¶æ–‚ï¼ˆä¸å†çˆ†ç‚¸ï¼‰
#   - è¨“ç·´/é©—è­‰å·®è·ç¸®å°è‡³ <10%
#   - æ¢¯åº¦ç©©å®šåœ¨ <5.0
#   - é©—è­‰ F1 > 50% (ç›®æ¨™ > 65%)
#   - Class 1ï¼ˆæŒå¹³ï¼‰æ¯”ä¾‹å¢åŠ è‡³ 35-45%
#
# ğŸš€ ä½¿ç”¨æ–¹æ³•ï¼š
#   python scripts/train_deeplob_v5.py \
#       --config configs/train_v5_recovery.yaml \
#       --data-dir ./data/processed_v5_fixed/npz \
#       --epochs 50
#
# ğŸ’¡ ç›£æ§é‡é»ï¼š
#   - Class 1 å¬å›ç‡ï¼ˆæ‡‰ > 50%ï¼Œé¿å…æ©«ç›¤èª¤äº¤æ˜“ï¼‰
#   - ä¸‰é¡ F1 å‡è¡¡æ€§ï¼ˆé¿å…æŸé¡éä½ï¼‰
#   - é©—è­‰æå¤±æ›²ç·šï¼ˆæ‡‰å¹³æ»‘ä¸‹é™ï¼‰
# ===================================================================
