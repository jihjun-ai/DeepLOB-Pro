# Label Viewer - V5 ä¿®å¾©ç‰ˆæ›´æ–°æ—¥èªŒ

**ç‰ˆæœ¬**: v2.1 (V5 Fix Support)
**æ—¥æœŸ**: 2025-10-20
**ç‹€æ…‹**: å·²å®Œæˆ

---

## æ›´æ–°æ‘˜è¦

ç‚ºäº†æ”¯æ´ `extract_tw_stock_data_v5.py` çš„è·¨æ—¥æ±¡æŸ“ä¿®å¾©ç‰ˆæœ¬ï¼ŒLabel Viewer æ–°å¢äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

---

## æ–°å¢åŠŸèƒ½

### 1. å¿«é€Ÿé¸æ“‡æŒ‰éˆ•æ“´å…… â­

**ä½ç½®**: å·¦å´æ§åˆ¶é¢æ¿ â†’ å¿«é€Ÿé¸æ“‡å€åŸŸ

**æ–°å¢æŒ‰éˆ•**:
- `v5 ä¿®å¾©ç‰ˆ` (ç¶ è‰²) â†’ `./data/processed_v5_fixed/npz`
- `v5 æ¸¬è©¦` (æ©™è‰²) â†’ `./data/test_fix/npz`

**åŠŸèƒ½èªªæ˜**:
- é»æ“ŠæŒ‰éˆ•è‡ªå‹•å¡«å…¥å°æ‡‰æ•¸æ“šç›®éŒ„è·¯å¾‘
- ç¶ è‰²æŒ‰éˆ•è¡¨ç¤ºæ­£å¼ä¿®å¾©ç‰ˆæœ¬
- æ©™è‰²æŒ‰éˆ•è¡¨ç¤ºæ¸¬è©¦ç”¨å°æ¨£æœ¬æ•¸æ“š

**å¯¦ç¾ä½ç½®**: [app.py:112-128](./app.py#L112-L128)

---

### 2. V5 é…ç½®è³‡è¨Šé¢æ¿ â­â­â­

**ä½ç½®**: å³å´è³‡è¨Šé¢æ¿ â†’ æ¨™ç±¤åˆ†å¸ƒä¸‹æ–¹

**é¡¯ç¤ºè³‡è¨Š**:

#### a) ç‰ˆæœ¬è³‡è¨Š
- é¡¯ç¤ºæ•¸æ“šé›†ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼š`5.0.3-ml-optimal-fixed`ï¼‰
- å¾ `normalization_meta.json` ä¸­çš„ `version` æ¬„ä½è®€å–

#### b) æ³¢å‹•ç‡é…ç½®
- **æ³¢å‹•ç‡æ–¹æ³•**: `ewma` / `garch`
- **EWMA åŠè¡°æœŸ**: é¡¯ç¤º halflife åƒæ•¸ï¼ˆåƒ… EWMAï¼‰
- ç¤ºä¾‹ï¼š`ewma (halflife=60)`

#### c) Triple-Barrier åƒæ•¸
- **PT/SL å€æ•¸**: æ­¢ç›ˆ/æ­¢æå€æ•¸ï¼ˆä¾‹å¦‚ï¼š`PT=3.5Ïƒ, SL=3.5Ïƒ`ï¼‰
- **æœ€å¤§æŒæœ‰æœŸ**: MaxHold åƒæ•¸ï¼ˆä¾‹å¦‚ï¼š`40 bars`ï¼‰
- **æœ€å°å ±é…¬é–¾å€¼**: MinRet åƒæ•¸ï¼ˆä¾‹å¦‚ï¼š`0.0015`ï¼‰

#### d) è·¨æ—¥ä¿è­·ç‹€æ…‹ â­
- **å•Ÿç”¨**: é¡¯ç¤º `âœ… å•Ÿç”¨`ï¼ˆç¶ è‰²åŠ ç²—ï¼‰
- **ç¦ç”¨**: é¡¯ç¤º `âŒ ç¦ç”¨`ï¼ˆç´…è‰²åŠ ç²—ï¼‰
- é€™æ˜¯é©—è­‰ä¿®å¾©çš„é—œéµæŒ‡æ¨™ï¼

**è³‡æ–™ä¾†æº**: `normalization_meta.json`

**å¯¦ç¾ä½ç½®**: [app.py:532-604](./app.py#L532-L604)

---

## æŠ€è¡“å¯¦ç¾

### ä¿®æ”¹æ–‡ä»¶

**ä¸»è¦æ–‡ä»¶**: `label_viewer/app.py`

**ä¿®æ”¹å…§å®¹**:

1. **å¿«é€Ÿé¸æ“‡æŒ‰éˆ• UI** (ç¬¬ 112-128 è¡Œ):
   ```python
   # æ–°å¢å…©å€‹æŒ‰éˆ•ï¼Œåˆ†å…©è¡Œæ’åˆ—
   html.Button('v5 ä¿®å¾©ç‰ˆ', id='btn-v5-fixed', ...)
   html.Button('v5 æ¸¬è©¦', id='btn-v5-test', ...)
   ```

2. **å¿«é€Ÿé¸æ“‡å›èª¿å‡½æ•¸** (ç¬¬ 275-306 è¡Œ):
   ```python
   @app.callback(...)
   def quick_select_directory(n_v5, n_v5_bal, n_v5_4461, n_v5_fixed, n_v5_test):
       # æ–°å¢å…©å€‹æŒ‰éˆ•çš„è™•ç†é‚è¼¯
       elif button_id == 'btn-v5-fixed':
           return f'{base_path}/processed_v5_fixed/npz'
       elif button_id == 'btn-v5-test':
           return f'{base_path}/test_fix/npz'
   ```

3. **è³‡è¨Šé¢æ¿å¢å¼·** (ç¬¬ 532-604 è¡Œ):
   ```python
   # å¾ metadata æå– V5 é…ç½®
   v5_version = metadata.get('version', 'N/A')
   v5_volatility = metadata.get('volatility', {})
   v5_tb = metadata.get('triple_barrier', {})
   v5_respect_day = metadata.get('respect_day_boundary', None)

   # å‹•æ…‹æ§‹å»ºé¡¯ç¤ºé …ç›®
   v5_info_items = [...]
   ```

---

## ä½¿ç”¨æŒ‡å—

### é©—è­‰ä¿®å¾©æ•ˆæœçš„æ­¥é©Ÿ

#### æ­¥é©Ÿ 1: ç”Ÿæˆä¿®å¾©ç‰ˆæ•¸æ“š

```bash
# æ¿€æ´»ç’°å¢ƒ
conda activate deeplob-pro

# ç”Ÿæˆä¿®å¾©ç‰ˆæ•¸æ“š
python scripts/extract_tw_stock_data_v5.py \
    --input-dir ./data/temp \
    --output-dir ./data/processed_v5_fixed \
    --config ./configs/config_pro_v5_ml_optimal.yaml \
    --make-npz
```

#### æ­¥é©Ÿ 2: å•Ÿå‹• Label Viewer

```bash
cd label_viewer
python app.py
```

#### æ­¥é©Ÿ 3: è¼‰å…¥ä¿®å¾©ç‰ˆæ•¸æ“š

1. é»æ“Š `v5 ä¿®å¾©ç‰ˆ` æŒ‰éˆ•ï¼ˆç¶ è‰²ï¼‰
2. é»æ“Š `é–‹å§‹è®€å–è³‡æ–™`
3. é¸æ“‡è‚¡ç¥¨ä»£ç¢¼

#### æ­¥é©Ÿ 4: æª¢æŸ¥é…ç½®è³‡è¨Š

åœ¨å³å´è³‡è¨Šé¢æ¿ä¸­ï¼Œç¢ºèªä»¥ä¸‹é …ç›®ï¼š

âœ… **ç‰ˆæœ¬**: æ‡‰é¡¯ç¤º `5.0.3-ml-optimal-fixed` æˆ–é¡ä¼¼ç‰ˆæœ¬
âœ… **è·¨æ—¥ä¿è­·**: æ‡‰é¡¯ç¤º `âœ… å•Ÿç”¨`ï¼ˆç¶ è‰²ï¼‰
âœ… **Triple-Barrier**: æ‡‰é¡¯ç¤º `PT=3.5Ïƒ, SL=3.5Ïƒ` ç­‰åƒæ•¸
âœ… **æ¨™ç±¤åˆ†å¸ƒ**: Class 1 (æŒå¹³) æ‡‰åœ¨ 35-45% ç¯„åœå…§

#### æ­¥é©Ÿ 5: å°æ¯”ä¿®å¾©å‰å¾Œ

1. åˆ‡æ›åˆ° `v5 åŸå§‹` æŒ‰éˆ•
2. è§€å¯Ÿæ¨™ç±¤åˆ†å¸ƒå·®ç•°
3. è§€å¯Ÿè·¨æ—¥ä¿è­·ç‹€æ…‹å·®ç•°

**é æœŸçµæœ**:
- ä¿®å¾©ç‰ˆï¼šClass 1 (æŒå¹³) â‰ˆ 35-45%ï¼Œè·¨æ—¥ä¿è­·å•Ÿç”¨
- åŸå§‹ç‰ˆï¼šClass 1 (æŒå¹³) < 10%ï¼Œè·¨æ—¥ä¿è­·ç¦ç”¨

---

## ç›¸å®¹æ€§èªªæ˜

### å‘å¾Œç›¸å®¹

- âœ… **å®Œå…¨ç›¸å®¹èˆŠæ•¸æ“š**: å¦‚æœ `normalization_meta.json` ä¸­æ²’æœ‰ V5 é…ç½®æ¬„ä½ï¼Œä¸é¡¯ç¤º V5 é…ç½®é¢æ¿
- âœ… **ä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½**: æ‰€æœ‰ç¾æœ‰åŠŸèƒ½ï¼ˆä¸»åœ–è¡¨ã€æ¨™ç±¤åˆ†å¸ƒåœ–ç­‰ï¼‰ä¿æŒä¸è®Š
- âœ… **å„ªé›…é™ç´š**: ç¼ºå°‘é…ç½®æ¬„ä½æ™‚ï¼Œé¡¯ç¤º `N/A` è€Œä¸æ˜¯éŒ¯èª¤

### æ–°æ•¸æ“šæ ¼å¼

**å¿…éœ€æ¬„ä½** (å¿…é ˆå­˜åœ¨æ–¼ `normalization_meta.json`):
- `version`: å­—ç¬¦ä¸²ï¼Œæ•¸æ“šé›†ç‰ˆæœ¬
- `volatility`: å­—å…¸ï¼ŒåŒ…å« `method` å’Œ `halflife`
- `triple_barrier`: å­—å…¸ï¼ŒåŒ…å« `pt_multiplier`, `sl_multiplier`, `max_holding`, `min_return`
- `respect_day_boundary`: å¸ƒæ—å€¼ï¼Œè·¨æ—¥ä¿è­·ç‹€æ…‹

**ç¤ºä¾‹ metadata**:
```json
{
  "version": "5.0.3-ml-optimal-fixed",
  "volatility": {
    "method": "ewma",
    "halflife": 60
  },
  "triple_barrier": {
    "pt_multiplier": 3.5,
    "sl_multiplier": 3.5,
    "max_holding": 40,
    "min_return": 0.0015
  },
  "respect_day_boundary": true
}
```

---

## å·²çŸ¥é™åˆ¶

### é™åˆ¶ 1: è§¸ç™¼åŸå› çµ±è¨ˆæœªå¯¦ç¾

**ç‹€æ…‹**: å¾…å¯¦ç¾
**åŸå› **: `extract_tw_stock_data_v5.py` æœªå°‡ `why` çµ±è¨ˆå¯«å…¥ metadata

**å½±éŸ¿**: ç„¡æ³•é¡¯ç¤º PT/SL/Time è§¸ç™¼æ¯”ä¾‹

**è§£æ±ºæ–¹æ¡ˆ**: æœªä¾†ç‰ˆæœ¬å¯åœ¨æ•¸æ“šç”Ÿæˆæ™‚ä¿å­˜ `trigger_stats`

### é™åˆ¶ 2: è·¨æ—¥éæ¿¾çµ±è¨ˆæœªå¯¦ç¾

**ç‹€æ…‹**: å¾…å¯¦ç¾
**åŸå› **: è·¨æ—¥éæ¿¾çµ±è¨ˆåƒ…åœ¨ç”Ÿæˆæ™‚è¼¸å‡ºåˆ°æ—¥èªŒï¼Œæœªä¿å­˜åˆ° metadata

**å½±éŸ¿**: ç„¡æ³•é¡¯ç¤ºè¢«éæ¿¾çš„è·¨æ—¥è¦–çª—æ•¸é‡

**è§£æ±ºæ–¹æ¡ˆ**: æœªä¾†ç‰ˆæœ¬å¯åœ¨ metadata ä¸­æ–°å¢ `cross_day_filtered` æ¬„ä½

---

## æ¸¬è©¦æ¸…å–®

### åŠŸèƒ½æ¸¬è©¦

- [x] **æ–°æŒ‰éˆ•å¯é»æ“Š**: `v5 ä¿®å¾©ç‰ˆ` å’Œ `v5 æ¸¬è©¦` æŒ‰éˆ•æ­£å¸¸å·¥ä½œ
- [x] **è·¯å¾‘æ­£ç¢ºå¡«å…¥**: é»æ“ŠæŒ‰éˆ•å¾Œï¼Œè·¯å¾‘è¼¸å…¥æ¡†é¡¯ç¤ºæ­£ç¢ºè·¯å¾‘
- [x] **è³‡è¨Šé¢æ¿é¡¯ç¤º**: V5 é…ç½®è³‡è¨Šæ­£ç¢ºé¡¯ç¤º
- [x] **è·¨æ—¥ä¿è­·æ¨™è¨˜**: æ ¹æ“š `respect_day_boundary` é¡¯ç¤ºæ­£ç¢ºç‹€æ…‹
- [x] **å‘å¾Œç›¸å®¹**: èˆŠæ•¸æ“šè¼‰å…¥æ™‚ä¸å ±éŒ¯

### è¦–è¦ºæ¸¬è©¦

- [x] **æŒ‰éˆ•é¡è‰²**: ç¶ è‰²ï¼ˆä¿®å¾©ç‰ˆï¼‰ã€æ©™è‰²ï¼ˆæ¸¬è©¦ç‰ˆï¼‰
- [x] **æ–‡å­—å°é½Š**: è³‡è¨Šé¢æ¿æ–‡å­—å·¦å°é½Šï¼Œæ ¼å¼çµ±ä¸€
- [x] **å­—é«”å¤§å°**: ä¸»è¦è³‡è¨Š 12pxï¼Œæ¬¡è¦è³‡è¨Š 11px
- [x] **ç‹€æ…‹é¡è‰²**: å•Ÿç”¨ï¼ˆç¶ è‰²ï¼‰ã€ç¦ç”¨ï¼ˆç´…è‰²ï¼‰

### æ•´åˆæ¸¬è©¦

- [x] **å®Œæ•´æµç¨‹**: å•Ÿå‹• â†’ è¼‰å…¥ â†’ é¸è‚¡ â†’ æŸ¥çœ‹é…ç½®
- [ ] **åˆ‡æ›æ•¸æ“šé›†**: Train/Val/Test åˆ‡æ›æ­£å¸¸
- [ ] **åˆ‡æ›è‚¡ç¥¨**: ä¸åŒè‚¡ç¥¨é…ç½®è³‡è¨Šæ­£ç¢ºé¡¯ç¤º
- [ ] **å°æ¯”æ¨¡å¼**: ä¿®å¾©ç‰ˆ vs åŸå§‹ç‰ˆå°æ¯”

---

## æœªä¾†æ”¹é€²

### å„ªå…ˆç´š 1: è§¸ç™¼åŸå› è¦–è¦ºåŒ–

**åŠŸèƒ½**: åœ¨æ¨™ç±¤åˆ†å¸ƒåœ–æ—æ–°å¢ã€Œè§¸ç™¼åŸå› é¤…åœ–ã€

**é¡¯ç¤ºå…§å®¹**:
- PT è§¸ç™¼ (æ­¢ç›ˆ)
- SL è§¸ç™¼ (æ­¢æ)
- Time è§¸ç™¼ (æ™‚é–“åˆ°)

**æ•¸æ“šä¾†æº**: éœ€ä¿®æ”¹ `extract_tw_stock_data_v5.py` ä¿å­˜ `trigger_stats`

### å„ªå…ˆç´š 2: é…ç½®å°æ¯”æ¨¡å¼

**åŠŸèƒ½**: åŒæ™‚è¼‰å…¥å¤šå€‹æ•¸æ“šæºï¼Œä¸¦æ’é¡¯ç¤ºé…ç½®å·®ç•°

**å°æ¯”é …ç›®**:
- æ¨™ç±¤åˆ†å¸ƒ
- Triple-Barrier åƒæ•¸
- è·¨æ—¥ä¿è­·ç‹€æ…‹

### å„ªå…ˆç´š 3: å°å‡ºå ±å‘Š

**åŠŸèƒ½**: å°‡é…ç½®è³‡è¨Šå’Œçµ±è¨ˆçµæœå°å‡ºç‚º PDF/HTML å ±å‘Š

**å…§å®¹**:
- é…ç½®æ‘˜è¦
- æ¨™ç±¤åˆ†å¸ƒåœ–
- åƒ¹æ ¼æ›²ç·šåœ–
- çµ±è¨ˆè¡¨æ ¼

---

## ç›¸é—œæ–‡ä»¶

- **ä¸»ç¨‹å¼**: [app.py](./app.py)
- **æ•¸æ“šè¼‰å…¥**: [utils/data_loader.py](./utils/data_loader.py)
- **å°ˆæ¡ˆèªªæ˜**: [CLAUDE.md](./CLAUDE.md)
- **ä¿®å¾©å ±å‘Š**: [../docs/FIX_CROSS_DAY_CONTAMINATION.md](../docs/FIX_CROSS_DAY_CONTAMINATION.md)
- **æ•¸æ“šç”Ÿæˆ**: [../scripts/extract_tw_stock_data_v5.py](../scripts/extract_tw_stock_data_v5.py)

---

**æ›´æ–°è€…**: Claude Code
**å¯©æ ¸è€…**: DeepLOB-Pro Team
**æ›´æ–°æ—¥æœŸ**: 2025-10-20
**ç‰ˆæœ¬**: v2.1

---

## é™„éŒ„ï¼šä¿®æ”¹å‰å¾Œå°æ¯”

### æ§åˆ¶é¢æ¿ (ä¿®æ”¹å‰)

```
å¿«é€Ÿé¸æ“‡:
[v5 åŸå§‹] [v5 å¹³è¡¡] [v5-44.61]
```

### æ§åˆ¶é¢æ¿ (ä¿®æ”¹å¾Œ)

```
å¿«é€Ÿé¸æ“‡:
[v5 åŸå§‹] [v5 å¹³è¡¡] [v5-44.61]
[v5 ä¿®å¾©ç‰ˆ] [v5 æ¸¬è©¦]
```

---

### è³‡è¨Šé¢æ¿ (ä¿®æ”¹å‰)

```
è‚¡ç¥¨ 2330
æ•¸æ“šé›†: è¨“ç·´é›†
æ¨£æœ¬æ•¸: 12,345
æ”¶ç›¤åƒ¹ç¯„åœ: [100.50, 150.30]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ¨™ç±¤åˆ†å¸ƒ:
ä¸‹è·Œ (0): 3,000 (24.3%)
æŒå¹³ (1): 500 (4.1%)
ä¸Šæ¼² (2): 8,845 (71.6%)
```

### è³‡è¨Šé¢æ¿ (ä¿®æ”¹å¾Œ)

```
è‚¡ç¥¨ 2330
æ•¸æ“šé›†: è¨“ç·´é›†
æ¨£æœ¬æ•¸: 12,345
æ”¶ç›¤åƒ¹ç¯„åœ: [100.50, 150.30]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ¨™ç±¤åˆ†å¸ƒ:
ä¸‹è·Œ (0): 3,000 (24.3%)
æŒå¹³ (1): 5,000 (40.5%)
ä¸Šæ¼² (2): 4,345 (35.2%)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
V5 é…ç½®:
ç‰ˆæœ¬: 5.0.3-ml-optimal-fixed
æ³¢å‹•ç‡: ewma (halflife=60)
Triple-Barrier: PT=3.5Ïƒ, SL=3.5Ïƒ
  MaxHold=40 bars, MinRet=0.0015
è·¨æ—¥ä¿è­·: âœ… å•Ÿç”¨
```

---

**ç¥ä½¿ç”¨é †åˆ©ï¼ğŸ‰**
