# Label Viewer - 預處理數據查看器完整指南

**版本**: v4.0 完整版
**最後更新**: 2025-10-23
**對應腳本**: `app_preprocessed.py`

---

## 📋 概述

`app_preprocessed.py` 是專門用於查看 `preprocess_single_day.py` 產生的預處理數據（NPZ 格式）的互動式 Web 工具。

### 主要功能

✅ **完整數據支援**：支援 PREPROCESSED_DATA_SPECIFICATION.md 定義的所有數據欄位
✅ **彈性顯示**：通過 switch 開關自由選擇要顯示的圖表
✅ **單股與整體**：支援單一股票詳細分析和全部股票整體統計
✅ **實時互動**：縮放、懸停、篩選等完整互動功能

### 支援的數據欄位

根據 [PREPROCESSED_DATA_SPECIFICATION.md](../docs/PREPROCESSED_DATA_SPECIFICATION.md)：

1. **features** (必要) - LOB 特徵矩陣 (T, 20)
2. **mids** (必要) - 中間價時序
3. **bucket_event_count** (選用) - 每個時間桶的事件數量
4. **bucket_mask** (選用) - 時間桶遮罩
5. **metadata** (必要) - 元數據
6. **labels** (選用) - 標籤陣列

---

## 🚀 快速開始

### 啟動應用

```bash
# 方法 1: 直接啟動
cd label_viewer
conda activate deeplob-pro
python app_preprocessed.py

# 方法 2: 使用測試腳本
scripts\test_label_viewer_simple.bat
```

瀏覽器自動打開 http://localhost:8051

### 基本使用流程

1. **輸入日期目錄路徑**
   ```
   例如: data/preprocessed_v5_1hz/daily/20250901
   ```

2. **點擊「載入目錄」按鈕**
   - 系統會掃描目錄下所有 NPZ 文件
   - 顯示股票總數和狀態訊息

3. **選擇股票**
   - 「📊 全部股票（整體統計）」- 查看整體標籤分布
   - 個別股票代碼 - 查看單一股票詳細數據

4. **選擇顯示選項**（勾選框）
   - ☑ 中間價折線圖 (mids)
   - ☑ LOB 特徵矩陣 (features)
   - ☑ 標籤陣列圖 (labels)
   - ☑ 事件數量圖 (bucket_event_count)
   - ☑ 時間桶遮罩圖 (bucket_mask)
   - ☑ 標籤預覽分布
   - ☑ 元數據表格

---

## 📊 圖表類型詳解

### 1. 中間價折線圖 (mids)

**用途**: 查看價格時序走勢，標籤點疊加在價格線上

**特點**:
- 藍色線條：中間價時序
- 紅色點：Down (-1) 標籤
- 灰色點：Neutral (0) 標籤
- 綠色點：Up (1) 標籤

**互動**:
- 縮放：滾輪或拖拽選區
- 懸停：顯示時間步、價格、標籤
- 圖例點擊：隱藏/顯示特定標籤

**示例**:
```
時間步 0-100: 價格從 587 上升到 590
Down 標籤: 出現在 10, 25, 40 等時間點
Up 標籤: 出現在 15, 30, 55 等時間點
```

---

### 2. LOB 特徵矩陣熱圖 (features)

**用途**: 查看 5 檔買賣價量的時空分布

**特點**:
- X 軸：時間步（只顯示前 500 個，避免過大）
- Y 軸：20 個特徵
  - ask_price_1~5: 賣方 5 檔價格
  - ask_vol_1~5: 賣方 5 檔量
  - bid_price_1~5: 買方 5 檔價格
  - bid_vol_1~5: 買方 5 檔量
- 顏色：Viridis 配色（深藍→黃色，值由低到高）

**互動**:
- 懸停：顯示時間、特徵名稱、具體值
- 縮放：可縮放查看局部時段

**示例**:
```
ask_price_1: 始終高於 bid_price_1（買賣價差）
ask_vol_1/bid_vol_1: 量的變化反映市場活躍度
橫向條紋: 表示某個時段價格/量持平
```

**注意**:
- ⚠️ 只顯示前 500 時間步（全部顯示會過大）
- ⚠️ 數據為原始值（未標準化）

---

### 3. 標籤陣列視覺化 (labels)

**用途**: 查看標籤時間序列分布

**特點**:
- X 軸：時間步
- Y 軸：標籤值 (-1, 0, 1)
- 紅色點：Down (-1)
- 灰色點：Neutral (0)
- 綠色點：Up (1)

**互動**:
- 懸停：顯示標籤類別和時間步
- 縮放：查看特定時段標籤密度

**用途場景**:
- 檢查標籤是否均勻分布
- 識別標籤密集區域（可能是高波動時段）
- 驗證標籤計算正確性

**示例**:
```
總計 15,956 個有效標籤
Down: 出現在時間步 0-1000 密集分布
Neutral: 均勻分布在整個時段
Up: 出現在時間步 10000-15000 密集分布
```

---

### 4. 事件數量圖 (bucket_event_count)

**用途**: 查看每秒的事件數量（交易、報價更新等）

**特點**:
- X 軸：時間步
- Y 軸：事件數
- 藍色填充區域：事件數量
- 標題顯示：平均事件數

**互動**:
- 懸停：顯示具體時間步和事件數
- 縮放：查看特定時段的交易活躍度

**用途場景**:
- 識別高頻交易時段（事件數高）
- 識別低流動性時段（事件數低）
- 檢查數據質量（事件數太少可能不可靠）

**示例**:
```
平均事件數: 5.3 次/秒
高峰時段 (10:00-11:00): 10-15 次/秒
低谷時段 (13:00-13:30): 1-3 次/秒
```

**解讀**:
- 事件數 > 10: 高流動性，數據可靠 ✅
- 事件數 5-10: 正常流動性 ✅
- 事件數 < 5: 低流動性，標籤可能不準確 ⚠️

---

### 5. 時間桶遮罩圖 (bucket_mask)

**用途**: 查看數據有效性（0=缺失, 1=有效）

**特點**:
- X 軸：時間步
- Y 軸：遮罩值（0 或 1）
- 紫色填充：有效數據
- 標題顯示：有效比例

**互動**:
- 懸停：顯示時間步和狀態
- 縮放：查看缺失數據的具體位置

**用途場景**:
- 檢查數據完整性
- 識別數據缺失的時段
- 評估數據質量

**示例**:
```
有效比例: 98.5%
缺失時段: 時間步 500-550 (可能是停盤)
缺失時段: 時間步 12000-12010 (可能是數據異常)
```

**解讀**:
- 有效比例 > 95%: 數據質量優秀 ✅
- 有效比例 90-95%: 數據質量良好 ✅
- 有效比例 < 90%: 數據質量差，需檢查 ⚠️

---

### 6. 標籤預覽分布

**用途**: 快速查看標籤分布統計

**特點**:
- 柱狀圖顯示三個類別的數量和比例
- Down (-1) - 紅色
- Neutral (0) - 灰色
- Up (1) - 綠色

**用途場景**:
- 快速判斷標籤是否平衡
- 評估動態過濾效果
- 決定是否需要調整訓練權重

**示例**:
```
Down: 2,273 (14.25%)
Neutral: 11,395 (71.42%)
Up: 2,288 (14.34%)

結論: Neutral 偏多（正常現象），Down/Up 基本平衡
```

---

### 7. 元數據表格

**用途**: 查看所有元數據欄位的詳細資訊

**內容包含**（參考 PREPROCESSED_DATA_SPECIFICATION.md）:

**基本資訊**:
- symbol: 股票代碼
- date: 交易日期
- n_points: 數據點數

**價格統計**:
- open, close, high, low
- range_pct: 價格範圍（%）
- return_pct: 日報酬率（%）

**過濾資訊**:
- pass_filter: 是否通過過濾
- filter_threshold: 過濾閾值
- filter_reason: 過濾原因

**處理參數**:
- sampling_mode: 聚合模式
- bucket_seconds: 時間桶大小
- agg_reducer: 聚合方式

**數據質量**:
- raw_events: 原始事件數
- aggregated_points: 聚合後點數
- ffill_ratio: 填充比例
- missing_ratio: 缺失比例

**用途場景**:
- 檢查數據質量指標
- 了解預處理參數
- 診斷過濾失敗原因

---

## 🎯 使用場景

### 場景 1: 單股深度分析

**目標**: 了解某檔股票的完整數據特性

**步驟**:
1. 載入日期目錄
2. 選擇目標股票（例如：2330）
3. 勾選所有顯示選項
4. 依次查看：
   - 中間價走勢 → 了解價格變化
   - LOB 特徵矩陣 → 了解買賣盤結構
   - 標籤陣列 → 驗證標籤分布
   - 事件數量 → 評估流動性
   - 時間桶遮罩 → 檢查數據完整性
   - 元數據表格 → 查看統計資訊

**預期結果**: 全面理解該股票的數據質量和特性

---

### 場景 2: 整體標籤分布檢查

**目標**: 檢查當日所有股票的標籤分布是否符合預期

**步驟**:
1. 載入日期目錄
2. 選擇「📊 全部股票（整體統計）」
3. 查看整體標籤分布柱狀圖
4. 查看前 10 檔股票的標籤對比

**預期結果**:
- 整體分布接近 30/40/30（目標分布）
- 個股分布合理，無極端異常

---

### 場景 3: 數據質量評估

**目標**: 評估某檔股票是否適合用於訓練

**步驟**:
1. 選擇股票
2. 勾選：事件數量、時間桶遮罩、元數據表格
3. 檢查指標：
   - 平均事件數 > 5 ✅
   - 有效比例 > 95% ✅
   - 缺失比例 < 5% ✅
   - 填充比例 < 10% ✅

**決策**:
- 所有指標通過 → 適合訓練 ✅
- 部分指標不佳 → 謹慎使用 ⚠️
- 多數指標不佳 → 排除該股 ❌

---

### 場景 4: 標籤計算驗證

**目標**: 驗證標籤計算是否正確

**步驟**:
1. 選擇股票
2. 勾選：中間價折線圖、標籤陣列
3. 對比觀察：
   - 價格上漲時段 → 是否有較多 Up 標籤
   - 價格下跌時段 → 是否有較多 Down 標籤
   - 價格橫盤時段 → 是否有較多 Neutral 標籤

**預期結果**: 標籤與價格走勢一致

---

## 🔧 高級功能

### 快取機制

- 使用 LRU 快取（最多 10 個股票）
- 自動清理最久未使用的數據
- 快取命中率顯示在左下角

**示例**:
```
快取: 8/10 命中 (8/10)
```

### 數據自動處理

- 自動過濾 NaN 值
- LOB 特徵矩陣自動限制 500 時間步
- 標籤實時計算（如果 NPZ 無標籤）

---

## 🐛 故障排除

### 問題 1: 載入目錄失敗

**錯誤訊息**: "目錄不存在" 或 "沒有找到 NPZ 文件"

**解決方案**:
```bash
# 檢查路徑是否正確
dir data\preprocessed_v5_1hz\daily\20250901

# 檢查是否有 NPZ 文件
dir data\preprocessed_v5_1hz\daily\20250901\*.npz

# 確保使用正斜線或反斜線
data/preprocessed_v5_1hz/daily/20250901  ✅
data\preprocessed_v5_1hz\daily\20250901  ✅
```

---

### 問題 2: 某個圖表不顯示

**原因**: NPZ 文件缺少對應欄位（舊版 NPZ）

**檢查方式**:
```python
import numpy as np
data = np.load('path/to/stock.npz', allow_pickle=True)
print(data.keys())
# 應包含: features, mids, metadata
# 可選: labels, bucket_event_count, bucket_mask
```

**解決方案**:
- 重新運行 `preprocess_single_day.py` 生成新版 NPZ
- 或取消勾選缺少的圖表

---

### 問題 3: 標籤計算錯誤

**症狀**: 標籤與價格走勢不符

**可能原因**:
1. Triple-Barrier 參數設置不當
2. 數據質量差（事件數少、缺失多）
3. 波動率過低（被過濾）

**檢查步驟**:
1. 查看元數據中的 `pass_filter` 和 `filter_reason`
2. 查看事件數量圖（是否過低）
3. 檢查 config 中的 triple_barrier 參數

---

### 問題 4: 瀏覽器無法訪問

**錯誤**: 無法打開 http://localhost:8051

**解決方案**:
```bash
# 檢查端口是否被佔用
netstat -ano | findstr 8051

# 如果被佔用，修改端口
# 編輯 app_preprocessed.py 最後一行
app.run(debug=False, port=8052, host='0.0.0.0')
```

---

## 📝 開發說明

### 代碼結構

```python
app_preprocessed.py
├── scan_daily_directory()      # 掃描目錄
├── compute_labels_from_mids()  # 實時計算標籤
├── get_overall_label_stats()   # 整體統計
├── load_directory()            # 載入回調
├── update_charts()             # 更新回調
│   ├── update_single_stock_view()   # 單股檢視
│   └── update_all_stocks_view()     # 整體檢視
└── update_cache_info()         # 快取資訊
```

### 依賴的模組

```python
from utils.preprocessed_loader import (
    load_preprocessed_stock,    # 載入 NPZ
    get_cache_info              # 快取資訊
)
from components.label_preview_panel import (
    create_label_preview_bar,       # 標籤預覽柱狀圖
    create_metadata_table,          # 元數據表格
    create_overall_label_stats_bar  # 整體統計柱狀圖
)
```

---

## 🔗 相關文檔

- [PREPROCESSED_DATA_SPECIFICATION.md](../docs/PREPROCESSED_DATA_SPECIFICATION.md) - NPZ 數據格式規格
- [LABEL_PREVIEW_GUIDE.md](../docs/LABEL_PREVIEW_GUIDE.md) - 標籤預覽完整指南
- [V6_TWO_STAGE_PIPELINE_GUIDE.md](../docs/V6_TWO_STAGE_PIPELINE_GUIDE.md) - V6 雙階段處理流程

---

## 🎓 最佳實踐

### 1. 檢查數據質量流程

```
步驟 1: 載入目錄 → 查看總股票數
步驟 2: 選擇「全部股票」→ 查看整體標籤分布
步驟 3: 選擇個股 → 勾選「事件數量」和「時間桶遮罩」
步驟 4: 評估指標 → 決定是否納入訓練
```

### 2. 標籤驗證流程

```
步驟 1: 選擇股票 → 勾選「中間價」和「標籤陣列」
步驟 2: 對比觀察 → 標籤與價格走勢是否一致
步驟 3: 查看元數據 → 確認 Triple-Barrier 參數
步驟 4: 如有問題 → 調整 config 重新處理
```

### 3. 效率最佳化

```
技巧 1: 使用快取 → 避免重複載入
技巧 2: 只勾選需要的圖表 → 加快渲染
技巧 3: 先查看整體 → 再深入個股
技巧 4: 批次檢查 → 使用整體統計功能
```

---

## 📊 版本歷史

### v4.0 (2025-10-23) 🆕 完整版
- ✅ 支援所有 NPZ 欄位（features, labels, bucket_event_count, bucket_mask）
- ✅ 新增 5 種圖表類型
- ✅ 完整對應 PREPROCESSED_DATA_SPECIFICATION.md
- ✅ 更新文檔說明

### v3.0 (2025-10-23) 簡化版
- ✅ 基礎功能（中間價、標籤預覽、元數據）
- ✅ 單股與整體檢視
- ✅ 快取機制

---

## 💡 提示與技巧

**提示 1**: 使用「全部股票」模式快速檢查整體標籤分布
**提示 2**: LOB 特徵矩陣熱圖可以幫助理解市場微觀結構
**提示 3**: 事件數量和時間桶遮罩是評估數據質量的關鍵指標
**提示 4**: 縮放功能可以幫助深入查看特定時段的細節
**提示 5**: 快取命中率顯示在左下角，可以優化查看順序

---

**最後更新**: 2025-10-23
**文檔版本**: v4.0
**對應代碼**: app_preprocessed.py v4.0
