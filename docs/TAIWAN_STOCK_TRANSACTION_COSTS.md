# 台股交易成本配置说明

## 概述

本文档说明 `train_sb3_deeplob.py` 和 `TaiwanLOBTradingEnv` 中关于台股交易成本的定义和配置。

**日期**: 2025-10-26
**版本**: v1.0

---

## 当前配置

### 1. 配置文件定义

**文件**: `configs/sb3_deeplob_config.yaml`

```yaml
env_config:
  # 交易参数
  transaction_cost_rate: 0.001  # 0.1% 交易成本
  max_position: 1               # 最大持仓 {-1, 0, 1}

  # 奖励塑形
  reward_config:
    pnl_scale: 1.0              # PnL 权重
    cost_penalty: 1.0           # 交易成本惩罚
    inventory_penalty: 0.01     # 库存惩罚
    risk_penalty: 0.005         # 风险惩罚
```

### 2. 环境实现

**文件**: `src/envs/tw_lob_trading_env.py`

```python
# 第 64 行
self.transaction_cost_rate = config.get('transaction_cost_rate', 0.001)

# 第 294 行（计算交易成本）
if action != prev_position + 1:
    position_change = abs(action - (prev_position + 1))
    transaction_cost = position_change * current_price * self.transaction_cost_rate
    self.total_cost += transaction_cost
```

**计算逻辑**:
```
交易成本 = 仓位变化量 × 当前价格 × 交易成本率
```

**示例**:
- 买入 1 股，价格 100 元
- 交易成本 = 1 × 100 × 0.001 = 0.1 元

---

## 台股实际交易成本（2025 年最新）

### 1. 券商手续费（Commission）⭐

**收取方式**: **买卖双边都收**

| 券商类型 | 手续费率 | 说明 |
|---------|---------|------|
| 法定上限 | 0.1425% | 由交易所/主管机关规范 |
| 一般券商 | 0.1425% | 公定费率（无折扣） |
| 电子券商 | 0.05% ~ 0.1% | 常见折扣 5-7 折 |
| 量化交易 | 0.02% ~ 0.05% | 大户可议价（需月交易量支持） |
| 高频交易 | 0.01% ~ 0.02% | 极限协商价（需极大交易量） |

**重点**: 买入和卖出都收手续费

### 2. 证券交易税（STT）⭐⭐⭐

**收取方式**: **只在卖出时收**

| 证券类型 | 一般卖出 | 当冲卖出 | 说明 |
|---------|---------|---------|------|
| **现股** | 0.3% | 0.15% | 当冲税率减半 |
| ETF/TDR | 0.1% | 0.05% | 当冲税率减半 |

**当冲优惠**: 同日反向冲销（买进后当日卖出），税率减半
**有效期限**: 延长适用至 **2027/12/31**

**重点**: 只在卖出时收，买入不收

### 3. 台股交易成本估算（2025 最新）

#### 情境 A: 一般散户（无折扣）
```
买入成本 = 0.1425% (手续费)
卖出成本 = 0.1425% (手续费) + 0.3% (交易税) = 0.4425%
单次往返总成本 = 0.1425% + 0.4425% = 0.585%
```

#### 情境 B: 电子券商（折扣 6 折）
```
买入成本 = 0.1425% × 0.6 = 0.0855%
卖出成本 = 0.0855% + 0.3% = 0.3855%
单次往返总成本 = 0.0855% + 0.3855% = 0.471%
```

#### 情境 C: 量化交易（协商 3 折，现实可达）⭐⭐⭐⭐⭐
```
买入成本 = 0.1425% × 0.3 ≈ 0.043% (协商价 ~0.04%)
卖出成本 = 0.043% + 0.3% = 0.343%
单次往返总成本 ≈ 0.386%
```

#### 情境 D: 高频交易（极限协商 2 折）
```
买入成本 = 0.1425% × 0.2 ≈ 0.029% (协商价 ~0.03%)
卖出成本 = 0.029% + 0.3% = 0.329%
单次往返总成本 ≈ 0.358%
```

#### 情境 E: 当冲交易（日内高频，税率减半）⭐⭐⭐⭐⭐
```
买入成本 = 0.043% (协商价 3 折)
卖出成本 = 0.043% + 0.15% (当冲税率减半) = 0.193%
单次往返总成本 ≈ 0.236%
```

**当冲优势**: 交易税减半（0.3% → 0.15%），大幅降低成本

---

## 当前配置 vs 实际成本

### 问题分析

**当前配置**: `0.1%` (0.001)

**实际成本（2025 最新）**:
- 一般散户: `0.585%`（**5.85 倍高** ❌）
- 电子券商: `0.471%`（**4.71 倍高** ❌）
- 量化交易: `0.386%`（**3.86 倍高** ❌）
- 高频交易: `0.358%`（**3.58 倍高** ❌）
- **当冲交易**: `0.236%`（**2.36 倍高** ⚠️）

### ⚠️ 结论

**当前配置严重低估了台股的实际交易成本！**

这会导致:
1. ❌ **强化学习智能体过度交易**（认为交易成本很低）
2. ❌ **回测结果过于乐观**（实际盈利会显著降低 3-6 倍）
3. ❌ **实盘表现与训练不符**（真实环境成本高得多）
4. ❌ **无法正确评估策略的实际可行性**

---

## 建议配置（2025 最新）

### 方案 A: 保守配置（一般散户，无折扣）

**适合**: 模拟一般散户交易（最保守）

```yaml
env_config:
  transaction_cost_rate: 0.00585  # 0.585% (往返总成本)
```

**成本构成**: 买入 0.1425% + 卖出 0.4425% = 0.585%

**优点**: 最保守，考虑最高成本
**缺点**: 可能过度惩罚交易，智能体难以学到有效策略

---

### 方案 B: 中等配置（电子券商，6 折）

**适合**: 模拟使用电子券商的一般交易

```yaml
env_config:
  transaction_cost_rate: 0.00471  # 0.471% (往返总成本)
```

**成本构成**: 买入 0.0855% + 卖出 0.3855% = 0.471%

**优点**: 符合多数散户使用电子券商的情况
**缺点**: 仍较保守，限制高频交易策略

---

### 方案 C: 量化交易配置（协商 3 折）⭐⭐⭐⭐⭐

**适合**: 专业量化交易（现实可达成） - **推荐**

```yaml
env_config:
  transaction_cost_rate: 0.00386  # 0.386% (往返总成本)
```

**成本构成**: 买入 0.043% + 卖出 0.343% = 0.386%

**优点**:
- ✅ 符合专业量化交易的实际成本
- ✅ 成本合理，不会过度限制交易
- ✅ 适合高频交易策略（本专案目标）
- ✅ 现实可达成（需要一定交易量）

**推荐理由**:
- 本专案目标是**高频交易**（DeepLOB 预测 + RL 决策）
- 量化交易通常能协商到 3 折手续费
- 0.386% 是实际可达成的成本水平

---

### 方案 D: 高频交易配置（协商 2 折）

**适合**: 极限优化的高频交易

```yaml
env_config:
  transaction_cost_rate: 0.00358  # 0.358% (往返总成本)
```

**成本构成**: 买入 0.029% + 卖出 0.329% = 0.358%

**优点**: 符合极限优化的高频交易
**缺点**: 需要协商到 2 折（需要极大交易量）

---

### 方案 E: 当冲交易配置（税率减半）⭐⭐⭐⭐⭐

**适合**: 日内高频交易（当冲策略） - **最佳方案**

```yaml
env_config:
  transaction_cost_rate: 0.00236  # 0.236% (往返总成本)
  # 或更保守一点
  transaction_cost_rate: 0.00250  # 0.25% (往返总成本 + 缓冲)
```

**成本构成**: 买入 0.043% + 卖出 0.193% (含当冲减半税) = 0.236%

**优点**:
- ✅ **当冲税率减半**（0.3% → 0.15%），成本最低
- ✅ 非常适合高频交易策略
- ✅ 鼓励智能体学习日内平仓
- ✅ 符合本专案的高频交易目标

**推荐理由**:
- **当冲优惠延长至 2027/12/31**，政策稳定
- 高频交易策略天然适合当冲
- 成本降低 40% (0.386% → 0.236%)

**⚠️ 注意**: 需要确保策略在单日内平仓

---

### 方案 F: 买卖分开计算（最准确）⭐⭐⭐⭐⭐

**推荐最佳实践**: 将买入和卖出成本分开（最真实）

#### F1: 一般交易（买卖分开）

```yaml
env_config:
  # 量化交易（3 折手续费）
  buy_cost_rate: 0.00043   # 0.043% (买入手续费)
  sell_cost_rate: 0.00343  # 0.343% (卖出手续费 0.043% + 交易税 0.3%)
```

#### F2: 当冲交易（买卖分开，税率减半）

```yaml
env_config:
  # 量化交易 + 当冲优惠
  buy_cost_rate: 0.00043   # 0.043% (买入手续费)
  sell_cost_rate: 0.00193  # 0.193% (卖出手续费 0.043% + 当冲税 0.15%)
```

**需要修改代码**: `src/envs/tw_lob_trading_env.py`

```python
# 添加买卖分开的成本率
self.buy_cost_rate = config.get('buy_cost_rate', 0.00043)
self.sell_cost_rate = config.get('sell_cost_rate', 0.00193)  # 当冲版

# 修改 step() 方法（第 290-295 行）
if action != prev_position + 1:
    position_change = abs(action - (prev_position + 1))

    # 根据买卖方向计算成本
    if action == 1:  # Buy
        transaction_cost = position_change * current_price * self.buy_cost_rate
    elif action == 2:  # Sell
        transaction_cost = position_change * current_price * self.sell_cost_rate
    else:  # Hold
        transaction_cost = 0.0

    self.total_cost += transaction_cost
```

**优点**:
- ✅ **最准确反映台股成本结构**
- ✅ 买入和卖出成本分开
- ✅ 智能体学会"卖出比买入更昂贵"
- ✅ 可以模拟当冲优惠

---

## 实施建议

### 🚀 立即行动方案（推荐）

#### 方案 1: 当冲交易配置（最佳）⭐⭐⭐⭐⭐

**最推荐**: 适合高频交易，成本最低

**步骤 1**: 修改配置文件

编辑 `configs/sb3_deeplob_config.yaml`:
```yaml
env_config:
  # 修改前（不准确）
  # transaction_cost_rate: 0.001  # 0.1% (严重低估)

  # 修改后（当冲交易，税率减半）
  transaction_cost_rate: 0.00250  # 0.25% (当冲往返总成本 + 缓冲)
```

**步骤 2**: 重新训练模型
```bash
# 快速测试（10K steps）
python scripts/train_sb3_deeplob.py --test

# 完整训练（1M steps）
python scripts/train_sb3_deeplob.py
```

**预期效果**:
- 交易频率降低 20-30%（仍保持高频特性）
- 策略更注重日内平仓
- 回测结果更接近实盘

---

#### 方案 2: 量化交易配置（保守）

**适合**: 不确定能否达成当冲条件

**步骤 1**: 修改配置文件

编辑 `configs/sb3_deeplob_config.yaml`:
```yaml
env_config:
  # 量化交易（一般税率）
  transaction_cost_rate: 0.00386  # 0.386% (量化交易往返总成本)
```

**步骤 2**: 重新训练模型
```bash
python scripts/train_sb3_deeplob.py --test
python scripts/train_sb3_deeplob.py
```

**预期效果**:
- 交易频率降低 30-40%
- 策略更保守但更稳定
- 适用于非当冲场景

### 长期方案（推荐）

**步骤 1**: 修改环境代码，支持买卖分开

编辑 `src/envs/tw_lob_trading_env.py`:
```python
# 添加买卖分开的成本
self.buy_cost_rate = config.get('buy_cost_rate', 0.0002)
self.sell_cost_rate = config.get('sell_cost_rate', 0.0032)

# 修改 step() 方法
if action == 1:  # Buy
    transaction_cost = position_change * current_price * self.buy_cost_rate
elif action == 2:  # Sell
    transaction_cost = position_change * current_price * self.sell_cost_rate
```

**步骤 2**: 更新配置文件

```yaml
env_config:
  # 买卖分开的成本（更准确）
  buy_cost_rate: 0.0002    # 0.02% (买入手续费)
  sell_cost_rate: 0.0032   # 0.32% (卖出手续费 + 交易税)

  # 或使用单一成本（简化版）
  transaction_cost_rate: 0.0034  # 0.34% (往返总成本)
```

---

## 成本敏感性分析

### 不同成本对策略的影响（2025 最新）

| 成本率 | 场景 | 交易频率 | 持仓时间 | 实盘可行性 |
|--------|------|----------|---------|----------|
| 0.1% | 当前配置 | 高（过度） | 短（不合理） | ❌ 严重低估 |
| **0.236%** | **当冲交易** | **高** | **短（日内）** | ✅ **最佳** |
| 0.25% | 当冲+缓冲 | 中高 | 短至中 | ✅ 推荐 |
| 0.358% | 高频交易 | 中高 | 短至中 | ✅ 可行 |
| 0.386% | 量化交易 | 中 | 中 | ✅ 保守 |
| 0.471% | 电子券商 | 中低 | 中至长 | ✅ 一般 |
| 0.585% | 一般散户 | 低 | 长 | ✅ 最保守 |
| 1.0% | - | 极低 | 极长 | ❌ 过度保守 |

### 预期影响对比

#### 场景 1: 从 0.1% → 0.25% (当冲配置，推荐)

- 交易频率: 降低 **20-30%**
- 平均持仓时间: 增加 **1.3-1.5 倍**
- Sharpe Ratio: 可能略降 5-10%（但更真实）
- 最大回撤: 可能略增 5-10%
- **实盘可行性**: ✅ 显著提高
- **成本真实性**: ✅ 非常准确（当冲场景）

#### 场景 2: 从 0.1% → 0.386% (量化交易，保守)

- 交易频率: 降低 **30-40%**
- 平均持仓时间: 增加 **1.5-2 倍**
- Sharpe Ratio: 可能降低 10-15%（但更真实）
- 最大回撤: 可能增加 10-15%
- **实盘可行性**: ✅ 显著提高
- **成本真实性**: ✅ 准确（一般场景）

#### 场景 3: 从 0.1% → 0.585% (一般散户)

- 交易频率: 降低 **50-70%**
- 平均持仓时间: 增加 **2-3 倍**
- Sharpe Ratio: 可能降低 20-30%
- 最大回撤: 可能增加 20-30%
- **实盘可行性**: ✅ 可行（但过于保守）
- **成本真实性**: ✅ 最保守

---

## 参考资料

### 台股交易成本官方规定

1. **证券交易税**: 财政部规定 0.3%（卖出）
2. **券商手续费**: 金管会规定上限 0.1425%
3. **电子券商折扣**: 各券商公告（通常 5-7 折）

### 量化交易手续费协商

- **交易量要求**: 通常月交易额 > 1000 万
- **协商范围**: 0.01% ~ 0.05%
- **实际可达**: 0.02% 是合理水平

### 高频交易成本优化

- **下单速度**: 使用 API 交易（非人工）
- **券商选择**: 支持 API 的券商（永丰、群益等）
- **交易时段**: 盘中流动性高时段
- **成本监控**: 实时追踪滑点和成本

---

## 实施检查清单

### ✅ 立即行动

- [ ] 修改 `configs/sb3_deeplob_config.yaml` 中的 `transaction_cost_rate`
- [ ] 从 `0.001` 改为 `0.0034`（或根据场景选择）
- [ ] 重新训练模型并比较结果

### ⏳ 短期优化（1-2 周）

- [ ] 分析不同成本率对策略的影响
- [ ] 进行成本敏感性测试
- [ ] 记录不同成本下的 Sharpe Ratio

### ⏳ 长期改进（1-2 月）

- [ ] 实现买卖成本分开计算
- [ ] 添加滑点模型（实际成交价与预期价的差异）
- [ ] 考虑市场冲击成本（大单对价格的影响）

---

## 总结与建议

### 🎯 核心问题

**当前配置 (0.1%) 严重低估台股实际交易成本 2-6 倍！**

| 对比项 | 当前配置 | 实际成本 | 差距 |
|--------|---------|---------|------|
| 成本率 | 0.1% | 0.236% ~ 0.585% | **2.36 ~ 5.85 倍** |
| 结果 | ❌ 过度交易 | ✅ 真实场景 | - |

### 🚀 推荐方案（2025 最新）

#### 第一推荐：当冲交易配置 ⭐⭐⭐⭐⭐

**配置值**: `0.0025` (0.25%)

**理由**:
1. ✅ **当冲税率减半**（0.3% → 0.15%）
2. ✅ 适合高频交易策略（本专案目标）
3. ✅ 成本最低且实际可达成
4. ✅ 政策稳定（延长至 2027/12/31）
5. ✅ 不会过度限制交易

**成本构成**:
```
买入: 0.043% (手续费 3 折)
卖出: 0.193% (手续费 0.043% + 当冲税 0.15%)
往返: 0.236%
缓冲: 0.014% (考虑滑点等)
总计: 0.25%
```

#### 第二推荐：量化交易配置 ⭐⭐⭐⭐

**配置值**: `0.00386` (0.386%)

**理由**:
1. ✅ 符合专业量化交易成本
2. ✅ 适用于非当冲场景
3. ✅ 现实可达成（需一定交易量）
4. ✅ 更保守但更稳定

### 💡 快速实施步骤

#### 步骤 1: 选择方案

**高频/当冲策略**: 使用 0.25%
**一般量化策略**: 使用 0.386%

#### 步骤 2: 修改配置

编辑 `configs/sb3_deeplob_config.yaml`:

```yaml
env_config:
  # 修改前（严重低估）
  # transaction_cost_rate: 0.001  # 0.1%

  # 修改后（当冲交易，推荐）
  transaction_cost_rate: 0.00250  # 0.25%

  # 或（量化交易，保守）
  # transaction_cost_rate: 0.00386  # 0.386%
```

#### 步骤 3: 重新训练

```bash
# 快速测试
python scripts/train_sb3_deeplob.py --test

# 完整训练
python scripts/train_sb3_deeplob.py
```

### 📊 预期效果

**使用 0.25% (当冲)**:

- 交易频率: 降低 20-30%（仍保持高频）
- 持仓时间: 增加 1.3-1.5 倍
- 策略特性: 更注重日内平仓
- 实盘可行性: ✅ 显著提高

**使用 0.386% (量化)**:

- 交易频率: 降低 30-40%
- 持仓时间: 增加 1.5-2 倍
- 策略特性: 更保守更稳定
- 实盘可行性: ✅ 显著提高

---

**文档版本**: v1.0
**最后更新**: 2025-10-26
**维护者**: SB3-DeepLOB Team
