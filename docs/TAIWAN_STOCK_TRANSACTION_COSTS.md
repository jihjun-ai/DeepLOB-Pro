# 台股交易成本配置说明

## 概述

本文档说明 `train_sb3_deeplob.py` 和 `TaiwanLOBTradingEnv` 中关于台股交易成本的定义和配置。

**日期**: 2025-10-26
**版本**: v1.0

---

## 当前配置

### 1. 配置文件定义

**文件**: `configs/sb3_deeplob_config.yaml`

```yaml
env_config:
  # 交易参数
  transaction_cost_rate: 0.001  # 0.1% 交易成本
  max_position: 1               # 最大持仓 {-1, 0, 1}

  # 奖励塑形
  reward_config:
    pnl_scale: 1.0              # PnL 权重
    cost_penalty: 1.0           # 交易成本惩罚
    inventory_penalty: 0.01     # 库存惩罚
    risk_penalty: 0.005         # 风险惩罚
```

### 2. 环境实现

**文件**: `src/envs/tw_lob_trading_env.py`

```python
# 第 64 行
self.transaction_cost_rate = config.get('transaction_cost_rate', 0.001)

# 第 294 行（计算交易成本）
if action != prev_position + 1:
    position_change = abs(action - (prev_position + 1))
    transaction_cost = position_change * current_price * self.transaction_cost_rate
    self.total_cost += transaction_cost
```

**计算逻辑**:
```
交易成本 = 仓位变化量 × 当前价格 × 交易成本率
```

**示例**:
- 买入 1 股，价格 100 元
- 交易成本 = 1 × 100 × 0.001 = 0.1 元

---

## 台股实际交易成本

### 1. 证券交易税（固定）

| 交易类型 | 税率 | 说明 |
|---------|------|------|
| **买入** | 0% | 买入免税 |
| **卖出** | 0.3% | 证券交易税 |

### 2. 券商手续费（浮动）

| 券商类型 | 手续费率 | 说明 |
|---------|---------|------|
| 一般券商 | 0.1425% | 法定最高费率 |
| 电子券商 | 0.05% ~ 0.1% | 折扣费率 |
| 大户优惠 | 0.01% ~ 0.03% | 量化交易可协商 |

**买卖双向收取**: 买入和卖出都收手续费

### 3. 台股高频交易成本估算

#### 情境 A: 一般散户
```
买入成本 = 0.1425% (手续费)
卖出成本 = 0.1425% (手续费) + 0.3% (交易税) = 0.4425%
单次往返总成本 = 0.1425% + 0.4425% = 0.585%
```

#### 情境 B: 电子券商（折扣 6 折）
```
买入成本 = 0.1425% × 0.6 = 0.0855%
卖出成本 = 0.0855% + 0.3% = 0.3855%
单次往返总成本 = 0.0855% + 0.3855% = 0.471%
```

#### 情境 C: 量化交易（大户优惠）
```
买入成本 = 0.02% (协商价)
卖出成本 = 0.02% + 0.3% = 0.32%
单次往返总成本 = 0.02% + 0.32% = 0.34%
```

#### 情境 D: 高频交易（极限优化）
```
买入成本 = 0.01% (最低协商价)
卖出成本 = 0.01% + 0.3% = 0.31%
单次往返总成本 = 0.01% + 0.31% = 0.32%
```

---

## 当前配置 vs 实际成本

### 问题分析

**当前配置**: `0.1%` (0.001)
**实际成本**:
- 一般散户: `0.585%`（**5.85 倍高**）
- 电子券商: `0.471%`（**4.71 倍高**）
- 量化交易: `0.34%`（**3.4 倍高**）
- 高频交易: `0.32%`（**3.2 倍高**）

### ⚠️ 结论

**当前配置严重低估了台股的实际交易成本！**

这会导致:
1. ❌ **强化学习智能体过度交易**（认为交易成本很低）
2. ❌ **回测结果过于乐观**（实际盈利会显著降低）
3. ❌ **实盘表现与训练不符**（真实环境成本高 3-6 倍）

---

## 建议配置

### 方案 A: 保守配置（一般散户）

适合：模拟一般散户交易

```yaml
env_config:
  transaction_cost_rate: 0.00585  # 0.585% (往返总成本)
```

**优点**: 最保守，考虑最高成本
**缺点**: 可能过度惩罚交易，智能体学不到有效策略

### 方案 B: 中等配置（电子券商）

适合：模拟使用电子券商的交易

```yaml
env_config:
  transaction_cost_rate: 0.00471  # 0.471% (往返总成本)
```

**优点**: 符合多数散户使用电子券商的情况
**缺点**: 仍较保守

### 方案 C: 量化交易配置（推荐） ⭐⭐⭐⭐⭐

适合：模拟专业量化交易（协商手续费）

```yaml
env_config:
  transaction_cost_rate: 0.0034   # 0.34% (往返总成本)
```

**优点**:
- 符合专业量化交易的成本
- 成本合理，不会过度限制交易
- 适合高频交易策略

**推荐理由**:
- 本专案目标是**高频交易**（DeepLOB 预测 + RL 决策）
- 高频交易通常能协商较低手续费
- 0.34% 是实际可达成的成本水平

### 方案 D: 高频交易配置（激进）

适合：极限优化的高频交易

```yaml
env_config:
  transaction_cost_rate: 0.0032   # 0.32% (往返总成本)
```

**优点**: 符合极限优化的高频交易
**缺点**: 需要协商到最低手续费（0.01%），不一定能达成

### 方案 E: 买卖分开计算（最准确） ⭐⭐⭐⭐⭐

**推荐最佳实践**: 将买入和卖出成本分开

```yaml
env_config:
  # 不使用单一 transaction_cost_rate
  buy_cost_rate: 0.0002    # 0.02% (买入手续费)
  sell_cost_rate: 0.0032   # 0.32% (卖出手续费 + 交易税)
```

**需要修改代码**:
```python
# tw_lob_trading_env.py
if action == 1:  # Buy
    transaction_cost = position_change * current_price * self.buy_cost_rate
elif action == 2:  # Sell
    transaction_cost = position_change * current_price * self.sell_cost_rate
```

**优点**:
- ✅ 最准确反映台股成本结构
- ✅ 买入和卖出成本分开
- ✅ 智能体学会卖出比买入更昂贵

---

## 实施建议

### 短期方案（立即实施）

**步骤 1**: 修改配置文件

编辑 `configs/sb3_deeplob_config.yaml`:
```yaml
env_config:
  # 修改前: transaction_cost_rate: 0.001  # 0.1% (不准确)
  # 修改后:
  transaction_cost_rate: 0.0034  # 0.34% (量化交易往返总成本)
```

**步骤 2**: 重新训练模型
```bash
python scripts/train_sb3_deeplob.py --test  # 先测试
python scripts/train_sb3_deeplob.py          # 完整训练
```

### 长期方案（推荐）

**步骤 1**: 修改环境代码，支持买卖分开

编辑 `src/envs/tw_lob_trading_env.py`:
```python
# 添加买卖分开的成本
self.buy_cost_rate = config.get('buy_cost_rate', 0.0002)
self.sell_cost_rate = config.get('sell_cost_rate', 0.0032)

# 修改 step() 方法
if action == 1:  # Buy
    transaction_cost = position_change * current_price * self.buy_cost_rate
elif action == 2:  # Sell
    transaction_cost = position_change * current_price * self.sell_cost_rate
```

**步骤 2**: 更新配置文件

```yaml
env_config:
  # 买卖分开的成本（更准确）
  buy_cost_rate: 0.0002    # 0.02% (买入手续费)
  sell_cost_rate: 0.0032   # 0.32% (卖出手续费 + 交易税)

  # 或使用单一成本（简化版）
  transaction_cost_rate: 0.0034  # 0.34% (往返总成本)
```

---

## 成本敏感性分析

### 不同成本对策略的影响

| 成本率 | 交易频率 | 平均持仓时间 | 适用场景 |
|--------|----------|-------------|---------|
| 0.1% | 高（过度） | 短（不合理） | ❌ 不准确 |
| 0.32% | 中高 | 短至中 | ✅ 高频交易 |
| 0.471% | 中 | 中 | ✅ 电子券商 |
| 0.585% | 低 | 长 | ✅ 一般散户 |
| 1.0% | 极低 | 极长 | ❌ 过度保守 |

### 预期影响

**从 0.1% 提高到 0.34%**:
- 交易频率: 预计降低 **30-50%**
- 平均持仓时间: 增加 **1.5-2 倍**
- Sharpe Ratio: 可能略降（但更真实）
- 最大回撤: 可能略增
- **实盘可行性**: 显著提高 ✅

---

## 参考资料

### 台股交易成本官方规定

1. **证券交易税**: 财政部规定 0.3%（卖出）
2. **券商手续费**: 金管会规定上限 0.1425%
3. **电子券商折扣**: 各券商公告（通常 5-7 折）

### 量化交易手续费协商

- **交易量要求**: 通常月交易额 > 1000 万
- **协商范围**: 0.01% ~ 0.05%
- **实际可达**: 0.02% 是合理水平

### 高频交易成本优化

- **下单速度**: 使用 API 交易（非人工）
- **券商选择**: 支持 API 的券商（永丰、群益等）
- **交易时段**: 盘中流动性高时段
- **成本监控**: 实时追踪滑点和成本

---

## 实施检查清单

### ✅ 立即行动

- [ ] 修改 `configs/sb3_deeplob_config.yaml` 中的 `transaction_cost_rate`
- [ ] 从 `0.001` 改为 `0.0034`（或根据场景选择）
- [ ] 重新训练模型并比较结果

### ⏳ 短期优化（1-2 周）

- [ ] 分析不同成本率对策略的影响
- [ ] 进行成本敏感性测试
- [ ] 记录不同成本下的 Sharpe Ratio

### ⏳ 长期改进（1-2 月）

- [ ] 实现买卖成本分开计算
- [ ] 添加滑点模型（实际成交价与预期价的差异）
- [ ] 考虑市场冲击成本（大单对价格的影响）

---

## 总结

### 核心问题

**当前配置 (0.1%) 严重低估了台股实际交易成本（3-6 倍）**

### 推荐方案

**量化交易配置**: `0.34%` (0.0034) ⭐⭐⭐⭐⭐

**理由**:
1. ✅ 符合专业量化交易的成本水平
2. ✅ 适合高频交易策略
3. ✅ 实际可达成（协商手续费）
4. ✅ 不会过度限制交易

### 实施步骤

```yaml
# 编辑 configs/sb3_deeplob_config.yaml
env_config:
  transaction_cost_rate: 0.0034  # 从 0.001 改为 0.0034
```

```bash
# 重新训练
python scripts/train_sb3_deeplob.py --test
```

### 预期效果

- 交易频率降低 30-50%
- 策略更保守但更实际
- 实盘可行性显著提高

---

**文档版本**: v1.0
**最后更新**: 2025-10-26
**维护者**: SB3-DeepLOB Team
