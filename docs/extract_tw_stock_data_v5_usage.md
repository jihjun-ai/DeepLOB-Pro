# extract_tw_stock_data_v5.py ä½¿ç”¨èªªæ˜

## ğŸ“‹ æ¦‚è¿°

`extract_tw_stock_data_v5.py` æ˜¯ DeepLOB-Pro å°ˆæ¡ˆçš„**å°è‚¡æ•¸æ“šé è™•ç†å·¥å…·**ï¼ˆV5 å°ˆæ¥­ç‰ˆï¼‰ï¼Œè² è²¬å°‡åŸå§‹å°è‚¡ LOB æ•¸æ“šè½‰æ›ç‚º DeepLOB æ¨¡å‹å¯ç”¨çš„è¨“ç·´æ ¼å¼ã€‚

**ç‰ˆæœ¬**ï¼šv5.0.0
**æ›´æ–°æ—¥æœŸ**ï¼š2025-10-19
**å°ˆæ¡ˆæ–‡æª”**ï¼š[CLAUDE.md](../CLAUDE.md)

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### V5 ç›¸è¼ƒæ–¼ V4 çš„é‡å¤§å‡ç´š

| åŠŸèƒ½æ¨¡çµ„ | V4 | V5 |
|---------|----|----|
| **æ¨™ç±¤ç”Ÿæˆ** | å›ºå®š k æ­¥åƒ¹æ ¼è®Šå‹•ï¼ˆalpha=0.002ï¼‰ | Triple-Barrier è‡ªé©æ‡‰æ¨™ç±¤ âœ… |
| **æ³¢å‹•ç‡ä¼°è¨ˆ** | ç°¡å–® std/mean | EWMA / Yang-Zhang / GARCH âœ… |
| **æ¨£æœ¬æ¬Šé‡** | ç„¡ | æ”¶ç›ŠåŠ æ¬Š + æ™‚é–“è¡°æ¸› + é¡åˆ¥å¹³è¡¡ âœ… |
| **éœ‡ç›ªçµ±è¨ˆ** | ç„¡ | å®Œæ•´éœ‡ç›ªåˆ†å¸ƒå ±å‘Š âœ… **ï¼ˆNEWï¼‰** |
| **è¼¸å‡ºæ ¼å¼** | (X, y) | (X, y, weights, metadata) âœ… |

---

## ğŸ“¦ è¼¸å…¥èˆ‡è¼¸å‡º

### è¼¸å…¥

**åŸå§‹æ•¸æ“šæ ¼å¼**ï¼šå°è‚¡é€ç­†äº¤æ˜“æ•¸æ“šï¼ˆ.txt æ–‡ä»¶ï¼‰

```
æ•¸æ“šç›®éŒ„çµæ§‹ï¼š
data/temp/
â”œâ”€â”€ 20241001_stock_data.txt
â”œâ”€â”€ 20241002_stock_data.txt
â”œâ”€â”€ ...
â””â”€â”€ 20241050_stock_data.txt
```

**æ•¸æ“šæ¬„ä½è¦æ±‚**ï¼ˆ34 æ¬„ï¼Œ|| åˆ†éš”ï¼‰ï¼š
- ç´¢å¼• 1: è‚¡ç¥¨ä»£ç¢¼ï¼ˆSymbolï¼‰
- ç´¢å¼• 3-5: åƒè€ƒåƒ¹ã€æ¼²åœåƒ¹ã€è·Œåœåƒ¹
- ç´¢å¼• 9-11: æœ€å¾Œæˆäº¤åƒ¹ã€æœ€å¾Œæˆäº¤é‡ã€ç¸½æˆäº¤é‡
- ç´¢å¼• 12-21: äº”æª”è²·åƒ¹ã€è²·é‡
- ç´¢å¼• 22-31: äº”æª”è³£åƒ¹ã€è³£é‡
- ç´¢å¼• 32: æ™‚é–“ï¼ˆHHMMSSï¼‰
- ç´¢å¼• 33: è©¦æ’®æ¨™è¨˜ï¼ˆIsTrialMatchï¼‰

### è¼¸å‡º

**æ¨™æº–è¼¸å‡ºçµæ§‹**ï¼š

```
data/processed_v5/
â”œâ”€â”€ npz/                                    # è¨“ç·´æ•¸æ“š
â”‚   â”œâ”€â”€ stock_embedding_train.npz          # è¨“ç·´é›†ï¼ˆ70%ï¼‰
â”‚   â”œâ”€â”€ stock_embedding_val.npz            # é©—è­‰é›†ï¼ˆ15%ï¼‰
â”‚   â”œâ”€â”€ stock_embedding_test.npz           # æ¸¬è©¦é›†ï¼ˆ15%ï¼‰
â”‚   â””â”€â”€ normalization_meta.json            # å…ƒæ•¸æ“š
â”œâ”€â”€ volatility_stats.csv                   # éœ‡ç›ªçµ±è¨ˆï¼ˆå®Œæ•´æ•¸æ“šï¼‰â­ NEW
â””â”€â”€ volatility_summary.json                # éœ‡ç›ªçµ±è¨ˆï¼ˆæ‘˜è¦ï¼‰â­ NEW
```

**NPZ æª”æ¡ˆå…§å®¹**ï¼š

```python
import numpy as np

data = np.load('stock_embedding_train.npz')
X = data['X']           # (N, 100, 20) - LOB ç‰¹å¾µåºåˆ—
y = data['y']           # (N,) - æ¨™ç±¤ {0: ä¸‹è·Œ, 1: æŒå¹³, 2: ä¸Šæ¼²}
weights = data['weights']    # (N,) - æ¨£æœ¬æ¬Šé‡ï¼ˆNEW in V5ï¼‰
stock_ids = data['stock_ids'] # (N,) - è‚¡ç¥¨ä»£ç¢¼
```

---

## ğŸš€ åŸºæœ¬ä½¿ç”¨

### 1. ç’°å¢ƒæº–å‚™

```bash
# æ¿€æ´»ç’°å¢ƒ
conda activate deeplob-pro

# ç¢ºèªä¾è³´å·²å®‰è£
pip install triple-barrier arch ruamel.yaml pandas scikit-learn numpy
```

### 2. å¿«é€Ÿé–‹å§‹ï¼ˆä½¿ç”¨é è¨­é…ç½®ï¼‰

```bash
python scripts/extract_tw_stock_data_v5.py \
    --input-dir ./data/temp \
    --output-dir ./data/processed_v5 \
    --config configs/config_pro_v5.yaml \
    --make-npz
```

**åƒæ•¸èªªæ˜**ï¼š
- `--input-dir`: åŸå§‹æ•¸æ“šç›®éŒ„ï¼ˆåŒ…å« .txt æ–‡ä»¶ï¼‰
- `--output-dir`: è¼¸å‡ºç›®éŒ„
- `--config`: V5 é…ç½®æ–‡ä»¶è·¯å¾‘
- `--make-npz`: ç”Ÿæˆ NPZ è¨“ç·´æ–‡ä»¶ï¼ˆé»˜èªå•Ÿç”¨ï¼‰

### 3. åŸ·è¡Œæµç¨‹

```
é–‹å§‹åŸ·è¡Œ
  â†“
è¼‰å…¥é…ç½®æ–‡ä»¶ï¼ˆconfig_pro_v5.yamlï¼‰
  â†“
è®€å–åŸå§‹æ•¸æ“šï¼ˆ.txt æ–‡ä»¶ï¼‰
  â†“
æ•¸æ“šæ¸…æ´—ï¼ˆç§»é™¤è©¦æ’®ã€åƒ¹å·®æª¢æŸ¥ã€æ™‚é–“çª—å£éæ¿¾ï¼‰
  â†“
10 äº‹ä»¶èšåˆï¼ˆ10 ç­†å¿«ç…§ â†’ 1 æ™‚é–“é»ï¼‰
  â†“
è¨ˆç®—éœ‡ç›ªçµ±è¨ˆï¼ˆæ¯å€‹ symbol-dayï¼‰â­ NEW
  â†“
æŒ‰è‚¡ç¥¨ä¸²æ¥æ•¸æ“š
  â†“
è¨ˆç®—æ³¢å‹•ç‡ï¼ˆEWMA/GARCHï¼‰
  â†“
ç”Ÿæˆ Triple-Barrier æ¨™ç±¤
  â†“
è¨ˆç®—æ¨£æœ¬æ¬Šé‡
  â†“
ç”¢ç”Ÿæ»‘çª—æ¨£æœ¬ï¼ˆ100 timestepsï¼‰
  â†“
70/15/15 åˆ‡åˆ†ï¼ˆæŒ‰è‚¡ç¥¨æ•¸ï¼‰
  â†“
Z-Score æ¨™æº–åŒ–ï¼ˆåŸºæ–¼è¨“ç·´é›†ï¼‰
  â†“
ä¿å­˜ NPZ æ–‡ä»¶ + Metadata + éœ‡ç›ªçµ±è¨ˆå ±å‘Š â­ NEW
  â†“
å®Œæˆ
```

---

## âš™ï¸ é…ç½®æ–‡ä»¶èªªæ˜

### é…ç½®æ–‡ä»¶ä½ç½®

`configs/config_pro_v5.yaml`

### é—œéµé…ç½®é …

```yaml
# ============================================================
# V5 Pro é…ç½®æ–‡ä»¶
# ============================================================

version: "5.0.0"

# ------------------------------------------------------------
# 1. æ³¢å‹•ç‡ä¼°è¨ˆï¼ˆVolatility Estimationï¼‰
# ------------------------------------------------------------
volatility:
  method: "ewma"        # å¯é¸: "ewma", "garch"
  halflife: 60          # EWMA åŠè¡°æœŸï¼ˆåƒ…ç•¶ method=ewma æ™‚ä½¿ç”¨ï¼‰

# ------------------------------------------------------------
# 2. Triple-Barrier æ¨™ç±¤ï¼ˆLabelingï¼‰
# ------------------------------------------------------------
triple_barrier:
  pt_multiplier: 2.0    # æ­¢ç›ˆå€æ•¸ï¼ˆprofit-takingï¼‰
  sl_multiplier: 2.0    # æ­¢æå€æ•¸ï¼ˆstop-lossï¼‰
  max_holding: 200      # æœ€å¤§æŒæœ‰æœŸï¼ˆbarsï¼‰
  min_return: 0.0001    # æœ€å°å ±é…¬é–¾å€¼ï¼ˆ0.01%ï¼‰

# ------------------------------------------------------------
# 3. æ¨£æœ¬æ¬Šé‡ï¼ˆSample Weightingï¼‰
# ------------------------------------------------------------
sample_weights:
  enabled: true         # æ˜¯å¦å•Ÿç”¨æ¨£æœ¬æ¬Šé‡
  tau: 100.0           # æ™‚é–“è¡°æ¸›åƒæ•¸
  return_scaling: 10.0 # æ”¶ç›Šç¸®æ”¾ä¿‚æ•¸
  balance_classes: true # æ˜¯å¦å•Ÿç”¨é¡åˆ¥å¹³è¡¡

# ------------------------------------------------------------
# 4. æ•¸æ“šåˆ‡åˆ†ï¼ˆTrain/Val/Test Splitï¼‰
# ------------------------------------------------------------
split:
  train_ratio: 0.70    # è¨“ç·´é›†æ¯”ä¾‹
  val_ratio: 0.15      # é©—è­‰é›†æ¯”ä¾‹
  test_ratio: 0.15     # æ¸¬è©¦é›†æ¯”ä¾‹
  seed: 42             # éš¨æ©Ÿç¨®å­ï¼ˆç¢ºä¿å¯é‡ç¾ï¼‰

# ------------------------------------------------------------
# 5. éœ‡ç›ªç¯©é¸ï¼ˆIntraday Volatility Filterï¼‰â­ å¾…å¯¦ä½œ
# ------------------------------------------------------------
# intraday_volatility_filter:
#   enabled: false      # æ˜¯å¦å•Ÿç”¨éœ‡ç›ªç¯©é¸
#   min_range_pct: 0.02 # æœ€å°éœ‡ç›ªå¹…åº¦ï¼ˆ2%ï¼‰
```

### é…ç½®åƒæ•¸è©³è§£

#### æ³¢å‹•ç‡ä¼°è¨ˆæ–¹æ³•

| æ–¹æ³• | å„ªé» | ç¼ºé» | å»ºè­°å ´æ™¯ |
|------|------|------|---------|
| **ewma** | å¿«é€Ÿã€ç©©å®šã€è¼•é‡ | ç²¾åº¦ç•¥ä½ | æ—¥å¸¸ä½¿ç”¨ã€å¿«é€Ÿå¯¦é©— â­ |
| **garch** | å°ˆæ¥­ã€ç²¾ç¢º | è¨ˆç®—æ…¢ã€å¯èƒ½å¤±æ•— | æœ€çµ‚è¨“ç·´ã€ç ”ç©¶ç”¨é€” |

#### Triple-Barrier åƒæ•¸èª¿å„ª

| åƒæ•¸ | é è¨­å€¼ | å»ºè­°ç¯„åœ | èªªæ˜ |
|------|--------|---------|------|
| **pt_multiplier** | 2.0 | 1.5 ~ 3.0 | è¶Šå¤§è¶Šä¿å®ˆï¼ˆéœ€æ›´å¤§æ³¢å‹•æ‰æ¨™è¨˜ï¼‰ |
| **sl_multiplier** | 2.0 | 1.5 ~ 3.0 | è¶Šå¤§è¶Šå¯¬é¬†ï¼ˆå…è¨±æ›´å¤§è™§æï¼‰ |
| **max_holding** | 200 | 100 ~ 300 | é«˜é »äº¤æ˜“å»ºè­° 100-150 |
| **min_return** | 0.0001 | 0.0001 ~ 0.001 | éæ¿¾å¾®å°æ³¢å‹• |

#### æ¨£æœ¬æ¬Šé‡ç­–ç•¥

**æ¬Šé‡è¨ˆç®—å…¬å¼**ï¼š
```
weight = |return| Ã— scale Ã— exp(-tt / tau) Ã— class_weight
```

- `|return|`: çµ•å°å ±é…¬ï¼ˆçå‹µå¤§æ³¢å‹•æ¨£æœ¬ï¼‰
- `scale`: ç¸®æ”¾ä¿‚æ•¸ï¼ˆé¿å…æ¬Šé‡éå°ï¼‰
- `exp(-tt / tau)`: æ™‚é–“è¡°æ¸›ï¼ˆçå‹µå¿«é€Ÿè§¸ç™¼ï¼‰
- `class_weight`: é¡åˆ¥å¹³è¡¡ï¼ˆè™•ç†é¡åˆ¥ä¸å¹³è¡¡ï¼‰

---

## ğŸ“Š æ–°åŠŸèƒ½ï¼šéœ‡ç›ªçµ±è¨ˆå ±å‘Šï¼ˆV5.0 æ–°å¢ï¼‰

### åŠŸèƒ½èªªæ˜

è‡ªå‹•è¨ˆç®—æ¯å€‹ **symbol-day** çš„éœ‡ç›ªå¹…åº¦ï¼Œç”Ÿæˆè©³ç´°å ±å‘Šï¼Œç”¨æ–¼ï¼š
- äº†è§£æ•¸æ“šæ³¢å‹•ç‰¹æ€§
- æ±ºå®šæ˜¯å¦éœ€è¦ç¯©é¸ä½æ³¢å‹•è‚¡ç¥¨
- å„ªåŒ– Triple-Barrier åƒæ•¸

### è¼¸å‡ºæª”æ¡ˆ

#### 1. volatility_stats.csvï¼ˆå®Œæ•´æ•¸æ“šï¼‰

**ç¯„ä¾‹å…§å®¹**ï¼š

| date | symbol | range_pct | return_pct | high | low | open | close | n_points |
|------|--------|-----------|------------|------|-----|------|-------|----------|
| 20241018 | 2454 | 0.0345 | 0.0123 | 102.5 | 99.0 | 100.0 | 101.23 | 245 |
| 20241018 | 1216 | 0.0082 | -0.0015 | 50.5 | 50.1 | 50.3 | 50.22 | 187 |

**æ¬„ä½èªªæ˜**ï¼š
- `range_pct`: éœ‡ç›ªå¹…åº¦ï¼ˆ(æœ€é«˜-æœ€ä½)/é–‹ç›¤ï¼‰â­
- `return_pct`: æ¼²è·Œå¹…ï¼ˆ(æ”¶ç›¤-é–‹ç›¤)/é–‹ç›¤ï¼‰
- `n_points`: æ•¸æ“šé»æ•¸

#### 2. volatility_summary.jsonï¼ˆçµ±è¨ˆæ‘˜è¦ï¼‰

**ç¯„ä¾‹å…§å®¹**ï¼š

```json
{
  "total_samples": 9750,
  "n_stocks": 195,
  "n_dates": 50,
  "range_pct": {
    "mean": 2.34,
    "median": 2.10,
    "percentiles": {
      "P50": 2.10,
      "P75": 3.12,
      "P90": 4.25
    }
  },
  "threshold_stats": [
    {"threshold_pct": 1.0, "count": 7800, "percentage": 80.0},
    {"threshold_pct": 2.0, "count": 3900, "percentage": 40.0}
  ]
}
```

#### 3. æ§åˆ¶å°å ±å‘Šï¼ˆè‡ªå‹•é¡¯ç¤ºï¼‰

åŸ·è¡Œæ™‚æœƒè‡ªå‹•è¼¸å‡ºï¼š

```
============================================================
ğŸ“Š éœ‡ç›ªå¹…åº¦çµ±è¨ˆå ±å‘Šï¼ˆIntraday Range Analysisï¼‰
============================================================
ç¸½æ¨£æœ¬æ•¸: 9,750 å€‹ symbol-day çµ„åˆ
è‚¡ç¥¨æ•¸: 195 æª”
äº¤æ˜“æ—¥æ•¸: 50 å¤©

éœ‡ç›ªå¹…åº¦ (Range %) åˆ†å¸ƒ:
  å¹³å‡å€¼: 2.34%
  ä¸­ä½æ•¸: 2.10%

é–¾å€¼ç¯©é¸çµ±è¨ˆï¼ˆéœ‡ç›ª â‰¥ X% çš„æ¨£æœ¬æ•¸ï¼‰:
  é–¾å€¼ | æ¨£æœ¬æ•¸ |  ä½”æ¯”
------+--------+------
  1.0% |  7,800 | 80.0%
  2.0% |  3,900 | 40.0%  â† å»ºè­°é–¾å€¼
  3.0% |  1,463 | 15.0%
============================================================
```

---

## ğŸ”§ é€²éšä½¿ç”¨

### ä½¿ç”¨æ¡ˆä¾‹ 1ï¼šæ›´æ”¹æ³¢å‹•ç‡æ–¹æ³•ç‚º GARCH

**æ­¥é©Ÿ 1**ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶

```yaml
volatility:
  method: "garch"  # æ”¹ç‚º GARCH
```

**æ­¥é©Ÿ 2**ï¼šåŸ·è¡Œ

```bash
python scripts/extract_tw_stock_data_v5.py \
    --config configs/config_pro_v5_garch.yaml \
    --output-dir ./data/processed_v5_garch
```

### ä½¿ç”¨æ¡ˆä¾‹ 2ï¼šèª¿æ•´ Triple-Barrier åƒæ•¸ï¼ˆæ›´ä¿å®ˆï¼‰

**æ­¥é©Ÿ 1**ï¼šå‰µå»ºæ–°é…ç½®æ–‡ä»¶ `config_pro_v5_conservative.yaml`

```yaml
triple_barrier:
  pt_multiplier: 3.0    # æ›´å¤§çš„æ­¢ç›ˆå€æ•¸ï¼ˆæ›´ä¿å®ˆï¼‰
  sl_multiplier: 3.0    # æ›´å¤§çš„æ­¢æå€æ•¸ï¼ˆæ›´å¯¬é¬†ï¼‰
  max_holding: 150      # æ›´çŸ­çš„æŒæœ‰æœŸï¼ˆé«˜é »äº¤æ˜“ï¼‰
  min_return: 0.0005    # æ›´å¤§çš„æœ€å°å ±é…¬é–¾å€¼
```

**æ­¥é©Ÿ 2**ï¼šåŸ·è¡Œ

```bash
python scripts/extract_tw_stock_data_v5.py \
    --config configs/config_pro_v5_conservative.yaml \
    --output-dir ./data/processed_v5_conservative
```

### ä½¿ç”¨æ¡ˆä¾‹ 3ï¼šç¦ç”¨æ¨£æœ¬æ¬Šé‡

```yaml
sample_weights:
  enabled: false  # ç¦ç”¨æ¬Šé‡ï¼ˆæ‰€æœ‰æ¨£æœ¬æ¬Šé‡ç‚º 1ï¼‰
```

### ä½¿ç”¨æ¡ˆä¾‹ 4ï¼šåªç”¢ç”Ÿéœ‡ç›ªçµ±è¨ˆï¼ˆä¸ç”Ÿæˆè¨“ç·´æ•¸æ“šï¼‰â­ NEW

**ç›®çš„**ï¼šå¿«é€Ÿåˆ†ææ•¸æ“šæ³¢å‹•ç‰¹æ€§ï¼Œä¸éœ€ç­‰å¾…å®Œæ•´è¨“ç·´æ•¸æ“šç”Ÿæˆ

**æ–¹æ³• Aï¼šä½¿ç”¨ä¸»ç¨‹å¼ + --stats-only åƒæ•¸**

```bash
python scripts/extract_tw_stock_data_v5.py \
    --input-dir ./data/temp \
    --output-dir ./data/volatility_only \
    --config configs/config_pro_v5.yaml \
    --stats-only
```

**æ–¹æ³• Bï¼šä½¿ç”¨å¿«é€Ÿçµ±è¨ˆå·¥å…·**ï¼ˆæ¨è–¦ï¼‰

```bash
python scripts/quick_stats_only.py \
    --input-dir ./data/temp \
    --output-dir ./data/volatility_stats
```

**æ–¹æ³• Cï¼šWindows æ‰¹æ¬¡è…³æœ¬**ï¼ˆæœ€ç°¡å–®ï¼‰

```bash
# é›™æ“ŠåŸ·è¡Œï¼Œæˆ–åœ¨å‘½ä»¤åˆ—åŸ·è¡Œï¼š
quick_stats.bat
```

**å„ªé»**ï¼š
- âš¡ **é€Ÿåº¦å¿«**ï¼šåªéœ€ 5-10% çš„æ™‚é–“ï¼ˆç›¸æ¯”å®Œæ•´æµç¨‹ï¼‰
  - å®Œæ•´æµç¨‹ï¼š30-60 åˆ†é˜
  - å¿«é€Ÿæ¨¡å¼ï¼š3-5 åˆ†é˜
- ğŸ’¾ **ç¯€çœç©ºé–“**ï¼šä¸ç”Ÿæˆå¤§å‹ NPZ æª”æ¡ˆï¼ˆå¯ç¯€çœæ•¸ GB ç©ºé–“ï¼‰
- ğŸ“Š **å®Œæ•´å ±å‘Š**ï¼šä»ç„¶ç”¢ç”Ÿ CSV + JSON + æ§åˆ¶å°å ±å‘Š

**è¼¸å‡ºæª”æ¡ˆ**ï¼š

```
data/volatility_stats/
â”œâ”€â”€ volatility_stats.csv      # å®Œæ•´éœ‡ç›ªæ•¸æ“š
â””â”€â”€ volatility_summary.json   # çµ±è¨ˆæ‘˜è¦
```

**åŸ·è¡Œçµæœç¯„ä¾‹**ï¼š

```
============================================================
âš¡ å¿«é€Ÿæ¨¡å¼ï¼šå·²å®Œæˆéœ‡ç›ªçµ±è¨ˆï¼Œè·³éè¨“ç·´æ•¸æ“šç”Ÿæˆ
============================================================
å¦‚éœ€ç”Ÿæˆè¨“ç·´æ•¸æ“šï¼Œè«‹ç§»é™¤ --stats-only åƒæ•¸
============================================================

============================================================
ğŸ“Š éœ‡ç›ªå¹…åº¦çµ±è¨ˆå ±å‘Šï¼ˆIntraday Range Analysisï¼‰
============================================================
ç¸½æ¨£æœ¬æ•¸: 9,750 å€‹ symbol-day çµ„åˆ
è‚¡ç¥¨æ•¸: 195 æª”

é–¾å€¼ç¯©é¸çµ±è¨ˆï¼ˆéœ‡ç›ª â‰¥ X% çš„æ¨£æœ¬æ•¸ï¼‰:
  é–¾å€¼ | æ¨£æœ¬æ•¸ |  ä½”æ¯”
------+--------+------
  2.0% |  3,900 | 40.0%  â† å»ºè­°é–¾å€¼
============================================================

============================================================
[å®Œæˆ] éœ‡ç›ªçµ±è¨ˆæˆåŠŸï¼Œè¼¸å‡ºè³‡æ–™å¤¾: ./data/volatility_stats
============================================================
çµ±è¨ˆè³‡æ–™:
  åŸå§‹äº‹ä»¶æ•¸: 125,487,352
  æ¸…æ´—å¾Œ: 98,234,521
  èšåˆå¾Œæ™‚é–“é»: 9,823,452
  éœ‡ç›ªçµ±è¨ˆæ¨£æœ¬: 9,750
============================================================
```

**ä½¿ç”¨å ´æ™¯**ï¼š
1. **åˆæ­¥æ•¸æ“šæ¢ç´¢**ï¼šå¿«é€Ÿäº†è§£æ•¸æ“šæ³¢å‹•ç‰¹æ€§
2. **æ±ºç­–ç¯©é¸é–¾å€¼**ï¼šæ ¹æ“šçµ±è¨ˆæ±ºå®šæ˜¯å¦éœ€è¦ç¯©é¸
3. **æ•¸æ“šå“è³ªé©—è­‰**ï¼šç¢ºèªæ•¸æ“šæºæ˜¯å¦ç¬¦åˆé æœŸ
4. **å¿«é€Ÿå¯¦é©—**ï¼šæ¸¬è©¦ä¸åŒæ•¸æ“šæºæˆ–æ™‚é–“ç¯„åœ

---

## ğŸ“ˆ è¼¸å‡ºæ•¸æ“šçµ±è¨ˆè³‡è¨Š

### åŸ·è¡Œå®Œæˆå¾Œçš„çµ±è¨ˆå ±å‘Š

```
============================================================
[å®Œæˆ] V5 è½‰æ›æˆåŠŸï¼Œè¼¸å‡ºè³‡æ–™å¤¾: ./data/processed_v5
============================================================
çµ±è¨ˆè³‡æ–™:
  åŸå§‹äº‹ä»¶æ•¸: 125,487,352
  æ¸…æ´—å¾Œ: 98,234,521
  èšåˆå¾Œæ™‚é–“é»: 9,823,452
  æœ‰æ•ˆçª—å£: 7,549,123
  Triple-Barrier æˆåŠŸ: 195
  éœ‡ç›ªçµ±è¨ˆæ¨£æœ¬: 9,750 â­ NEW
============================================================
```

### Metadata æª”æ¡ˆå…§å®¹

`normalization_meta.json` åŒ…å«å®Œæ•´çš„è™•ç†è³‡è¨Šï¼š

```json
{
  "format": "deeplob_v5_pro",
  "version": "5.0.0",
  "creation_date": "2025-10-19T14:30:00",
  "seq_len": 100,
  "feature_dim": 20,

  "volatility": {
    "method": "ewma",
    "halflife": 60
  },

  "triple_barrier": {
    "pt_multiplier": 2.0,
    "sl_multiplier": 2.0,
    "max_holding": 200,
    "min_return": 0.0001
  },

  "data_split": {
    "train_stocks": 136,
    "val_stocks": 29,
    "test_stocks": 30,
    "results": {
      "train": {
        "samples": 5584553,
        "label_dist": [397396, 506030, 345993]
      }
    }
  }
}
```

---

## âš ï¸ å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### Q1: åŸ·è¡Œæ™‚å‡ºç¾ `FileNotFoundError: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨`

**åŸå› **ï¼šé…ç½®æ–‡ä»¶è·¯å¾‘éŒ¯èª¤

**è§£æ±º**ï¼š
```bash
# ç¢ºèªé…ç½®æ–‡ä»¶å­˜åœ¨
ls configs/config_pro_v5.yaml

# ä½¿ç”¨çµ•å°è·¯å¾‘
python scripts/extract_tw_stock_data_v5.py \
    --config "D:/Case-New/python/DeepLOB-Pro/configs/config_pro_v5.yaml"
```

### Q2: GARCH æ³¢å‹•ç‡è¨ˆç®—å¤±æ•—

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
GARCH å¤±æ•—: ..., å›é€€åˆ° EWMA
```

**åŸå› **ï¼šæ•¸æ“šé»ä¸è¶³æˆ–æ•¸æ“šç•°å¸¸

**è§£æ±º**ï¼š
1. æª¢æŸ¥æ•¸æ“šå“è³ªï¼ˆæ˜¯å¦æœ‰è¶³å¤ çš„æ™‚é–“é»ï¼‰
2. æ”¹ç”¨ EWMA æ–¹æ³•
3. å¢åŠ æ•¸æ“šé‡ï¼ˆä½¿ç”¨æ›´å¤šäº¤æ˜“æ—¥ï¼‰

### Q3: æ¨£æœ¬æ•¸é‡å¤ªå°‘

**ç¾è±¡**ï¼šè¨“ç·´é›†æ¨£æœ¬æ•¸ < 100 è¬

**å¯èƒ½åŸå› **ï¼š
- åŸå§‹æ•¸æ“šå¤ªå°‘
- Triple-Barrier åƒæ•¸éæ–¼åš´æ ¼
- è‚¡ç¥¨åºåˆ—å¤ªçŸ­è¢«éæ¿¾

**è§£æ±º**ï¼š
1. å¢åŠ åŸå§‹æ•¸æ“šï¼ˆæ›´å¤šäº¤æ˜“æ—¥ï¼‰
2. é™ä½ `min_return` é–¾å€¼
3. æ¸›å°‘ `pt_multiplier` å’Œ `sl_multiplier`
4. æª¢æŸ¥ `MIN_POINTS` è¨­å®šï¼ˆé è¨­ 150ï¼‰

### Q4: é¡åˆ¥åš´é‡ä¸å¹³è¡¡

**ç¾è±¡**ï¼š
```
æ¨™ç±¤åˆ†å¸ƒ: ä¸Šæ¼²=100,000, æŒå¹³=800,000, ä¸‹è·Œ=50,000
```

**è§£æ±º**ï¼š
1. å•Ÿç”¨æ¨£æœ¬æ¬Šé‡ï¼ˆ`sample_weights.enabled: true`ï¼‰
2. èª¿æ•´ Triple-Barrier åƒæ•¸
3. å¢åŠ  `min_return` é–¾å€¼ï¼ˆæ¸›å°‘æŒå¹³æ¨£æœ¬ï¼‰

### Q5: åŸ·è¡Œé€Ÿåº¦å¤ªæ…¢

**å„ªåŒ–æ–¹å‘**ï¼š
1. ä½¿ç”¨ EWMA è€Œé GARCHï¼ˆå¿« 10 å€ï¼‰
2. æ¸›å°‘åŸå§‹æ•¸æ“šé‡ï¼ˆæ¸¬è©¦æ™‚ï¼‰
3. ä½¿ç”¨ SSD å„²å­˜æ•¸æ“š
4. å¢åŠ è¨˜æ†¶é«”ï¼ˆæ¸›å°‘ swapï¼‰

### Q6: éœ‡ç›ªçµ±è¨ˆé¡¯ç¤ºæ‰€æœ‰è‚¡ç¥¨æ³¢å‹•éƒ½å¾ˆä½ï¼ˆ< 1%ï¼‰

**å¯èƒ½åŸå› **ï¼š
- æ•¸æ“šæºå•é¡Œï¼ˆåªåŒ…å«ç©©å®šè‚¡ç¥¨ï¼‰
- æ•¸æ“šæ™‚é–“ç¯„åœå¤ªçŸ­
- ä½¿ç”¨äº†éäº¤æ˜“æ™‚æ®µæ•¸æ“š

**è§£æ±º**ï¼š
1. æª¢æŸ¥æ•¸æ“šæºï¼ˆç¢ºä¿åŒ…å«æ´»èºè‚¡ç¥¨ï¼‰
2. å»¶é•·æ•¸æ“šæ™‚é–“ç¯„åœ
3. ç¢ºèªæ™‚é–“éæ¿¾æ­£ç¢ºï¼ˆ09:00-13:30ï¼‰

---

## ğŸ§ª æ¸¬è©¦èˆ‡é©—è­‰

### 1. å¿«é€Ÿé©—è­‰åŠŸèƒ½

```bash
# ä½¿ç”¨æ¨¡æ“¬æ•¸æ“šæ¸¬è©¦éœ‡ç›ªçµ±è¨ˆåŠŸèƒ½
python scripts/quick_verify_volatility.py
```

**é æœŸè¼¸å‡º**ï¼š
```
ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼
```

### 2. å°è¦æ¨¡æ•¸æ“šæ¸¬è©¦

```bash
# ä½¿ç”¨å°‘é‡æ•¸æ“šæ¸¬è©¦å®Œæ•´æµç¨‹ï¼ˆ5-10 åˆ†é˜ï¼‰
python scripts/extract_tw_stock_data_v5.py \
    --input-dir ./data/temp_sample \
    --output-dir ./data/processed_v5_test
```

### 3. é©—è­‰è¼¸å‡ºæ•¸æ“š

```python
import numpy as np
import json

# è¼‰å…¥è¨“ç·´æ•¸æ“š
data = np.load('data/processed_v5/npz/stock_embedding_train.npz')

print(f"X shape: {data['X'].shape}")        # æ‡‰ç‚º (N, 100, 20)
print(f"y shape: {data['y'].shape}")        # æ‡‰ç‚º (N,)
print(f"weights shape: {data['weights'].shape}")  # æ‡‰ç‚º (N,)
print(f"Label distribution: {np.bincount(data['y'])}")

# è¼‰å…¥ metadata
with open('data/processed_v5/npz/normalization_meta.json', 'r') as f:
    meta = json.load(f)
    print(f"Version: {meta['version']}")
    print(f"Method: {meta['volatility']['method']}")
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

### å°ˆæ¡ˆæ–‡æª”

- [CLAUDE.md](../CLAUDE.md) - å°ˆæ¡ˆç¸½è¦½
- [VOLATILITY_ANALYSIS_GUIDE.md](../VOLATILITY_ANALYSIS_GUIDE.md) - éœ‡ç›ªåˆ†æå®Œæ•´æŒ‡å—
- [QUICK_START_VOLATILITY.md](../QUICK_START_VOLATILITY.md) - éœ‡ç›ªåˆ†æå¿«é€Ÿé–‹å§‹
- [V5_Pro_NoMLFinLab_Guide.md](./V5_Pro_NoMLFinLab_Guide.md) - V5 è¨­è¨ˆæ–‡æª”

### é…ç½®æ–‡ä»¶

- [configs/config_pro_v5.yaml](../configs/config_pro_v5.yaml) - æ¨™æº–é…ç½®

### ç›¸é—œè…³æœ¬

- [scripts/train_deeplob_generic.py](../scripts/train_deeplob_generic.py) - DeepLOB è¨“ç·´è…³æœ¬
- [scripts/quick_verify_volatility.py](../scripts/quick_verify_volatility.py) - åŠŸèƒ½é©—è­‰è…³æœ¬

---

## ğŸ”„ ç‰ˆæœ¬æ­·å²

### v5.0.0 (2025-10-19)

**é‡å¤§æ›´æ–°**ï¼š
- âœ… æ–°å¢éœ‡ç›ªçµ±è¨ˆåŠŸèƒ½
  - `calculate_intraday_volatility()` å‡½æ•¸
  - `generate_volatility_report()` å‡½æ•¸
  - è‡ªå‹•ç”Ÿæˆ CSV + JSON å ±å‘Š
- âœ… Triple-Barrier æ¨™ç±¤ç”Ÿæˆ
- âœ… å°ˆæ¥­æ³¢å‹•ç‡ä¼°è¨ˆï¼ˆEWMA/GARCHï¼‰
- âœ… æ¨£æœ¬æ¬Šé‡è¨ˆç®—

### v4.0.0 (ä¹‹å‰ç‰ˆæœ¬)

- åŸºç¤æ•¸æ“šè™•ç†
- å›ºå®š k æ­¥æ¨™ç±¤
- Z-Score æ¨™æº–åŒ–

---

## ğŸ’¡ æœ€ä½³å¯¦è¸

### 1. æ•¸æ“šè™•ç†æµç¨‹å»ºè­°

```bash
# æ­¥é©Ÿ 1: å¿«é€Ÿæ¸¬è©¦ï¼ˆå°æ•¸æ“šï¼‰
python scripts/extract_tw_stock_data_v5.py \
    --input-dir ./data/temp_sample \
    --output-dir ./data/test

# æ­¥é©Ÿ 2: æŸ¥çœ‹éœ‡ç›ªå ±å‘Šï¼Œæ±ºå®šæ˜¯å¦ç¯©é¸
cat data/test/volatility_summary.json

# æ­¥é©Ÿ 3: èª¿æ•´é…ç½®ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰
# ç·¨è¼¯ configs/config_pro_v5.yaml

# æ­¥é©Ÿ 4: å®Œæ•´è™•ç†
python scripts/extract_tw_stock_data_v5.py \
    --input-dir ./data/temp \
    --output-dir ./data/processed_v5_final
```

### 2. åƒæ•¸èª¿å„ªç­–ç•¥

**ç¬¬ä¸€æ¬¡åŸ·è¡Œ**ï¼šä½¿ç”¨é è¨­åƒæ•¸
```yaml
triple_barrier:
  pt_multiplier: 2.0
  sl_multiplier: 2.0
```

**æ ¹æ“šçµæœèª¿æ•´**ï¼š
- å¦‚æœæŒå¹³æ¨£æœ¬ > 50%ï¼šå¢åŠ  `min_return` æˆ–æ¸›å°‘ `pt/sl_multiplier`
- å¦‚æœæ™‚é–“è§¸ç™¼ > 70%ï¼šæ¸›å°‘ `max_holding` æˆ–å¢åŠ  `pt/sl_multiplier`

### 3. æ•¸æ“šå“è³ªæª¢æŸ¥æ¸…å–®

åŸ·è¡Œå¾Œæª¢æŸ¥ï¼š
- âœ… æ¨£æœ¬æ•¸ > 100 è¬ï¼ˆè¨“ç·´é›†ï¼‰
- âœ… é¡åˆ¥åˆ†å¸ƒç›¸å°å¹³è¡¡ï¼ˆ30% ~ 40% æ¯é¡ï¼‰
- âœ… Triple-Barrier æœ‰æ•ˆè§¸ç™¼ç‡ > 30%
- âœ… éœ‡ç›ªåˆ†å¸ƒåˆç†ï¼ˆå¹³å‡ > 1%ï¼‰

---

## ğŸ“ æŠ€è¡“æ”¯æ´

### å ±å‘Šå•é¡Œ

å¦‚é‡åˆ°å•é¡Œï¼Œè«‹æä¾›ï¼š
1. å®Œæ•´éŒ¯èª¤è¨Šæ¯
2. ä½¿ç”¨çš„é…ç½®æ–‡ä»¶
3. æ•¸æ“šè¦æ¨¡ï¼ˆæª”æ¡ˆæ•¸ã€å¤§å°ï¼‰
4. åŸ·è¡Œç’°å¢ƒï¼ˆPython ç‰ˆæœ¬ã€ä½œæ¥­ç³»çµ±ï¼‰

### åƒè€ƒè³‡æº

- **Triple-Barrier æ¨™ç±¤**ï¼šã€ŠAdvances in Financial Machine Learningã€‹ï¼ˆMarcos LÃ³pez de Pradoï¼‰
- **GARCH æ¨¡å‹**ï¼š`arch` åº«æ–‡æª”
- **DeepLOB è«–æ–‡**ï¼šZhang et al., 2019

---

**æ–‡æª”ç‰ˆæœ¬**ï¼šv1.0
**æœ€å¾Œæ›´æ–°**ï¼š2025-10-19
**ç¶­è­·è€…**ï¼šDeepLOB-Pro Team
