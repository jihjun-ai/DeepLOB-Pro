# DeepLOB 調參歷史

## 格式說明

每次實驗記錄：配置參數 + 5 epoch 結果 + 問題診斷 

每次保留數據及成果(原因及目的),簡要說明(其他廢話不用),這是改下次調參參考用

取資料腳本:

python scripts\extract_tw_stock_data_v6.py 

--preprocessed-dir .\data\preprocessed_v5_1hz 

--output-dir .\data\processed_v6 

--config   .\configs\config_pro_v5_ml_optimal.yaml



## 環境

```bash
conda activate deeplob-pro
數據: data/processed_v6/npz
腳本: scripts/train_deeplob_v5.py
配置: configs/train_v5.yaml
```

---

## 實驗 1: 初始配置（2025-10-22）

### 數據特性

```
訓練樣本: 7,564,697
標籤分布: Down 45.7% | Neutral 15.0% | Up 39.4%
不平衡比: 3.05x (Down/Neutral)
問題: Neutral 嚴重不足（目標 40%，實際 15%）
```

### 配置參數（train_v5.yaml）

```yaml
dataloader:
  batch_size: 512
  balance_sampler.enabled: false  # 🚨 關鍵問題

model:
  lstm_hidden_size: 32
  fc_hidden_size: 32
  dropout: 0.5

optim:
  lr: 0.00005
  weight_decay: 0.0005
  grad_clip: 0.5

train:
  epochs: 40
  early_stop.patience: 8
```

### 訓練結果（前 5 epoch）

| Epoch | Train Loss | Val Loss   | Train Acc | Val Acc | Val F1(W) | Grad     |
| ----- | ---------- | ---------- | --------- | ------- | --------- | -------- |
| 1     | 0.5945     | 0.6045     | 44.20%    | 43.30%  | 0.3612    | 0.72     |
| 2     | 0.5554     | 0.6025     | 47.52%    | 43.35%  | 0.3682    | 2.11     |
| 3     | 0.4979     | 0.6695     | 53.86%    | 44.82%  | 0.3960    | 5.45     |
| 4     | 0.4348     | 0.7580     | 60.80%    | 45.76%  | 0.4033    | 7.35     |
| 5     | 0.3745     | **0.8523** | 67.15%    | 46.71%  | 0.4035    | **7.96** |

### 問題診斷

```
🚨 嚴重過擬合
- Val Loss 爆炸: 0.6045 → 0.8523 (+41%)
- Train/Val Acc 差距: 0.9% → 20.44%
- 梯度持續增大: 0.72 → 7.96 (grad_clip 未生效)
- Val F1 過低: 0.4035 (目標 > 0.6)

根本原因:
1. 數據不平衡 (Neutral 15% vs 目標 40%)
2. 未啟用平衡採樣器
3. 學習率過小 (0.00005)
4. 梯度裁剪未生效
```

### 下次調整方向

```
方案 A (快速): 調整訓練配置
  - balance_sampler.enabled: true
  - batch_size: 512 → 256
  - lr: 0.00005 → 0.0001
  - dropout: 0.5 → 0.6
  - grad_clip: 0.5 → 1.0

方案 B (根本): 重新生成數據
  - TB pt_multiplier: 3.5 → 2.5 (更多 up/down)
  - TB min_return: 0.0015 → 0.0025 (更多 neutral)
  - 目標分布: 30/40/30

方案 C (推薦): A + B 組合
```

---

## 實驗 2: [待填寫]

### 配置參數

```yaml
[下次實驗的配置]
```

### 訓練結果

```
[下次實驗的結果]
```

### 問題診斷

```
[下次實驗的問題]
```

### 下次調整

```
[下次實驗的調整方向]
```

---
