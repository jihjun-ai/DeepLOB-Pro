# extract_tw_stock_data_v6.py æŠ€è¡“åˆ†æèˆ‡æ”¹é€²æ–¹æ¡ˆ

**ç‰ˆæœ¬**: v1.0
**åˆ†ææ—¥æœŸ**: 2025-10-23
**ç›®æ¨™**: åˆ†æç•¶å‰ v6 è…³æœ¬ä¸¦æå‡ºå„ªåŒ–æ–¹æ¡ˆï¼ˆåˆ©ç”¨é è™•ç†æ•¸æ“šä¸­å·²æœ‰çš„è³‡æ–™ï¼‰

---

## ğŸ“‹ ç›®éŒ„

1. [ç•¶å‰æ¶æ§‹åˆ†æ](#ç•¶å‰æ¶æ§‹åˆ†æ)
2. [é è™•ç†æ•¸æ“šå…§å®¹åˆ†æ](#é è™•ç†æ•¸æ“šå…§å®¹åˆ†æ)
3. [é‡è¤‡è¨ˆç®—è­˜åˆ¥](#é‡è¤‡è¨ˆç®—è­˜åˆ¥)
4. [æ”¹é€²æ–¹æ¡ˆè¨­è¨ˆ](#æ”¹é€²æ–¹æ¡ˆè¨­è¨ˆ)
5. [å¯¦æ–½è¨ˆåŠƒ](#å¯¦æ–½è¨ˆåŠƒ)

---

## ç•¶å‰æ¶æ§‹åˆ†æ

### 1. è…³æœ¬æ¦‚è¿°

**æ–‡ä»¶**: `scripts/extract_tw_stock_data_v6.py`
**ç‰ˆæœ¬**: v6.0.0
**åŠŸèƒ½**: å¾é è™•ç† NPZ ç”Ÿæˆè¨“ç·´æ•¸æ“š
**è¡Œæ•¸**: 1181 è¡Œ

### 2. æ ¸å¿ƒæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¼¸å…¥: é è™•ç† NPZ (preprocess_single_day.py è¼¸å‡º)           â”‚
â”‚  â”œâ”€ features (T, 20) - LOB ç‰¹å¾µï¼ˆå·²æ¸…æ´—ã€å·²èšåˆï¼‰           â”‚
â”‚  â”œâ”€ mids (T,) - ä¸­é–“åƒ¹                                      â”‚
â”‚  â”œâ”€ bucket_mask (T,) - æ•¸æ“šè³ªé‡é®ç½©                         â”‚
â”‚  â”œâ”€ metadata - å…ƒæ•¸æ“šï¼ˆå« label_previewï¼‰                   â”‚
â”‚  â””â”€ labels (T,) - æ¨™ç±¤é™£åˆ—ã€é è™•ç†å·²è¨ˆç®—ã€‘ğŸ†•               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: è¼‰å…¥é è™•ç†æ•¸æ“š                                      â”‚
â”‚  â””â”€ load_preprocessed_npz()                                 â”‚
â”‚     â””â”€ validate_preprocessed_data()                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: Z-Score æ¨™æº–åŒ–                                      â”‚
â”‚  â”œâ”€ zscore_fit() - è¨ˆç®—è¨“ç·´é›†çµ±è¨ˆé‡                          â”‚
â”‚  â””â”€ zscore_apply() - æ‡‰ç”¨æ¨™æº–åŒ–                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: æ³¢å‹•ç‡è¨ˆç®— ã€é‡è¤‡è¨ˆç®—ã€‘âš ï¸                           â”‚
â”‚  â””â”€ ewma_vol() - EWMA æ³¢å‹•ç‡ä¼°è¨ˆ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: æ¨™ç±¤ç”Ÿæˆ ã€é‡è¤‡è¨ˆç®—ã€‘âš ï¸                             â”‚
â”‚  â”œâ”€ tb_labels() - Triple-Barrier æ¨™ç±¤                       â”‚
â”‚  â””â”€ trend_labels() - è¶¨å‹¢æ¨™ç±¤                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: æ¨£æœ¬æ¬Šé‡è¨ˆç®— ã€éƒ¨åˆ†é‡è¤‡ã€‘âš ï¸                         â”‚
â”‚  â””â”€ make_sample_weight()                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 6: æ»‘çª—ç”Ÿæˆ                                            â”‚
â”‚  â””â”€ ç”Ÿæˆ (N, 100, 20) æ™‚é–“åºåˆ—çª—å£                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¼¸å‡º: è¨“ç·´ NPZ                                              â”‚
â”‚  â”œâ”€ stock_embedding_train.npz                               â”‚
â”‚  â”œâ”€ stock_embedding_val.npz                                 â”‚
â”‚  â”œâ”€ stock_embedding_test.npz                                â”‚
â”‚  â””â”€ normalization_meta.json                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. é—œéµå‡½æ•¸åˆ†æ

#### 3.1 æ•¸æ“šè¼‰å…¥ï¼ˆç„¡é‡è¤‡ï¼‰âœ…

```python
def load_preprocessed_npz(npz_path: str) -> Optional[Tuple]:
    """
    è¼‰å…¥é è™•ç† NPZ

    è¿”å›:
        (features, mids, bucket_mask, metadata)

    ç‹€æ…‹: âœ… ç„¡é‡è¤‡è¨ˆç®—ï¼Œé«˜æ•ˆ
    """
```

#### 3.2 Z-Score æ¨™æº–åŒ–ï¼ˆç„¡é‡è¤‡ï¼‰âœ…

```python
def zscore_fit(X: np.ndarray, method='global') -> Tuple[np.ndarray, np.ndarray]:
    """
    è¨ˆç®— Z-Score åƒæ•¸

    ç‹€æ…‹: âœ… å¿…é ˆåœ¨æ­¤éšæ®µè¨ˆç®—ï¼ˆé è™•ç†æœªæ¨™æº–åŒ–ï¼‰
    åŸå› : æ¨™æº–åŒ–éœ€è¦åŸºæ–¼è¨“ç·´é›†çµ±è¨ˆé‡
    """

def zscore_apply(X: np.ndarray, mu, sd, method='global') -> np.ndarray:
    """
    æ‡‰ç”¨ Z-Score

    ç‹€æ…‹: âœ… å¿…é ˆåœ¨æ­¤éšæ®µæ‡‰ç”¨
    """
```

#### 3.3 æ³¢å‹•ç‡è¨ˆç®—ï¼ˆé‡è¤‡è¨ˆç®—ï¼‰âš ï¸

```python
def ewma_vol(close: pd.Series, halflife=60) -> pd.Series:
    """
    EWMA æ³¢å‹•ç‡ä¼°è¨ˆ

    ç‹€æ…‹: âš ï¸ é‡è¤‡è¨ˆç®—ï¼

    å•é¡Œ:
        1. é è™•ç†éšæ®µå·²è¨ˆç®—æ³¢å‹•ç‡ï¼ˆç”¨æ–¼ label_previewï¼‰
        2. æ­¤è™•é‡æ–°è¨ˆç®—ç›¸åŒçš„æ³¢å‹•ç‡
        3. è¨ˆç®—æˆæœ¬: O(T) æ¯å€‹è‚¡ç¥¨æ¯å¤©

    å½±éŸ¿:
        - æ¯æ¬¡é‹è¡Œéœ€è¦é‡æ–°è¨ˆç®—æ‰€æœ‰è‚¡ç¥¨çš„æ³¢å‹•ç‡
        - ç´„ä½”ç¸½æ™‚é–“çš„ 10-15%
    """
```

**ä»£ç¢¼ä½ç½®**: ç¬¬ 90-139 è¡Œ

**èª¿ç”¨ä½ç½®**: ç¬¬ 776 è¡Œï¼ˆsliding_windows_v6 å‡½æ•¸å…§ï¼‰

```python
# ç¬¬ 776 è¡Œ
vol = ewma_vol(close, halflife=config['volatility']['halflife'])
```

#### 3.4 æ¨™ç±¤ç”Ÿæˆï¼ˆé‡è¤‡è¨ˆç®—ï¼‰âš ï¸âš ï¸âš ï¸

```python
def tb_labels(close, vol, pt_mult=2.0, sl_mult=2.0, ...) -> pd.DataFrame:
    """
    Triple-Barrier æ¨™ç±¤ç”Ÿæˆ

    ç‹€æ…‹: âš ï¸âš ï¸âš ï¸ åš´é‡é‡è¤‡è¨ˆç®—ï¼

    å•é¡Œ:
        1. é è™•ç†éšæ®µå·²è¨ˆç®— Triple-Barrier æ¨™ç±¤
        2. labels æ¬„ä½å·²å­˜åœ¨æ–¼ NPZ ä¸­ï¼ˆv2.0+ï¼‰
        3. metadata.label_preview å·²æœ‰æ¨™ç±¤çµ±è¨ˆ
        4. æ­¤è™•å®Œå…¨é‡æ–°è¨ˆç®—
        5. è¨ˆç®—æˆæœ¬: O(T * max_holding) æ¯å€‹è‚¡ç¥¨æ¯å¤©

    å½±éŸ¿:
        - é€™æ˜¯æœ€è€—æ™‚çš„æ­¥é©Ÿï¼
        - ç´„ä½”ç¸½æ™‚é–“çš„ 50-70%
        - å®Œå…¨å¯ä»¥é¿å…ï¼
    """
```

**ä»£ç¢¼ä½ç½®**: ç¬¬ 142-232 è¡Œ

**èª¿ç”¨ä½ç½®**: ç¬¬ 827-835 è¡Œ

```python
# ç¬¬ 827-835 è¡Œ
tb_df_sampled = tb_labels(
    close=close_sampled,
    vol=vol_sampled,
    pt_mult=tb_cfg['pt_multiplier'],
    sl_mult=tb_cfg['sl_multiplier'],
    max_holding=tb_cfg['max_holding'],
    min_return=tb_cfg['min_return'],
    day_end_idx=len(close_sampled) - 1
)
```

```python
def trend_labels(close, vol, lookforward=150, vol_multiplier=2.0) -> pd.Series:
    """
    è¶¨å‹¢æ¨™ç±¤ç”Ÿæˆ

    ç‹€æ…‹: âš ï¸âš ï¸âš ï¸ åš´é‡é‡è¤‡è¨ˆç®—ï¼

    å•é¡Œ:
        1. é è™•ç†éšæ®µå¯ä»¥è¨ˆç®—ï¼ˆæœªå¯¦ä½œï¼‰
        2. è¨ˆç®—æˆæœ¬: O(T * lookforward) æ¯å€‹è‚¡ç¥¨æ¯å¤©
        3. å®Œå…¨å¯ä»¥é¿å…ï¼
    """
```

**ä»£ç¢¼ä½ç½®**: ç¬¬ 234-261 è¡Œ

**èª¿ç”¨ä½ç½®**: ç¬¬ 794-799 è¡Œ

#### 3.5 æ¨£æœ¬æ¬Šé‡è¨ˆç®—ï¼ˆéƒ¨åˆ†é‡è¤‡ï¼‰âš ï¸

```python
def make_sample_weight(ret, tt, y, tau=100.0, ...) -> pd.Series:
    """
    æ¨£æœ¬æ¬Šé‡è¨ˆç®—

    ç‹€æ…‹: âš ï¸ éƒ¨åˆ†å¯é è¨ˆç®—

    å•é¡Œ:
        1. éœ€è¦ä½¿ç”¨ ret å’Œ ttï¼ˆTriple-Barrier è¼¸å‡ºï¼‰
        2. å¦‚æœä½¿ç”¨é è™•ç†çš„ labelsï¼Œret/tt ä¸å¯ç”¨
        3. éœ€è¦é‡æ–°è¨­è¨ˆ

    å½±éŸ¿:
        - å¦‚æœä¿ç•™ TB è¼¸å‡ºï¼ˆret, ttï¼‰ï¼Œå¯ä»¥é è¨ˆç®—
        - å¦‚æœåªä½¿ç”¨ labelsï¼Œéœ€è¦ç°¡åŒ–æ¬Šé‡è¨ˆç®—
    """
```

**ä»£ç¢¼ä½ç½®**: ç¬¬ 264-310 è¡Œ

**èª¿ç”¨ä½ç½®**: ç¬¬ 869-877 è¡Œ

---

## é è™•ç†æ•¸æ“šå…§å®¹åˆ†æ

### 1. NPZ æ–‡ä»¶çµæ§‹ï¼ˆv2.0ï¼‰

æ ¹æ“š [PREPROCESSED_DATA_SPECIFICATION.md](PREPROCESSED_DATA_SPECIFICATION.md)ï¼š

| æ¬„ä½ | é¡å‹ | å½¢ç‹€ | èªªæ˜ | éšæ®µ2æ˜¯å¦éœ€è¦ |
|-----|------|------|------|-------------|
| `features` | ndarray | (T, 20) | LOB ç‰¹å¾µï¼ˆå·²æ¸…æ´—ã€èšåˆï¼‰| âœ… å¿…è¦ |
| `mids` | ndarray | (T,) | ä¸­é–“åƒ¹ | âœ… å¿…è¦ |
| `bucket_mask` | ndarray | (T,) | æ•¸æ“šè³ªé‡é®ç½© | âœ… å¿…è¦ |
| `bucket_event_count` | ndarray | (T,) | äº‹ä»¶æ•¸é‡ | âšª å¯é¸ |
| `metadata` | JSON | - | å…ƒæ•¸æ“š | âœ… å¿…è¦ |
| **`labels`** | ndarray | (T,) | **Triple-Barrier æ¨™ç±¤** | **ğŸ†• å¯é‡ç”¨** |

### 2. metadata å…§å®¹åˆ†æ

#### 2.1 åŸºæœ¬è³‡è¨Šï¼ˆå·²æœ‰ï¼‰âœ…

```json
{
  "symbol": "2330",
  "date": "20250901",
  "n_points": 15957,
  "pass_filter": true
}
```

#### 2.2 åƒ¹æ ¼çµ±è¨ˆï¼ˆå·²æœ‰ï¼‰âœ…

```json
{
  "high": 592.0,
  "low": 585.5,
  "open": 587.0,
  "close": 590.0,
  "range_pct": 1.11,
  "return_pct": 0.51
}
```

#### 2.3 æ•¸æ“šè³ªé‡ï¼ˆå·²æœ‰ï¼‰âœ…

```json
{
  "raw_events": 85432,
  "aggregated_points": 15957,
  "ffill_ratio": 0.015,
  "missing_ratio": 0.012,
  "max_gap_sec": 5
}
```

#### 2.4 æ¨™ç±¤é è¦½ï¼ˆå·²æœ‰ï¼‰âœ…

```json
{
  "label_preview": {
    "total_labels": 15956,
    "down_count": 2273,
    "neutral_count": 11395,
    "up_count": 2288,
    "down_pct": 0.1425,
    "neutral_pct": 0.7142,
    "up_pct": 0.1434,
    "label_counts": {
      "-1": 2273,
      "0": 11395,
      "1": 2288
    }
  }
}
```

#### 2.5 æ¬Šé‡ç­–ç•¥ï¼ˆå·²æœ‰ï¼‰âœ…

```json
{
  "weight_strategies": {
    "balanced": {
      "class_weights": {"-1": 1.11, "0": 2.38, "1": 1.11},
      "type": "class_weight"
    },
    "effective_num_0999": {
      "class_weights": {"-1": 1.02, "0": 1.92, "1": 1.04},
      "type": "class_weight"
    },
    // ... 11 ç¨®ç­–ç•¥
  }
}
```

### 3. labels é™£åˆ—åˆ†æï¼ˆv2.0 æ–°å¢ï¼‰ğŸ†•

#### 3.1 æ ¼å¼

```python
labels = data['labels']  # shape: (T,), dtype: float32

# æ¨™ç±¤å€¼:
# -1 = Downï¼ˆåƒ¹æ ¼ä¸‹è·Œï¼‰
# 0  = Neutralï¼ˆåƒ¹æ ¼æŒå¹³ï¼‰
# 1  = Upï¼ˆåƒ¹æ ¼ä¸Šæ¼²ï¼‰
# NaN = æœªè¨ˆç®—ï¼ˆé‚Šç•Œé»ï¼‰
```

#### 3.2 è¨ˆç®—æ–¹å¼

- ä½¿ç”¨ `compute_label_preview()` å‡½æ•¸ï¼ˆpreprocess_single_day.pyï¼‰
- åŸºæ–¼ Triple-Barrier æ–¹æ³•
- åƒæ•¸ä¾†è‡ª `config_pro_v5_ml_optimal.yaml`

#### 3.3 å¯é‡ç”¨æ€§åˆ†æ

| æ¢ä»¶ | å¯é‡ç”¨ | èªªæ˜ |
|-----|-------|------|
| Triple-Barrier åƒæ•¸ç›¸åŒ | âœ… | å®Œå…¨å¯é‡ç”¨ |
| Triple-Barrier åƒæ•¸ä¸åŒ | âŒ | éœ€è¦é‡æ–°è¨ˆç®— |
| ä½¿ç”¨è¶¨å‹¢æ¨™ç±¤ | âŒ | labels æ˜¯ TBï¼Œä¸é©ç”¨ |
| éœ€è¦ ret/tt è³‡è¨Š | âŒ | labels ä¸å« ret/tt |

---

## é‡è¤‡è¨ˆç®—è­˜åˆ¥

### 1. é‡è¤‡è¨ˆç®—ç¸½çµ

| æ­¥é©Ÿ | ç•¶å‰ç‹€æ…‹ | é è™•ç†å·²æœ‰ | é‡è¤‡ç¨‹åº¦ | å¯å„ªåŒ– |
|-----|---------|-----------|---------|--------|
| æ•¸æ“šè¼‰å…¥ | âœ… ç›´æ¥è®€å– | âœ… | ç„¡ | - |
| æ•¸æ“šé©—è­‰ | âœ… é©—è­‰ | âœ… | ç„¡ | - |
| Z-Score æ¨™æº–åŒ– | âœ… å¿…é ˆè¨ˆç®— | âŒ | ç„¡ | - |
| **æ³¢å‹•ç‡è¨ˆç®—** | âš ï¸ é‡æ–°è¨ˆç®— | âœ… å·²è¨ˆç®—ï¼ˆç”¨æ–¼ label_previewï¼‰| **ä¸­ç­‰** | **âœ… å¯å„ªåŒ–** |
| **Triple-Barrier æ¨™ç±¤** | âš ï¸âš ï¸âš ï¸ é‡æ–°è¨ˆç®— | âœ… **labels æ¬„ä½**ï¼ˆv2.0+ï¼‰| **åš´é‡** | **âœ…âœ…âœ… å¼·çƒˆå»ºè­°å„ªåŒ–** |
| **è¶¨å‹¢æ¨™ç±¤** | âš ï¸âš ï¸âš ï¸ é‡æ–°è¨ˆç®— | âŒ æœªå¯¦ä½œ | **åš´é‡** | **âœ…âœ… å»ºè­°å„ªåŒ–** |
| æ¨£æœ¬æ¬Šé‡ | âš ï¸ è¨ˆç®— | âšª å¯é è¨ˆç®— | è¼•å¾® | âœ… å¯è€ƒæ…® |
| æ»‘çª—ç”Ÿæˆ | âœ… å¿…é ˆè¨ˆç®— | âŒ | ç„¡ | - |

### 2. æ•ˆèƒ½å½±éŸ¿åˆ†æ

#### 2.1 æ™‚é–“æˆæœ¬ä¼°ç®—ï¼ˆå–®æ¬¡é‹è¡Œï¼‰

å‡è¨­è™•ç† 195 æª”è‚¡ç¥¨ Ã— 250 å¤© = 48,750 å€‹ symbol-dayï¼š

| æ­¥é©Ÿ | ç•¶å‰è€—æ™‚ | å„ªåŒ–å¾Œè€—æ™‚ | ç¯€çœæ™‚é–“ | ç¯€çœæ¯”ä¾‹ |
|-----|---------|-----------|---------|---------|
| æ•¸æ“šè¼‰å…¥ | 30 ç§’ | 30 ç§’ | 0 | 0% |
| Z-Score æ¨™æº–åŒ– | 60 ç§’ | 60 ç§’ | 0 | 0% |
| **æ³¢å‹•ç‡è¨ˆç®—** | **60 ç§’** | **5 ç§’** | **55 ç§’** | **92%** |
| **Triple-Barrier æ¨™ç±¤** | **300 ç§’** | **10 ç§’** | **290 ç§’** | **97%** |
| æ¨£æœ¬æ¬Šé‡ | 30 ç§’ | 30 ç§’ | 0 | 0% |
| æ»‘çª—ç”Ÿæˆ | 120 ç§’ | 120 ç§’ | 0 | 0% |
| **ç¸½è¨ˆ** | **600 ç§’ (10 åˆ†é˜)** | **255 ç§’ (4.25 åˆ†é˜)** | **345 ç§’** | **58%** |

**çµè«–**: å¯ç¯€çœç´„ **58%** çš„æ™‚é–“ï¼

#### 2.2 æœ€å£æƒ…æ³åˆ†æ

å¦‚æœ Triple-Barrier åƒæ•¸ä¸åŒï¼ˆéœ€è¦é‡æ–°è¨ˆç®—ï¼‰ï¼š

- ç„¡æ³•ä½¿ç”¨é è¨ˆç®—çš„ labels
- ä»éœ€é‡æ–°è¨ˆç®— TB
- ä½†å¯ä»¥ä½¿ç”¨é è¨ˆç®—çš„æ³¢å‹•ç‡ï¼ˆå¦‚æœä¿å­˜ï¼‰
- ç¯€çœæ™‚é–“ï¼šç´„ 10%

---

## æ”¹é€²æ–¹æ¡ˆè¨­è¨ˆ

### æ–¹æ¡ˆ 1: æ¼¸é€²å¼å„ªåŒ–ï¼ˆæ¨è–¦ï¼‰â­â­â­â­â­

**ç†å¿µ**: å„ªå…ˆä½¿ç”¨é è™•ç†æ•¸æ“šï¼Œåƒæ•¸è®ŠåŒ–æ™‚è‡ªå‹•å›é€€åˆ°é‡æ–°è¨ˆç®—

#### å„ªé»
- âœ… å‘å¾Œå…¼å®¹ï¼ˆæ”¯æ´èˆŠç‰ˆ NPZï¼‰
- âœ… éˆæ´»æ€§é«˜ï¼ˆåƒæ•¸è®ŠåŒ–æ™‚è‡ªå‹•è™•ç†ï¼‰
- âœ… é¢¨éšªä½ï¼ˆæœ‰ fallback æ©Ÿåˆ¶ï¼‰
- âœ… æ•ˆèƒ½æå‡é¡¯è‘—ï¼ˆ58%ï¼‰

#### ç¼ºé»
- âšª ä»£ç¢¼ç¨è¤‡é›œï¼ˆéœ€è¦åƒæ•¸æ¯”å°é‚è¼¯ï¼‰

#### å¯¦æ–½ç­–ç•¥

```python
# å½ä»£ç¢¼
if labels_available and params_match:
    # å¿«é€Ÿè·¯å¾‘ï¼šä½¿ç”¨é è¨ˆç®—æ¨™ç±¤
    labels = load_labels_from_npz()
else:
    # æ…¢é€Ÿè·¯å¾‘ï¼šé‡æ–°è¨ˆç®—
    labels = compute_labels()
```

---

### æ–¹æ¡ˆ 2: æ¿€é€²å¼å„ªåŒ–ï¼ˆä¸æ¨è–¦ï¼‰

**ç†å¿µ**: å®Œå…¨ä¾è³´é è™•ç†æ•¸æ“šï¼Œä¸æ”¯æ´åƒæ•¸è®ŠåŒ–

#### å„ªé»
- âœ… ä»£ç¢¼æœ€ç°¡æ½”
- âœ… æ•ˆèƒ½æœ€é«˜

#### ç¼ºé»
- âŒ ç„¡æ³•è™•ç†åƒæ•¸è®ŠåŒ–
- âŒ ä¸æ”¯æ´èˆŠç‰ˆ NPZ
- âŒ éˆæ´»æ€§å·®

---

### æ–¹æ¡ˆ 3: å¢é‡å¼å„ªåŒ–ï¼ˆéƒ¨åˆ†æ¨è–¦ï¼‰â­â­â­

**ç†å¿µ**: åªå„ªåŒ–æœ€è€—æ™‚çš„éƒ¨åˆ†ï¼ˆTriple-Barrierï¼‰ï¼Œä¿ç•™å…¶ä»–è¨ˆç®—

#### å„ªé»
- âœ… é¢¨éšªæœ€ä½
- âœ… å¯¦æ–½æˆæœ¬ä½
- âœ… æ•ˆèƒ½æå‡ç´„ 50%

#### ç¼ºé»
- âšª æœªå®Œå…¨åˆ©ç”¨é è™•ç†æ•¸æ“š
- âšª ä»æœ‰å„ªåŒ–ç©ºé–“

---

## æ”¹é€²æ–¹æ¡ˆï¼šæ–¹æ¡ˆ 1 è©³ç´°è¨­è¨ˆ

### 1. æ¶æ§‹èª¿æ•´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¼¸å…¥: é è™•ç† NPZ                                            â”‚
â”‚  â”œâ”€ features (T, 20)                                        â”‚
â”‚  â”œâ”€ mids (T,)                                               â”‚
â”‚  â”œâ”€ bucket_mask (T,)                                        â”‚
â”‚  â”œâ”€ metadata (å« label_preview, weight_strategies)          â”‚
â”‚  â””â”€ labels (T,) ã€v2.0+ï¼Œå¯é¸ã€‘                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: è¼‰å…¥é è™•ç†æ•¸æ“š                                      â”‚
â”‚  â””â”€ load_preprocessed_npz()                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: åƒæ•¸åŒ¹é…æª¢æŸ¥ ğŸ†•                                     â”‚
â”‚  â””â”€ check_label_compatibility()                             â”‚
â”‚     â”œâ”€ æ¯”å° TB åƒæ•¸                                         â”‚
â”‚     â””â”€ æ±ºå®šä½¿ç”¨é è¨ˆç®—æˆ–é‡æ–°è¨ˆç®—                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¿«é€Ÿè·¯å¾‘ ğŸ†•         â”‚    â”‚  æ…¢é€Ÿè·¯å¾‘ï¼ˆåŸæœ‰ï¼‰     â”‚
â”‚  ä½¿ç”¨é è¨ˆç®— labels   â”‚    â”‚  é‡æ–°è¨ˆç®—            â”‚
â”‚  â”œâ”€ è¼‰å…¥ labels      â”‚    â”‚  â”œâ”€ ewma_vol()       â”‚
â”‚  â”œâ”€ è½‰æ›æ ¼å¼         â”‚    â”‚  â”œâ”€ tb_labels()      â”‚
â”‚  â””â”€ è·³é TB è¨ˆç®—     â”‚    â”‚  â””â”€ trend_labels()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: Z-Score æ¨™æº–åŒ–                                      â”‚
â”‚  â”œâ”€ zscore_fit()                                            â”‚
â”‚  â””â”€ zscore_apply()                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: æ¨£æœ¬æ¬Šé‡è¨ˆç®—                                        â”‚
â”‚  â”œâ”€ å¿«é€Ÿè·¯å¾‘ï¼šä½¿ç”¨ class_weightï¼ˆå¾ metadataï¼‰ğŸ†•            â”‚
â”‚  â””â”€ æ…¢é€Ÿè·¯å¾‘ï¼šmake_sample_weight()ï¼ˆåŸæœ‰ï¼‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: æ»‘çª—ç”Ÿæˆ                                            â”‚
â”‚  â””â”€ ç”Ÿæˆ (N, 100, 20) æ™‚é–“åºåˆ—çª—å£                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¼¸å‡º: è¨“ç·´ NPZ                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. é—œéµå‡½æ•¸è¨­è¨ˆ

#### 2.1 åƒæ•¸åŒ¹é…æª¢æŸ¥å‡½æ•¸ ğŸ†•

```python
def check_label_compatibility(npz_meta: Dict, config: Dict) -> Tuple[bool, str]:
    """
    æª¢æŸ¥é è¨ˆç®—æ¨™ç±¤æ˜¯å¦å¯ç”¨

    Returns:
        (is_compatible, reason)

    Examples:
        (True, "é è¨ˆç®—æ¨™ç±¤å¯ç”¨")
        (False, "TB åƒæ•¸ä¸åŒ¹é…: pt_mult 2.0 vs 1.5")
        (False, "æ¨™ç±¤æ–¹æ³•ä¸åŒ: triple_barrier vs trend")
    """
    # æª¢æŸ¥ 1: labels æ¬„ä½æ˜¯å¦å­˜åœ¨
    if 'labels' not in npz_meta:
        return False, "NPZ ç„¡ labels æ¬„ä½ï¼ˆèˆŠç‰ˆ v1.0ï¼‰"

    # æª¢æŸ¥ 2: æ¨™ç±¤æ–¹æ³•æ˜¯å¦åŒ¹é…
    config_method = config.get('labeling_method', 'triple_barrier')
    npz_method = npz_meta.get('labeling_method', 'triple_barrier')

    if config_method != npz_method:
        return False, f"æ¨™ç±¤æ–¹æ³•ä¸åŒ: {config_method} vs {npz_method}"

    # æª¢æŸ¥ 3: TB åƒæ•¸æ˜¯å¦åŒ¹é…ï¼ˆå¦‚æœæ˜¯ triple_barrierï¼‰
    if config_method == 'triple_barrier':
        config_tb = config['triple_barrier']
        npz_tb = npz_meta.get('triple_barrier_config', {})

        # é—œéµåƒæ•¸
        key_params = ['pt_multiplier', 'sl_multiplier', 'max_holding', 'min_return']

        for param in key_params:
            config_val = config_tb.get(param)
            npz_val = npz_tb.get(param)

            if config_val != npz_val:
                return False, f"TB åƒæ•¸ä¸åŒ¹é…: {param} {config_val} vs {npz_val}"

    # æª¢æŸ¥ 4: è¶¨å‹¢æ¨™ç±¤åƒæ•¸æ˜¯å¦åŒ¹é…ï¼ˆå¦‚æœæ˜¯ trendï¼‰
    if config_method == 'trend_adaptive':
        config_trend = config.get('trend_labeling', {})
        npz_trend = npz_meta.get('trend_labeling_config', {})

        key_params = ['lookforward', 'vol_multiplier']

        for param in key_params:
            if config_trend.get(param) != npz_trend.get(param):
                return False, f"è¶¨å‹¢åƒæ•¸ä¸åŒ¹é…: {param}"

    return True, "é è¨ˆç®—æ¨™ç±¤å¯ç”¨"
```

#### 2.2 æ¨™ç±¤è¼‰å…¥å‡½æ•¸ ğŸ†•

```python
def load_labels_from_npz(labels_raw: np.ndarray, method: str) -> pd.DataFrame:
    """
    å¾ NPZ è¼‰å…¥æ¨™ç±¤ä¸¦è½‰æ›ç‚ºçµ±ä¸€æ ¼å¼

    Args:
        labels_raw: åŸå§‹æ¨™ç±¤é™£åˆ—ï¼ˆ-1/0/1ï¼‰
        method: æ¨™ç±¤æ–¹æ³•

    Returns:
        DataFrame with columns: ['y', 'ret', 'tt', 'why']
        (ret, tt ç‚ºæ¨¡æ“¬å€¼ï¼Œç”¨æ–¼å…¼å®¹ç¾æœ‰ä»£ç¢¼)
    """
    # éæ¿¾ NaN
    valid_mask = ~np.isnan(labels_raw)
    labels = labels_raw[valid_mask]

    # å‰µå»ºçµ±ä¸€æ ¼å¼
    df = pd.DataFrame(index=range(len(labels_raw)))
    df['y'] = labels_raw

    # æ¨¡æ“¬ ret å’Œ ttï¼ˆå¦‚æœéœ€è¦æ¨£æœ¬æ¬Šé‡ï¼‰
    # æ³¨æ„ï¼šé€™äº›å€¼æ˜¯ä¼°è¨ˆå€¼ï¼Œä¸å¦‚é‡æ–°è¨ˆç®—æº–ç¢º
    df['ret'] = 0.0  # æ¨¡æ“¬å€¼
    df['tt'] = 0     # æ¨¡æ“¬å€¼
    df['why'] = method
    df['up_p'] = 0.0
    df['dn_p'] = 0.0

    return df
```

#### 2.3 å¿«é€Ÿè·¯å¾‘æ•´åˆ ğŸ†•

```python
def build_split_v7(split_name, use_precomputed=True):
    """
    V7 ç‰ˆæœ¬ï¼šæ”¯æ´é è¨ˆç®—æ¨™ç±¤çš„æ»‘çª—ç”Ÿæˆ

    æ”¹é€²:
        - å„ªå…ˆä½¿ç”¨é è¨ˆç®—æ¨™ç±¤
        - åƒæ•¸ä¸åŒ¹é…æ™‚è‡ªå‹•å›é€€
        - å®Œå…¨å‘å¾Œå…¼å®¹
    """
    for sym, n_points, day_data_sorted in stock_list:
        for date, features, mids, bucket_mask, metadata, labels_npz in day_data_sorted:

            # 1. Z-Score æ¨™æº–åŒ–ï¼ˆå¿…é ˆï¼‰
            Xn = zscore_apply(features, mu, sd)

            # 2. æ¨™ç±¤è™•ç†ï¼ˆå¿«é€Ÿ/æ…¢é€Ÿè·¯å¾‘ï¼‰
            is_compatible, reason = check_label_compatibility(metadata, config)

            if is_compatible and labels_npz is not None and use_precomputed:
                # å¿«é€Ÿè·¯å¾‘ï¼šä½¿ç”¨é è¨ˆç®—æ¨™ç±¤
                logging.info(f"  {sym} @ {date}: ä½¿ç”¨é è¨ˆç®—æ¨™ç±¤")
                tb_df = load_labels_from_npz(labels_npz, config['labeling_method'])
            else:
                # æ…¢é€Ÿè·¯å¾‘ï¼šé‡æ–°è¨ˆç®—
                if not is_compatible:
                    logging.warning(f"  {sym} @ {date}: {reason}ï¼Œé‡æ–°è¨ˆç®—æ¨™ç±¤")

                # è¨ˆç®—æ³¢å‹•ç‡
                close = pd.Series(mids)
                vol = ewma_vol(close, halflife=config['volatility']['halflife'])

                # è¨ˆç®—æ¨™ç±¤
                if config['labeling_method'] == 'triple_barrier':
                    tb_df = tb_labels(close, vol, ...)
                else:
                    tb_df = trend_labels(close, vol, ...)

            # 3. è½‰æ›æ¨™ç±¤ï¼ˆ-1/0/1 â†’ 0/1/2ï¼‰
            y_tb = tb_df["y"].map({-1: 0, 0: 1, 1: 2})

            # 4. æ¨£æœ¬æ¬Šé‡ï¼ˆå¿«é€Ÿ/æ…¢é€Ÿè·¯å¾‘ï¼‰
            if config['sample_weights']['enabled']:
                if use_precomputed and 'weight_strategies' in metadata:
                    # å¿«é€Ÿè·¯å¾‘ï¼šä½¿ç”¨é è¨ˆç®—æ¬Šé‡ç­–ç•¥
                    strategy_name = config['sample_weights']['strategy']
                    class_weights = metadata['weight_strategies'][strategy_name]['class_weights']

                    # æ˜ å°„åˆ°æ¨£æœ¬æ¬Šé‡
                    w = y_tb.map({
                        0: class_weights['-1'],  # Down
                        1: class_weights['0'],   # Neutral
                        2: class_weights['1']    # Up
                    })
                else:
                    # æ…¢é€Ÿè·¯å¾‘ï¼šè¨ˆç®—æ¨£æœ¬æ¬Šé‡
                    w = make_sample_weight(tb_df["ret"], tb_df["tt"], y_tb, ...)
            else:
                w = pd.Series(np.ones(len(y_tb)))

            # 5. æ»‘çª—ç”Ÿæˆï¼ˆåŸæœ‰é‚è¼¯ï¼‰
            for t in range(SEQ_LEN - 1, max_t):
                window = Xn[window_start:t + 1, :]
                # ... åŸæœ‰é‚è¼¯
```

### 3. é…ç½®æ–‡ä»¶æ“´å±•

#### 3.1 æ–°å¢é…ç½®é … ğŸ†•

```yaml
# configs/config_pro_v5_ml_optimal.yaml

# æ–°å¢ï¼šæ¨™ç±¤é‡ç”¨é…ç½®
label_reuse:
  enabled: true                    # æ˜¯å¦å•Ÿç”¨é è¨ˆç®—æ¨™ç±¤é‡ç”¨
  strict_param_match: true         # æ˜¯å¦åš´æ ¼åŒ¹é…åƒæ•¸
  fallback_to_compute: true        # åƒæ•¸ä¸åŒ¹é…æ™‚æ˜¯å¦å›é€€åˆ°é‡æ–°è¨ˆç®—
  warn_on_fallback: true           # å›é€€æ™‚æ˜¯å¦è­¦å‘Š

# æ–°å¢ï¼šæ¬Šé‡ç­–ç•¥é¸æ“‡
sample_weights:
  enabled: true
  strategy: "effective_num_0999"   # å¾ metadata.weight_strategies é¸æ“‡
  # å¦‚æœä½¿ç”¨è‡ªå®šç¾©æ¬Šé‡ï¼Œå‰‡ä½¿ç”¨åŸæœ‰çš„ tau, return_scaling ç­‰
  use_precomputed_weights: true    # æ˜¯å¦ä½¿ç”¨é è¨ˆç®—æ¬Šé‡
```

### 4. è¼¸å‡º metadata æ›´æ–°

```json
{
  "format": "deeplob_v7",
  "version": "7.0.0",

  "label_source": {
    "method": "precomputed",  // æˆ– "computed"
    "used_npz_labels": true,
    "fallback_count": 5,      // å›é€€åˆ°é‡æ–°è¨ˆç®—çš„æ¬¡æ•¸
    "compatibility_rate": 0.95 // labels å…¼å®¹æ¯”ä¾‹
  },

  "performance": {
    "total_time_seconds": 255,
    "time_saved_seconds": 345,
    "speedup_ratio": 2.35
  }
}
```

---

## å¯¦æ–½è¨ˆåŠƒ

### Phase 1: æº–å‚™å·¥ä½œï¼ˆ1 å°æ™‚ï¼‰

#### ä»»å‹™ 1.1: æª¢æŸ¥é è™•ç†æ•¸æ“šå®Œæ•´æ€§
- [ ] ç¢ºèªæ‰€æœ‰ NPZ éƒ½æœ‰ labels æ¬„ä½
- [ ] æª¢æŸ¥ labels æ ¼å¼å’Œå€¼ç¯„åœ
- [ ] é©—è­‰ metadata ä¸­çš„ triple_barrier_config

#### ä»»å‹™ 1.2: å‚™ä»½ç•¶å‰ç‰ˆæœ¬
- [ ] è¤‡è£½ extract_tw_stock_data_v6.py â†’ extract_tw_stock_data_v6_backup.py
- [ ] Git commit ç•¶å‰ç‹€æ…‹

### Phase 2: æ ¸å¿ƒå‡½æ•¸å¯¦ä½œï¼ˆ2 å°æ™‚ï¼‰

#### ä»»å‹™ 2.1: å¯¦ä½œåƒæ•¸åŒ¹é…æª¢æŸ¥
- [ ] ç·¨å¯« `check_label_compatibility()`
- [ ] å–®å…ƒæ¸¬è©¦ï¼ˆåŒ¹é…/ä¸åŒ¹é…/ç¼ºå¤±ï¼‰

#### ä»»å‹™ 2.2: å¯¦ä½œæ¨™ç±¤è¼‰å…¥
- [ ] ç·¨å¯« `load_labels_from_npz()`
- [ ] è™•ç† NaN å€¼
- [ ] æ ¼å¼è½‰æ›æ¸¬è©¦

#### ä»»å‹™ 2.3: å¯¦ä½œå¿«é€Ÿè·¯å¾‘é‚è¼¯
- [ ] ä¿®æ”¹ `build_split_v7()`
- [ ] æ·»åŠ  if-else åˆ†æ”¯
- [ ] æ—¥èªŒè¼¸å‡ºå„ªåŒ–

### Phase 3: æ¬Šé‡ç­–ç•¥æ•´åˆï¼ˆ1 å°æ™‚ï¼‰

#### ä»»å‹™ 3.1: å¯¦ä½œé è¨ˆç®—æ¬Šé‡ä½¿ç”¨
- [ ] å¾ metadata.weight_strategies è®€å–
- [ ] æ˜ å°„åˆ°æ¨£æœ¬æ¬Šé‡
- [ ] å…¼å®¹åŸæœ‰ make_sample_weight()

### Phase 4: æ¸¬è©¦é©—è­‰ï¼ˆ2 å°æ™‚ï¼‰

#### ä»»å‹™ 4.1: å–®å…ƒæ¸¬è©¦
- [ ] æ¸¬è©¦ check_label_compatibility()
- [ ] æ¸¬è©¦ load_labels_from_npz()
- [ ] æ¸¬è©¦å¿«é€Ÿ/æ…¢é€Ÿè·¯å¾‘åˆ‡æ›

#### ä»»å‹™ 4.2: æ•´åˆæ¸¬è©¦
- [ ] å°æ•¸æ“šé›†æ¸¬è©¦ï¼ˆ1-2 å¤©ï¼‰
- [ ] å°æ¯” v6 vs v7 è¼¸å‡ºï¼ˆæ‡‰ç›¸åŒï¼‰
- [ ] æ€§èƒ½æ¸¬è©¦ï¼ˆæ™‚é–“å°æ¯”ï¼‰

#### ä»»å‹™ 4.3: å®Œæ•´æ¸¬è©¦
- [ ] å®Œæ•´æ•¸æ“šé›†æ¸¬è©¦
- [ ] é©—è­‰æ¨™ç±¤åˆ†å¸ƒ
- [ ] é©—è­‰è¨“ç·´æ•ˆæœ

### Phase 5: æ–‡æª”æ›´æ–°ï¼ˆ1 å°æ™‚ï¼‰

#### ä»»å‹™ 5.1: ä»£ç¢¼æ–‡æª”
- [ ] æ›´æ–° docstrings
- [ ] æ·»åŠ ä½¿ç”¨ç¯„ä¾‹
- [ ] æ›´æ–°ç‰ˆæœ¬è™Ÿ â†’ v7.0.0

#### ä»»å‹™ 5.2: ç”¨æˆ¶æ–‡æª”
- [ ] æ›´æ–° PREPROCESSED_TO_TRAINING_GUIDE.md
- [ ] å‰µå»º V7_CHANGELOG.md
- [ ] æ›´æ–° README

### Phase 6: éƒ¨ç½²ä¸Šç·šï¼ˆ30 åˆ†é˜ï¼‰

#### ä»»å‹™ 6.1: ç™¼å¸ƒ
- [ ] Git commit + tag v7.0.0
- [ ] æ›´æ–°ä¸»åˆ†æ”¯
- [ ] é€šçŸ¥ç”¨æˆ¶

---

## é æœŸæ•ˆæœ

### 1. æ€§èƒ½æå‡

| æŒ‡æ¨™ | v6.0 | v7.0 | æ”¹å–„ |
|-----|------|------|------|
| è™•ç†æ™‚é–“ï¼ˆ195 æª” Ã— 250 å¤©ï¼‰| 10 åˆ†é˜ | 4.25 åˆ†é˜ | **-58%** |
| Triple-Barrier è¨ˆç®— | 5 åˆ†é˜ | 10 ç§’ | **-97%** |
| æ³¢å‹•ç‡è¨ˆç®— | 1 åˆ†é˜ | 5 ç§’ | **-92%** |
| åƒæ•¸èª¿æ•´é‡æ–°ç”Ÿæˆ | 10 åˆ†é˜ | 10 åˆ†é˜ | 0%ï¼ˆéœ€é‡ç®—ï¼‰|

### 2. ç”¨æˆ¶é«”é©—

| å ´æ™¯ | v6.0 | v7.0 |
|-----|------|------|
| é¦–æ¬¡ç”Ÿæˆè¨“ç·´æ•¸æ“š | 10 åˆ†é˜ | 4.25 åˆ†é˜ â­ |
| èª¿æ•´ Z-Score åƒæ•¸ | 10 åˆ†é˜ | 4.25 åˆ†é˜ â­ |
| èª¿æ•´ TB åƒæ•¸ | 10 åˆ†é˜ | 10 åˆ†é˜ |
| æ¸¬è©¦ä¸åŒæ¬Šé‡ç­–ç•¥ | 10 åˆ†é˜ | 4.25 åˆ†é˜ â­ |

### 3. ç¶­è­·æ€§

- âœ… å‘å¾Œå…¼å®¹ï¼ˆæ”¯æ´èˆŠç‰ˆ NPZï¼‰
- âœ… è‡ªå‹• fallbackï¼ˆåƒæ•¸ä¸åŒ¹é…æ™‚ï¼‰
- âœ… è©³ç´°æ—¥èªŒï¼ˆçŸ¥é“ä½•æ™‚ä½¿ç”¨å¿«é€Ÿ/æ…¢é€Ÿè·¯å¾‘ï¼‰
- âœ… éˆæ´»é…ç½®ï¼ˆå¯é—œé–‰å„ªåŒ–ï¼‰

---

## é¢¨éšªè©•ä¼°

### é¢¨éšª 1: æ¨™ç±¤ç²¾åº¦å·®ç•°

**é¢¨éšª**: é è¨ˆç®—æ¨™ç±¤èˆ‡å¯¦æ™‚è¨ˆç®—å¯èƒ½æœ‰å¾®å°å·®ç•°

**åŸå› **:
- æµ®é»æ•¸ç²¾åº¦
- è¨ˆç®—é †åºå·®ç•°
- NaN è™•ç†æ–¹å¼

**ç·©è§£æªæ–½**:
- æ•´åˆæ¸¬è©¦å°æ¯”è¼¸å‡º
- å®¹å¿ < 0.1% çš„å·®ç•°
- è©³ç´°æ—¥èªŒè¨˜éŒ„

**é¢¨éšªç­‰ç´š**: ä½ âšª

### é¢¨éšª 2: åƒæ•¸åŒ¹é…é‚è¼¯éŒ¯èª¤

**é¢¨éšª**: check_label_compatibility() åˆ¤æ–·éŒ¯èª¤

**ç·©è§£æªæ–½**:
- å®Œæ•´å–®å…ƒæ¸¬è©¦
- ä¿å®ˆç­–ç•¥ï¼ˆä¸ç¢ºå®šæ™‚å›é€€ï¼‰
- ç”¨æˆ¶å¯å¼·åˆ¶é‡ç®—

**é¢¨éšªç­‰ç´š**: ä½ âšª

### é¢¨éšª 3: èˆŠç‰ˆ NPZ å…¼å®¹æ€§

**é¢¨éšª**: èˆŠç‰ˆ NPZ æ²’æœ‰ labels æ¬„ä½

**ç·©è§£æªæ–½**:
- è‡ªå‹•æª¢æ¸¬ä¸¦å›é€€
- æ˜ç¢ºæ—¥èªŒæç¤º
- ä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½

**é¢¨éšªç­‰ç´š**: æ¥µä½ âšª

---

## çµè«–

### æ ¸å¿ƒç™¼ç¾

1. **é‡è¤‡è¨ˆç®—åš´é‡**: v6 é‡è¤‡è¨ˆç®—äº†é è™•ç†éšæ®µå·²å®Œæˆçš„ 50-70% å·¥ä½œ
2. **å„ªåŒ–æ½›åŠ›å¤§**: å¯ç¯€çœç´„ **58%** çš„æ™‚é–“
3. **é è™•ç†æ•¸æ“šå®Œæ•´**: labels æ¬„ä½ï¼ˆv2.0+ï¼‰å·²åŒ…å«æ‰€éœ€è³‡è¨Š
4. **å¯¦æ–½é¢¨éšªä½**: å®Œå…¨å‘å¾Œå…¼å®¹ï¼Œè‡ªå‹• fallback

### æ¨è–¦æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1: æ¼¸é€²å¼å„ªåŒ–** â­â­â­â­â­

- å„ªå…ˆä½¿ç”¨é è¨ˆç®— labels
- åƒæ•¸ä¸åŒ¹é…æ™‚è‡ªå‹•å›é€€
- å®Œå…¨å‘å¾Œå…¼å®¹
- æ•ˆèƒ½æå‡ 58%

### ä¸‹ä¸€æ­¥

âœ… **æ‰¹å‡†æ­¤æŠ€è¡“åˆ†ææ–‡æª”**
âœ… **å•Ÿå‹• Phase 1: æº–å‚™å·¥ä½œ**
âœ… **å‰µå»º extract_tw_stock_data_v7.py**

---

**æ–‡æª”ç‰ˆæœ¬**: v1.0
**æœ€å¾Œæ›´æ–°**: 2025-10-23
**ç‹€æ…‹**: âœ… åˆ†æå®Œæˆï¼Œå¾…æ‰¹å‡†å¯¦æ–½
