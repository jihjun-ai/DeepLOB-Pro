# 數據洩漏問題解決方案

**版本**: v1.0
**更新日期**: 2025-10-21
**問題**: 健康檢查發現未來資訊洩漏（檢查 2 失敗）

---

## 📋 問題診斷

### 原始健康檢查結果

```
檢查 2: 未來資訊洩漏測試
  基準模型（正常對齊）: 準確率 0.588 (58.8%)
  測試 A: 時間打亂標籤:    準確率 0.539 (53.9%)
  下降幅度: 0.048 (4.8%)
  結果: ❌ 失敗 - 打亂後仍高準確率，可能有洩漏
```

### 問題分析

**正常情況**（無洩漏）:
- 打亂標籤後，模型應該無法學習
- 準確率應該下降到接近隨機（~33%，3 類別）
- 期望下降幅度 > 10%

**實際情況**（有洩漏）:
- 打亂標籤後，準確率只下降 4.8%
- 仍然達到 53.9%（遠高於隨機 33%）
- **診斷**: 特徵中包含「未來資訊」

### 洩漏原因

#### 主要原因：隨機切分導致時間洩漏 ⭐⭐⭐⭐⭐

**舊方法**（按股票隨機切分）:
```
股票 A: Day 1-10 → 隨機分配到 train/val/test
股票 B: Day 1-10 → 隨機分配到 train/val/test
...
```

**問題**:
1. 同一股票的不同天被拆到不同集合
2. 訓練集可能包含 Day 8-10 的數據
3. 測試集可能包含 Day 1-3 的數據
4. **結果**: 用「未來」訓練，測試「過去」→ 時間洩漏

**範例**:
```
訓練集: 股票 A (Day 8-10) + 股票 B (Day 1-3) + ...
測試集: 股票 A (Day 1-7) + 股票 C (Day 5-10) + ...
        └─ 時間重疊！訓練集看過 Day 8-10，測試集也有 Day 8-10
```

#### 次要原因：滑窗重疊

**滑窗重疊**（99% 重疊）:
```
Window 1: [t=0   ... t=99]  → Label at t=99
Window 2: [t=1   ... t=100] → Label at t=100
         └─── 99% 重疊！ ───┘
```

**影響**:
- 相鄰樣本特徵幾乎完全相同
- 模型學到「相鄰樣本有相似標籤」而非真正的價格預測
- 打亂標籤後，仍能利用特徵相似性猜測

---

## 🛠️ 解決方案

### 方案 1: 時間序列切分（已實施）⭐⭐⭐⭐⭐

#### 新方法（按時間切分）

```
所有股票:
  Day 1-7   → 訓練集（所有股票）
  Day 8-9   → 驗證集（所有股票）
  Day 10    → 測試集（所有股票）
```

#### 優勢

| 特性 | 隨機切分 | 時間序列切分 |
|------|---------|-------------|
| 時間洩漏 | ❌ 嚴重 | ✅ 無 |
| 符合實際交易 | ❌ 不符合 | ✅ 完全符合 |
| 分布穩定性 | ⭐⭐⭐⭐ | ⭐⭐⭐ (可能漂移) |
| 測試集大小 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ (較小) |

#### 配置修改

```yaml
# configs/config_pro_v5_ml_optimal.yaml
split:
  method: 'temporal'  # 改為時間序列切分
  train_days: 7       # 前 7 天訓練
  val_days: 2         # 中間 2 天驗證
  test_days: 1        # 最後 1 天測試
```

#### 代碼修改

**主要修改**: `scripts/extract_tw_stock_data_v6.py`

```python
# 舊方法（第 607-629 行）
# 按股票隨機切分 70/15/15
random.shuffle(valid_stocks)
train_stocks = valid_stocks[:n_train]
val_stocks = valid_stocks[n_train:n_train + n_val]
test_stocks = valid_stocks[n_train + n_val:]

# 新方法（第 607-697 行）
# 按時間切分
if split_method == 'temporal':
    # 提取所有日期並排序
    sorted_dates = sorted(all_dates)

    # 按日期切分
    train_date_set = set(sorted_dates[:train_days])
    val_date_set = set(sorted_dates[train_days:train_days + val_days])
    test_date_set = set(sorted_dates[train_days + val_days:])

    # 為每個集合過濾對應日期的數據
    for sym, n_points, day_data_sorted in valid_stocks:
        train_day_data = [... if date in train_date_set]
        val_day_data = [... if date in val_date_set]
        test_day_data = [... if date in test_date_set]
```

### 方案 2: 滾動窗口標準化（已實施）⭐⭐⭐⭐

**配置修改**:
```yaml
normalization:
  method: 'rolling_zscore'  # 滾動窗口 Z-Score
  window: 100               # 使用最近 100 個 tick
  min_periods: 20           # 最小有效樣本數
```

**優勢**:
- 適應市場變化（統計量動態更新）
- 減少分布漂移（PSI 預期 < 0.1）
- 符合實際交易（只用歷史數據）

---

## 📊 預期改善

### 洩漏測試預期結果

**修正前**:
```
基準準確率: 58.8%
打亂後準確率: 53.9%
下降幅度: 4.8% ❌
```

**修正後**（預期）:
```
基準準確率: 50-55%（可能略降，但更真實）
打亂後準確率: 33-38%（接近隨機）
下降幅度: > 15% ✅
```

### 穩定性測試預期結果

**修正前**:
```
PSI 平均: 0.207（輕微漂移）
PSI 最大: 0.383（顯著漂移）
狀態: ❌ 失敗
```

**修正後**（預期）:
```
PSI 平均: < 0.1（穩定）
PSI 最大: < 0.15（穩定）
狀態: ✅ 通過
```

---

## 🎯 執行步驟

### 步驟 1: 修改配置（已完成）✅

```yaml
# configs/config_pro_v5_ml_optimal.yaml
split:
  method: 'temporal'
  train_days: 7
  val_days: 2
  test_days: 1

normalization:
  method: 'rolling_zscore'
  window: 100
  min_periods: 20
```

### 步驟 2: 修改代碼（已完成）✅

- ✅ `scripts/extract_tw_stock_data_v6.py`: 新增時間序列切分邏輯
- ✅ `scripts/extract_tw_stock_data_v6.py`: 新增滾動窗口標準化
- ✅ Metadata 記錄切分方法和日期範圍

### 步驟 3: 重新生成數據（執行中）⏳

```bash
conda activate deeplob-pro
python scripts/extract_tw_stock_data_v6.py \
    --preprocessed-dir ./data/preprocessed_v5_1hz \
    --output-dir ./data/processed_v6_temporal \
    --config ./configs/config_pro_v5_ml_optimal.yaml
```

### 步驟 4: 驗證改善（待執行）

```bash
# 健康檢查
python scripts/data_health_check.py \
    --train-npz data/processed_v6_temporal/npz/stock_embedding_train.npz \
    --val-npz data/processed_v6_temporal/npz/stock_embedding_val.npz \
    --test-npz data/processed_v6_temporal/npz/stock_embedding_test.npz \
    --output-dir data/processed_v6_temporal/health_check
```

---

## 📝 關鍵改進總結

### 1. 時間序列切分（核心改進）

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| 切分方式 | 按股票隨機 | 按日期順序 |
| 時間洩漏 | ❌ 嚴重 | ✅ 無 |
| 訓練集 | 70% 股票（所有天） | 所有股票（前 7 天） |
| 測試集 | 15% 股票（所有天） | 所有股票（最後 1 天） |
| 符合實際 | ❌ | ✅ |

### 2. 滾動窗口標準化（輔助改進）

| 項目 | 修正前 | 修正後 |
|------|-------|-------|
| 標準化方法 | 全局統計量 | 滾動窗口 |
| 分布漂移 | PSI=0.38 | PSI<0.1（預期） |
| 適應性 | ❌ 靜態 | ✅ 動態 |

### 3. Metadata 增強

- ✅ 記錄切分方法（`temporal` 或 `random`）
- ✅ 記錄訓練/驗證/測試日期範圍
- ✅ 記錄標準化方法和參數
- ✅ 標註「時間序列切分避免未來資訊洩漏」

---

## ⚠️ 注意事項

### 潛在問題

1. **測試集變小**
   - 舊方法: 15% 股票 × 10 天 = 約 150 symbol-days
   - 新方法: 所有股票 × 1 天 = 約 294 symbol-days
   - **影響**: 測試集樣本數可能減少（取決於股票在 Day 10 的活躍度）

2. **分布漂移風險**
   - 訓練集（Day 1-7）和測試集（Day 10）之間可能有分布差異
   - **緩解**: 滾動窗口標準化能部分適應分布變化

3. **泛化能力評估**
   - 只測試 1 天的數據，泛化能力評估可能不夠全面
   - **建議**: 未來可實施滾動回測（Walk-Forward Validation）

### 驗證標準

**健康檢查必須通過**:
- ✅ 檢查 1: 標籤平衡（已通過）
- ✅ 檢查 2: 未來資訊洩漏（預期通過，下降幅度 > 10%）
- ✅ 檢查 3: 數據足量（已通過）
- ✅ 檢查 4: 穩定性（預期通過，PSI < 0.1）
- ✅ 檢查 5: 基準對比（已通過）

---

## 🔗 相關文檔

- [數據質量驗證完整流程](數據質量驗證完整流程(產生訓練資料).md)
- [ChatGPT 數據質量建議分析](CHATGPT_SUGGESTIONS_ANALYSIS.md)
- [V6 雙階段處理指南](V6_TWO_STAGE_PIPELINE_GUIDE.md)

---

**最後更新**: 2025-10-21
**狀態**: 代碼修改完成，數據生成中，待驗證
