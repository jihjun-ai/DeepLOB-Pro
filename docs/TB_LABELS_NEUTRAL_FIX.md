# Triple-Barrier æ¨™ç±¤ã€Œå¹³ã€æ¯”ä¾‹éä½å•é¡Œåˆ†æèˆ‡è§£æ±ºæ–¹æ¡ˆ

## ğŸ“Š å•é¡Œè¨ºæ–·

### ç•¶å‰ç‹€æ³
æ ¹æ“šä½ çš„é…ç½® `config_pro_v5_ml_optimal.yaml`ï¼š
```yaml
triple_barrier:
  pt_multiplier: 3.5
  sl_multiplier: 3.5
  max_holding: 40
  min_return: 0.0015  # 0.15%
```

### ç‚ºä»€éº¼ã€Œå¹³ã€(label=0) è¢«åƒæ‰ï¼Ÿ

**åŸå§‹é‚è¼¯ï¼ˆextract_tw_stock_data_v5.py ç¬¬ 306-316 è¡Œï¼‰**ï¼š
```python
if trigger_why == 'time':
    if np.abs(ret) < min_return:  # â† åªæœ‰é€™è£¡æœƒç”¢ç”Ÿ label=0
        label = 0
    else:
        label = int(np.sign(ret))
else:  # PT/SL è§¸ç™¼
    label = int(np.sign(ret))  # â† ä¸€å¾‹æ¨™ç‚º Â±1
```

**å•é¡Œéˆæ¢**ï¼š
1. **PT/SL è§¸ç™¼å å¤§å¤šæ•¸** â†’ å°è‚¡æ—¥å…§æ³¢å‹•å¤§ï¼Œ3.5Ïƒ ç¶“å¸¸è¢«è§¸åŠ
2. **PT/SL ä¸€å¾‹æ¨™ Â±1** â†’ å³ä½¿å¯¦éš›æ”¶ç›Šå¾ˆå°ï¼ˆå¦‚ 0.05%ï¼‰ï¼Œä¹Ÿè¢«æ¨™ç‚ºä¸Šæ¼²/ä¸‹è·Œ
3. **time trigger ä¹Ÿå¸¸è¶…éé–¾å€¼** â†’ `min_return=0.0015` é›–ç„¶çœ‹ä¼¼å°ï¼Œä½†åœ¨ 40 bars å¾Œåƒ¹æ ¼å¸¸æœ‰ >0.15% è®Šå‹•
4. **çµæœ** â†’ åªæœ‰ã€Œæ™‚é–“åˆ° + æ”¶ç›Šæ¥µå°ã€æ‰æ˜¯ 0 â†’ **æ¯”ä¾‹ <10%**

### æ•¸æ“šé©—è­‰ï¼ˆç¤ºæ„ï¼‰
å‡è¨­ä¸€å¤© 1000 å€‹æ¨£æœ¬ï¼š
- PT è§¸ç™¼ï¼š350 å€‹ â†’ å…¨æ¨™ +1ï¼ˆå³ä½¿æœ‰äº›åªæ¼² 0.08%ï¼‰
- SL è§¸ç™¼ï¼š320 å€‹ â†’ å…¨æ¨™ -1ï¼ˆå³ä½¿æœ‰äº›åªè·Œ 0.06%ï¼‰
- Time è§¸ç™¼ï¼š330 å€‹
  - å…¶ä¸­ 280 å€‹ |ret| > 0.15% â†’ æ¨™ Â±1
  - **åªæœ‰ 50 å€‹ |ret| < 0.15% â†’ æ¨™ 0**
- **æœ€çµ‚åˆ†å¸ƒ**ï¼šä¸‹è·Œ 35% / æŒå¹³ 5% / ä¸Šæ¼² 35% / å…¶ä»– 25%

---

## ğŸ¯ è§£æ±ºæ–¹æ¡ˆï¼ˆ3 ç¨®ç­–ç•¥ï¼‰

### æ–¹æ¡ˆ Aï¼šPT/SL ä¹Ÿæª¢æŸ¥ min_returnï¼ˆæ¨è–¦ï¼‰
**ç†å¿µ**ï¼šé›–ç„¶è§¸åŠ barrierï¼Œä½†å¦‚æœå¯¦éš›æ”¶ç›Šå¤ªå°ï¼Œè¦–ç‚ºã€Œé›œè¨Šã€æ¨™ç‚º 0

**ä¿®æ”¹é‚è¼¯**ï¼š
```python
if trigger_why == 'time':
    if np.abs(ret) < min_return:
        label = 0
    else:
        label = int(np.sign(ret))
else:  # PT/SL è§¸ç™¼
    # âœ… æ–°å¢ï¼šä¹Ÿæª¢æŸ¥ min_return
    if np.abs(ret) < min_return:
        label = 0  # é›–ç„¶è§¸åŠ barrierï¼Œä½†æ”¶ç›Šå¤ªå°
    else:
        label = int(np.sign(ret))
```

**å„ªé»**ï¼š
- ç¬¦åˆã€Œæ—¥æ²–äº¤æ˜“ã€é‚è¼¯ï¼šå¾®å°æ³¢å‹•ä¸å€¼å¾—äº¤æ˜“
- å¢åŠ ã€Œå¹³ã€æ¨™ç±¤æ¯”ä¾‹ï¼ˆé æœŸ 20-40%ï¼‰
- ä¿ç•™ Triple-Barrier çš„è·¯å¾‘ç‰¹æ€§

**ç¼ºé»**ï¼š
- å¯èƒ½èˆ‡ã€Œå…ˆè§¸åŠã€å“²å­¸ç¨æœ‰è¡çªï¼ˆä½†å¯¦å‹™æ›´åˆç†ï¼‰

**å»ºè­°åƒæ•¸**ï¼š
```yaml
min_return: 0.002  # æé«˜åˆ° 0.2%ï¼ˆç´„ 2 å€‹ tickï¼‰
pt_sl_check_min_return: true
```

---

### æ–¹æ¡ˆ Bï¼šæ”¾å¯¬ barrierï¼ˆå¢åŠ  time triggerï¼‰
**ç†å¿µ**ï¼šè®“ PT/SL æ›´é›£è§¸åŠï¼Œæ›´å¤šæ¨£æœ¬ç”±æ™‚é–“åˆ°æœŸæ±ºå®š

**ä¿®æ”¹åƒæ•¸**ï¼š
```yaml
triple_barrier:
  pt_multiplier: 5.0  # 3.5 â†’ 5.0ï¼ˆæ›´å¯¬ï¼‰
  sl_multiplier: 5.0
  max_holding: 40
  min_return: 0.0015
```

**å„ªé»**ï¼š
- ä¿æŒåŸå§‹é‚è¼¯ä¸è®Š
- å¢åŠ  time trigger æ¯”ä¾‹

**ç¼ºé»**ï¼š
- å¯èƒ½éŒ¯éçœŸå¯¦çš„æ­¢ç›ˆ/æ­¢æä¿¡è™Ÿ
- ã€Œå¹³ã€çš„å¢åŠ æœ‰é™ï¼ˆå› ç‚º time trigger ä¹Ÿå¸¸è¶…é min_returnï¼‰

---

### æ–¹æ¡ˆ Cï¼šæé«˜ min_return é–¾å€¼
**ç†å¿µ**ï¼šæŠŠã€Œä¸å¤ æ¸…æ™°ã€çš„æ¼²è·Œéƒ½è¦–ç‚ºå¹³

**ä¿®æ”¹åƒæ•¸**ï¼š
```yaml
triple_barrier:
  pt_multiplier: 3.5
  sl_multiplier: 3.5
  max_holding: 40
  min_return: 0.005  # æé«˜åˆ° 0.5%ï¼ˆ5 å€‹ tickï¼‰
```

**å„ªé»**ï¼š
- é‚è¼¯ç°¡å–®æ¸…æ™°
- ã€Œå¹³ã€æ¨™ç±¤å¢åŠ æ˜é¡¯

**ç¼ºé»**ï¼š
- 0.5% å¯èƒ½å¤ªå¤§ï¼ŒæœƒéŒ¯å¤±çœŸå¯¦çš„å°è¶¨å‹¢
- ä¸ç¬¦åˆé«˜é »äº¤æ˜“ç‰¹æ€§

---

## âœ… æ¨è–¦çµ„åˆæ–¹æ¡ˆï¼ˆA + åƒæ•¸å¾®èª¿ï¼‰

### ä½¿ç”¨æ”¹é€²ç‰ˆå‡½æ•¸
å·²æä¾› `scripts/tb_labels_improved.py` ä¸­çš„ `tb_labels_v2()`

### å»ºè­°é…ç½®
```yaml
triple_barrier:
  pt_multiplier: 4.0      # ç¨å¾®æ”¾å¯¬ï¼ˆ3.5 â†’ 4.0ï¼‰
  sl_multiplier: 4.0
  max_holding: 50         # ç¨å¾®å»¶é•·ï¼ˆ40 â†’ 50ï¼‰
  min_return: 0.0025      # æé«˜é–¾å€¼ï¼ˆ0.15% â†’ 0.25%ï¼‰
  pt_sl_check_min_return: true  # â† é—œéµæ–°å¢
```

### é æœŸæ•ˆæœ
- **ä¸‹è·Œ** (label=0)ï¼š28-32%
- **æŒå¹³** (label=1)ï¼š35-45% âœ…
- **ä¸Šæ¼²** (label=2)ï¼š28-32%

---

## ğŸ”§ å¯¦æ–½æ­¥é©Ÿ

### Step 1ï¼šæ¸¬è©¦æ”¹é€²ç‰ˆå‡½æ•¸
```bash
python scripts/test_tb_comparison.py --config configs/config_pro_v5_ml_optimal.yaml
```
é€™æœƒæ¯”è¼ƒ 3 ç¨®æ–¹æ³•çš„æ¨™ç±¤åˆ†å¸ƒã€‚

### Step 2ï¼šé¸æ“‡æœ€ä½³åƒæ•¸
æ ¹æ“šæ¸¬è©¦çµæœï¼Œèª¿æ•´é…ç½®æ–‡ä»¶ä¸­çš„ï¼š
- `min_return`
- `pt_multiplier` / `sl_multiplier`
- æ˜¯å¦å•Ÿç”¨ `pt_sl_check_min_return`

### Step 3ï¼šæ‡‰ç”¨åˆ°ç”Ÿç”¢æµç¨‹
ä¿®æ”¹ `extract_tw_stock_data_v5.py` ä¸­çš„ `tb_labels` å‡½æ•¸ï¼ˆæˆ–ç›´æ¥æ›¿æ›ç‚º `tb_labels_v2`ï¼‰

### Step 4ï¼šé‡æ–°ç”Ÿæˆæ•¸æ“š
```bash
python scripts/extract_tw_stock_data_v5.py \
    --input-dir ./data/temp \
    --output-dir ./data/processed_v5_balanced \
    --config configs/config_pro_v5_ml_optimal_v2.yaml
```

---

## ğŸ“ˆ é©—è­‰æ¸…å–®

ç”Ÿæˆæ–°æ•¸æ“šå¾Œï¼Œæª¢æŸ¥ï¼š
1. âœ… æ¨™ç±¤åˆ†å¸ƒï¼š`label_0` 30-45%
2. âœ… è§¸ç™¼åŸå› ï¼štime/up/down åˆ†å¸ƒåˆç†
3. âœ… éš¨æ©ŸæŠ½æŸ¥ï¼šç•«å‡ºåƒ¹æ ¼èµ°å‹¢ + barrierï¼Œç¢ºèªæ¨™ç±¤åˆç†
4. âœ… è¨“ç·´ç©©å®šæ€§ï¼šæ¨¡å‹è¨“ç·´æ™‚ loss ä¸‹é™æ­£å¸¸ï¼Œä¸åå‘æŸé¡

---

## ğŸ¯ å“²å­¸é¸æ“‡

### å°æ–¼ã€Œæ—¥æ²–äº¤æ˜“ã€
**æ¨è–¦ï¼šæ–¹æ¡ˆ Aï¼ˆè·¯å¾‘å°å‘ + PT/SL æª¢æŸ¥ min_returnï¼‰**

ç†ç”±ï¼š
1. å¯¦éš›äº¤æ˜“æœƒè¨­æ­¢ç›ˆæ­¢æï¼ˆç¬¦åˆ Triple-Barrierï¼‰
2. ä½†å¾®å°æ³¢å‹•ä¸å€¼å¾—åŸ·è¡Œï¼ˆç¬¦åˆ min_return æª¢æŸ¥ï¼‰
3. è¨“ç·´æ•¸æ“šæ‡‰åæ˜ ã€Œå€¼å¾—äº¤æ˜“çš„ä¿¡è™Ÿã€è€Œéã€Œæ‰€æœ‰æ³¢å‹•ã€
4. å¢åŠ ã€Œå¹³ã€æ¨™ç±¤ = å‘Šè¨´æ¨¡å‹ã€Œé€™ç¨®æƒ…æ³ä¸è¦å‡ºæ‰‹ã€â†’ é™ä½éåº¦äº¤æ˜“

### å¦‚æœæƒ³ç´”ç²¹é æ¸¬åƒ¹æ ¼æ–¹å‘
å¯è€ƒæ…®**çµ‚é»å°å‘**ï¼ˆæ–¹æ¡ˆ B åœ¨æˆ‘æä¾›çš„æ–‡æª”ä¸­ï¼‰ï¼š
- åªçœ‹å›ºå®šè¦–çª—å¾Œçš„æ¼²è·Œ
- æ›´ç°¡å–®ï¼Œä½†å¤±å»æ­¢ç›ˆæ­¢æè³‡è¨Š

---

## ğŸ“ é…ç½®æ–‡ä»¶ç¯„ä¾‹

å·²ç‚ºä½ æº–å‚™ï¼š`configs/config_pro_v5_balanced_neutral.yaml`
```yaml
triple_barrier:
  pt_multiplier: 4.0
  sl_multiplier: 4.0
  max_holding: 50
  min_return: 0.0025
  pt_sl_check_min_return: true  # æ–°å¢åƒæ•¸
```

ä½¿ç”¨ï¼š
```bash
python scripts/extract_tw_stock_data_v5.py \
    --config configs/config_pro_v5_balanced_neutral.yaml \
    --output-dir ./data/processed_v5_neutral_fix
```

