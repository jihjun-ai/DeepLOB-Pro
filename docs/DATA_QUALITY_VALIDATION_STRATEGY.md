# æ•¸æ“šè³ªé‡é©—è­‰ç­–ç•¥

**æ—¥æœŸ**: 2025-10-21
**ç‰ˆæœ¬**: v1.0
**åŸå‰‡**: **åœ¨æºé ­ä¿è­‰è³ªé‡ï¼Œåœ¨ä¸‹æ¸¸æª¢æŸ¥è³ªé‡**

---

## æ ¸å¿ƒåŸå‰‡

### âœ… æ­£ç¢ºåšæ³•ï¼šåˆ†å±¤é˜²ç¦¦

```
éšæ®µ 1: é è™•ç†ï¼ˆpreprocess_single_day.pyï¼‰
   â†“
   è§’è‰²: æ•¸æ“šæ¸…æ´—èˆ‡è³ªé‡ä¿è­‰
   è²¬ä»»: ç§»é™¤ç•°å¸¸å€¼ã€å¡«å……ç¼ºå¤±å€¼ã€é©—è­‰æ•¸æ“šå®Œæ•´æ€§
   è¼¸å‡º: ä¹¾æ·¨çš„ NPZ æª”æ¡ˆï¼ˆç„¡ mids=0ã€ç„¡ NaNï¼‰

éšæ®µ 2: è¨“ç·´æ•¸æ“šç”Ÿæˆï¼ˆextract_tw_stock_data_v6.pyï¼‰
   â†“
   è§’è‰²: æ•¸æ“šè³ªé‡æª¢æŸ¥èˆ‡å ±è­¦
   è²¬ä»»: é©—è­‰è¼¸å…¥æ•¸æ“šè³ªé‡ã€å ±å‘Šå•é¡Œã€æ‹’çµ•è™•ç†ç•°å¸¸æ•¸æ“š
   è¼¸å‡º: è¨“ç·´é›† NPZï¼ˆæˆ–å ±éŒ¯ï¼‰
```

### âŒ éŒ¯èª¤åšæ³•ï¼šä¸‹æ¸¸ä¿®è£œ

```python
# éŒ¯èª¤ç¤ºç¯„ï¼ˆä¸è¦é€™æ¨£åšï¼‰
def process_data(data):
    # éœé»˜ä¿®è£œæ•¸æ“šå•é¡Œ
    data = data.replace(0, np.nan)
    data = data.ffill()
    # ... ç¹¼çºŒè™•ç†
```

**å•é¡Œ**ï¼š
1. âŒ æ©è“‹äº†ä¸Šæ¸¸çš„æ•¸æ“šè³ªé‡å•é¡Œ
2. âŒ ç„¡æ³•è¿½æº¯å•é¡Œæ ¹æº
3. âŒ å¯èƒ½å¼•å…¥æ–°çš„åå·®

---

## å¯¦ä½œç­–ç•¥

### éšæ®µ 1: é è™•ç†éšæ®µï¼ˆä¿®å¾©å•é¡Œï¼‰

**æ–‡ä»¶**: `scripts/preprocess_single_day.py`

#### è²¬ä»»
1. **æ¸…æ´—åŸå§‹æ•¸æ“š**
   - ç§»é™¤è©¦æ’®ï¼ˆtrial=1ï¼‰
   - ç§»é™¤äº¤æ˜“æ™‚é–“å¤–æ•¸æ“š
   - ç§»é™¤åƒ¹å·®ç•°å¸¸æ•¸æ“š

2. **1Hz èšåˆ**
   - æŒ‰ç§’èšåˆäº‹ä»¶
   - å‰å‘å¡«å……ï¼ˆffill, æœ€å¤š 120 ç§’ï¼‰
   - **ç§»é™¤ç„¡æ³•å¡«å……çš„ç¼ºå¤±æ¡¶**ï¼ˆmask=2, mids=0ï¼‰

3. **é©—è­‰è¼¸å‡ºè³ªé‡**
   ```python
   # ç¢ºä¿æ²’æœ‰ mids=0
   if (mids == 0).any():
       logging.warning(f"ç™¼ç¾ {(mids == 0).sum()} å€‹ mids=0")
       valid_mids = mids > 0
       features = features[valid_mids]
       mids = mids[valid_mids]
   ```

#### è¼¸å‡ºä¿è­‰
- âœ… `mids` å…¨éƒ¨ > 0
- âœ… ç„¡ NaN å€¼
- âœ… `features` èˆ‡ `mids` é•·åº¦åŒ¹é…

---

### éšæ®µ 2: è¨“ç·´æ•¸æ“šç”Ÿæˆéšæ®µï¼ˆæª¢æŸ¥å•é¡Œï¼‰

**æ–‡ä»¶**: `scripts/extract_tw_stock_data_v6.py`

#### è²¬ä»»
1. **é©—è­‰è¼¸å…¥æ•¸æ“š**ï¼ˆè¼‰å…¥æ™‚ï¼‰
   ```python
   def validate_preprocessed_data(features, mids, meta, npz_path):
       """ä¸ä¿®è£œï¼Œåªæª¢æŸ¥"""
       # æª¢æŸ¥ 1: mids=0
       if (mids == 0).any():
           logging.error(f"âŒ ç™¼ç¾ mids=0ï¼Œæª”æ¡ˆ: {npz_path}")
           return False

       # æª¢æŸ¥ 2: NaN
       if np.isnan(mids).any():
           logging.error(f"âŒ ç™¼ç¾ NaNï¼Œæª”æ¡ˆ: {npz_path}")
           return False

       # ... å…¶ä»–æª¢æŸ¥
       return True
   ```

2. **é©—è­‰è¨ˆç®—çµæœ**ï¼ˆè™•ç†æ™‚ï¼‰
   ```python
   def ewma_vol(close):
       """å‡è¨­è¼¸å…¥å·²æ¸…æ´—"""
       # æ•¸æ“šè³ªé‡æª¢æŸ¥ï¼ˆä¸ä¿®è£œï¼‰
       if (close == 0).any():
           raise ValueError("âŒ mids=0 æ‡‰åœ¨é è™•ç†éšæ®µç§»é™¤ï¼")

       # æ­£å¸¸è¨ˆç®—
       ret = np.log(close).diff()
       ...
   ```

3. **å ±å‘Šæ•¸æ“šè³ªé‡å•é¡Œ**
   ```python
   logging.warning(f"âš ï¸ è·³éæœ‰å•é¡Œçš„æ•¸æ“š: {npz_path}")
   global_stats["data_quality_errors"] += 1
   ```

#### è¼¸å‡ºè¡Œç‚º
- âœ… å¦‚æœæ•¸æ“šè³ªé‡é€šéï¼šæ­£å¸¸ç”Ÿæˆè¨“ç·´é›†
- âš ï¸ å¦‚æœç™¼ç¾å•é¡Œï¼šè¨˜éŒ„éŒ¯èª¤ã€è·³éè©²æ–‡ä»¶ã€è¿”å›ç‹€æ…‹ç¢¼ 2
- âŒ å¦‚æœå•é¡Œåš´é‡ï¼šæ‹‹å‡ºç•°å¸¸ã€åœæ­¢åŸ·è¡Œ

---

## æ•¸æ“šè³ªé‡æª¢æŸ¥æ¸…å–®

### è¼‰å…¥æ™‚æª¢æŸ¥ï¼ˆvalidate_preprocessed_dataï¼‰

| æª¢æŸ¥é … | æ¢ä»¶ | è¡Œå‹• |
|--------|------|------|
| mids=0 | `(mids == 0).any()` | âŒ è¨˜éŒ„éŒ¯èª¤ï¼Œè·³éæª”æ¡ˆ |
| NaN å€¼ | `np.isnan(mids).any()` | âŒ è¨˜éŒ„éŒ¯èª¤ï¼Œè·³éæª”æ¡ˆ |
| è² åƒ¹æ ¼ | `(mids < 0).any()` | âŒ è¨˜éŒ„éŒ¯èª¤ï¼Œè·³éæª”æ¡ˆ |
| NaN ç‰¹å¾µ | `np.isnan(features).any()` | âŒ è¨˜éŒ„éŒ¯èª¤ï¼Œè·³éæª”æ¡ˆ |
| é•·åº¦åŒ¹é… | `features.shape[0] != len(mids)` | âŒ è¨˜éŒ„éŒ¯èª¤ï¼Œè·³éæª”æ¡ˆ |

### è¨ˆç®—æ™‚æª¢æŸ¥ï¼ˆewma_vol, tb_labelsï¼‰

| æª¢æŸ¥é … | ä½ç½® | è¡Œå‹• |
|--------|------|------|
| mids=0 | ewma_vol é–‹é ­ | ğŸš¨ æ‹‹å‡º ValueError |
| NaN åƒ¹æ ¼ | ewma_vol é–‹é ­ | ğŸš¨ æ‹‹å‡º ValueError |
| è² åƒ¹æ ¼ | ewma_vol é–‹é ­ | ğŸš¨ æ‹‹å‡º ValueError |
| NaN æ”¶ç›Šç‡ | tb_labels è¨ˆç®—å¾Œ | ğŸš¨ æ‹‹å‡º ValueError |

---

## éŒ¯èª¤è¨Šæ¯è¨­è¨ˆ

### è‰¯å¥½çš„éŒ¯èª¤è¨Šæ¯ç¯„ä¾‹

```python
logging.error(
    f"âŒ æ•¸æ“šè³ªé‡éŒ¯èª¤ [{symbol} @ {date}]\n"
    f"   ç™¼ç¾ {zero_count} å€‹ mids=0 ({zero_pct:.1f}%)\n"
    f"   æª”æ¡ˆ: {npz_path}\n"
    f"   â†’ é è™•ç†éšæ®µ (preprocess_single_day.py) æ‡‰è©²ç§»é™¤é€™äº›é»ï¼"
)
```

**å„ªé»**ï¼š
- âœ… æ¸…æ¥šèªªæ˜å•é¡Œï¼ˆmids=0ï¼‰
- âœ… æä¾›å®šé‡è³‡è¨Šï¼ˆæ•¸é‡ã€ç™¾åˆ†æ¯”ï¼‰
- âœ… æŒ‡å‡ºå•é¡Œä¾†æºï¼ˆå“ªå€‹æª”æ¡ˆï¼‰
- âœ… å»ºè­°ä¿®å¾©æ–¹æ³•ï¼ˆé‡æ–°é è™•ç†ï¼‰

### ç³Ÿç³•çš„éŒ¯èª¤è¨Šæ¯ç¯„ä¾‹

```python
# âŒ ä¸è¦é€™æ¨£åš
logging.error("æ•¸æ“šæœ‰å•é¡Œ")  # å¤ªæ¨¡ç³Š
logging.error(f"éŒ¯èª¤: {e}")  # æ²’æœ‰ä¸Šä¸‹æ–‡
# æˆ–æ›´ç³Ÿï¼šå®Œå…¨ä¸å ±éŒ¯ï¼Œéœé»˜ä¿®è£œ
```

---

## æ¸¬è©¦èˆ‡é©—è­‰

### æ¸¬è©¦è…³æœ¬

```bash
# å®Œæ•´æµæ°´ç·šæ¸¬è©¦
test_complete_pipeline.bat
```

### é æœŸè¡Œç‚º

#### æƒ…å¢ƒ 1: æ•¸æ“šè³ªé‡è‰¯å¥½ âœ…

```
[é è™•ç†éšæ®µ]
âœ… èšåˆå¾Œ: 16,197 æ™‚é–“é»ï¼Œ223 å€‹è‚¡ç¥¨
âœ… é€šééæ¿¾: 112 æª”è‚¡ç¥¨

[è¨“ç·´æ•¸æ“šç”Ÿæˆéšæ®µ]
âœ… è¼‰å…¥ NPZ: 112 å€‹æª”æ¡ˆ
âœ… æ•¸æ“šè³ªé‡æª¢æŸ¥: å…¨éƒ¨é€šé
âœ… æˆåŠŸç”Ÿæˆè¨“ç·´é›†: 5,584,553 æ¨£æœ¬
```

#### æƒ…å¢ƒ 2: ç™¼ç¾æ•¸æ“šè³ªé‡å•é¡Œ âš ï¸

```
[é è™•ç†éšæ®µ]
âš ï¸ è­¦å‘Šï¼šç™¼ç¾ 15 å€‹ mids=0 çš„é»ï¼ˆå¯èƒ½æ˜¯æ•¸æ“šå•é¡Œï¼‰
âœ… å·²ç§»é™¤ï¼Œå‰©é¤˜ 16,182 æ™‚é–“é»

[è¨“ç·´æ•¸æ“šç”Ÿæˆéšæ®µ]
âœ… è¼‰å…¥ NPZ: 112 å€‹æª”æ¡ˆ
âœ… æ•¸æ“šè³ªé‡æª¢æŸ¥: å…¨éƒ¨é€šé
âœ… æˆåŠŸç”Ÿæˆè¨“ç·´é›†
```

#### æƒ…å¢ƒ 3: åš´é‡æ•¸æ“šè³ªé‡å•é¡Œ âŒ

```
[é è™•ç†éšæ®µ]
ï¼ˆå‡è¨­æœ‰ bugï¼Œæ²’æœ‰ç§»é™¤ mids=0ï¼‰

[è¨“ç·´æ•¸æ“šç”Ÿæˆéšæ®µ]
âŒ æ•¸æ“šè³ªé‡éŒ¯èª¤ [3048 @ 20250902]
   ç™¼ç¾ 15 å€‹ mids=0 (0.1%)
   æª”æ¡ˆ: data/preprocessed_v5_1hz/daily/20250902/3048.npz
   â†’ é è™•ç†éšæ®µæ‡‰è©²ç§»é™¤é€™äº›é»ï¼
âš ï¸ è·³éæœ‰å•é¡Œçš„æ•¸æ“š

æœ€çµ‚çµ±è¨ˆ:
  âš ï¸ æ•¸æ“šè³ªé‡éŒ¯èª¤: 1 å€‹æª”æ¡ˆ
     â†’ è«‹æª¢æŸ¥ä¸Šæ–¹çš„éŒ¯èª¤è¨Šæ¯ï¼Œä¸¦é‡æ–°é‹è¡Œé è™•ç†ï¼

é€€å‡ºç¢¼: 2ï¼ˆè­¦å‘Šï¼‰
```

---

## ä¿®å¾©æµç¨‹

### å¦‚æœç™¼ç¾æ•¸æ“šè³ªé‡å•é¡Œ

#### æ­¥é©Ÿ 1: æª¢æŸ¥éŒ¯èª¤æ—¥èªŒ

```bash
# æŸ¥æ‰¾éŒ¯èª¤è¨Šæ¯
grep "âŒ æ•¸æ“šè³ªé‡éŒ¯èª¤" logs/extract_v6.log
```

#### æ­¥é©Ÿ 2: é‡æ–°é è™•ç†å•é¡Œæª”æ¡ˆ

```bash
# å–®æª”é‡æ–°é è™•ç†
python scripts\preprocess_single_day.py ^
    --input data\temp\20250902.txt ^
    --output-dir data\preprocessed_v5_1hz ^
    --config configs\config_pro_v5_ml_optimal.yaml
```

#### æ­¥é©Ÿ 3: é©—è­‰ä¿®å¾©

```bash
# é‡æ–°æª¢æŸ¥è©²æª”æ¡ˆ
python -c "
import numpy as np
data = np.load('data/preprocessed_v5_1hz/daily/20250902/3048.npz')
mids = data['mids']
print(f'mids min: {mids.min():.2f}')
print(f'mids max: {mids.max():.2f}')
print(f'é›¶å€¼æ•¸é‡: {(mids == 0).sum()}')
"
```

#### æ­¥é©Ÿ 4: é‡æ–°ç”Ÿæˆè¨“ç·´æ•¸æ“š

```bash
python scripts\extract_tw_stock_data_v6.py ^
    --preprocessed-dir data\preprocessed_v5_1hz ^
    --output-dir data\processed_v6 ^
    --config configs\config_pro_v5_ml_optimal.yaml
```

---

## é€€å‡ºç‹€æ…‹ç¢¼

| ç‹€æ…‹ç¢¼ | æ„ç¾© | è¡Œå‹• |
|--------|------|------|
| 0 | âœ… æˆåŠŸï¼Œç„¡å•é¡Œ | ç¹¼çºŒä¸‹ä¸€æ­¥ |
| 1 | âŒ åš´é‡éŒ¯èª¤ï¼ˆç„¡æ³•ç¹¼çºŒï¼‰ | æª¢æŸ¥é…ç½®æˆ–è¼¸å…¥ |
| 2 | âš ï¸ è­¦å‘Šï¼ˆæœ‰å•é¡Œä½†å·²è·³éï¼‰ | é‡æ–°é è™•ç†å•é¡Œæª”æ¡ˆ |

### ä½¿ç”¨ç¯„ä¾‹

```bash
python scripts\extract_tw_stock_data_v6.py ...
if %ERRORLEVEL% EQU 2 (
    echo âš ï¸ ç™¼ç¾æ•¸æ“šè³ªé‡å•é¡Œï¼Œå»ºè­°é‡æ–°é è™•ç†
)
```

---

## ç›¸é—œæ–‡ä»¶

- [Bug ä¿®å¾©å ±å‘Š: mids=0](docs/BUG_FIX_MIDS_ZERO.md)
- [æ•¸æ“šè³ªé‡é©—è­‰å®Œæ•´æµç¨‹](docs/æ•¸æ“šè³ªé‡é©—è­‰å®Œæ•´æµç¨‹(ç”¢ç”Ÿè¨“ç·´è³‡æ–™).md)
- [1Hz èšåˆè¼¸å‡ºåˆ†æ](docs/1HZ_OUTPUT_ANALYSIS_REPORT.md)

---

## æœ€ä½³å¯¦è¸ç¸½çµ

### âœ… Doï¼ˆæ¨è–¦åšæ³•ï¼‰

1. **åœ¨æœ€æ—©éšæ®µä¿è­‰è³ªé‡**
   ```python
   # é è™•ç†éšæ®µï¼šç§»é™¤å•é¡Œ
   if (mids == 0).any():
       mids = mids[mids > 0]
   ```

2. **åœ¨ä¸‹æ¸¸æª¢æŸ¥è³ªé‡**
   ```python
   # è¨“ç·´æ•¸æ“šç”Ÿæˆéšæ®µï¼šæª¢æŸ¥ä¸¦å ±è­¦
   if (mids == 0).any():
       raise ValueError("æ•¸æ“šæ‡‰è©²å·²æ¸…æ´—ï¼")
   ```

3. **æä¾›æ¸…æ™°çš„éŒ¯èª¤è¨Šæ¯**
   ```python
   logging.error(
       f"âŒ å•é¡Œæè¿°\n"
       f"   è©³ç´°è³‡è¨Š\n"
       f"   â†’ ä¿®å¾©å»ºè­°"
   )
   ```

4. **ä½¿ç”¨é€€å‡ºç‹€æ…‹ç¢¼**
   ```python
   if has_warnings:
       return 2  # è­¦å‘Šç‹€æ…‹
   ```

### âŒ Don'tï¼ˆé¿å…åšæ³•ï¼‰

1. **ä¸è¦åœ¨ä¸‹æ¸¸éœé»˜ä¿®è£œ**
   ```python
   # âŒ ä¸è¦é€™æ¨£åš
   data = data.fillna(0)  # æ©è“‹å•é¡Œ
   ```

2. **ä¸è¦ä½¿ç”¨æ¨¡ç³Šçš„éŒ¯èª¤è¨Šæ¯**
   ```python
   # âŒ ä¸è¦é€™æ¨£åš
   logging.error("æœ‰å•é¡Œ")
   ```

3. **ä¸è¦å¿½ç•¥æ•¸æ“šè³ªé‡å•é¡Œ**
   ```python
   # âŒ ä¸è¦é€™æ¨£åš
   try:
       process_data(data)
   except:
       pass  # å¿½ç•¥éŒ¯èª¤
   ```

---

**ä½œè€…**: Claude (Sonnet 4.5)
**å¯©æ ¸**: å¾…ç”¨æˆ¶ç¢ºèª
**ç‰ˆæœ¬**: v1.0
**ç‹€æ…‹**: âœ… å·²å¯¦ä½œ
