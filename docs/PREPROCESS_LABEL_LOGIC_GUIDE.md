# preprocess_single_day.py 標籤生成邏輯說明

**版本**: v2.1-simplified
**更新日期**: 2025-10-24
**標籤方法**: Trend Stable（穩定趨勢標籤）

---

## 一、標籤生成概述

### 1.1 核心目標

`preprocess_single_day.py` 的標籤生成功能旨在為每個時間點（1秒）預測**未來 2 分鐘內的價格趨勢方向**，用於日內波段交易策略。

### 1.2 標籤含義

生成的標籤為三分類：

| 標籤值 | 名稱 | 含義 | 交易建議 |
|-------|------|------|---------|
| **-1** | Down（下跌） | 未來將出現下跌趨勢 | 做空或離場 |
| **0** | Neutral（橫盤） | 未來無明顯趨勢（震盪） | 觀望，不交易 |
| **1** | Up（上漲） | 未來將出現上漲趨勢 | 做多或持有 |

### 1.3 標籤方法選擇

目前採用 **Trend Stable（穩定趨勢標籤）**：
- ✅ 適合日內波段交易（1-2 次/天，≥1% 利潤）
- ✅ 減少震盪區間的頻繁翻轉（>70% 時間為 Neutral）
- ✅ 提高趨勢識別的可靠性
- ❌ 不適合超高頻交易（10-20 次/天）

**已棄用的方法**：
- Triple-Barrier（適合超短線，但標籤不穩定）
- Trend Adaptive（震盪區間頻繁翻轉）

---

## 二、Trend Stable 標籤方法

### 2.1 核心理念

**Trend Stable 是一種保守的趨勢識別方法**，設計原則：

> **寧可錯過小波動，也不要誤判震盪為趨勢**

主要特點：
1. **高門檻** - 進入趨勢需要滿足多重條件
2. **低退出** - 趨勢確認後不輕易退出
3. **多重驗證** - 幅度 × 方向 × 持續性三重檢查
4. **平滑處理** - 消除單點噪音

### 2.2 判定流程（五階段）

```
原始價格
  ↓
【階段 1】計算前瞻報酬率與方向一致性
  ↓
【階段 2】設定進/出門檻（相對 + 絕對）
  ↓
【階段 3】生成原始方向信號（幅度 + 一致性）
  ↓
【階段 4】狀態機 + 遲滯效應（持續性驗證）
  ↓
【階段 5】多數票平滑（消除抖動）
  ↓
最終標籤 {-1, 0, 1}
```

---

## 三、五階段詳細說明

### 階段 1: 計算前瞻指標

#### 1.1 前瞻報酬率

**定義**：從當前時刻看未來 `lookforward` 秒（預設 150 秒）的價格變化率。

**計算公式**：
```
前瞻報酬率(t) = (價格(t+150) / 價格(t)) - 1
```

**物理意義**：
- 如果我現在買入，持有 2.5 分鐘後賣出，會賺/賠多少？
- 正值 = 未來上漲，負值 = 未來下跌

**範例**：
```
時刻 t=0:
  當前價格 = 100.0
  未來價格(t+150) = 102.0
  前瞻報酬率 = (102.0 / 100.0) - 1 = 0.02 = 2.0%
  → 顯示未來有上漲趨勢
```

#### 1.2 方向一致性

**定義**：未來 150 秒內，價格逐秒變化的**方向穩定度**。

**計算邏輯**：
```
1. 計算每秒的價格變化方向（漲 = +1，跌 = -1，平 = 0）
2. 統計未來 150 秒內：
   - 上漲步數（step > 0）
   - 下跌步數（step < 0）
3. 計算比例：
   - 上漲一致性 = 上漲步數 / 總步數
   - 下跌一致性 = 下跌步數 / 總步數
```

**物理意義**：
- 趨勢不僅要「幅度大」，還要「方向穩定」
- 震盪區間：上漲步數 ≈ 下跌步數 ≈ 50%
- 上漲趨勢：上漲步數 > 60%，下跌步數 < 40%
- 下跌趨勢：下跌步數 > 60%，上漲步數 < 40%

**範例**：
```
未來 150 秒價格變化：
  [+1, +1, -1, +1, +1, +1, -1, +1, +1, +1, ...]

統計結果：
  上漲步數 = 95 次
  下跌步數 = 45 次
  總步數 = 140 次（排除平盤）

  上漲一致性 = 95 / 140 = 67.9%
  下跌一致性 = 45 / 140 = 32.1%

結論：
  上漲一致性 > 60% → 方向穩定，可能是上漲趨勢
```

---

### 階段 2: 設定進/出門檻

#### 2.1 門檻設計（雙重保護）

Trend Stable 使用**相對門檻 + 絕對門檻**雙重機制：

**A. 相對門檻**（基於波動率）

```
進入門檻 = vol_multiplier × 波動率(σ)
          = 2.5 × σ

退出門檻 = vol_multiplier × hysteresis_ratio × σ
          = 2.5 × 0.6 × σ
          = 1.5 × σ
```

**物理意義**：
- 高波動股票（σ 大）→ 門檻高（避免噪音）
- 低波動股票（σ 小）→ 門檻低（捕捉小趨勢）

**範例**：
```
股票 A（高波動）：
  波動率 σ = 0.01 (1%)
  進入門檻 = 2.5 × 0.01 = 0.025 (2.5%)
  退出門檻 = 1.5 × 0.01 = 0.015 (1.5%)

股票 B（低波動）：
  波動率 σ = 0.002 (0.2%)
  進入門檻 = 2.5 × 0.002 = 0.005 (0.5%)
  退出門檻 = 1.5 × 0.002 = 0.003 (0.3%)
```

**B. 絕對門檻**（防止過低）

**問題**：低波動時，相對門檻可能過小（例如 0.125%），導致微小漂移被誤判為趨勢。

**解決方案**：設置絕對下限

```
實際進入門檻 = max(相對門檻, 絕對地板)
             = max(2.5σ, 0.20%)

實際退出門檻 = max(相對門檻, 絕對地板)
             = max(1.5σ, 0.10%)
```

**範例**：
```
股票 C（極低波動）：
  波動率 σ = 0.0005 (0.05%)

  相對進入門檻 = 2.5 × 0.0005 = 0.00125 (0.125%)  ← 太小！
  絕對地板 = 0.0020 (0.20%)

  實際進入門檻 = max(0.00125, 0.0020) = 0.20%  ✓ 合理
```

#### 2.2 遲滯效應（Hysteresis）

**核心思想**：進入容易，退出難 → 避免邊界抖動

```
進入趨勢（嚴格）：需要突破 2.5σ 或 0.20%
退出趨勢（寬鬆）：僅需跌破 1.5σ 或 0.10%
```

**物理意義**：
- 類似溫控器的開關邏輯
- 冷氣：溫度 > 28°C 開啟，< 26°C 關閉（不會在 27°C 頻繁開關）
- 趨勢：漲幅 > 2.5% 確認上漲，回調 < 1.5% 才退出

**範例**：
```
價格變動序列：
  t=0:   100.0  → 報酬率 = 0%     → Neutral
  t=10:  102.6  → 報酬率 = 2.6%   → 突破 2.5% 進入門檻 → Up
  t=20:  103.5  → 報酬率 = 3.5%   → 維持 Up
  t=30:  102.0  → 報酬率 = 2.0%   → 高於 1.5% 退出門檻 → 仍是 Up ✓
  t=40:  101.0  → 報酬率 = 1.0%   → 跌破 1.5% → 退出趨勢 → Neutral
```

---

### 階段 3: 生成原始方向信號

#### 3.1 雙重條件檢查

每個時間點的原始方向需**同時滿足**兩個條件：

**條件 A：幅度門檻**
```
上漲方向：前瞻報酬率 > 進入門檻
下跌方向：前瞻報酬率 < -進入門檻
```

**條件 B：方向一致性**
```
上漲方向：上漲一致性 ≥ 60%
下跌方向：下跌一致性 ≥ 60%
```

#### 3.2 判定邏輯

```python
if (前瞻報酬率 > 0.20%) AND (上漲一致性 ≥ 60%):
    原始方向 = 1  # Up
elif (前瞻報酬率 < -0.20%) AND (下跌一致性 ≥ 60%):
    原始方向 = -1  # Down
else:
    原始方向 = 0  # Neutral
```

**範例**：

| 時刻 | 前瞻報酬率 | 上漲一致性 | 下跌一致性 | 幅度檢查 | 方向檢查 | 原始方向 |
|-----|----------|----------|----------|---------|---------|---------|
| t1  | +2.5%    | 70%      | 30%      | ✓       | ✓       | **1 (Up)** |
| t2  | +0.1%    | 55%      | 45%      | ✗       | ✗       | **0 (Neutral)** |
| t3  | +3.0%    | 52%      | 48%      | ✓       | ✗       | **0 (Neutral)** |
| t4  | -2.8%    | 35%      | 65%      | ✓       | ✓       | **-1 (Down)** |

**重點**：
- t1：幅度大 + 方向穩定 → **確認上漲趨勢**
- t2：幅度不足 → **震盪，不交易**
- t3：幅度夠但方向不穩（震盪上漲）→ **不確認，避免假信號**
- t4：幅度大 + 方向穩定 → **確認下跌趨勢**

---

### 階段 4: 狀態機 + 持續性驗證

#### 4.1 狀態機設計

Trend Stable 使用三狀態機制：

```
State 0: Neutral（橫盤）
State 1: Up（上漲趨勢）
State -1: Down（下跌趨勢）
```

#### 4.2 狀態轉換規則

**A. 從 Neutral → Up/Down**

**條件**：原始方向連續 N 秒保持同方向（預設 45 秒）

```
if State == Neutral:
    if 原始方向 == 1:
        計數器 += 1
        if 計數器 >= 45 秒:
            State → Up
    elif 原始方向 == -1:
        計數器 += 1
        if 計數器 >= 45 秒:
            State → Down
    else:
        計數器 = 0  # 重置
```

**物理意義**：
- 短暫觸發不算（過濾噪音）
- 必須連續 45 秒維持方向才確認趨勢
- 避免單根 K 線誤判

**範例**：
```
原始方向序列：[0, 0, 1, 1, 1, ..., 1 (連續 45 秒), 1, 1, ...]
                    ↑                      ↑
                  開始計數              計數到 45 → 確認 Up
```

**B. 從 Up/Down → Neutral**

**條件**：退出信號連續 N 秒（預設 45 秒）

```
if State == Up:
    # 檢查退出條件（雙重）
    退出信號 = (前瞻報酬率 < -退出門檻) OR (上漲一致性 < 40%)

    if 退出信號:
        計數器 += 1
        if 計數器 >= 45 秒:
            State → Neutral
    else:
        計數器 = 0  # 重置
```

**退出雙重條件**：
1. **反向突破**：前瞻報酬率 < -1.0%（退出門檻）
2. **方向崩潰**：上漲一致性 < 40%（= 1.0 - 60%）

**物理意義**：
- 趨勢確認後不輕易退出
- 允許短暫回調（遲滯效應）
- 只有反轉或方向崩潰才退出

**範例**：
```
State = Up，退出門檻 = 1.0%

時刻序列：
  t=0:  報酬率 = +2.0%, 一致性 = 70%  → 維持 Up
  t=10: 報酬率 = +0.5%, 一致性 = 65%  → 維持 Up（允許回調）
  t=20: 報酬率 = -0.8%, 一致性 = 55%  → 維持 Up（未達退出門檻）
  t=30: 報酬率 = -1.2%, 一致性 = 45%  → 觸發退出（計數 +1）
  t=40: 報酬率 = -1.5%, 一致性 = 40%  → 繼續退出（計數 +2）
  ...
  t=70: 計數達到 45 秒 → State 轉為 Neutral
```

#### 4.3 狀態機流程圖

```
┌─────────────┐
│  Neutral    │ ← 初始狀態
│   (State 0) │
└─────┬───────┘
      │
      ├─ 原始方向 = 1（連續 45 秒）→ ┌──────────┐
      │                              │   Up     │
      │                              │ (State 1)│
      │                              └─────┬────┘
      │                                    │
      │                   退出信號（45秒） │
      │                              ←─────┘
      │
      ├─ 原始方向 = -1（連續 45 秒）→ ┌──────────┐
      │                               │  Down    │
      │                               │(State -1)│
      │                               └─────┬────┘
      │                                     │
      │                   退出信號（45秒）  │
      └─────────────────────────── ←───────┘
```

---

### 階段 5: 多數票平滑

#### 5.1 平滑目的

即使經過狀態機，仍可能有單點抖動：

```
狀態序列：[0, 0, 0, 1, 0, 0, 0, 1, 1, 1, ...]
                     ↑     ↑
                   單點雜訊（需消除）
```

#### 5.2 多數票算法

**窗口大小**：21 秒（奇數，預設）

**規則**：
```
對於每個時刻 t：
  1. 取窗口 [t-10, t+10]（共 21 個點）
  2. 統計窗口內的標籤分布：
     - Down 數量（-1）
     - Neutral 數量（0）
     - Up 數量（1）
  3. 採用多數票：
     if Down 數量最多 且 Down > Neutral 且 Down > Up:
         標籤(t) = -1
     elif Up 數量最多 且 Up > Neutral 且 Up > Down:
         標籤(t) = 1
     else:
         標籤(t) = 0
```

**範例**：

```
原始狀態序列：
  [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1]
                              ↑
                           t=8（檢查此點）

窗口範圍 [t-10 ~ t+10] = [-2 ~ 18]（實際從 0 開始）:
  [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1]
   ↑───────────────────────窗口 21 個點──────────────────↑

統計：
  Down (-1) = 0 個
  Neutral (0) = 13 個
  Up (1) = 8 個

多數票結果：
  Neutral 最多 → 標籤(t=8) = 0

修正後：
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1]
                           ↑
                      單點 1 被修正為 0
```

#### 5.3 平滑效果

**平滑前**（抖動）：
```
[0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, ...]
        ↑     ↑     ↑           ↑
      單點雜訊（不穩定）
```

**平滑後**（穩定）：
```
[0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, ...]
                           ↑
                      趨勢開始明確
```

---

## 四、參數配置說明

### 4.1 核心參數表

| 參數名稱 | 預設值 | 單位 | 物理意義 | 調整建議 |
|---------|-------|------|---------|---------|
| `lookforward` | 150 | 秒 | 前瞻窗口（2.5 分鐘） | 波段↑，短線↓ |
| `vol_multiplier` | 2.5 | 倍 | 進入趨勢門檻 | 保守↑，激進↓ |
| `hysteresis_ratio` | 0.6 | 比例 | 退出/進入比例 | 穩定↑，靈敏↓ |
| `smooth_window` | 21 | 秒 | 平滑窗口 | 平滑↑，靈敏↓ |
| `min_trend_duration` | 45 | 秒 | 最短趨勢持續 | 嚴格↑，寬鬆↓ |
| `abs_floor_enter` | 0.0020 | 比例 | 絕對進入地板（0.20%） | 保守↑ |
| `abs_floor_exit` | 0.0010 | 比例 | 絕對退出地板（0.10%） | 穩定↑ |
| `dir_consistency` | 0.60 | 比例 | 方向一致性（60%） | 嚴格↑ |

### 4.2 參數對標籤分布的影響

**A. 增加 `lookforward`（150 → 300 秒）**

```
效果：
  - Neutral ↑↑（震盪時間更長）
  - Up/Down ↓（只捕捉長趨勢）
  - 交易頻率 ↓↓

適合：
  - 日內波段交易
  - 低手續費環境
```

**B. 降低 `vol_multiplier`（2.5 → 1.5）**

```
效果：
  - Neutral ↓（更容易進入趨勢）
  - Up/Down ↑（捕捉小波動）
  - 交易頻率 ↑
  - 假信號 ↑↑（風險）

適合：
  - 高勝率需求
  - 高流動性股票
```

**C. 增加 `min_trend_duration`（45 → 90 秒）**

```
效果：
  - Neutral ↑（需要更長持續性）
  - 趨勢切換次數 ↓
  - 趨勢穩定性 ↑

適合：
  - 避免頻繁交易
  - 低手續費敏感度
```

### 4.3 配置範例

#### 場景 1: 保守波段交易（推薦）

```yaml
trend_labeling:
  lookforward: 150          # 2.5 分鐘
  vol_multiplier: 2.5       # 高門檻
  hysteresis_ratio: 0.6     # 遲滯
  smooth_window: 21         # 21 秒平滑
  min_trend_duration: 45    # 45 秒持續
  abs_floor_enter: 0.0020   # 0.20%
  abs_floor_exit: 0.0010    # 0.10%
  dir_consistency: 0.60     # 60%
```

**預期分布**：Down 25% / Neutral 50% / Up 25%

#### 場景 2: 激進短線交易

```yaml
trend_labeling:
  lookforward: 60           # 1 分鐘
  vol_multiplier: 1.5       # 低門檻
  hysteresis_ratio: 0.7     # 更窄遲滯
  smooth_window: 11         # 11 秒平滑
  min_trend_duration: 20    # 20 秒持續
  abs_floor_enter: 0.0010   # 0.10%
  abs_floor_exit: 0.0005    # 0.05%
  dir_consistency: 0.55     # 55%
```

**預期分布**：Down 35% / Neutral 30% / Up 35%

#### 場景 3: 極保守（僅捕捉大趨勢）

```yaml
trend_labeling:
  lookforward: 300          # 5 分鐘
  vol_multiplier: 3.0       # 超高門檻
  hysteresis_ratio: 0.5     # 寬遲滯
  smooth_window: 31         # 31 秒平滑
  min_trend_duration: 90    # 90 秒持續
  abs_floor_enter: 0.0030   # 0.30%
  abs_floor_exit: 0.0015    # 0.15%
  dir_consistency: 0.65     # 65%
```

**預期分布**：Down 15% / Neutral 70% / Up 15%

---

## 五、標籤質量控制

### 5.1 動態閾值選擇

`preprocess_single_day.py` 會自動調整過濾閾值，確保標籤分布接近目標：

**目標分布**（預設）：
```
Down: 30%
Neutral: 40%
Up: 30%
```

**動態調整邏輯**：
```python
候選閾值 = [0.001, 0.002, 0.003, 0.005, 0.010, 0.015, 0.020]

for 閾值 in 候選閾值:
    模擬過濾 → 計算標籤分布
    計算與目標分布的差距

選擇差距最小的閾值
```

**範例**：
```
閾值 = 0.001:
  過濾後 Down 25% / Neutral 50% / Up 25%
  差距 = |25-30| + |50-40| + |25-30| = 20

閾值 = 0.005:
  過濾後 Down 28% / Neutral 44% / Up 28%
  差距 = |28-30| + |44-40| + |28-30| = 8  ← 最佳

選擇閾值 = 0.005
```

### 5.2 數據質量驗證

預處理階段會進行多重驗證：

**驗證項目**：
1. ✅ 移除 mids = 0 的點（避免 log(0) 錯誤）
2. ✅ 移除 NaN 值
3. ✅ 移除負價格
4. ✅ 檢查 features 和 labels 長度匹配
5. ✅ 檢查標籤值範圍 {-1, 0, 1}

**失敗處理**：
- 記錄錯誤到日誌
- 跳過有問題的股票
- 繼續處理其他股票

---

## 六、標籤輸出與使用

### 6.1 NPZ 檔案結構

預處理後的 NPZ 檔案包含：

```python
npz_file = np.load('preprocessed_v5/daily/20250901/2330.npz')

features = npz_file['features']   # (T, 20) - LOB 特徵
labels = npz_file['labels']       # (T,) - 標籤 {-1, 0, 1}
mids = npz_file['mids']           # (T,) - 中間價
metadata = npz_file['metadata']   # JSON 字符串
```

### 6.2 Metadata 內容

```json
{
  "symbol": "2330",
  "date": "20250901",
  "original_rows": 15000,
  "cleaned_rows": 14850,
  "pass_filter": true,
  "filter_threshold": 0.005,
  "label_distribution": {
    "down": 4455,
    "neutral": 5940,
    "up": 4455
  },
  "weight_strategies": {
    "uniform": {"class_weights": {"-1": 1.0, "0": 1.0, "1": 1.0}},
    "balanced": {"class_weights": {"-1": 1.15, "0": 0.82, "1": 1.15}},
    // ... 其他策略
  }
}
```

### 6.3 後續使用

**V7 階段**：
```python
# V7 直接讀取 labels，不重新計算
features, labels, meta = load_preprocessed_npz(npz_path)

# 生成滑動窗口
for i in range(T - 100):
    X_window = features[i:i+100]  # (100, 20)
    y_label = labels[i+99]        # {-1, 0, 1}

    # 轉換為 {0, 1, 2}
    if y_label == -1: y_label = 0
    elif y_label == 0: y_label = 1
    elif y_label == 1: y_label = 2
```

---

## 七、標籤方法對比

### 7.1 Trend Stable vs Triple-Barrier

| 特性 | Trend Stable | Triple-Barrier |
|------|-------------|----------------|
| **目標** | 捕捉趨勢方向 | 捕捉止盈/止損 |
| **時間尺度** | 2-5 分鐘 | 20-40 秒 |
| **交易頻率** | 1-2 次/天 | 10-20 次/天 |
| **Neutral 比例** | 50-70% | 20-40% |
| **穩定性** | 高（多重驗證） | 中（單次觸發） |
| **適合場景** | 波段交易 | 超短線交易 |
| **標籤一致性** | 高 | 中 |
| **計算複雜度** | 高 | 低 |

### 7.2 適用場景

**使用 Trend Stable**（當前採用）：
- ✅ 日內波段交易（1-2 次/天）
- ✅ 利潤目標 ≥ 1%
- ✅ 手續費 0.1-0.3%
- ✅ 追求穩定勝率

**使用 Triple-Barrier**（已棄用）：
- ❌ 超短線交易（10-20 次/天）
- ❌ 利潤目標 0.3-0.5%
- ❌ 低手續費 < 0.05%
- ❌ 追求高交易頻率

---

## 八、常見問題

### Q1: 為什麼 Neutral 比例這麼高（50-70%）？

**A**: 這是設計特性，不是缺陷。

**原因**：
1. 台股大部分時間處於震盪（箱型整理）
2. 寧可錯過小波動，也不要誤判震盪為趨勢
3. 高 Neutral 比例 = 避免頻繁交易 = 降低手續費

**驗證**：
- 人工標註台股分時圖，Neutral 通常占 60-80%
- 保守策略的核心：**不交易也是一種交易決策**

### Q2: 如何調整參數增加 Up/Down 比例？

**A**: 降低門檻，但會增加假信號。

**方法**：
```yaml
# 降低這些參數
vol_multiplier: 2.5 → 1.5      # 降低進入門檻
min_trend_duration: 45 → 20    # 縮短持續性
dir_consistency: 0.60 → 0.55   # 放寬方向要求
```

**風險**：
- Up/Down 比例 ↑，但假信號 ↑↑
- 回測勝率可能下降
- 實盤手續費損耗增加

### Q3: 標籤是否考慮了未來資訊（Look-ahead Bias）？

**A**: 是的，但這是設計目標。

**解釋**：
- 標籤生成**必須使用未來信息**（前瞻報酬率）
- 目的：讓模型學習「當前 LOB 特徵」與「未來趨勢」的關係
- 訓練時：模型只看到當前 100 秒的 LOB，不知道未來
- 推理時：模型根據當前 LOB 預測未來趨勢

**類比**：
- 標籤 = 老師的答案（基於未來）
- 特徵 = 學生的考題（僅當前）
- 訓練 = 學生學習「考題 → 答案」的映射

### Q4: 為什麼需要「方向一致性」檢查？

**A**: 防止震盪區間被誤判為趨勢。

**範例**：
```
價格序列：[100, 102, 99, 103, 98, 104, 97, 105]

計算結果：
  前瞻報酬率 = (105 - 100) / 100 = 5.0%  ← 幅度大！
  但方向一致性 = 50%（上漲 4 次，下跌 4 次）← 不穩定！

結論：
  這是震盪上漲，不是趨勢 → 標籤 = Neutral
```

### Q5: 如何驗證標籤質量？

**A**: 使用 `scripts/label_viewer.py`

```bash
# 查看標籤分布
python scripts/label_viewer.py \
    --npz-file data/preprocessed_v5/daily/20250901/2330.npz \
    --show-chart

# 統計分析
python scripts/analyze_label_distribution.py \
    --preprocessed-dir data/preprocessed_v5 \
    --mode stats
```

---

## 九、總結

### 9.1 核心優勢

1. ✅ **保守穩定** - 多重驗證，減少假信號
2. ✅ **適應性強** - 相對 + 絕對門檻雙重保護
3. ✅ **震盪友好** - 高 Neutral 比例，避免頻繁交易
4. ✅ **趨勢明確** - 遲滯 + 持續性，確認後不輕易退出
5. ✅ **可調參數** - 8 個參數靈活調整

### 9.2 關鍵機制

| 機制 | 作用 | 參數 |
|------|------|------|
| 前瞻報酬率 | 評估未來漲跌幅度 | `lookforward` |
| 方向一致性 | 驗證趨勢穩定性 | `dir_consistency` |
| 相對門檻 | 適應不同波動率 | `vol_multiplier` |
| 絕對門檻 | 防止低波過敏 | `abs_floor_enter/exit` |
| 遲滯效應 | 避免邊界抖動 | `hysteresis_ratio` |
| 持續性檢查 | 過濾短暫信號 | `min_trend_duration` |
| 多數票平滑 | 消除單點噪音 | `smooth_window` |

### 9.3 標籤含義總結

| 標籤 | 物理意義 | 交易策略 | 預期時間占比 |
|------|---------|---------|-------------|
| **-1** | 未來 2.5 分鐘內，價格將下跌 > 0.20%，且方向穩定（下跌步數 > 60%） | 做空或離場 | 25-30% |
| **0** | 未來無明顯趨勢（震盪、箱型、整理） | 觀望，不交易 | 50-70% |
| **1** | 未來 2.5 分鐘內，價格將上漲 > 0.20%，且方向穩定（上漲步數 > 60%） | 做多或持有 | 25-30% |

---

**文檔版本**: v1.0
**最後更新**: 2025-10-24
**維護者**: DeepLOB-Pro Team
**相關文檔**:
- [EXTRACT_V7_FUNCTION_GUIDE.md](EXTRACT_V7_FUNCTION_GUIDE.md) - V7 數據組織流程
- [TREND_LABELING_IMPLEMENTATION.md](TREND_LABELING_IMPLEMENTATION.md) - 趨勢標籤技術細節
