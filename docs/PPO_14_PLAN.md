# PPO_14 è¨“ç·´è¨ˆåŠƒ - é™ä½æœªå¹³å€‰æ‡²ç½°

**æ—¥æœŸ**: 2025-10-27
**ç‰ˆæœ¬**: v14.0
**ç­–ç•¥**: Long Only + é™ä½æœªå¹³å€‰æ‡²ç½°

---

## ğŸ¯ ç›®æ¨™

è§£æ±º PPO_13 éåº¦ä¿å®ˆå•é¡Œï¼ˆBuy æ¯”ä¾‹åƒ… 2%ï¼‰ï¼Œæ‰¾åˆ°ã€Œé¼“å‹µäº¤æ˜“ã€èˆ‡ã€Œé¿å…éš”å¤œã€çš„å¹³è¡¡é»ã€‚

---

## ğŸ“Š PPO_13 å•é¡Œè¨ºæ–·

### è¨“ç·´æŒ‡æ¨™ (çœ‹ä¼¼è‰¯å¥½)

- âœ… **KL æ•£åº¦**: 0.0036 (æ¥µåº¦ç©©å®š)
- âœ… **è§£é‡‹æ–¹å·®**: 0.966 (åƒ¹å€¼å‡½æ•¸æ“¬åˆå„ªç§€)
- âœ… **è¶¨å‹¢ RÂ²**: 0.930 (å¼·ä¸Šå‡è¶¨å‹¢)
- âœ… **å¥åº·åº¦**: 90/100 (æ¥µä½³)

### å¯¦éš›äº¤æ˜“è¡Œç‚º (åš´é‡å•é¡Œ)

- âŒ **Buy æ¯”ä¾‹**: 2.0% (ç›®æ¨™: 15%-40%)
- âŒ **Hold æ¯”ä¾‹**: 98.0% (å¹¾ä¹ä¸äº¤æ˜“)
- âŒ **Episode çå‹µ**: -2.91 Â± 4.06 (ä»ç‚ºè² )
- âš ï¸ **äº¤æ˜“æ¬¡æ•¸**: 5.8/Episode (æ•¸é‡åˆç†ï¼Œä½†å¤šç‚ºç©ºå€‰)

### æ ¹æœ¬åŸå› 

**æœªå¹³å€‰æ‡²ç½°éæ–¼åš´è‹›**: `-10 å…ƒ/å€‰ä½`

```python
# tw_lob_trading_env.py:380 (PPO_13)
unclosed_penalty = -10.0 * self.position
```

**æ‡²ç½°å¼·åº¦åˆ†æ**:
- PPO_11 æŒå€‰ 500 æ­¥çå‹µ: `+0.05 Ã— 500 = +25 å…ƒ`
- PPO_13 æœªå¹³å€‰æ‡²ç½°: `-10 å…ƒ` (ç›¸ç•¶æ–¼æå¤± **40%** çå‹µ)
- **çµæœ**: æ¨¡å‹å­¸åˆ°ã€Œç›¡é‡ä¸æŒå€‰ã€ä»¥é¿å…æ‡²ç½°

---

## ğŸ”§ PPO_14 èª¿æ•´æ–¹æ¡ˆ

### æ ¸å¿ƒä¿®æ”¹

**é™ä½æœªå¹³å€‰æ‡²ç½° 80%**: `-10 å…ƒ â†’ -2 å…ƒ/å€‰ä½`

```python
# tw_lob_trading_env.py:380 (PPO_14)
unclosed_penalty = -2.0 * self.position
```

### ç†ç”±

1. **-2 å…ƒä»èƒ½é¼“å‹µå¹³å€‰**:
   - æŒå€‰ 500 æ­¥éœ€ç›ˆåˆ© > `2 / 500 / å ±åƒ¹ â‰ˆ 0.4%` æ‰åˆ’ç®—
   - ä»ä¿ç•™ç•¶æ²–è¦å‰‡æ¿€å‹µ

2. **ä¸æœƒéåº¦æŠ‘åˆ¶äº¤æ˜“**:
   - `-2 å…ƒ = 8%` PPO_11 æŒå€‰çå‹µï¼ˆvs. PPO_13 çš„ 40%ï¼‰
   - æº«å’Œæ‡²ç½°ï¼Œè®“ç­–ç•¥æœ‰ç©ºé–“æ¢ç´¢

3. **åƒè€ƒ PPO_11 æˆåŠŸç¶“é©—**:
   - PPO_11 å¹³å‡çå‹µ: `+24.15` (è­‰æ˜æœ‰ç›ˆåˆ©ç©ºé–“)
   - PPO_14 ç›®æ¨™: ä¿ç•™ç›ˆåˆ©èƒ½åŠ›ï¼Œé¿å…éåº¦äº¤æ˜“

---

## ğŸ¯ è¨“ç·´ç›®æ¨™

| æŒ‡æ¨™ | PPO_13 (ç•¶å‰) | PPO_14 (ç›®æ¨™) | è©•ä¼°æ¨™æº– |
|------|--------------|--------------|----------|
| **Buy æ¯”ä¾‹** | 2.0% âŒ | 15%-40% | é©åº¦äº¤æ˜“ |
| **Episode çå‹µ** | -2.91 âŒ | > 0 | ç›ˆåˆ© |
| **äº¤æ˜“æ¬¡æ•¸** | 5.8/Ep | 5-10/Ep | ä¿æŒåˆç† |
| **KL æ•£åº¦** | 0.0036 âœ… | < 0.02 | ä¿æŒç©©å®š |
| **è§£é‡‹æ–¹å·®** | 0.966 âœ… | > 0.7 | ä¿æŒè‰¯å¥½ |

---

## ğŸ“‹ è¨“ç·´é…ç½®

### è¶…åƒæ•¸ (ä¿æŒ PPO_13)

```yaml
ppo:
  learning_rate: 1e-4       # âœ… ç©©å®šè¨“ç·´
  clip_range: 0.1           # âœ… KL æ•£åº¦è‰¯å¥½
  vf_coef: 1.0              # âœ… è§£é‡‹æ–¹å·® 0.966
  net_arch:
    pi: [512, 256]          # âœ… å®¹é‡å……è¶³
    vf: [512, 256]

training:
  total_timesteps: 200000   # å¿«é€Ÿæ¸¬è©¦
```

### çå‹µå‡½æ•¸

```python
# reward_shaper.py (ç„¡è®ŠåŒ–)
ç¸½çå‹µ = PnL - äº¤æ˜“æˆæœ¬

# tw_lob_trading_env.py (å”¯ä¸€è®ŠåŒ–)
if Episode çµæŸ and æœ‰æŒå€‰:
    ç¸½çå‹µ -= 2.0 * position  # PPO_14: -2 | PPO_13: -10
```

---

## ğŸš€ åŸ·è¡Œæ­¥é©Ÿ

### 1. é©—è­‰ä¿®æ”¹

```bash
# æª¢æŸ¥ç’°å¢ƒä»£ç¢¼
type src\envs\tw_lob_trading_env.py | findstr "unclosed_penalty"
# æ‡‰é¡¯ç¤º: unclosed_penalty = -2.0 * self.position

# æª¢æŸ¥é…ç½®æ–‡ä»¶
type configs\sb3_deeplob_config.yaml | findstr "total_timesteps"
# æ‡‰é¡¯ç¤º: total_timesteps: 200000
```

### 2. é–‹å§‹è¨“ç·´ (200K steps, ~28 åˆ†é˜)

```bash
# æ¿€æ´»ç’°å¢ƒ
conda activate deeplob-pro

# é–‹å§‹è¨“ç·´
python scripts/train_sb3_deeplob.py --config configs/sb3_deeplob_config.yaml

# ç›£æ§è¨“ç·´
tensorboard --logdir logs/sb3_deeplob/
```

### 3. è¨“ç·´å¾Œé©—è­‰

```bash
# 3.1 åˆ†æ TensorBoard æ—¥èªŒ
python scripts/analyze_tensorboard.py --log-dir logs/sb3_deeplob/PPO_14

# 3.2 æª¢æŸ¥äº¤æ˜“è¡Œç‚º
python scripts/check_trading_behavior.py --model checkpoints/sb3/ppo_deeplob/best_model --n_episodes 5

# 3.3 è©•ä¼°æ¨¡å‹æ€§èƒ½
python scripts/evaluate_sb3.py --model checkpoints/sb3/ppo_deeplob/best_model --n_episodes 20
```

---

## ğŸ“ˆ é æœŸçµæœ

### æ¨‚è§€é æœŸ (â­â­â­â­â­)

- Buy æ¯”ä¾‹: **25%-35%** (é©åº¦äº¤æ˜“)
- Episode çå‹µ: **+5~+15** (å¯¦éš›ç›ˆåˆ©)
- äº¤æ˜“æ¬¡æ•¸: **6-8/Ep** (åˆç†é »ç‡)
- KL æ•£åº¦: **< 0.01** (ä¿æŒç©©å®š)

### ä¿å®ˆé æœŸ (â­â­â­)

- Buy æ¯”ä¾‹: **10%-20%** (ä»åä¿å®ˆ)
- Episode çå‹µ: **-1~+3** (æ¥è¿‘ç›ˆè™§å¹³è¡¡)
- éœ€é€²ä¸€æ­¥èª¿æ•´ unclosed_penalty (-2 â†’ -1 æˆ– -0.5)

### å¤±æ•—æƒ…æ³ (âŒ)

- Buy æ¯”ä¾‹: **< 5%** (ä»éåº¦ä¿å®ˆ)
- Episode çå‹µ: **< -2** (ä»ç‚ºè² )
- éœ€æ”¹ç”¨å…¶ä»–æ–¹æ¡ˆï¼ˆè¦‹ä¸‹æ–‡å‚™é¸æ–¹æ¡ˆï¼‰

---

## ğŸ”„ å‚™é¸æ–¹æ¡ˆ (å¦‚ PPO_14 å¤±æ•—)

### æ–¹æ¡ˆ B: æ¼¸é€²å¼æ‡²ç½° â­â­â­â­

```python
# æ ¹æ“šæŒå€‰æ™‚é–“èª¿æ•´æ‡²ç½°å¼·åº¦
if holding_duration < 200:
    unclosed_penalty = 0            # çŸ­æœŸæŒå€‰ç„¡æ‡²ç½°
elif holding_duration < 400:
    unclosed_penalty = -1 * position  # ä¸­æœŸæŒå€‰è¼•æ‡²ç½°
else:
    unclosed_penalty = -5 * position  # é•·æœŸæŒå€‰é‡æ‡²ç½°
```

**å„ªé»**: ä¸æ‡²ç½°çŸ­æœŸæŒå€‰ï¼Œåªæ‡²ç½°é•·æœŸæŒå€‰
**ç¼ºé»**: éœ€ä¿®æ”¹ä»£ç¢¼ï¼Œå¢åŠ æŒå€‰æ™‚é–“è¨˜éŒ„

### æ–¹æ¡ˆ C: æ··åˆç­–ç•¥ â­â­â­

```python
# æŒå€‰æ¿€å‹µ (é¼“å‹µäº¤æ˜“)
holding_bonus = +0.01 * position

# æœªå¹³å€‰æ‡²ç½° (é¿å…éš”å¤œ)
unclosed_penalty = -5.0 * position

# 500 æ­¥æ·¨æ•ˆæœ: +0.01 Ã— 500 - 5 = 0 å…ƒ (éœ€ç›ˆåˆ© > 0.1% æ‰åˆ’ç®—)
```

**å„ªé»**: å¹³è¡¡é¼“å‹µèˆ‡æ‡²ç½°
**ç¼ºé»**: åƒæ•¸èª¿æ•´è¤‡é›œï¼ˆéœ€åŒæ™‚å¹³è¡¡å…©å€‹æ•¸å€¼ï¼‰

### æ–¹æ¡ˆ D: å›åˆ° PPO_11 + é™ä½æ¿€å‹µ â­â­

```python
# åƒ…é™ä½æŒå€‰æ¿€å‹µï¼Œç§»é™¤æœªå¹³å€‰æ‡²ç½°
holding_bonus = +0.01 * position  # é™ä½ 80% (0.05 â†’ 0.01)
unclosed_penalty = 0              # ç§»é™¤æ‡²ç½°
```

**å„ªé»**: PPO_11 å·²è­‰æ˜å¯ç²åˆ© (+24.15)
**ç¼ºé»**: å¯èƒ½ä»æœ‰éåº¦äº¤æ˜“é¢¨éšª

---

## ğŸ“ æˆåŠŸæ¨™æº–

**å¿…é ˆé”æˆ**:
1. âœ… Buy æ¯”ä¾‹ > 5% (é¿å…éåº¦ä¿å®ˆ)
2. âœ… Episode çå‹µ > -1 (æ¥è¿‘ç›ˆåˆ©)
3. âœ… KL æ•£åº¦ < 0.02 (è¨“ç·´ç©©å®š)

**ç†æƒ³ç›®æ¨™**:
1. ğŸ¯ Buy æ¯”ä¾‹ 15%-40% (é©åº¦äº¤æ˜“)
2. ğŸ¯ Episode çå‹µ > +5 (å¯¦éš›ç›ˆåˆ©)
3. ğŸ¯ äº¤æ˜“æ¬¡æ•¸ 5-10/Ep (åˆç†é »ç‡)

---

## ğŸ“š åƒè€ƒæ–‡æª”

- [èª¿åƒæ­·å²](20251026-sb3èª¿åƒæ­·å².md) - PPO_11/PPO_13 è©³ç´°è¨˜éŒ„
- [çå‹µè¨ˆç®—æŒ‡å—](REWARD_CALCULATION_GUIDE.md) - çå‹µå‡½æ•¸è¨­è¨ˆ
- [æœªå¹³å€‰æ‡²ç½°ç­–ç•¥](UNCLOSED_POSITION_PENALTY.md) - PPO_12 ç­–ç•¥æ–‡æª”

---

**æœ€å¾Œæ›´æ–°**: 2025-10-27
**ç‹€æ…‹**: â³ å¾…è¨“ç·´
**ä¸‹ä¸€æ­¥**: åŸ·è¡Œè¨“ç·´ â†’ é©—è­‰çµæœ â†’ æ›´æ–°è¨˜éŒ„
