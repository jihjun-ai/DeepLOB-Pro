# DeepLOB 調參歷史

### 每次保留數據及成果,簡要說明(其他廢話不用),這是改下次調參參考用

數據產生:

```bash
python scripts/extract_tw_stock_data_v5.py \
    --config configs/config_pro_v5_ml_optimal.yaml \
    --output_dir data/processed_v5
```

#### 環境: conda activate deeplob-pro

---

## 實驗 #4 - 2025-10-19 ⚠️ 失敗

**配置**: `configs/train_v5_fix_moderate.yaml`
**數據源**: `data/processed_v5_balanced/npz/` (更平衡的類別分布)
**訓練指令**: `python scripts/train_deeplob_v5.py --config configs/train_v5_fix_moderate.yaml`

### 數據規模
- 訓練集: 1,249,419 樣本
- Class 分布: 0=31.0%, 1=42.0%, 2=27.0% (相比 v5: 29.4%/45.0%/25.6%)

### 模型配置
- LSTM hidden: 48 (↑ from 32)
- FC hidden: 48 (↑ from 32)
- Dropout: 0.4 (↓ from 0.5)
- Conv filters: 32/32/32

### 訓練配置
- Batch size: 256
- LR: 0.00012
- Weight decay: 0.0003
- Grad clip: 0.8
- 平衡採樣器: ✅ enabled (inv_freq)
- 手動權重: [1.2, 1.0, 1.3]

### 結果 ❌
**最佳 Epoch**: 37/40
**驗證集**: Weighted F1 = **0.4075** (40.75%)
**測試集**:
- Weighted F1: **0.3415** (34.15%)
- Unweighted Acc: 39.82%
- Unweighted F1: 38.94%

**各類別表現**:
| Class | Precision | Recall | F1 |
|-------|-----------|--------|-----|
| 0 (下跌) | 0.405 | **0.543** | 0.464 |
| 1 (持平) | **0.631** | **0.253** | 0.360 |
| 2 (上漲) | **0.306** | 0.390 | 0.343 |

**混淆矩陣** (測試集):
```
實際\預測    0        1        2
0        62,843    8,305   44,585
1        41,633   27,810   40,511
2        50,780    7,983   37,597
```

### 問題診斷
1. **嚴重性能崩潰**: F1 從 72.98% → 34.15% (-38.83%)
2. **Class 1 召回率仍極低**: 25.3% (目標 >35%)
3. **Class 2 精確度最差**: 30.6%
4. **過早停止**: 37/40 epochs
5. **可能原因**: 平衡採樣器 + 手動權重衝突，導致訓練不穩定

### 下次調參方向
1. **禁用平衡採樣器** - 只用手動權重或只用採樣器，不要同時用
2. **回退到原始 v5 數據** - 使用 `data/processed_v5/npz/`
3. **更激進的權重**: [2.5, 1.0, 2.8] (大幅提升 Class 0/2)
4. **增加容量**: LSTM 48→64, dropout 0.4→0.3
5. **延長訓練**: epochs 40→60, patience 10→15

---

## 實驗 #3 - 2025-10-18


