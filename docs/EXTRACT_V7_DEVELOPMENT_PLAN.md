# extract_tw_stock_data_v7.py å¼€å‘æ”¹ç‰ˆè®¡åˆ’ï¼ˆç°¡åŒ–ç‰ˆï¼‰

**ç‰ˆæœ¬**: v7.0.0-simplified
**æ–‡æ¡£æ—¥æœŸ**: 2025-10-23
**ç›®æ ‡**: ç°¡åŒ–æ•¸æ“šè™•ç†æµç¨‹ï¼Œå°ˆæ³¨æ•¸æ“šçµ„ç¹”è€Œéè¨ˆç®—

---

## ğŸ“‹ ç›®å½•

1. [æ”¹ç‰ˆèƒŒæ™¯](#æ”¹ç‰ˆèƒŒæ™¯)
2. [æ ¸å¿ƒç†å¿µ](#æ ¸å¿ƒç†å¿µ)
3. [æŠ€è¡“è¨­è¨ˆ](#æŠ€è¡“è¨­è¨ˆ)
4. [æ€§èƒ½é æœŸ](#æ€§èƒ½é æœŸ)
5. [å¯¦æ–½é¢¨éšª](#å¯¦æ–½é¢¨éšª)
6. [æ¸¬è©¦ç­–ç•¥](#æ¸¬è©¦ç­–ç•¥)

---

## æ”¹ç‰ˆèƒŒæ™¯

### V6 æ¶æ§‹çš„å•é¡Œ

æ ¹æ“šå¯¦éš›åˆ†æï¼ŒV6 å­˜åœ¨ä»¥ä¸‹**é‡è¤‡è¨ˆç®—å•é¡Œ**ï¼š

| æ­¥é©Ÿ | V6 åšæ³• | é è™•ç†å·²å®Œæˆ | å•é¡Œ |
|-----|---------|------------|------|
| **æ¨™ç±¤è¨ˆç®—** | âš ï¸âš ï¸âš ï¸ é‡æ–°è¨ˆç®— | âœ… `labels` å­—æ®µå·²å­˜åœ¨ | **åš´é‡é‡è¤‡** |
| **æ³¢å‹•ç‡è¨ˆç®—** | âš ï¸ é‡æ–°è¨ˆç®— | âœ… æ¨™ç±¤å·²ç”Ÿæˆï¼Œä¸éœ€æ³¢å‹•ç‡ | **ä¸å¿…è¦** |
| **æ¬Šé‡è¨ˆç®—** | âš ï¸ æ¯æ¬¡è¨ˆç®— | âœ… `weight_strategies` å·²æœ‰ 11 ç¨® | **é‡è¤‡å·¥ä½œ** |
| **æ•¸æ“šæ¸…æ´—** | âš ï¸ Z-Score æ¨™æº–åŒ– | âœ… `features` å·²æ¨™æº–åŒ– | **é‡è¤‡å·¥ä½œ** |

### æ ¸å¿ƒç™¼ç¾

é€šéæª¢æŸ¥å¯¦éš› NPZ æ–‡ä»¶ï¼ˆ`data/preprocessed_swing/daily/20250901/0050.npz`ï¼‰ï¼š

```
âœ… features (15957, 20)  - å·²æ¨™æº–åŒ–çš„ LOB ç‰¹å¾µ
âœ… labels (15957,)       - å€¼ç‚º {0.0, 1.0} å·²è¨ˆç®—å®Œæˆ
âœ… metadata.weight_strategies - åŒ…å« 5+ ç¨®é è¨ˆç®—ç­–ç•¥
âœ… metadata.label_preview - åŒ…å«æ¨™ç±¤çµ±è¨ˆä¿¡æ¯
```

**çµè«–**: é è™•ç†éšæ®µå·²å®Œæˆæ‰€æœ‰é‡è¦è¨ˆç®—ï¼ŒV6 çš„"é‡æ–°è¨ˆç®—"æ˜¯**å®Œå…¨ä¸å¿…è¦çš„é‡è¤‡å·¥ä½œ**ã€‚

### V6 â†’ V7 æ¼”é€²ç›®æ¨™

**æ ¸å¿ƒç†å¿µ**: "é è™•ç†å·²å®Œæˆï¼ŒV7 åªåšæ•¸æ“šçµ„ç¹”"

```
é è™•ç†éšæ®µï¼ˆpreprocess_single_day.pyï¼‰:
  âœ… æ•¸æ“šæ¸…æ´—èˆ‡èšåˆ
  âœ… Z-Score æ¨™æº–åŒ–
  âœ… æ¨™ç±¤è¨ˆç®—ï¼ˆTriple-Barrier / Trendï¼‰
  âœ… æ¬Šé‡ç­–ç•¥è¨ˆç®—ï¼ˆ11 ç¨®ï¼‰
  âœ… çµ±è¨ˆä¿¡æ¯è¨˜éŒ„

V7 éšæ®µï¼ˆextract_tw_stock_data_v7.pyï¼‰:
  âœ… è®€å–é è™•ç† NPZï¼ˆç›´æ¥ä½¿ç”¨ features, labelsï¼‰
  âœ… æ•¸æ“šé¸æ“‡ï¼ˆdataset_selection.json æˆ–é…ç½®éæ¿¾ï¼‰
  âœ… æ»‘å‹•çª—å£ç”Ÿæˆï¼ˆ100 timestepsï¼‰
  âœ… æŒ‰è‚¡ç¥¨åŠƒåˆ†ï¼ˆtrain/val/test = 70/15/15ï¼‰
  âœ… è¼¸å‡º NPZï¼ˆèˆ‡ V6 æ ¼å¼å…¼å®¹ï¼‰

  âŒ ä¸é‡æ–°è¨ˆç®—æ¨™ç±¤
  âŒ ä¸é‡æ–°è¨ˆç®—æ³¢å‹•ç‡
  âŒ ä¸é‡æ–°è¨ˆç®—æ¬Šé‡
  âŒ ä¸é‡æ–°æ¨™æº–åŒ–
```

---

## æ ¸å¿ƒç†å¿µ

### âŒ V7 ä¸åšçš„äº‹ï¼ˆå·²åœ¨é è™•ç†å®Œæˆï¼‰

1. **âŒ æ¨™ç±¤è¨ˆç®—**
   - é è™•ç†å·²å®Œæˆ Triple-Barrier æˆ–è¶¨å‹¢æ¨™ç±¤
   - NPZ çš„ `labels` å­—æ®µç›´æ¥å¯ç”¨

2. **âŒ æ³¢å‹•ç‡è¨ˆç®—**
   - æ¨™ç±¤å·²ç”Ÿæˆï¼Œä¸éœ€è¦å†ç®—æ³¢å‹•ç‡
   - å¦‚éœ€ä¿®æ”¹æ¨™ç±¤ï¼Œæ‡‰é‡è·‘é è™•ç†ï¼ˆä¸æ˜¯ V7ï¼‰

3. **âŒ æ¬Šé‡è¨ˆç®—**
   - é è™•ç†å·²è¨ˆç®— 11 ç¨®æ¬Šé‡ç­–ç•¥
   - ç›´æ¥å¾ `metadata.weight_strategies` è®€å–

4. **âŒ æ•¸æ“šæ¸…æ´—**
   - é è™•ç†å·²å®Œæˆ Z-Score æ¨™æº–åŒ–
   - `features` å­—æ®µå·²æ˜¯æ¨™æº–åŒ–çµæœ

5. **âŒ åƒæ•¸åŒ¹é…æª¢æŸ¥**
   - ä¸åš"æ™ºèƒ½é‡ç”¨"é‚è¼¯ï¼ˆéæ–¼è¤‡é›œï¼‰
   - å¦‚éœ€ä¸åŒåƒæ•¸ï¼Œé‡è·‘é è™•ç†

### âœ… V7 åªåšçš„äº‹

1. **è®€å–é è™•ç† NPZ**
   - è¼‰å…¥ `features`, `labels`, `metadata`
   - é©—è­‰ç‰ˆæœ¬ï¼ˆå¼·åˆ¶ v2.0+ï¼‰

2. **æ•¸æ“šé¸æ“‡**ï¼ˆæ–°å¢åŠŸèƒ½ â­â­â­â­â­ï¼‰
   - æ”¯æŒ `dataset_selection.json`ï¼ˆå„ªå…ˆç´š 1ï¼‰
   - æˆ–ä½¿ç”¨é…ç½®éæ¿¾ï¼ˆå„ªå…ˆç´š 2ï¼‰

3. **æ»‘å‹•çª—å£ç”Ÿæˆ**
   - ç”Ÿæˆ (100, 20) æ™‚é–“åºåˆ—çª—å£
   - æ¨™ç±¤è½‰æ›ï¼š{-1, 0, 1} â†’ {0, 1, 2}

4. **æŒ‰è‚¡ç¥¨åŠƒåˆ†**
   - train/val/test = 70/15/15

5. **è¼¸å‡º NPZ**
   - èˆ‡ V6 æ ¼å¼å®Œå…¨å…¼å®¹
   - ç¢ºä¿è¨“ç·´æµç¨‹ç„¡éœ€ä¿®æ”¹

---

## æŠ€è¡“è¨­è¨ˆ

### ç°¡åŒ–å¾Œçš„å‡½æ•¸æ¸…å–®

#### æ–°å¢å‡½æ•¸

1. **`read_dataset_selection_json(json_path: str) -> Dict`**
   - è®€å– dataset_selection.json
   - è¿”å› file_listï¼ˆæ¯å€‹å…ƒç´ : {date, symbol, file_path}ï¼‰

2. **`filter_data_by_selection(all_data, config) -> List`**
   - å„ªå…ˆç´š 1: ä½¿ç”¨ dataset_selection.json éæ¿¾
   - å„ªå…ˆç´š 2: ä½¿ç”¨é…ç½®éæ¿¾ï¼ˆstart_date, num_days, symbolsï¼‰

#### ä¿®æ”¹å‡½æ•¸

1. **`load_preprocessed_npz(npz_path) -> Tuple`**
   ```
   V6 è¿”å›: (features, mids, bucket_mask, meta)
   V7 è¿”å›: (features, labels, meta)

   æ”¹å‹•:
   - æ–°å¢è¿”å› labels
   - ç§»é™¤ midsï¼ˆä¸éœ€è¦è¨ˆç®—æ¨™ç±¤ï¼‰
   - ç§»é™¤ bucket_maskï¼ˆä¸éœ€è¦ï¼‰
   ```

2. **`sliding_windows_v6()` â†’ `sliding_windows_v7()`**
   ```
   ç°¡åŒ–å…§å®¹:
   - ç§»é™¤æ¨™ç±¤è¨ˆç®—é‚è¼¯ï¼ˆtb_labels, trend_labelsï¼‰
   - ç§»é™¤æ³¢å‹•ç‡è¨ˆç®—é‚è¼¯ï¼ˆewma_volï¼‰
   - ç›´æ¥ä½¿ç”¨é è™•ç†çš„ labels
   - å¾ metadata è®€å–æ¬Šé‡ï¼ˆä¸é‡æ–°è¨ˆç®—ï¼‰
   ```

3. **`load_all_preprocessed_data()`**
   ```
   æ–°å¢æª¢æŸ¥:
   - å¼·åˆ¶ NPZ v2.0+ï¼ˆå¿…é ˆæœ‰ labels å­—æ®µï¼‰
   - èˆŠç‰ˆ NPZ ç›´æ¥å ±éŒ¯ï¼Œæç¤ºé‡è·‘é è™•ç†
   ```

#### ç§»é™¤å‡½æ•¸

ä»¥ä¸‹ V6 å‡½æ•¸åœ¨ V7 ä¸­**å®Œå…¨ç§»é™¤**ï¼š

```python
# âŒ ç§»é™¤: æ¨™ç±¤è¨ˆç®—å‡½æ•¸ï¼ˆé è™•ç†å·²å®Œæˆï¼‰
def tb_labels(...)  # Triple-Barrier æ¨™ç±¤
def trend_labels(...)  # è¶¨å‹¢æ¨™ç±¤

# âŒ ç§»é™¤: æ³¢å‹•ç‡è¨ˆç®—å‡½æ•¸ï¼ˆä¸éœ€è¦ï¼‰
def ewma_vol(...)  # EWMA æ³¢å‹•ç‡

# âŒ ç§»é™¤: åƒæ•¸åŒ¹é…æª¢æŸ¥ï¼ˆéæ–¼è¤‡é›œï¼‰
def check_label_compatibility(...)
def load_volatility_from_metadata(...)

# âšª ä¿ç•™ä½†ç°¡åŒ–: æ¬Šé‡å‡½æ•¸ï¼ˆæ”¹ç‚ºè®€å– metadataï¼‰
def get_sample_weights_from_metadata(...)
```

**ä»£ç¢¼é‡è®ŠåŒ–**: V6 ç´„ 1800 è¡Œ â†’ V7 ç´„ 1200 è¡Œï¼ˆ**æ¸›å°‘ 33%**ï¼‰

---

### é…ç½®æ–‡ä»¶è®ŠåŒ–

```yaml
# configs/config_pro_v7_optimal.yaml

# V7 æ–°å¢: æ•¸æ“šé¸æ“‡ï¼ˆâ­â­â­â­â­ æ ¸å¿ƒåŠŸèƒ½ï¼‰
data_selection:
  # é¸é … 1: ä½¿ç”¨ JSON æ–‡ä»¶ï¼ˆå„ªå…ˆç´šæœ€é«˜ï¼‰
  json_file: "results/dataset_selection_auto.json"

  # é¸é … 2: ä½¿ç”¨é…ç½®éæ¿¾ï¼ˆå¾Œå‚™æ–¹æ¡ˆï¼‰
  start_date: "20250901"           # èµ·å§‹æ—¥æœŸï¼ˆnull = å…¨éƒ¨ï¼‰
  end_date: null                   # çµæŸæ—¥æœŸï¼ˆnull = æœ€æ™šï¼‰
  num_days: 10                     # è™•ç†å¤©æ•¸ï¼ˆnull = å…¨éƒ¨ï¼‰
  symbols: null                    # æŒ‡å®šè‚¡ç¥¨ï¼ˆnull = å…¨éƒ¨ï¼‰
  sample_ratio: 1.0                # æ¡æ¨£æ¯”ä¾‹

# V7 ç°¡åŒ–: æ¬Šé‡ç­–ç•¥ï¼ˆç›´æ¥å¾ metadata è®€å–ï¼‰
sample_weights:
  enabled: true
  strategy: "effective_num_0999"   # å¾é è¨ˆç®—çš„ 11 ç¨®ç­–ç•¥é¸æ“‡

# V7 ç§»é™¤çš„é…ç½®ï¼ˆä¸å†éœ€è¦ï¼‰
# âŒ label_reuseï¼ˆä¸åšæ™ºèƒ½é‡ç”¨ï¼‰
# âŒ triple_barrier åƒæ•¸ï¼ˆé è™•ç†æ±ºå®šï¼‰
# âŒ volatility åƒæ•¸ï¼ˆé è™•ç†æ±ºå®šï¼‰
# âŒ sample_generation.target_distï¼ˆä½¿ç”¨ dataset_selection.json æ§åˆ¶ï¼‰
```

---

### dataset_selection.json æ ¼å¼

V7 çš„**æ ¸å¿ƒæ–°åŠŸèƒ½**æ˜¯æ”¯æŒç²¾ç¢ºæ§åˆ¶æ•¸æ“šé›†ã€‚

**æ ¼å¼**:
```json
{
  "metadata": {
    "creation_date": "2025-10-23T10:30:00",
    "preprocessed_dir": "data/preprocessed_v5",
    "total_samples": 2500000,
    "label_distribution": {
      "down": 750000,
      "neutral": 1000000,
      "up": 750000
    }
  },
  "file_list": [
    {
      "date": "20250901",
      "symbol": "2330",
      "file_path": "data/preprocessed_v5/daily/20250901/2330.npz",
      "samples": 15000,
      "label_dist": {"down": 4500, "neutral": 6000, "up": 4500}
    },
    {
      "date": "20250901",
      "symbol": "2454",
      "file_path": "data/preprocessed_v5/daily/20250901/2454.npz",
      "samples": 12000,
      "label_dist": {"down": 3600, "neutral": 4800, "up": 3600}
    }
  ]
}
```

**ç”Ÿæˆæ–¹å¼**:
```bash
# ä½¿ç”¨ analyze_label_distribution.py ç”Ÿæˆ
python scripts/analyze_label_distribution.py \
    --preprocessed-dir data/preprocessed_v5 \
    --mode smart_recommend \
    --start-date 20250901 \
    --target-dist "0.30,0.40,0.30" \
    --min-samples 50000 \
    --output results/dataset_selection_auto.json
```

---

### è¼¸å‡º Metadata æ›´æ–°

```json
{
  "format": "deeplob_v7_simplified",
  "version": "7.0.0",
  "creation_date": "2025-10-23T10:30:00",

  "data_source": {
    "preprocessed_version": "v2.0",
    "selection_method": "json_file",
    "json_file": "results/dataset_selection_auto.json",
    "npz_count": 1785,
    "date_range": ["20250901", "20250912"],
    "symbols_count": 195
  },

  "label_source": {
    "method": "preprocessed",
    "note": "ç›´æ¥ä½¿ç”¨é è™•ç† NPZ çš„ labels å­—æ®µï¼Œæœªé‡æ–°è¨ˆç®—"
  },

  "sample_weights": {
    "method": "preprocessed",
    "strategy": "effective_num_0999",
    "source": "metadata.weight_strategies"
  },

  "performance": {
    "total_time_seconds": 120,
    "v6_estimated_time": 600,
    "speedup_note": "ç„¡æ¨™ç±¤/æ³¢å‹•ç‡è¨ˆç®—ï¼Œé€Ÿåº¦æå‡ 5x"
  },

  "data_split": {
    "method": "by_symbol",
    "train": {
      "samples": 5584553,
      "symbols": 137,
      "label_dist": [1678365, 2233111, 1673077],
      "label_pct": [30.1, 40.0, 29.9]
    },
    "val": {...},
    "test": {...}
  }
}
```

---

## æ€§èƒ½é æœŸ

### æ™‚é–“ç¯€çœ

å‡è¨­è™•ç† **195 æª”è‚¡ç¥¨ Ã— 10 å¤© = 1,950 å€‹ symbol-day**ï¼š

| æ­¥é©Ÿ | V6 è€—æ™‚ | V7 è€—æ™‚ | ç¯€çœ | èªªæ˜ |
|-----|---------|---------|------|------|
| æ•¸æ“šè¼‰å…¥ | 30ç§’ | 35ç§’ | -5ç§’ | è¼‰å…¥ labels å­—æ®µ |
| Z-Score æ¨™æº–åŒ– | 60ç§’ | 0ç§’ | **+60ç§’** | é è™•ç†å·²å®Œæˆ |
| **æ³¢å‹•ç‡è¨ˆç®—** | **60ç§’** | **0ç§’** | **+60ç§’** | ä¸éœ€è¦ |
| **Triple-Barrier æ¨™ç±¤** | **300ç§’** | **0ç§’** | **+300ç§’** | ç›´æ¥ä½¿ç”¨ NPZ |
| æ¨£æœ¬æ¬Šé‡ | 30ç§’ | 5ç§’ | +25ç§’ | è®€å– metadata |
| æ»‘çª—ç”Ÿæˆ | 120ç§’ | 100ç§’ | +20ç§’ | ç°¡åŒ–é‚è¼¯ |
| **ç¸½è¨ˆ** | **600ç§’ (10åˆ†é˜)** | **140ç§’ (2.3åˆ†é˜)** | **+460ç§’** | **ç¯€çœ 77%** |

### èˆ‡ V6 å°æ¯”

| æŒ‡æ¨™ | V6 | V7 ç°¡åŒ–ç‰ˆ | æ”¹å–„ |
|-----|----|----|------|
| è™•ç†æ™‚é–“ | 10åˆ†é˜ | 2.3åˆ†é˜ | **-77%** |
| ä»£ç¢¼è¡Œæ•¸ | 1800 è¡Œ | 1200 è¡Œ | **-33%** |
| è¤‡é›œåº¦ | é«˜ | ä½ | â¬‡ï¸ |
| ç¶­è­·æ€§ | ä¸­ | é«˜ | â¬†ï¸ |
| å¯é æ€§ | ä¸­ | é«˜ | â¬†ï¸ |

### ç‚ºä½•æ›´å¿«ï¼Ÿ

1. **ä¸é‡æ–°è¨ˆç®—æ¨™ç±¤**: ç¯€çœ 300 ç§’ï¼ˆ50%ï¼‰
2. **ä¸é‡æ–°è¨ˆç®—æ³¢å‹•ç‡**: ç¯€çœ 60 ç§’ï¼ˆ10%ï¼‰
3. **ä¸é‡æ–°æ¨™æº–åŒ–**: ç¯€çœ 60 ç§’ï¼ˆ10%ï¼‰
4. **ç°¡åŒ–æ¬Šé‡è®€å–**: ç¯€çœ 25 ç§’ï¼ˆ4%ï¼‰
5. **ä»£ç¢¼æ›´ç°¡æ½”**: ç¯€çœ 15 ç§’ï¼ˆ3%ï¼‰

**ç¸½ç¯€çœ**: **77%**

---

## å¯¦æ–½é¢¨éšª

### é¢¨éšª 1: NPZ ç‰ˆæœ¬ä¸å…¼å®¹ âš ï¸

**æè¿°**: ç”¨æˆ¶ä½¿ç”¨èˆŠç‰ˆ NPZï¼ˆv1.0ï¼Œç„¡ labels å­—æ®µï¼‰

**å½±éŸ¿**: ç¨‹åºå ±éŒ¯ï¼Œç„¡æ³•é‹è¡Œ

**ç·©è§£æªæ–½**:
```python
# æ¸…æ™°çš„éŒ¯èª¤æç¤º
if 'labels' not in npz_data:
    raise ValueError(
        f"âŒ NPZ ç‰ˆæœ¬éèˆŠï¼ˆv1.0ï¼‰\n"
        f"   V7 è¦æ±‚ v2.0+ NPZï¼ˆå« labels å­—æ®µï¼‰\n"
        f"   è§£æ±ºæ–¹æ³•:\n"
        f"   1. é‹è¡Œ: scripts\\batch_preprocess.bat\n"
        f"   2. ç¢ºä¿ NPZ å«æœ‰ 'labels' å­—æ®µ"
    )
```

**é¢¨éšªç­‰ç´š**: ä¸­ âš ï¸ï¼ˆå¯æ§ï¼‰

### é¢¨éšª 2: dataset_selection.json æ ¼å¼éŒ¯èª¤ âš ï¸

**æè¿°**: JSON æ–‡ä»¶æ ¼å¼ä¸æ­£ç¢ºæˆ–è·¯å¾‘éŒ¯èª¤

**å½±éŸ¿**: ç„¡æ³•è¼‰å…¥æ•¸æ“š

**ç·©è§£æªæ–½**:
- è©³ç´°æ ¼å¼é©—è­‰
- æ¸…æ™°éŒ¯èª¤æç¤º
- æä¾›ç¯„ä¾‹æ–‡ä»¶

**é¢¨éšªç­‰ç´š**: ä½ âšª

### é¢¨éšª 3: æ¨™ç±¤ç²¾åº¦å·®ç•° âšª

**æè¿°**: ç›´æ¥ä½¿ç”¨é è™•ç†æ¨™ç±¤ï¼Œç„¡æ³•å‹•æ…‹èª¿æ•´åƒæ•¸

**å½±éŸ¿**: å¦‚éœ€ä¸åŒæ¨™ç±¤åƒæ•¸ï¼Œå¿…é ˆé‡è·‘é è™•ç†

**ç·©è§£æªæ–½**:
- æ–‡æª”èªªæ˜æ¸…æ¥š
- é è™•ç†é€Ÿåº¦å¿«ï¼ˆ4 åˆ†é˜/å¤©ï¼‰

**é¢¨éšªç­‰ç´š**: ä½ âšª

---

## æ¸¬è©¦ç­–ç•¥

### Phase 1: å–®å…ƒæ¸¬è©¦

#### æ¸¬è©¦ 1.1: dataset_selection.json è®€å–

**ç›®æ¨™**: é©—è­‰ JSON è®€å–èˆ‡é©—è­‰

**æ¸¬è©¦æ¡ˆä¾‹**:
- æ­£å¸¸ JSON æ–‡ä»¶
- ç¼ºå°‘å¿…è¦å­—æ®µ
- æ–‡ä»¶ä¸å­˜åœ¨
- æ ¼å¼éŒ¯èª¤

#### æ¸¬è©¦ 1.2: æ¨™ç±¤è¼‰å…¥

**ç›®æ¨™**: é©—è­‰å¾ NPZ è®€å– labels

**æ¸¬è©¦æ¡ˆä¾‹**:
- æ­£å¸¸è¼‰å…¥ï¼ˆå€¼ç‚º {-1, 0, 1}ï¼‰
- é•·åº¦ä¸åŒ¹é…
- ç•°å¸¸å€¼æª¢æ¸¬
- ç¼ºå°‘ labels å­—æ®µï¼ˆèˆŠç‰ˆ NPZï¼‰

#### æ¸¬è©¦ 1.3: æ¬Šé‡è®€å–

**ç›®æ¨™**: é©—è­‰å¾ metadata è®€å–æ¬Šé‡ç­–ç•¥

**æ¸¬è©¦æ¡ˆä¾‹**:
- æ­£å¸¸è®€å–ï¼ˆ11 ç¨®ç­–ç•¥ä¹‹ä¸€ï¼‰
- ç­–ç•¥ä¸å­˜åœ¨
- metadata æ ¼å¼éŒ¯èª¤

### Phase 2: æ•´åˆæ¸¬è©¦

#### æ¸¬è©¦ 2.1: å°æ•¸æ“šé›†å®Œæ•´æµç¨‹

**æ­¥é©Ÿ**:
```bash
# å‰µå»ºæ¸¬è©¦é…ç½®
# config_v7_test.yaml:
#   data_selection:
#     start_date: "20250901"
#     num_days: 2

python scripts/extract_tw_stock_data_v7.py \
    --preprocessed-dir ./data/preprocessed_v5 \
    --output-dir ./data/processed_v7_test \
    --config ./configs/config_v7_test.yaml
```

**é©—è­‰**:
- âœ… ç¨‹åºæ­£å¸¸é‹è¡Œï¼ˆç„¡éŒ¯èª¤ï¼‰
- âœ… ç”Ÿæˆ train/val/test.npz
- âœ… æ¨™ç±¤åˆ†å¸ƒæ­£ç¢º
- âœ… è™•ç†æ™‚é–“ < 5 åˆ†é˜

#### æ¸¬è©¦ 2.2: dataset_selection.json æ¸¬è©¦

**æ­¥é©Ÿ**:
```bash
# 1. ç”Ÿæˆ JSON
python scripts/analyze_label_distribution.py \
    --preprocessed-dir data/preprocessed_v5 \
    --mode smart_recommend \
    --start-date 20250901 \
    --target-dist "0.30,0.40,0.30" \
    --min-samples 50000 \
    --output results/dataset_selection_test.json

# 2. ä½¿ç”¨ JSON é‹è¡Œ V7
python scripts/extract_tw_stock_data_v7.py \
    --preprocessed-dir ./data/preprocessed_v5 \
    --output-dir ./data/processed_v7_json \
    --config ./configs/config_v7_json.yaml
```

**é©—è­‰**:
- âœ… åªè™•ç† JSON æŒ‡å®šçš„æ–‡ä»¶
- âœ… æ¨™ç±¤åˆ†å¸ƒç¬¦åˆ JSON é æœŸ
- âœ… æ—¥èªŒè¼¸å‡ºæ­£ç¢º

#### æ¸¬è©¦ 2.3: å°æ¯” V6 vs V7 ä¸€è‡´æ€§

**æ­¥é©Ÿ**:
```python
# ä½¿ç”¨ç›¸åŒé è™•ç†æ•¸æ“šé‹è¡Œ V6 å’Œ V7
# å°æ¯”è¼¸å‡ºæ¨™ç±¤åˆ†å¸ƒ

v6_data = np.load('data/processed_v6/npz/stock_embedding_train.npz')
v7_data = np.load('data/processed_v7/npz/stock_embedding_train.npz')

v6_dist = np.bincount(v6_data['y'], minlength=3) / len(v6_data['y'])
v7_dist = np.bincount(v7_data['y'], minlength=3) / len(v7_data['y'])

# æ¨™ç±¤åˆ†å¸ƒæ‡‰ä¸€è‡´ï¼ˆå› ç‚ºéƒ½ç”¨é è™•ç†çš„ labelsï¼‰
assert np.allclose(v6_dist, v7_dist, atol=0.01)
```

**é©—è­‰**:
- âœ… æ¨™ç±¤åˆ†å¸ƒä¸€è‡´ï¼ˆèª¤å·® < 1%ï¼‰
- âœ… æ¨£æœ¬æ•¸é‡ä¸€è‡´
- âœ… ç‰¹å¾µç¶­åº¦ä¸€è‡´

### Phase 3: å®Œæ•´æ¸¬è©¦

#### æ¸¬è©¦ 3.1: å®Œæ•´æ•¸æ“šé›†

**æ­¥é©Ÿ**:
```bash
# å®Œæ•´ 195 æª” Ã— 10 å¤©
python scripts/extract_tw_stock_data_v7.py \
    --preprocessed-dir ./data/preprocessed_v5 \
    --output-dir ./data/processed_v7 \
    --config ./configs/config_pro_v7_optimal.yaml
```

**é©—è­‰**:
- âœ… è™•ç†æ™‚é–“ < 5 åˆ†é˜ï¼ˆV6 éœ€ 10 åˆ†é˜ï¼‰
- âœ… æ¨™ç±¤åˆ†å¸ƒç¬¦åˆé æœŸ
- âœ… ç„¡éŒ¯èª¤æˆ–è­¦å‘Š

#### æ¸¬è©¦ 3.2: è¨“ç·´é©—è­‰

**æ­¥é©Ÿ**:
```bash
# ä½¿ç”¨ V7 æ•¸æ“šè¨“ç·´ DeepLOB
python scripts/train_deeplob_generic.py \
    --data-dir ./data/processed_v7/npz \
    --config ./configs/deeplob_config.yaml
```

**é©—è­‰**:
- âœ… è¨“ç·´æ­£å¸¸é‹è¡Œ
- âœ… æº–ç¢ºç‡ > 65%ï¼ˆåŸºæº–ï¼‰
- âœ… ç„¡ç•°å¸¸éŒ¯èª¤

---

## ç¸½çµ

### V7 ç°¡åŒ–ç‰ˆæ ¸å¿ƒç‰¹æ€§

âœ… **ä»£ç¢¼ç°¡å–®**: ç§»é™¤ 500+ è¡Œæ¨™ç±¤/æ³¢å‹•ç‡è¨ˆç®—ä»£ç¢¼ï¼ˆ-33%ï¼‰
âœ… **é€Ÿåº¦æ›´å¿«**: ä¸é‡è¤‡è¨ˆç®—ï¼Œæ™‚é–“ç¯€çœ 77%ï¼ˆ10åˆ†é˜ â†’ 2.3åˆ†é˜ï¼‰
âœ… **æ›´å¯é **: ä¸é‡è¤‡è¨ˆç®—ï¼Œé¿å…ä¸ä¸€è‡´
âœ… **æ›´éˆæ´»**: æ”¯æŒ dataset_selection.json ç²¾ç¢ºæ§åˆ¶æ•¸æ“šé›†
âœ… **æ˜“ç¶­è­·**: é‚è¼¯æ¸…æ™°ï¼Œå°ˆæ³¨æ•¸æ“šçµ„ç¹”

### V7 èˆ‡ V6 å°æ¯”

| ç‰¹æ€§ | V6 | V7 ç°¡åŒ–ç‰ˆ |
|-----|----|----|
| æ¨™ç±¤ä¾†æº | é‡æ–°è¨ˆç®— | é è™•ç† NPZ âœ… |
| æ³¢å‹•ç‡è¨ˆç®— | é‡æ–°è¨ˆç®— | ä¸éœ€è¦ âœ… |
| æ¬Šé‡è¨ˆç®— | æ¯æ¬¡è¨ˆç®— | è®€å– metadata âœ… |
| æ•¸æ“šé¸æ“‡ | é…ç½®éæ¿¾ | JSON + é…ç½® âœ… |
| è™•ç†æ™‚é–“ | 10 åˆ†é˜ | 2.3 åˆ†é˜ âœ… |
| ä»£ç¢¼è¡Œæ•¸ | 1800 è¡Œ | 1200 è¡Œ âœ… |
| è¤‡é›œåº¦ | é«˜ | ä½ âœ… |

### é æœŸæ•ˆç›Š

| æŒ‡æ¨™ | V6 | V7 ç°¡åŒ–ç‰ˆ | æ”¹å–„ |
|-----|----|----|------|
| è™•ç†æ™‚é–“ | 10åˆ†é˜ | 2.3åˆ†é˜ | **-77%** |
| åƒæ•¸èª¿æ•´æˆæœ¬ | é‡è·‘é è™•ç† + V6 | åƒ…é‡è·‘é è™•ç† | æ›´æ¸…æ™° |
| ä»£ç¢¼ç¶­è­· | è¤‡é›œ | ç°¡å–® | â¬†ï¸ |
| å¯é æ€§ | ä¸­ | é«˜ | â¬†ï¸ |

### ä¸‹ä¸€æ­¥

è©³è¦‹ [EXTRACT_V7_TODO.md](EXTRACT_V7_TODO.md)ï¼ˆç°¡åŒ–ç‰ˆå¯¦æ–½è¨ˆåŠƒï¼‰

---

**æ–‡æª”ç‰ˆæœ¬**: v7.0.0-simplified
**æœ€å¾Œæ›´æ–°**: 2025-10-23
**ç‹€æ…‹**: âœ… è¨­è¨ˆå®Œæˆï¼ˆç°¡åŒ–ç‰ˆï¼‰ï¼Œå¾…å¯¦æ–½
