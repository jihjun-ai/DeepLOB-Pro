# 快速開始：數據質量驗證完整流程

**目標**: 確保訓練數據滿足「具有學習價值、且可以學起來」的標準

**時間**: 約 2-3 小時（首次運行）

**版本**: v1.0 (2025-10-21)

---

## 📋 前置準備

### 1. 確認環境

```bash
conda activate deeplob-pro

# 確認必要套件
python -c "import numpy, pandas, sklearn, scipy; print('OK')"
```

### 2. 確認數據

```bash
# 檢查原始 TXT 檔案
ls data/temp/*.txt

# 應該看到多個日期的 TXT 檔案
# 20250901.txt, 20250902.txt, ...
```

---

## 🚀 完整流程（5 步驟）

### 步驟 1: 預處理 + 過濾（已改進 ✅）

**目的**: 1Hz 聚合 + 動態波動率過濾（限制最高 P50）

```bash
# 執行批次預處理（已修改為最高 P50）
cd D:\Case-New\python\DeepLOB-Pro
scripts\batch_preprocess.bat

# 或手動運行
conda activate deeplob-pro
python scripts\preprocess_single_day.py --input data\temp\20250901.txt \
    --output-dir data\preprocessed_v5_1hz \
    --config configs\config_pro_v5_ml_optimal.yaml
```

**檢查點 1** - 查看過濾結果:
```bash
# 查看 summary.json
cat data\preprocessed_v5_1hz\daily\20250901\summary.json

# 關鍵指標：
# - "filter_method": 應該是 "P50" 或 "P25"（不再是 "P75"）
# - "predicted_label_dist": neutral 應該 > 15%
```

**預期改進**:
- ✅ 舊版 P75: Neutral = 5-10%（太少）
- ✅ 新版 P50: Neutral = 15-25%（合理）
- ✅ 新版 P25: Neutral = 25-35%（更平衡）

---

### 步驟 2: 生成訓練數據（已修復洩漏 ✅）

**目的**: 從 NPZ 生成訓練數據（已修復 bfill 洩漏）

```bash
python scripts\extract_tw_stock_data_v6.py \
    --preprocessed-dir data\preprocessed_v5_1hz \
    --output-dir data\processed_v6 \
    --config configs\config_pro_v5_ml_optimal.yaml
```

**檢查點 2** - 確認輸出:
```bash
ls data\processed_v6\npz\

# 應該看到：
# - stock_embedding_train.npz
# - stock_embedding_val.npz
# - stock_embedding_test.npz
# - normalization_meta.json
```

---

### 步驟 3: 數據健檢（必要條件 1-3, 5）

**目的**: 檢查明確任務、無洩漏、足量多樣、噪聲管理

```bash
python scripts\data_health_check.py \
    --train-npz data\processed_v6\npz\stock_embedding_train.npz \
    --val-npz data\processed_v6\npz\stock_embedding_val.npz \
    --test-npz data\processed_v6\npz\stock_embedding_test.npz \
    --output-dir data\processed_v6\health_check
```

**檢查點 3** - 查看報告:
```bash
cat data\processed_v6\health_check\health_check_report.txt
```

**通過標準**:
```
檢查結果:
  1. 明確任務與標籤: ✅ 通過
  2. 未來資訊洩漏: ✅ 通過      ← 關鍵！
  3. 足量且多樣: ✅ 通過         ← 應該比之前好
  4. 穩定性: (需步驟 4)
  5. 基準對比: ✅ 通過

總體評估: ✅ 數據具有學習價值
```

**如果未通過怎麼辦？**

| 檢查項 | 未通過原因 | 解決方案 |
|--------|-----------|---------|
| 2. 洩漏測試 | 打亂後準確率仍高 | ❌ 嚴重問題，回報 bug |
| 3. 足量多樣 | Neff < 500 | 增加數據天數 |
| 3. 足量多樣 | Neutral < 15% | 放寬過濾至 P25 |
| 5. 基準對比 | AUC < 0.50 | 檢查數據質量 |

---

### 步驟 4: 穩定性驗證（必要條件 4）⭐ **最關鍵**

**目的**: 滾動回測，證明訊號在時間上穩定

```bash
python scripts\stability_check.py \
    --preprocessed-dir data\preprocessed_v5_1hz \
    --output-dir data\stability_check \
    --train-window 20 \
    --test-window 5 \
    --step 5
```

**參數說明**:
- `--train-window 20`: 用 20 天訓練
- `--test-window 5`: 測試 5 天
- `--step 5`: 每 5 天滾動一次

**時間**: 約 30-60 分鐘（取決於數據量）

**檢查點 4** - 查看穩定性報告:
```bash
cat data\stability_check\stability_report.txt
```

**通過標準**:
```
穩定性指標:
  AUC 平均: 0.520 ± 0.040         ← 應 > 0.52
  AUC 範圍: [0.480, 0.580]
  AUC 正比例: 85.0%                ← 應 > 80%

  IC 平均: 0.025 ± 0.015
  IC 範圍: [0.005, 0.045]
  IC 正比例: 90.0%                 ← 應 > 60%

總體評估: ✅ 穩定
通過: 是
```

**穩定性等級**:
- ✅ **穩定**: AUC 平均 > 0.52, std < 0.05, 正比例 > 80%
- ⚠️ **勉強**: AUC 平均 > 0.50, 正比例 > 60%
- ❌ **不穩定**: AUC 經常 < 0.5 或波動劇烈

---

### 步驟 5: 最終確認

**檢查清單**:

- [ ] 步驟 1: 過濾方法不是 P75（改為 P50 或 P25）
- [ ] 步驟 2: 訓練數據生成無錯誤
- [ ] 步驟 3: 健檢報告 4/5 項通過
- [ ] 步驟 4: 穩定性報告通過（AUC > 0.52）
- [ ] **額外**: Neutral 標籤 > 15%

**如果全部通過** ✅:
```bash
# 恭喜！數據具有學習價值，可以開始訓練
python scripts\train_deeplob_v5.py \
    --input-dir data\processed_v6 \
    --output-dir checkpoints\v6
```

**如果未通過** ⚠️:
- 查看 [docs/DATA_QUALITY_IMPROVEMENT_GUIDE.md](docs/DATA_QUALITY_IMPROVEMENT_GUIDE.md) 詳細改進方案
- 或聯繫支援

---

## 🔧 故障排除

### 問題 1: Neutral 標籤仍然過低（< 15%）

**原因**: P50 仍然太激進

**解決**:
```bash
# 修改 scripts/preprocess_single_day.py
# 將 candidates 改為只包含 P10, P25（移除 P50）

candidates = {
    'P10': np.percentile(range_values, 10),
    'P25': np.percentile(range_values, 25),
    # 'P50': np.percentile(range_values, 50),  # 註解掉
    'none': 0.0
}

# 重新執行步驟 1
```

### 問題 2: 穩定性檢查 AUC < 0.50

**可能原因**:
1. 數據天數太少（< 30 天）
2. 標籤質量問題
3. 特徵無預測力

**診斷**:
```bash
# 檢查數據天數
ls data\preprocessed_v5_1hz\daily | wc -l

# 應該 > 30 天
```

**解決**:
- 增加數據天數至 60+ 天
- 檢查 Triple-Barrier 參數是否合理

### 問題 3: 健檢報告顯示洩漏

**檢查**:
```json
// health_check_report.json
{
  "check_2_leakage": {
    "test_a_pass": false,  // ❌ 打亂測試失敗
    "shuffled_accuracy": 0.55  // 打亂後仍高
  }
}
```

**行動**:
1. 確認已更新 extract_tw_stock_data_v6.py（修復 bfill）
2. 確認已重新生成訓練數據
3. 如果仍失敗，回報問題

---

## 📊 關鍵指標速查表

| 指標 | 健康範圍 | 警戒範圍 | 危險範圍 |
|------|---------|---------|---------|
| **Neutral %** | 20-45% | 15-20%, 45-55% | < 15%, > 60% |
| **Neff (每類)** | > 1000 | 500-1000 | < 500 |
| **健檢 AUC** | > 0.52 | 0.50-0.52 | < 0.50 |
| **穩定性 AUC 平均** | > 0.52 | 0.50-0.52 | < 0.50 |
| **穩定性 AUC std** | < 0.05 | 0.05-0.08 | > 0.08 |
| **IC 平均** | > 0.02 | 0.01-0.02 | < 0.01 |
| **PSI (最大)** | < 0.15 | 0.15-0.25 | > 0.25 |

---

## 📈 改進前後對比

### 改進前（P75 過濾）

```
過濾結果:
  保留股票: 56/223 (25%)
  Neutral: 5.4%  ❌ 太少

數據健檢:
  穩定性: ❌ 未驗證

風險:
  - 樣本選擇偏差
  - 模型只見過高波動場景
  - 未證明訊號穩定
```

### 改進後（P50 過濾 + 穩定性驗證）

```
過濾結果:
  保留股票: ~112/223 (50%)
  Neutral: 15-25%  ✅ 合理

數據健檢:
  1. 明確任務: ✅
  2. 無洩漏: ✅ (已修復 bfill)
  3. 足量多樣: ✅ (改善)
  4. 穩定性: ✅ (新增驗證)
  5. 基準對比: ✅

風險:
  - 大幅降低
  - 涵蓋多種行情
  - 訊號穩定性已驗證
```

---

## 🎯 下一步

### 如果通過所有檢查 ✅

1. **開始訓練 DeepLOB**
   ```bash
   python scripts\train_deeplob_v5.py \
       --input-dir data\processed_v6 \
       --output-dir checkpoints\v6 \
       --epochs 50
   ```

2. **監控訓練指標**
   ```bash
   tensorboard --logdir logs\deeplob_v6
   ```

3. **定期重新驗證**（每月）
   - 重新運行健檢和穩定性檢查
   - 監控 PSI 是否顯著漂移

### 如果未通過某些檢查 ⚠️

1. **優先處理**:
   - 穩定性問題（最關鍵）
   - 洩漏問題（嚴重）
   - 樣本多樣性（中等）

2. **參考詳細指南**:
   - [DATA_QUALITY_IMPROVEMENT_GUIDE.md](docs/DATA_QUALITY_IMPROVEMENT_GUIDE.md)

---

## 📞 支援與資源

**文檔**:
- [DATA_QUALITY_IMPROVEMENT_GUIDE.md](docs/DATA_QUALITY_IMPROVEMENT_GUIDE.md) - 完整改進指南
- [1HZ_OUTPUT_ANALYSIS_REPORT.md](docs/1HZ_OUTPUT_ANALYSIS_REPORT.md) - 1Hz 聚合分析
- [SB3_IMPLEMENTATION_REPORT.md](docs/SB3_IMPLEMENTATION_REPORT.md) - SB3 實作報告

**腳本**:
- `scripts/data_health_check.py` - 數據健檢
- `scripts/stability_check.py` - 穩定性驗證
- `scripts/preprocess_single_day.py` - 預處理
- `scripts/extract_tw_stock_data_v6.py` - 訓練數據生成

**關鍵修改**:
- ✅ `preprocess_single_day.py:527` - 移除 P75
- ✅ `extract_tw_stock_data_v6.py:86-108` - 修復 bfill
- ✅ `extract_tw_stock_data_v6.py:471` - 強制 day_boundary

---

**最後更新**: 2025-10-21
**版本**: v1.0
**狀態**: 已完成所有關鍵改進
