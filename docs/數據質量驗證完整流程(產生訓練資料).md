# å¿«é€Ÿé–‹å§‹ï¼šæ•¸æ“šè³ªé‡é©—è­‰å®Œæ•´æµç¨‹

**ç›®æ¨™**: ç¢ºä¿è¨“ç·´æ•¸æ“šæ»¿è¶³ã€Œå…·æœ‰å­¸ç¿’åƒ¹å€¼ã€ä¸”å¯ä»¥å­¸èµ·ä¾†ã€çš„æ¨™æº–

**æ™‚é–“**: ç´„ 2-3 å°æ™‚ï¼ˆé¦–æ¬¡é‹è¡Œï¼‰

**ç‰ˆæœ¬**: v1.0 (2025-10-21)

---

## ğŸ“‹ å‰ç½®æº–å‚™

### 1. ç¢ºèªç’°å¢ƒ

```bash
conda activate deeplob-pro

# ç¢ºèªå¿…è¦å¥—ä»¶
python -c "import numpy, pandas, sklearn, scipy; print('OK')"
```

### 2. ç¢ºèªæ•¸æ“š

```bash
# æª¢æŸ¥åŸå§‹ TXT æª”æ¡ˆ
ls data/temp/*.txt

# æ‡‰è©²çœ‹åˆ°å¤šå€‹æ—¥æœŸçš„ TXT æª”æ¡ˆ
# 20250901.txt, 20250902.txt, ...
```

---

## ğŸš€ å®Œæ•´æµç¨‹ï¼ˆ5 æ­¥é©Ÿï¼‰

### æ­¥é©Ÿ 1: é è™•ç† + éæ¿¾ï¼ˆå·²æ”¹é€² âœ…ï¼‰

**ç›®çš„**: 1Hz èšåˆ + å‹•æ…‹æ³¢å‹•ç‡éæ¿¾ï¼ˆé™åˆ¶æœ€é«˜ P50ï¼‰

```bash
# åŸ·è¡Œæ‰¹æ¬¡é è™•ç†ï¼ˆå·²ä¿®æ”¹ç‚ºæœ€é«˜ P50ï¼‰
cd D:\Case-New\python\DeepLOB-Pro
scripts\batch_preprocess.bat

# æˆ–æ‰‹å‹•é‹è¡Œ
conda activate deeplob-pro
python scripts\preprocess_single_day.py --input data\temp\20250901.txt \
    --output-dir data\preprocessed_v5_1hz \
    --config configs\config_pro_v5_ml_optimal.yaml
```

**æª¢æŸ¥é» 1** - æŸ¥çœ‹éæ¿¾çµæœ:
```bash
# æŸ¥çœ‹ summary.json
cat data\preprocessed_v5_1hz\daily\20250901\summary.json

# é—œéµæŒ‡æ¨™ï¼š
# - "filter_method": æ‡‰è©²æ˜¯ "P50" æˆ– "P25"ï¼ˆä¸å†æ˜¯ "P75"ï¼‰
# - "predicted_label_dist": neutral æ‡‰è©² > 15%
```

**é æœŸæ”¹é€²**:
- âœ… èˆŠç‰ˆ P75: Neutral = 5-10%ï¼ˆå¤ªå°‘ï¼‰
- âœ… æ–°ç‰ˆ P50: Neutral = 15-25%ï¼ˆåˆç†ï¼‰
- âœ… æ–°ç‰ˆ P25: Neutral = 25-35%ï¼ˆæ›´å¹³è¡¡ï¼‰

---

### æ­¥é©Ÿ 2: ç”Ÿæˆè¨“ç·´æ•¸æ“šï¼ˆå·²ä¿®å¾©æ´©æ¼ âœ…ï¼‰

**ç›®çš„**: å¾ NPZ ç”Ÿæˆè¨“ç·´æ•¸æ“šï¼ˆå·²ä¿®å¾© bfill æ´©æ¼ï¼‰

```bash
python scripts\extract_tw_stock_data_v6.py \
    --preprocessed-dir data\preprocessed_v5_1hz \
    --output-dir data\processed_v6 \
    --config configs\config_pro_v5_ml_optimal.yaml
```

**æª¢æŸ¥é» 2** - ç¢ºèªè¼¸å‡º:
```bash
ls data\processed_v6\npz\

# æ‡‰è©²çœ‹åˆ°ï¼š
# - stock_embedding_train.npz
# - stock_embedding_val.npz
# - stock_embedding_test.npz
# - normalization_meta.json
```

---

### æ­¥é©Ÿ 3: æ•¸æ“šå¥æª¢ï¼ˆå¿…è¦æ¢ä»¶ 1-3, 5ï¼‰

**ç›®çš„**: æª¢æŸ¥æ˜ç¢ºä»»å‹™ã€ç„¡æ´©æ¼ã€è¶³é‡å¤šæ¨£ã€å™ªè²ç®¡ç†

```bash
python scripts\data_health_check.py \
    --train-npz data\processed_v6\npz\stock_embedding_train.npz \
    --val-npz data\processed_v6\npz\stock_embedding_val.npz \
    --test-npz data\processed_v6\npz\stock_embedding_test.npz \
    --output-dir data\processed_v6\health_check
```

**æª¢æŸ¥é» 3** - æŸ¥çœ‹å ±å‘Š:
```bash
cat data\processed_v6\health_check\health_check_report.txt
```

**é€šéæ¨™æº–**:
```
æª¢æŸ¥çµæœ:
  1. æ˜ç¢ºä»»å‹™èˆ‡æ¨™ç±¤: âœ… é€šé
  2. æœªä¾†è³‡è¨Šæ´©æ¼: âœ… é€šé      â† é—œéµï¼
  3. è¶³é‡ä¸”å¤šæ¨£: âœ… é€šé         â† æ‡‰è©²æ¯”ä¹‹å‰å¥½
  4. ç©©å®šæ€§: (éœ€æ­¥é©Ÿ 4)
  5. åŸºæº–å°æ¯”: âœ… é€šé

ç¸½é«”è©•ä¼°: âœ… æ•¸æ“šå…·æœ‰å­¸ç¿’åƒ¹å€¼
```

**å¦‚æœæœªé€šéæ€éº¼è¾¦ï¼Ÿ**

| æª¢æŸ¥é … | æœªé€šéåŸå›  | è§£æ±ºæ–¹æ¡ˆ |
|--------|-----------|---------|
| 2. æ´©æ¼æ¸¬è©¦ | æ‰“äº‚å¾Œæº–ç¢ºç‡ä»é«˜ | âŒ åš´é‡å•é¡Œï¼Œå›å ± bug |
| 3. è¶³é‡å¤šæ¨£ | Neff < 500 | å¢åŠ æ•¸æ“šå¤©æ•¸ |
| 3. è¶³é‡å¤šæ¨£ | Neutral < 15% | æ”¾å¯¬éæ¿¾è‡³ P25 |
| 5. åŸºæº–å°æ¯” | AUC < 0.50 | æª¢æŸ¥æ•¸æ“šè³ªé‡ |

---

### æ­¥é©Ÿ 4: ç©©å®šæ€§é©—è­‰ï¼ˆå¿…è¦æ¢ä»¶ 4ï¼‰â­ **æœ€é—œéµ**

**ç›®çš„**: æ»¾å‹•å›æ¸¬ï¼Œè­‰æ˜è¨Šè™Ÿåœ¨æ™‚é–“ä¸Šç©©å®š

```bash
python scripts\stability_check.py \
    --preprocessed-dir data\preprocessed_v5_1hz \
    --output-dir data\stability_check \
    --train-window 20 \
    --test-window 5 \
    --step 5
```

**åƒæ•¸èªªæ˜**:
- `--train-window 20`: ç”¨ 20 å¤©è¨“ç·´
- `--test-window 5`: æ¸¬è©¦ 5 å¤©
- `--step 5`: æ¯ 5 å¤©æ»¾å‹•ä¸€æ¬¡

**æ™‚é–“**: ç´„ 30-60 åˆ†é˜ï¼ˆå–æ±ºæ–¼æ•¸æ“šé‡ï¼‰

**æª¢æŸ¥é» 4** - æŸ¥çœ‹ç©©å®šæ€§å ±å‘Š:
```bash
cat data\stability_check\stability_report.txt
```

**é€šéæ¨™æº–**:
```
ç©©å®šæ€§æŒ‡æ¨™:
  AUC å¹³å‡: 0.520 Â± 0.040         â† æ‡‰ > 0.52
  AUC ç¯„åœ: [0.480, 0.580]
  AUC æ­£æ¯”ä¾‹: 85.0%                â† æ‡‰ > 80%

  IC å¹³å‡: 0.025 Â± 0.015
  IC ç¯„åœ: [0.005, 0.045]
  IC æ­£æ¯”ä¾‹: 90.0%                 â† æ‡‰ > 60%

ç¸½é«”è©•ä¼°: âœ… ç©©å®š
é€šé: æ˜¯
```

**ç©©å®šæ€§ç­‰ç´š**:
- âœ… **ç©©å®š**: AUC å¹³å‡ > 0.52, std < 0.05, æ­£æ¯”ä¾‹ > 80%
- âš ï¸ **å‹‰å¼·**: AUC å¹³å‡ > 0.50, æ­£æ¯”ä¾‹ > 60%
- âŒ **ä¸ç©©å®š**: AUC ç¶“å¸¸ < 0.5 æˆ–æ³¢å‹•åŠ‡çƒˆ

---

### æ­¥é©Ÿ 5: æœ€çµ‚ç¢ºèª

**æª¢æŸ¥æ¸…å–®**:

- [ ] æ­¥é©Ÿ 1: éæ¿¾æ–¹æ³•ä¸æ˜¯ P75ï¼ˆæ”¹ç‚º P50 æˆ– P25ï¼‰
- [ ] æ­¥é©Ÿ 2: è¨“ç·´æ•¸æ“šç”Ÿæˆç„¡éŒ¯èª¤
- [ ] æ­¥é©Ÿ 3: å¥æª¢å ±å‘Š 4/5 é …é€šé
- [ ] æ­¥é©Ÿ 4: ç©©å®šæ€§å ±å‘Šé€šéï¼ˆAUC > 0.52ï¼‰
- [ ] **é¡å¤–**: Neutral æ¨™ç±¤ > 15%

**å¦‚æœå…¨éƒ¨é€šé** âœ…:
```bash
# æ­å–œï¼æ•¸æ“šå…·æœ‰å­¸ç¿’åƒ¹å€¼ï¼Œå¯ä»¥é–‹å§‹è¨“ç·´
python scripts\train_deeplob_v5.py \
    --input-dir data\processed_v6 \
    --output-dir checkpoints\v6
```

**å¦‚æœæœªé€šé** âš ï¸:
- æŸ¥çœ‹ [docs/DATA_QUALITY_IMPROVEMENT_GUIDE.md](docs/DATA_QUALITY_IMPROVEMENT_GUIDE.md) è©³ç´°æ”¹é€²æ–¹æ¡ˆ
- æˆ–è¯ç¹«æ”¯æ´

---

## ğŸ”§ æ•…éšœæ’é™¤

### å•é¡Œ 1: Neutral æ¨™ç±¤ä»ç„¶éä½ï¼ˆ< 15%ï¼‰

**åŸå› **: P50 ä»ç„¶å¤ªæ¿€é€²

**è§£æ±º**:
```bash
# ä¿®æ”¹ scripts/preprocess_single_day.py
# å°‡ candidates æ”¹ç‚ºåªåŒ…å« P10, P25ï¼ˆç§»é™¤ P50ï¼‰

candidates = {
    'P10': np.percentile(range_values, 10),
    'P25': np.percentile(range_values, 25),
    # 'P50': np.percentile(range_values, 50),  # è¨»è§£æ‰
    'none': 0.0
}

# é‡æ–°åŸ·è¡Œæ­¥é©Ÿ 1
```

### å•é¡Œ 2: ç©©å®šæ€§æª¢æŸ¥ AUC < 0.50

**å¯èƒ½åŸå› **:
1. æ•¸æ“šå¤©æ•¸å¤ªå°‘ï¼ˆ< 30 å¤©ï¼‰
2. æ¨™ç±¤è³ªé‡å•é¡Œ
3. ç‰¹å¾µç„¡é æ¸¬åŠ›

**è¨ºæ–·**:
```bash
# æª¢æŸ¥æ•¸æ“šå¤©æ•¸
ls data\preprocessed_v5_1hz\daily | wc -l

# æ‡‰è©² > 30 å¤©
```

**è§£æ±º**:
- å¢åŠ æ•¸æ“šå¤©æ•¸è‡³ 60+ å¤©
- æª¢æŸ¥ Triple-Barrier åƒæ•¸æ˜¯å¦åˆç†

### å•é¡Œ 3: å¥æª¢å ±å‘Šé¡¯ç¤ºæ´©æ¼

**æª¢æŸ¥**:
```json
// health_check_report.json
{
  "check_2_leakage": {
    "test_a_pass": false,  // âŒ æ‰“äº‚æ¸¬è©¦å¤±æ•—
    "shuffled_accuracy": 0.55  // æ‰“äº‚å¾Œä»é«˜
  }
}
```

**è¡Œå‹•**:
1. ç¢ºèªå·²æ›´æ–° extract_tw_stock_data_v6.pyï¼ˆä¿®å¾© bfillï¼‰
2. ç¢ºèªå·²é‡æ–°ç”Ÿæˆè¨“ç·´æ•¸æ“š
3. å¦‚æœä»å¤±æ•—ï¼Œå›å ±å•é¡Œ

---

## ğŸ“Š é—œéµæŒ‡æ¨™é€ŸæŸ¥è¡¨

| æŒ‡æ¨™ | å¥åº·ç¯„åœ | è­¦æˆ’ç¯„åœ | å±éšªç¯„åœ |
|------|---------|---------|---------|
| **Neutral %** | 20-45% | 15-20%, 45-55% | < 15%, > 60% |
| **Neff (æ¯é¡)** | > 1000 | 500-1000 | < 500 |
| **å¥æª¢ AUC** | > 0.52 | 0.50-0.52 | < 0.50 |
| **ç©©å®šæ€§ AUC å¹³å‡** | > 0.52 | 0.50-0.52 | < 0.50 |
| **ç©©å®šæ€§ AUC std** | < 0.05 | 0.05-0.08 | > 0.08 |
| **IC å¹³å‡** | > 0.02 | 0.01-0.02 | < 0.01 |
| **PSI (æœ€å¤§)** | < 0.15 | 0.15-0.25 | > 0.25 |

---

## ğŸ“ˆ æ”¹é€²å‰å¾Œå°æ¯”

### æ”¹é€²å‰ï¼ˆP75 éæ¿¾ï¼‰

```
éæ¿¾çµæœ:
  ä¿ç•™è‚¡ç¥¨: 56/223 (25%)
  Neutral: 5.4%  âŒ å¤ªå°‘

æ•¸æ“šå¥æª¢:
  ç©©å®šæ€§: âŒ æœªé©—è­‰

é¢¨éšª:
  - æ¨£æœ¬é¸æ“‡åå·®
  - æ¨¡å‹åªè¦‹éé«˜æ³¢å‹•å ´æ™¯
  - æœªè­‰æ˜è¨Šè™Ÿç©©å®š
```

### æ”¹é€²å¾Œï¼ˆP50 éæ¿¾ + ç©©å®šæ€§é©—è­‰ï¼‰

```
éæ¿¾çµæœ:
  ä¿ç•™è‚¡ç¥¨: ~112/223 (50%)
  Neutral: 15-25%  âœ… åˆç†

æ•¸æ“šå¥æª¢:
  1. æ˜ç¢ºä»»å‹™: âœ…
  2. ç„¡æ´©æ¼: âœ… (å·²ä¿®å¾© bfill)
  3. è¶³é‡å¤šæ¨£: âœ… (æ”¹å–„)
  4. ç©©å®šæ€§: âœ… (æ–°å¢é©—è­‰)
  5. åŸºæº–å°æ¯”: âœ…

é¢¨éšª:
  - å¤§å¹…é™ä½
  - æ¶µè“‹å¤šç¨®è¡Œæƒ…
  - è¨Šè™Ÿç©©å®šæ€§å·²é©—è­‰
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### å¦‚æœé€šéæ‰€æœ‰æª¢æŸ¥ âœ…

1. **é–‹å§‹è¨“ç·´ DeepLOB**
   ```bash
   python scripts\train_deeplob_v5.py \
       --input-dir data\processed_v6 \
       --output-dir checkpoints\v6 \
       --epochs 50
   ```

2. **ç›£æ§è¨“ç·´æŒ‡æ¨™**
   ```bash
   tensorboard --logdir logs\deeplob_v6
   ```

3. **å®šæœŸé‡æ–°é©—è­‰**ï¼ˆæ¯æœˆï¼‰
   - é‡æ–°é‹è¡Œå¥æª¢å’Œç©©å®šæ€§æª¢æŸ¥
   - ç›£æ§ PSI æ˜¯å¦é¡¯è‘—æ¼‚ç§»

### å¦‚æœæœªé€šéæŸäº›æª¢æŸ¥ âš ï¸

1. **å„ªå…ˆè™•ç†**:
   - ç©©å®šæ€§å•é¡Œï¼ˆæœ€é—œéµï¼‰
   - æ´©æ¼å•é¡Œï¼ˆåš´é‡ï¼‰
   - æ¨£æœ¬å¤šæ¨£æ€§ï¼ˆä¸­ç­‰ï¼‰

2. **åƒè€ƒè©³ç´°æŒ‡å—**:
   - [DATA_QUALITY_IMPROVEMENT_GUIDE.md](docs/DATA_QUALITY_IMPROVEMENT_GUIDE.md)

---

## ğŸ“ æ”¯æ´èˆ‡è³‡æº

**æ–‡æª”**:
- [DATA_QUALITY_IMPROVEMENT_GUIDE.md](docs/DATA_QUALITY_IMPROVEMENT_GUIDE.md) - å®Œæ•´æ”¹é€²æŒ‡å—
- [1HZ_OUTPUT_ANALYSIS_REPORT.md](docs/1HZ_OUTPUT_ANALYSIS_REPORT.md) - 1Hz èšåˆåˆ†æ
- [SB3_IMPLEMENTATION_REPORT.md](docs/SB3_IMPLEMENTATION_REPORT.md) - SB3 å¯¦ä½œå ±å‘Š

**è…³æœ¬**:
- `scripts/data_health_check.py` - æ•¸æ“šå¥æª¢
- `scripts/stability_check.py` - ç©©å®šæ€§é©—è­‰
- `scripts/preprocess_single_day.py` - é è™•ç†
- `scripts/extract_tw_stock_data_v6.py` - è¨“ç·´æ•¸æ“šç”Ÿæˆ

**é—œéµä¿®æ”¹**:
- âœ… `preprocess_single_day.py:527` - ç§»é™¤ P75
- âœ… `extract_tw_stock_data_v6.py:86-108` - ä¿®å¾© bfill
- âœ… `extract_tw_stock_data_v6.py:471` - å¼·åˆ¶ day_boundary

---

**æœ€å¾Œæ›´æ–°**: 2025-10-21
**ç‰ˆæœ¬**: v1.0
**ç‹€æ…‹**: å·²å®Œæˆæ‰€æœ‰é—œéµæ”¹é€²
