# V6 雙階段數據與 DeepLOB 訓練配置對應關係

**建立日期**: 2025-10-22
**目的**: 明確 V6 雙階段處理產生的數據與 DeepLOB 訓練腳本的配置對應

---

## 📋 快速對應表

| 項目 | V6 數據處理 | DeepLOB 訓練 |
|------|------------|-------------|
| **數據處理配置** | `configs/config_pro_v5_ml_optimal.yaml` | - |
| **訓練配置** | - | `configs/train_v5.yaml` |
| **處理腳本** | `scripts/extract_tw_stock_data_v6.py` | `scripts/train_deeplob_v5.py` |
| **數據輸出目錄** | `data/processed_v6/npz/` | - |
| **模型輸出目錄** | - | `checkpoints/v5/` |

---

## 🔄 完整工作流程

### 步驟 1: V6 雙階段數據處理

#### 1.1 預處理（階段 1）

**目的**: 將原始 TXT 轉為中間 NPZ 格式

```bash
# 批次預處理（首次執行）
conda activate deeplob-pro
scripts\batch_preprocess.bat
```

**配置**: 使用 `configs/config_pro_v5_ml_optimal.yaml` 中的：
- `data.aggregation_factor: 10`
- `data.trading_start/end`
- 動態過濾相關參數

**輸出**: `data/preprocessed_v5/daily/YYYYMMDD/*.npz`

---

#### 1.2 訓練數據生成（階段 2）

**目的**: 從預處理 NPZ 生成訓練用數據

```bash
# 生成訓練數據（使用 config_pro_v5_ml_optimal.yaml）
python scripts\extract_tw_stock_data_v6.py ^
    --preprocessed-dir .\data\preprocessed_v5 ^
    --output-dir .\data\processed_v6 ^
    --config .\configs\config_pro_v5_ml_optimal.yaml
```

**配置**: 使用 `configs/config_pro_v5_ml_optimal.yaml` 中的：
- `normalization.*` - Z-Score 標準化
- `volatility.*` - EWMA 波動率
- `triple_barrier.*` - 標籤生成
- `sample_weights.*` - 樣本權重
- `split.*` - 數據切分

**輸出**:
```
data/processed_v6/npz/
├── stock_embedding_train.npz
├── stock_embedding_val.npz
├── stock_embedding_test.npz
└── normalization_meta.json
```

**NPZ 格式** (與 V5 完全兼容):
```python
{
    "X": (N, 100, 20),      # 特徵序列
    "y": (N,),              # 標籤 {0, 1, 2}
    "weights": (N,),        # 樣本權重
    "stock_ids": (N,)       # 股票代碼
}
```

---

### 步驟 2: DeepLOB 訓練

**腳本**: `scripts/train_deeplob_v5.py`
**配置**: `configs/train_v5.yaml`

#### 2.1 修改 train_v5.yaml 數據路徑

**重要**: 需要手動修改配置文件中的數據路徑，指向 V6 產生的數據！

```yaml
# ==================== 數據配置 ====================
data:
  # ⚠️ 修改這些路徑，指向 V6 輸出目錄！
  train: "data/processed_v6/npz/stock_embedding_train.npz"  # 原本是 processed_v5
  val: "data/processed_v6/npz/stock_embedding_val.npz"
  test: "data/processed_v6/npz/stock_embedding_test.npz"
  norm_meta: "data/processed_v6/npz/normalization_meta.json"

  # 其他配置保持不變
  v5_labels: true
  use_sample_weights: true
  use_stock_ids: false
```

#### 2.2 執行訓練

**方法 1: 使用修改後的 train_v5.yaml**
```bash
conda activate deeplob-pro
python scripts\train_deeplob_v5.py --config configs\train_v5.yaml
```

**方法 2: 使用 --data-dir 參數（推薦）⭐**
```bash
# 無需修改 YAML，直接指定數據目錄
python scripts\train_deeplob_v5.py ^
    --config configs\train_v5.yaml ^
    --data-dir data\processed_v6\npz
```

**說明**: `--data-dir` 參數會自動覆蓋配置中的數據路徑：
```python
# train_deeplob_v5.py 內部邏輯（Line 730-736）
if args.data_dir:
    config['data']['train'] = os.path.join(data_dir, 'stock_embedding_train.npz')
    config['data']['val'] = os.path.join(data_dir, 'stock_embedding_val.npz')
    config['data']['test'] = os.path.join(data_dir, 'stock_embedding_test.npz')
    config['data']['norm_meta'] = os.path.join(data_dir, 'normalization_meta.json')
```

---

## 🎯 配置文件詳解

### config_pro_v5_ml_optimal.yaml（數據處理）

**用途**: 控制 V6 數據生成的所有參數

**關鍵參數**:
```yaml
# 標準化
normalization:
  method: 'rolling_zscore'  # 滾動窗口 Z-Score
  window: 100

# 波動率
volatility:
  method: 'ewma'
  halflife: 60

# Triple-Barrier 標籤
triple_barrier:
  pt_multiplier: 3.5   # 止盈
  sl_multiplier: 3.5   # 止損
  max_holding: 40      # 最大持有
  min_return: 0.0015   # 閾值

# 樣本權重
sample_weights:
  enabled: true
  tau: 80.0
  return_scaling: 1.0
  balance_classes: true
  use_log_scale: true

# 數據切分
split:
  train_ratio: 0.7
  val_ratio: 0.15
  test_ratio: 0.15
  seed: 42
```

---

### train_v5.yaml（模型訓練）

**用途**: 控制 DeepLOB 模型訓練的所有參數

**關鍵參數**:
```yaml
# 數據配置
data:
  train: "data/processed_v6/npz/stock_embedding_train.npz"  # ⚠️ 需修改！
  val: "data/processed_v6/npz/stock_embedding_val.npz"
  test: "data/processed_v6/npz/stock_embedding_test.npz"
  v5_labels: true
  use_sample_weights: true

# DataLoader
dataloader:
  batch_size: 512
  num_workers: 4

# 模型架構
model:
  arch: "DeepLOB"
  lstm_hidden_size: 32
  fc_hidden_size: 32
  dropout: 0.5

# 損失函數
loss:
  type: "ce"
  class_weights: "auto"

# 優化器
optim:
  name: "adamw"
  lr: 0.00005
  weight_decay: 0.0005
  grad_clip: 0.5

# 訓練配置
train:
  epochs: 40
  early_stop:
    metric: "val.f1_macro_weighted"
    patience: 8
```

---

## ⚠️ 常見錯誤與解決方案

### 錯誤 1: 數據路徑錯誤

**症狀**:
```
FileNotFoundError: [Errno 2] No such file or directory:
'data/processed_v5/npz/stock_embedding_train.npz'
```

**原因**: `train_v5.yaml` 中的路徑仍指向 `processed_v5`

**解決方案**:
1. 修改 `train_v5.yaml` 中的路徑為 `processed_v6`
2. **或使用 `--data-dir` 參數（推薦）**:
   ```bash
   python scripts\train_deeplob_v5.py ^
       --config configs\train_v5.yaml ^
       --data-dir data\processed_v6\npz
   ```

---

### 錯誤 2: 標籤分布不符預期

**症狀**:
```
Class 1 (持平) 比例過高 (>60%) 或過低 (<20%)
```

**原因**: `config_pro_v5_ml_optimal.yaml` 參數未調整

**解決方案**: 調整 Triple-Barrier 參數
```yaml
triple_barrier:
  pt_multiplier: 3.0   # 降低閾值 → 更多 up/down
  sl_multiplier: 3.0
  min_return: 0.002    # 提高閾值 → 更多 neutral
```

重新執行階段 2（僅需 5-10 分鐘）:
```bash
python scripts\extract_tw_stock_data_v6.py ^
    --preprocessed-dir .\data\preprocessed_v5 ^
    --output-dir .\data\processed_v6_test ^
    --config .\configs\config_pro_v5_ml_optimal.yaml
```

---

### 錯誤 3: 數據格式不兼容

**症狀**:
```
KeyError: 'weights' or 'stock_ids'
```

**原因**: V6 產生的數據缺少必要欄位

**解決方案**: 檢查 `config_pro_v5_ml_optimal.yaml`:
```yaml
output:
  save_meta: true
  save_weights: true  # ⚠️ 確保啟用
```

---

## 📊 完整示例：從零開始訓練

```bash
# ========== 階段 0: 環境準備 ==========
conda activate deeplob-pro

# ========== 階段 1: 預處理（首次，30 分鐘）==========
scripts\batch_preprocess.bat

# ========== 階段 2: 生成訓練數據（8 分鐘）==========
python scripts\extract_tw_stock_data_v6.py ^
    --preprocessed-dir .\data\preprocessed_v5 ^
    --output-dir .\data\processed_v6 ^
    --config .\configs\config_pro_v5_ml_optimal.yaml

# ========== 驗證數據 ==========
python -c "
import numpy as np
data = np.load('data/processed_v6/npz/stock_embedding_train.npz', allow_pickle=True)
print('Keys:', list(data.keys()))
print('X shape:', data['X'].shape)
print('y shape:', data['y'].shape)
print('Label dist:', np.bincount(data['y']))
"

# ========== 階段 3: 訓練 DeepLOB（2-4 小時，RTX 5090）==========
python scripts\train_deeplob_v5.py ^
    --config configs\train_v5.yaml ^
    --data-dir data\processed_v6\npz ^
    --epochs 40

# ========== 監控訓練 ==========
tensorboard --logdir logs/deeplob_v5
```

---

## 🔧 參數調整建議

### 快速測試標籤分布

如果需要測試不同的 Triple-Barrier 參數：

1. **複製配置**:
   ```bash
   copy configs\config_pro_v5_ml_optimal.yaml configs\config_test.yaml
   ```

2. **修改參數** (config_test.yaml):
   ```yaml
   triple_barrier:
     pt_multiplier: 3.0   # 測試不同閾值
     min_return: 0.002
   ```

3. **快速生成數據**（5-10 分鐘）:
   ```bash
   python scripts\extract_tw_stock_data_v6.py ^
       --preprocessed-dir .\data\preprocessed_v5 ^
       --output-dir .\data\processed_test ^
       --config .\configs\config_test.yaml
   ```

4. **檢查標籤分布**:
   ```bash
   python -c "
   import numpy as np
   import json

   # 方法 1: 從 NPZ 檢查
   data = np.load('data/processed_test/npz/stock_embedding_train.npz')
   y = data['y']
   dist = np.bincount(y)
   pct = dist / dist.sum() * 100
   print(f'Label dist: {dist}')
   print(f'Percentage: Down={pct[0]:.1f}%, Neutral={pct[1]:.1f}%, Up={pct[2]:.1f}%')

   # 方法 2: 從 metadata 檢查
   with open('data/processed_test/npz/normalization_meta.json') as f:
       meta = json.load(f)
   print(json.dumps(meta['data_split']['results']['train'], indent=2))
   "
   ```

---

## 📚 相關文檔

- [2.V6 雙階段資料處理流程指南.md](2.V6%20雙階段資料處理流程指南.md) - V6 完整指南
- [1.DeepLOB 台股模型訓練最終報告.md](1.DeepLOB%20台股模型訓練最終報告.md) - V5 訓練成果
- [V6_QUICK_START.md](../V6_QUICK_START.md) - V6 快速開始

---

## 總結

### V6 雙階段 + DeepLOB 訓練的完整配置對應：

| 階段 | 腳本 | 配置文件 | 輸出 |
|------|------|---------|------|
| **預處理** | `preprocess_single_day.py` | `config_pro_v5_ml_optimal.yaml` | `preprocessed_v5/daily/` |
| **數據生成** | `extract_tw_stock_data_v6.py` | `config_pro_v5_ml_optimal.yaml` | `processed_v6/npz/` |
| **模型訓練** | `train_deeplob_v5.py` | `train_v5.yaml` + `--data-dir` | `checkpoints/v5/` |

### 關鍵要點：

1. ✅ **數據處理配置**: `config_pro_v5_ml_optimal.yaml` 控制標籤生成、標準化等
2. ✅ **訓練配置**: `train_v5.yaml` 控制模型架構、優化器等
3. ✅ **數據兼容性**: V6 輸出格式與 V5 完全兼容
4. ✅ **推薦用法**: 使用 `--data-dir` 參數避免修改 YAML

### 最佳實踐：

```bash
# 1. 數據生成（使用 config_pro_v5_ml_optimal.yaml）
python scripts\extract_tw_stock_data_v6.py ^
    --preprocessed-dir .\data\preprocessed_v5 ^
    --output-dir .\data\processed_v6 ^
    --config .\configs\config_pro_v5_ml_optimal.yaml

# 2. 模型訓練（使用 train_v5.yaml + --data-dir）
python scripts\train_deeplob_v5.py ^
    --config configs\train_v5.yaml ^
    --data-dir data\processed_v6\npz
```

---

**最後更新**: 2025-10-22
**版本**: 1.0
**適用專案**: DeepLOB-Pro V6
