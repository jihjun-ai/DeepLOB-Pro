# è¨“ç·´æ•¸æ“šæ¨™ç±¤è¦–è¦ºåŒ–å·¥å…·ä½¿ç”¨èªªæ˜

## å·¥å…·æ¦‚è¿°

`visualize_training_labels.py` æ˜¯ä¸€å€‹å°ˆé–€ç”¨æ–¼æª¢æŸ¥ `extract_tw_stock_data_v5.py` ç”¢ç”Ÿçš„è¨“ç·´æ•¸æ“šæ¨™ç±¤æ­£ç¢ºæ€§çš„è¦–è¦ºåŒ–å·¥å…·ã€‚

### ä¸»è¦åŠŸèƒ½

1. **æ”¶ç›¤åƒ¹èˆ‡æ¨™ç±¤è¶¨å‹¢å°ç…§**ï¼šç¹ªè£½æ”¶ç›¤åƒ¹æ›²ç·šï¼Œä¸¦ç”¨é¡è‰²æ¨™è¨»æ¨™ç±¤ï¼ˆç´…=ä¸‹è·Œ, ç°=æŒå¹³, ç¶ =ä¸Šæ¼²ï¼‰
2. **æ¨™ç±¤åˆ†å¸ƒçµ±è¨ˆ**ï¼šæª¢æŸ¥æ¨™ç±¤é¡åˆ¥å¹³è¡¡ï¼ˆ0:ä¸‹è·Œ, 1:æŒå¹³, 2:ä¸Šæ¼²ï¼‰
3. **æ¨£æœ¬æ¬Šé‡åˆ†æ**ï¼šæª¢æŸ¥ Triple-Barrier æ¨£æœ¬æ¬Šé‡åˆ†é…
4. **æ•´é«”çµ±è¨ˆå ±å‘Š**ï¼šè·¨è‚¡ç¥¨çš„æ¨™ç±¤åˆ†å¸ƒèˆ‡æ¨£æœ¬æ•¸çµ±è¨ˆ

---

## ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ä½¿ç”¨ï¼ˆæª¢æŸ¥è¨“ç·´é›†ï¼‰

```bash
conda activate deeplob-pro
python scripts/visualize_training_labels.py \
    --data-dir ./data/processed_v5/npz \
    --split train \
    --n-stocks 5
```

### æª¢æŸ¥é©—è­‰é›†

```bash
python scripts/visualize_training_labels.py \
    --data-dir ./data/processed_v5/npz \
    --split val \
    --n-stocks 3
```

### æª¢æŸ¥æ¸¬è©¦é›†

```bash
python scripts/visualize_training_labels.py \
    --data-dir ./data/processed_v5/npz \
    --split test \
    --n-stocks 3
```

### æª¢æŸ¥å…¶ä»–é…ç½®ç‰ˆæœ¬

```bash
# æª¢æŸ¥ balanced ç‰ˆæœ¬
python scripts/visualize_training_labels.py \
    --data-dir ./data/processed_v5_balanced/npz \
    --split train \
    --n-stocks 5

# æª¢æŸ¥ç‰¹å®šéæ¿¾é…ç½®
python scripts/visualize_training_labels.py \
    --data-dir ./data/processed_v5-44.61/npz \
    --split train \
    --n-stocks 5
```

---

## åƒæ•¸èªªæ˜

| åƒæ•¸ | èªªæ˜ | é è¨­å€¼ |
|------|------|--------|
| `--data-dir` | NPZ æ•¸æ“šç›®éŒ„è·¯å¾‘ | `./data/processed_v5/npz` |
| `--split` | æ•¸æ“šé›†åŠƒåˆ† (`train`, `val`, `test`) | `train` |
| `--n-stocks` | é¡¯ç¤ºå‰ N æª”è‚¡ç¥¨çš„è©³ç´°åœ–è¡¨ | `3` |
| `--output-dir` | åœ–è¡¨è¼¸å‡ºç›®éŒ„ | `./results/label_visualization` |
| `--max-points` | å–®æª”è‚¡ç¥¨æœ€å¤šé¡¯ç¤ºçš„æ™‚é–“é»æ•¸ | `500` |

---

## è¼¸å‡ºçµæœ

### 1. æ•´é«”çµ±è¨ˆåœ– (`overall_statistics.png`)

åŒ…å«ä»¥ä¸‹å­åœ–ï¼š

- **æ¨™ç±¤åˆ†å¸ƒï¼ˆæ•´é«”ï¼‰**ï¼šé¡¯ç¤ºæ•´å€‹æ•¸æ“šé›†çš„æ¨™ç±¤é¡åˆ¥åˆ†å¸ƒ
- **è‚¡ç¥¨æ¨£æœ¬æ•¸åˆ†å¸ƒ**ï¼šæ¯æª”è‚¡ç¥¨çš„æ¨£æœ¬æ•¸åˆ†å¸ƒç›´æ–¹åœ–
- **æ¨£æœ¬æ¬Šé‡åˆ†å¸ƒ**ï¼šTriple-Barrier æ¨£æœ¬æ¬Šé‡åˆ†é…
- **å‰ 20 æª”è‚¡ç¥¨çš„æ¨™ç±¤åˆ†å¸ƒï¼ˆå †ç–Šåœ–ï¼‰**ï¼šæª¢æŸ¥ä¸åŒè‚¡ç¥¨çš„æ¨™ç±¤åˆ†å¸ƒæ˜¯å¦ä¸€è‡´

### 2. å€‹è‚¡è©³ç´°åœ– (`stock_<è‚¡ç¥¨ä»£ç¢¼>.png`)

æ¯æª”è‚¡ç¥¨åŒ…å«ä»¥ä¸‹å­åœ–ï¼š

- **æ”¶ç›¤åƒ¹èˆ‡æ¨™ç±¤è¶¨å‹¢ï¼ˆä¸»åœ–ï¼‰**ï¼š
  - è—è‰²ç·šï¼šæ”¶ç›¤åƒ¹æ›²ç·š
  - èƒŒæ™¯é¡è‰²ï¼šæ¨™ç±¤é¡åˆ¥ï¼ˆç´…=ä¸‹è·Œ, ç°=æŒå¹³, ç¶ =ä¸Šæ¼²ï¼‰
  - **æª¢æŸ¥é‡é»**ï¼šæ¨™ç±¤é¡è‰²èˆ‡åƒ¹æ ¼è¶¨å‹¢æ˜¯å¦ä¸€è‡´

- **æ¨™ç±¤åºåˆ—ï¼ˆæ™‚é–“è»¸ï¼‰**ï¼š
  - é¡è‰²æ¢å¸¶ï¼šæ¯å€‹æ™‚é–“é»çš„æ¨™ç±¤
  - **æª¢æŸ¥é‡é»**ï¼šæ¨™ç±¤æ˜¯å¦éæ–¼é€£çºŒæˆ–è·³å‹•

- **æ¨™ç±¤åˆ†å¸ƒçµ±è¨ˆ**ï¼š
  - æŸ±ç‹€åœ–ï¼šè©²è‚¡ç¥¨çš„æ¨™ç±¤é¡åˆ¥è¨ˆæ•¸èˆ‡ç™¾åˆ†æ¯”
  - **æª¢æŸ¥é‡é»**ï¼šæ˜¯å¦æœ‰æ¥µç«¯ä¸å¹³è¡¡

- **æ¨£æœ¬æ¬Šé‡åˆ†å¸ƒ**ï¼š
  - ç›´æ–¹åœ–ï¼šè©²è‚¡ç¥¨çš„æ¨£æœ¬æ¬Šé‡åˆ†é…
  - **æª¢æŸ¥é‡é»**ï¼šæ¬Šé‡æ˜¯å¦åˆç†ï¼ˆå‡å€¼æ‡‰æ¥è¿‘ 1.0ï¼‰

---

## å¦‚ä½•åˆ¤æ–·æ¨™ç±¤æ­£ç¢ºæ€§

### 1. æ¨™ç±¤èˆ‡è¶¨å‹¢ä¸€è‡´æ€§ï¼ˆä¸»åœ–ï¼‰

**âœ… æ­£ç¢ºç¯„ä¾‹**ï¼š
- åƒ¹æ ¼ä¸Šå‡éšæ®µï¼šèƒŒæ™¯ä¸»è¦ç‚ºç¶ è‰²ï¼ˆä¸Šæ¼²æ¨™ç±¤ï¼‰
- åƒ¹æ ¼ä¸‹é™éšæ®µï¼šèƒŒæ™¯ä¸»è¦ç‚ºç´…è‰²ï¼ˆä¸‹è·Œæ¨™ç±¤ï¼‰
- åƒ¹æ ¼æ©«ç›¤éšæ®µï¼šèƒŒæ™¯ä¸»è¦ç‚ºç°è‰²ï¼ˆæŒå¹³æ¨™ç±¤ï¼‰

**âŒ éŒ¯èª¤ç¯„ä¾‹**ï¼š
- åƒ¹æ ¼æ˜é¡¯ä¸Šå‡ï¼Œä½†æ¨™ç±¤ç‚ºç´…è‰²ï¼ˆä¸‹è·Œï¼‰
- åƒ¹æ ¼æ˜é¡¯ä¸‹é™ï¼Œä½†æ¨™ç±¤ç‚ºç¶ è‰²ï¼ˆä¸Šæ¼²ï¼‰
- æ¨™ç±¤é¡è‰²èˆ‡åƒ¹æ ¼è¶¨å‹¢å®Œå…¨ç›¸å

### 2. æ¨™ç±¤é€£çºŒæ€§ï¼ˆæ™‚é–“è»¸åœ–ï¼‰

**âœ… æ­£å¸¸æ¨¡å¼**ï¼š
- æ¨™ç±¤æœ‰é©åº¦é€£çºŒæ€§ï¼ˆåŒä¸€è¶¨å‹¢æŒçºŒæ•¸å€‹æ™‚é–“é»ï¼‰
- å¶çˆ¾æœ‰æ¨™ç±¤åˆ‡æ›ï¼ˆè¶¨å‹¢åè½‰ï¼‰

**âŒ ç•°å¸¸æ¨¡å¼**ï¼š
- æ¨™ç±¤éæ–¼è·³å‹•ï¼ˆæ¯å€‹æ™‚é–“é»éƒ½ä¸åŒï¼‰
- æ¨™ç±¤éæ–¼é€£çºŒï¼ˆæ•´æ®µæ™‚é–“åªæœ‰ä¸€ç¨®æ¨™ç±¤ï¼‰

### 3. æ¨™ç±¤åˆ†å¸ƒå¹³è¡¡

**âœ… è‰¯å¥½å¹³è¡¡**ï¼ˆåƒè€ƒ V5 è¨­è¨ˆç›®æ¨™ï¼‰ï¼š
- ä¸‹è·Œï¼š20-35%
- æŒå¹³ï¼š30-50%
- ä¸Šæ¼²ï¼š20-35%

**âš ï¸ éœ€è¦èª¿æ•´**ï¼š
- æŸé¡åˆ¥ < 10% æˆ– > 60%
- æŒå¹³é¡åˆ¥éå°‘ï¼ˆ< 20%ï¼‰æˆ–éå¤šï¼ˆ> 70%ï¼‰

### 4. æ¨£æœ¬æ¬Šé‡åˆç†æ€§

**âœ… æ­£å¸¸æ¬Šé‡**ï¼š
- å‡å€¼æ¥è¿‘ 1.0ï¼ˆÂ±0.2ï¼‰
- å¤§éƒ¨åˆ†æ¬Šé‡åœ¨ 0.1 ~ 5.0 ä¹‹é–“
- å°‘æ•¸é«˜æ¬Šé‡æ¨£æœ¬ï¼ˆç”¨æ–¼å¼·èª¿é‡è¦è¶¨å‹¢ï¼‰

**âŒ ç•°å¸¸æ¬Šé‡**ï¼š
- å‡å€¼é é›¢ 1.0ï¼ˆ> 2.0 æˆ– < 0.5ï¼‰
- å¤§é‡æ¥µç«¯æ¬Šé‡ï¼ˆ> 100ï¼‰

---

## å¸¸è¦‹å•é¡Œèˆ‡æ’æŸ¥

### Q1: æ¨™ç±¤èˆ‡è¶¨å‹¢å®Œå…¨ç›¸åï¼Ÿ

**å¯èƒ½åŸå› **ï¼š
- Triple-Barrier åƒæ•¸è¨­ç½®éŒ¯èª¤ï¼ˆæ­¢ç›ˆ/æ­¢æå€æ•¸éå¤§æˆ–éå°ï¼‰
- `min_return` é–¾å€¼è¨­ç½®ä¸ç•¶

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
æª¢æŸ¥ `config_pro_v5.yaml` ä¸­çš„ `triple_barrier` åƒæ•¸ï¼š

```yaml
triple_barrier:
  pt_multiplier: 2.0  # æ­¢ç›ˆå€æ•¸ï¼ˆå»ºè­° 1.5-3.0ï¼‰
  sl_multiplier: 2.0  # æ­¢æå€æ•¸ï¼ˆå»ºè­° 1.5-3.0ï¼‰
  max_holding: 200    # æœ€å¤§æŒæœ‰æœŸï¼ˆå»ºè­° 50-200ï¼‰
  min_return: 0.0001  # æœ€å°å ±é…¬é–¾å€¼ï¼ˆå»ºè­° 0.0001-0.002ï¼‰
```

### Q2: æ¨™ç±¤éæ–¼é›†ä¸­åœ¨ã€ŒæŒå¹³ã€ï¼Ÿ

**å¯èƒ½åŸå› **ï¼š
- `min_return` é–¾å€¼è¨­ç½®éé«˜ï¼Œå°è‡´å¤§éƒ¨åˆ†æ¨£æœ¬è¢«æ­¸é¡ç‚ºæŒå¹³
- æ³¢å‹•ç‡ä¼°è¨ˆéå°

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. é™ä½ `min_return` é–¾å€¼ï¼ˆä¾‹å¦‚å¾ 0.002 é™è‡³ 0.0005ï¼‰
2. èª¿æ•´æ³¢å‹•ç‡ä¼°è¨ˆæ–¹æ³•ï¼ˆå˜—è©¦ `garch` ä»£æ›¿ `ewma`ï¼‰

### Q3: æŸäº›è‚¡ç¥¨æ¨£æœ¬æ•¸éå°‘ï¼Ÿ

**å¯èƒ½åŸå› **ï¼š
- è©²è‚¡ç¥¨äº¤æ˜“ä¸æ´»èºï¼ˆæˆäº¤é‡å°ï¼‰
- æ•¸æ“šå“è³ªå•é¡Œï¼ˆéå¤šç•°å¸¸å€¼è¢«éæ¿¾ï¼‰

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
æª¢æŸ¥ `volatility_stats.csv` ç¢ºèªè©²è‚¡ç¥¨çš„éœ‡ç›ªå¹…åº¦çµ±è¨ˆ

### Q4: æ¬Šé‡åˆ†å¸ƒæ¥µç«¯ä¸å‡ï¼Ÿ

**å¯èƒ½åŸå› **ï¼š
- `return_scaling` æˆ– `tau` åƒæ•¸è¨­ç½®ä¸ç•¶
- æŸäº›è‚¡ç¥¨æœ‰æ¥µç«¯æ”¶ç›Šäº‹ä»¶

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
èª¿æ•´ `config_pro_v5.yaml` ä¸­çš„ `sample_weights` åƒæ•¸ï¼š

```yaml
sample_weights:
  enabled: true
  tau: 100.0           # æ™‚é–“è¡°æ¸›åƒæ•¸ï¼ˆå»ºè­° 50-200ï¼‰
  return_scaling: 10.0 # æ”¶ç›Šç¸®æ”¾ä¿‚æ•¸ï¼ˆå»ºè­° 5-20ï¼‰
  balance_classes: true
```

---

## è¼¸å‡ºç¯„ä¾‹

### æ§åˆ¶å°è¼¸å‡º

```
2025-10-20 14:30:15 - INFO - âœ… å·²è¼‰å…¥ train æ•¸æ“š: 1,249,419 å€‹æ¨£æœ¬
2025-10-20 14:30:15 - INFO -    å½¢ç‹€: X=(1249419, 100, 20), y=(1249419,), weights=(1249419,)
2025-10-20 14:30:18 - INFO - é‡å»ºæ”¶ç›¤åƒ¹åºåˆ—...
2025-10-20 14:30:20 - INFO -
ç”Ÿæˆæ•´é«”çµ±è¨ˆåœ–...
2025-10-20 14:30:25 - INFO - âœ… å·²ä¿å­˜æ•´é«”çµ±è¨ˆåœ–: results/label_visualization/train/overall_statistics.png
2025-10-20 14:30:25 - INFO -
ç”Ÿæˆå‰ 5 æª”è‚¡ç¥¨çš„è©³ç´°åœ–è¡¨...
2025-10-20 14:30:25 - INFO -   [1/5] è™•ç† 2330ï¼ˆ8,543 å€‹æ¨£æœ¬ï¼‰...
2025-10-20 14:30:27 - INFO -   âœ… å·²ä¿å­˜: results/label_visualization/train/stock_2330.png
...
2025-10-20 14:30:45 - INFO -
============================================================
2025-10-20 14:30:45 - INFO - ğŸ“Š æ¨™ç±¤æª¢æŸ¥æ‘˜è¦å ±å‘Š
2025-10-20 14:30:45 - INFO - ============================================================
2025-10-20 14:30:45 - INFO - æ•¸æ“šé›†: train
2025-10-20 14:30:45 - INFO - ç¸½æ¨£æœ¬æ•¸: 1,249,419
2025-10-20 14:30:45 - INFO - è‚¡ç¥¨æ•¸é‡: 256
2025-10-20 14:30:45 - INFO -
æ¨™ç±¤åˆ†å¸ƒ:
2025-10-20 14:30:45 - INFO -   ä¸‹è·Œ: 367,457 (29.41%)
2025-10-20 14:30:45 - INFO -   æŒå¹³: 562,361 (45.01%)
2025-10-20 14:30:45 - INFO -   ä¸Šæ¼²: 319,601 (25.58%)
2025-10-20 14:30:45 - INFO -
æ¨£æœ¬æ¬Šé‡çµ±è¨ˆ:
2025-10-20 14:30:45 - INFO -   å‡å€¼: 0.993
2025-10-20 14:30:45 - INFO -   æ¨™æº–å·®: 2.644
2025-10-20 14:30:45 - INFO -   æœ€å¤§å€¼: 238.655
2025-10-20 14:30:45 - INFO -   æœ€å°å€¼: 0.001
2025-10-20 14:30:45 - INFO -
åœ–è¡¨å·²ä¿å­˜è‡³: results/label_visualization/train
2025-10-20 14:30:45 - INFO - ============================================================
```

---

## æ‰¹æ¬¡æª¢æŸ¥å¤šå€‹é…ç½®

å»ºè­°ä½¿ç”¨æ‰¹æ¬¡è…³æœ¬ä¸€æ¬¡æª¢æŸ¥æ‰€æœ‰é…ç½®ç‰ˆæœ¬ï¼š

### Windows æ‰¹æ¬¡è…³æœ¬ (`check_all_labels.bat`)

```batch
@echo off
echo æª¢æŸ¥æ‰€æœ‰è¨“ç·´æ•¸æ“šæ¨™ç±¤...

echo.
echo [1/3] æª¢æŸ¥ processed_v5...
python scripts/visualize_training_labels.py --data-dir ./data/processed_v5/npz --split train --n-stocks 5

echo.
echo [2/3] æª¢æŸ¥ processed_v5_balanced...
python scripts/visualize_training_labels.py --data-dir ./data/processed_v5_balanced/npz --split train --n-stocks 5

echo.
echo [3/3] æª¢æŸ¥ processed_v5-44.61...
python scripts/visualize_training_labels.py --data-dir ./data/processed_v5-44.61/npz --split train --n-stocks 5

echo.
echo å®Œæˆï¼åœ–è¡¨å·²ä¿å­˜è‡³ results/label_visualization/
pause
```

### Linux/Mac Shell è…³æœ¬ (`check_all_labels.sh`)

```bash
#!/bin/bash
echo "æª¢æŸ¥æ‰€æœ‰è¨“ç·´æ•¸æ“šæ¨™ç±¤..."

echo ""
echo "[1/3] æª¢æŸ¥ processed_v5..."
python scripts/visualize_training_labels.py --data-dir ./data/processed_v5/npz --split train --n-stocks 5

echo ""
echo "[2/3] æª¢æŸ¥ processed_v5_balanced..."
python scripts/visualize_training_labels.py --data-dir ./data/processed_v5_balanced/npz --split train --n-stocks 5

echo ""
echo "[3/3] æª¢æŸ¥ processed_v5-44.61..."
python scripts/visualize_training_labels.py --data-dir ./data/processed_v5-44.61/npz --split train --n-stocks 5

echo ""
echo "å®Œæˆï¼åœ–è¡¨å·²ä¿å­˜è‡³ results/label_visualization/"
```

---

## æ•´åˆåˆ°è¨“ç·´æµç¨‹

å»ºè­°åœ¨æ¯æ¬¡é‡æ–°ç”Ÿæˆè¨“ç·´æ•¸æ“šå¾Œï¼Œç«‹å³åŸ·è¡Œè¦–è¦ºåŒ–æª¢æŸ¥ï¼š

```bash
# 1. ç”Ÿæˆè¨“ç·´æ•¸æ“š
python scripts/extract_tw_stock_data_v5.py \
    --input-dir ./data/temp \
    --output-dir ./data/processed_v5_new \
    --config configs/config_pro_v5_new.yaml

# 2. è¦–è¦ºåŒ–æª¢æŸ¥ï¼ˆç«‹å³æª¢æŸ¥æ¨™ç±¤æ­£ç¢ºæ€§ï¼‰
python scripts/visualize_training_labels.py \
    --data-dir ./data/processed_v5_new/npz \
    --split train \
    --n-stocks 10

# 3. æª¢æŸ¥åœ–è¡¨å¾Œï¼Œç¢ºèªç„¡èª¤å†é–‹å§‹è¨“ç·´
python scripts/train_deeplob_v5.py \
    --config configs/train_v5_new.yaml
```

---

## é€²éšä½¿ç”¨ï¼šè‡ªå®šç¾©åœ–è¡¨

å¦‚éœ€è‡ªå®šç¾©åœ–è¡¨æ¨£å¼æˆ–æ–°å¢çµ±è¨ˆé …ç›®ï¼Œå¯ä¿®æ”¹ `visualize_training_labels.py` ä¸­çš„ä»¥ä¸‹å‡½æ•¸ï¼š

- `plot_stock_labels()`: å€‹è‚¡è©³ç´°åœ–è¡¨
- `plot_overall_statistics()`: æ•´é«”çµ±è¨ˆåœ–è¡¨
- `reconstruct_close_price()`: åƒ¹æ ¼é‡å»ºé‚è¼¯

---

## ä¾è³´å¥—ä»¶

å·¥å…·å·²ä½¿ç”¨æ¨™æº–æ•¸æ“šç§‘å­¸å¥—ä»¶ï¼Œæ‡‰è©²å·²åŒ…å«åœ¨ `deeplob-pro` ç’°å¢ƒä¸­ï¼š

- `numpy`: æ•¸æ“šè™•ç†
- `pandas`: çµ±è¨ˆåˆ†æ
- `matplotlib`: åœ–è¡¨ç¹ªè£½
- `seaborn`: é€²éšè¦–è¦ºåŒ–ï¼ˆå¯é¸ï¼‰

å¦‚éœ€å®‰è£ç¼ºå°‘çš„å¥—ä»¶ï¼š

```bash
conda activate deeplob-pro
pip install matplotlib seaborn
```

---

**ç‰ˆæœ¬**ï¼šv1.0
**æ›´æ–°æ—¥æœŸ**ï¼š2025-10-20
**ä½œè€…**ï¼šDeepLOB-Pro Team
