# DeepLOB V5 訓練過擬合問題診斷與修復

**日期**: 2025-10-22
**狀態**: 🚨 嚴重過擬合
**優先級**: P0 (最高)

---

## 📊 問題現象

### 訓練日誌（前 5 個 Epoch）

| Epoch | Train Loss | Val Loss | Train Acc | Val Acc | Val F1 (W) | Grad |
|-------|-----------|----------|-----------|---------|------------|------|
| 1 | 0.5945 | 0.6045 | 44.20% | 43.30% | 0.3612 | 0.72 |
| 2 | 0.5554 | 0.6025 | 47.52% | 43.35% | 0.3682 | 2.11 |
| 3 | 0.4979 | 0.6695 | 53.86% | 44.82% | 0.3960 | 5.45 |
| 4 | 0.4348 | 0.7580 | 60.80% | 45.76% | 0.4033 | 7.35 |
| 5 | 0.3745 | **0.8523** | 67.15% | 46.71% | 0.4035 | **7.96** |

### 🚨 關鍵異常

1. **驗證損失爆炸**: 0.6045 → 0.8523 (+41%)
2. **Train/Val Acc 差距**: 0.9% → 20.44%（過擬合）
3. **梯度範數異常**: 0.72 → 7.96（11倍增長）
4. **Val F1 過低**: 0.4035（目標 > 0.6）

---

## 🔍 根本原因

### 1. 數據不平衡 ⭐⭐⭐⭐⭐

**實際分布**（7,564,697 樣本）:
```
Down:     45.7% (3,454,588)  目標 30%  +15.7%
Neutral:  15.0% (1,133,146)  目標 40%  -25% 🚨🚨🚨
Up:       39.4% (2,976,963)  目標 30%  +9.4%

不平衡比: 3.05x
```

**問題**: Neutral 嚴重不足，模型偏向預測多數類

### 2. 配置問題

```yaml
# train_v5.yaml
dataloader:
  balance_sampler:
    enabled: false  # 🚨 未啟用平衡採樣

optim:
  lr: 0.00005  # ⚠️ 過小
  grad_clip: 0.5  # ⚠️ 未生效
```

---

## 🔧 修復方案

### 方案 A: 快速修復（1小時）⭐⭐⭐⭐

**創建** `configs/train_v5_antioverfit.yaml`:

```yaml
dataloader:
  batch_size: 256  # 降低 (512→256)
  balance_sampler:
    enabled: true  # ✅ 啟用平衡採樣

optim:
  lr: 0.0001  # 提高 (0.00005→0.0001)
  weight_decay: 0.001  # 提高 (0.0005→0.001)
  grad_clip: 1.0  # 放寬 (0.5→1.0)

model:
  dropout: 0.6  # 提高 (0.5→0.6)

train:
  epochs: 20  # 縮短 (40→20)
  early_stop:
    patience: 5  # 縮短 (8→5)
```

**執行**:
```bash
python scripts\train_deeplob_v5.py ^
    --config configs\train_v5_antioverfit.yaml ^
    --data-dir data\processed_v6\npz ^
    --epochs 20
```

---

### 方案 B: 根本修復（3小時）⭐⭐⭐⭐⭐

**步驟 1**: 調整 TB 參數（`config_pro_v5_ml_optimal.yaml`）

```yaml
triple_barrier:
  pt_multiplier: 2.5  # 降低 (3.5→2.5，更多 up/down)
  sl_multiplier: 2.5
  min_return: 0.0025  # 提高 (0.0015→0.0025，更多 neutral)
```

**步驟 2**: 重新生成數據（8分鐘）

```bash
python scripts\extract_tw_stock_data_v6.py ^
    --preprocessed-dir .\data\preprocessed_v5 ^
    --output-dir .\data\processed_v6_balanced ^
    --config .\configs\config_pro_v5_ml_optimal.yaml
```

**步驟 3**: 驗證標籤分布

```bash
C:/ProgramData/miniconda3/envs/deeplob-pro/python.exe -c "import numpy as np; data = np.load('data/processed_v6_balanced/npz/stock_embedding_train.npz'); y = data['y']; dist = np.bincount(y); pct = dist / dist.sum() * 100; print(f'Down={pct[0]:.1f}%, Neutral={pct[1]:.1f}%, Up={pct[2]:.1f}%'); print(f'Imbalance: {max(dist)/min(dist):.2f}x')"
```

**目標**: Down 25-35%, Neutral 35-45%, Up 25-35%

**步驟 4**: 訓練

```bash
python scripts\train_deeplob_v5.py ^
    --config configs\train_v5.yaml ^
    --data-dir data\processed_v6_balanced\npz ^
    --epochs 30
```

---

### 方案 C: 組合方案（推薦）⭐⭐⭐⭐⭐

1. 重新生成平衡數據（方案 B 步驟 1-3）
2. 使用優化訓練配置（方案 A）

```bash
# 1. 調整並重新生成數據
python scripts\extract_tw_stock_data_v6.py ^
    --preprocessed-dir .\data\preprocessed_v5 ^
    --output-dir .\data\processed_v6_balanced ^
    --config .\configs\config_pro_v5_ml_optimal.yaml

# 2. 訓練
python scripts\train_deeplob_v5.py ^
    --config configs\train_v5_antioverfit.yaml ^
    --data-dir data\processed_v6_balanced\npz ^
    --epochs 30
```

---

## 📈 預期改善

### 當前（有問題）
- Train/Val Acc 差距: 20.44%
- Val F1: 0.4035
- 狀態: 🚨 嚴重過擬合

### 方案 A
- Train/Val Acc 差距: < 5%
- Val F1: 0.50-0.55
- 狀態: ⚠️ 改善但不理想

### 方案 B
- Train/Val Acc 差距: < 5%
- Val F1: 0.55-0.60
- 狀態: ✅ 良好

### 方案 C（最佳）
- Train/Val Acc 差距: < 3%
- Val F1: 0.60-0.65
- 狀態: ✅✅ 優秀

---

## ✅ 驗收標準

1. **Loss**: Val Loss 穩定下降，Train/Val 差距 < 0.1
2. **準確率**: Val Acc > 55%, Train/Val 差距 < 10%
3. **F1**: Val F1 (W) > 0.60, 每類 F1 > 0.50
4. **梯度**: Grad Norm 穩定在 1-3
5. **混淆矩陣**: Neutral 召回率 > 40%

---

## 🎯 立即行動

### 最小成本（1小時）

```bash
# 創建優化配置（手動修改 train_v5.yaml）
# 啟用 balance_sampler, 調整 lr/dropout

python scripts\train_deeplob_v5.py ^
    --config configs\train_v5_antioverfit.yaml ^
    --data-dir data\processed_v6\npz ^
    --epochs 20
```

### 最佳效果（3小時）

```bash
# 1. 調整 config_pro_v5_ml_optimal.yaml (TB 參數)
# 2. 重新生成數據
python scripts\extract_tw_stock_data_v6.py ^
    --preprocessed-dir .\data\preprocessed_v5 ^
    --output-dir .\data\processed_v6_balanced ^
    --config .\configs\config_pro_v5_ml_optimal.yaml

# 3. 訓練
python scripts\train_deeplob_v5.py ^
    --config configs\train_v5_antioverfit.yaml ^
    --data-dir data\processed_v6_balanced\npz ^
    --epochs 30
```

---

**最後更新**: 2025-10-22
**狀態**: 待執行修復
