# DeepLOB 調參歷史記錄

每次保留數據及成果,簡要說明(其他廢話不用),這是改下次調參參考用

## 格式:

**日期**:
**配置**:
**結果**:
**問題**:
**結論**:
---

## 實驗 1: 首次訓練（配置錯誤）

**日期**: 2025-10-24

**配置**:
```yaml
batch_size: 384
lr: 0.000004
weight_decay: 0.001
dropout: 0.7
warmup_ratio: 0.40
epochs: 30
grad_clip: 0.8
sched: cosine
eta_min: 3.0e-6

# ❌ 錯誤配置
data:
  train: "data/processed_v6/npz/stock_embedding_train.npz"  # V6 不存在！
```

**結果**:
| Epoch | Train Loss | Val Loss | Train Acc | Val Acc | Val F1 (W) | LR | Grad |
|-------|------------|----------|-----------|---------|------------|-----|------|
| 1 | 1.1093 | 1.1102 | 34.32% | 30.77% | 0.2036 | ~0 | 1.69 |
| 2 | 1.0940 | 1.0950 | 35.66% | **32.23%** | 0.3128 | ~1e-6 | 1.30 |
| 3 | 1.0858 | 1.0918 | 37.53% | 30.23% | 0.2675 | ~1e-6 | 1.57 |
| 4 | 1.0773 | 1.0966 | 39.23% | 28.93% | 0.2372 | ~1e-6 | 2.18 |
| 5 | 1.0678 | 1.1069 | 40.93% | 28.81% | 0.2339 | ~2e-6 | 2.80 |
| 6 | 1.0564 | 1.1010 | 42.73% | 30.33% | 0.2589 | ~2e-6 | 3.49 |
| 7 | 1.0421 | 1.1042 | 44.67% | 30.90% | 0.2649 | ~2e-6 | 4.29 |

**問題**:
1. **配置錯誤** ❌: 數據路徑指向不存在的 `processed_v6`
2. **性能極差**: Val Acc 最高僅 32.23%（應達 51%+）
3. **嚴重過擬合**: Train Acc 從 34% 升到 45%，Val Acc 反而下降
4. **Val Loss 惡化**: 從 1.0950 (Epoch 2) 上升到 1.1042 (Epoch 7)
5. **F1 極低**: 0.20-0.31（幾乎無預測能力）

**根本原因**:
- **數據路徑錯誤**: 配置指向 V6，但實際只有 V7 數據
- 訓練過程可能使用了錯誤/缺失的數據
- 或訓練腳本有 fallback 機制但數據質量差

**解決方案**:
✅ 已修正配置 → `data/processed_v7/npz/*`

**V7 數據確認**:
- 訓練樣本: 1,017,054
- 標籤分布: 30.86% / 42.96% / 26.19%（健康）

**結論**: ❌ 實驗無效（配置錯誤），需重新訓練

---

## 實驗 2: 修正配置後重訓（待執行）

**日期**: 2025-10-24

**配置**:
```yaml
batch_size: 384
lr: 0.000004
weight_decay: 0.001
dropout: 0.7
warmup_ratio: 0.40
epochs: 30
patience: 5
grad_clip: 0.8
sched: cosine
eta_min: 3.0e-6
min_delta: 0.0008

# ✅ 修正後配置
data:
  train: "data/processed_v7/npz/stock_embedding_train.npz"
  val: "data/processed_v7/npz/stock_embedding_val.npz"
  test: "data/processed_v7/npz/stock_embedding_test.npz"
```

**預期目標**（基於實驗 5/6 參考）:
- ✅ Val Acc > 51%（首次應達 50%+）
- ✅ Val F1 (Weighted) > 0.47
- ✅ Grad Norm < 4.5（全程）
- ✅ Train/Val 差距 < 10%（健康泛化）
- ✅ Val Loss 穩定下降（不反彈）

**停止規則**:
- 🔥 Grad Norm > 6.0 連續 2 epochs → 降 lr 或 batch
- 🔥 Val Loss 上升 > 10% from best → 早停失效
- 🔥 Train/Val 差距 > 15% → 過擬合

**結果**: ❌ 未執行（發現數據標準化問題）

**根本原因診斷**:
1. **數據完全未標準化**:
   - 舊數據: Min=0, Max=2571, Mean=81.9, Std=101.5 ❌
   - 預期: Mean≈0, Std≈1, Range: -5~+5

2. **問題源頭**:
   - `preprocess_single_day.py`: 只保存原始 LOB 數據（未標準化）
   - `extract_tw_stock_data_v7.py`: 定義了 `zscore_apply()` 但從未調用 ❌

3. **影響**:
   - 模型接收原始價格數據（0~2571）
   - 梯度爆炸/消失
   - 學習率不匹配
   - Val Acc 32%、F1 0.31（完全無法學習）

---

## 實驗 2b: 修復 V7 標準化（2025-10-24）⭐⭐⭐

**日期**: 2025-10-24

**修復內容**:

1. **修改 `extract_tw_stock_data_v7.py` (第 685-707 行)**:
```python
# 🆕 V7 修復：添加標準化步驟
norm_config = config.get('normalization', {})
norm_method = norm_config.get('method', 'rolling_zscore')
norm_window = norm_config.get('window', 100)
norm_min_periods = norm_config.get('min_periods', 20)

# 應用標準化
if norm_method == 'rolling_zscore':
    concat_features = zscore_apply(
        concat_features, mu=None, sd=None,
        method='rolling_zscore',
        window=norm_window, min_periods=norm_min_periods
    )
```

2. **重新生成訓練數據**:
```bash
# 備份舊數據
mv data/processed_v7 data/processed_v7_old

# 重新生成（使用修復後的 V7 腳本）
python scripts/extract_tw_stock_data_v7.py \
    --preprocessed-dir ./data/preprocessed_swing \
    --output-dir ./data/processed_v7 \
    --config configs/config_pro_v7_optimal.yaml \
    --json ./data/dataset_selection.json
```

**驗證結果**: ✅ 標準化成功
```
Train: Min=-9.96, Max=9.96, Mean=0.01, Std=1.44  ✅
Val:   Min=-9.96, Max=9.96, Mean=-0.01, Std=1.43 ✅
Test:  Min=-9.96, Max=9.96, Mean=0.05, Std=1.45  ✅
```

**數據規模**:
- Train: 1,017,054 樣本
- Val: 163,725 樣本
- Test: 169,047 樣本
- 標籤分布: Down 30.9%, Neutral 43.0%, Up 26.2%（健康）

**結論**: ✅ 數據標準化問題已徹底修復，可以重新訓練

---

## 實驗 3: 使用正確標準化數據訓練（待執行）

**日期**: 2025-10-24

**配置**: （與實驗 2 相同，但使用修復後的數據）
```yaml
batch_size: 384
lr: 0.000004
weight_decay: 0.001
dropout: 0.7
warmup_ratio: 0.40
epochs: 30
patience: 5
grad_clip: 0.8
sched: cosine
eta_min: 3.0e-6
min_delta: 0.0008

# ✅ 數據已正確標準化
data:
  train: "data/processed_v7/npz/stock_embedding_train.npz"
  val: "data/processed_v7/npz/stock_embedding_val.npz"
  test: "data/processed_v7/npz/stock_embedding_test.npz"
```

**預期目標**（基於實驗 5 參考）:
- ✅ Val Acc > 51%（正確數據應達標）
- ✅ Val F1 (Weighted) > 0.47
- ✅ Grad Norm < 4.5（全程）
- ✅ Train/Val 差距 < 10%（健康泛化）
- ✅ Val Loss 穩定下降（不反彈）

**訓練指令**:
```bash
python scripts\train_deeplob_v5.py --config configs\train_v5.yaml --data-dir data\processed_v7\npz
```

**結果**: （待訓練後補充）

---

