# 台股交易成本配置说明

## 配置文件位置

`configs/sb3_deeplob_config.yaml` → `env_config.transaction_cost`

## 配置结构（最简化版本）

```yaml
transaction_cost:
  # 券商手续费（买卖双边收取，折扣相同）
  commission:
    base_rate: 0.001425       # 法定上限 0.1425%
    discount: 0.3             # 折扣 (0.1-1.0)
    min_fee: 20.0             # 单笔最低手续费（台币）

  # 证券交易税（仅卖出收取）
  securities_tax:
    rate: 0.0015              # 税率 0.15%（当冲减半）

  # 滑点成本（可选）
  slippage:
    enabled: false            # 是否启用
    rate: 0.0001              # 滑点率 0.01%
```

## 参数说明

### 1. 券商手续费 (commission)

**收取方式**: 买入和卖出都收，折扣相同

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `base_rate` | 法定上限费率 | 0.001425 (0.1425%) |
| `discount` | 折扣倍数 | 0.3 (3折) |
| `min_fee` | 单笔最低手续费 | 20.0 元 |

**实际费率** = `base_rate × discount`

**折扣说明**:
- `1.0` = 无折扣 (0.1425%)
- `0.6` = 6折 (0.0855%) ← 电子券商常见
- `0.3` = 3折 (0.04275%) ← 量化交易
- `0.2` = 2折 (0.0285%) ← 高频交易

**计算示例** (3折):
```
交易价值: 1 张 @ 100 元 = 100,000 元
手续费: 100,000 × (0.001425 × 0.3) = 42.75 元
```

### 2. 证券交易税 (securities_tax)

**收取方式**: 仅卖出收取

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `rate` | 交易税率 | 0.0015 (0.15%) |

**税率说明**:
- **一般卖出**: 0.003 (0.3%)
- **当冲卖出**: 0.0015 (0.15%) ← 减半，延长至 2027/12/31

**推荐**: 使用当冲税率 `0.0015`（适合高频交易）

**计算示例**:
```
交易价值: 1 张 @ 100 元 = 100,000 元
交易税 (当冲): 100,000 × 0.0015 = 150 元
```

### 3. 滑点成本 (slippage) - 可选

**收取方式**: 买卖双边（如果启用）

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `enabled` | 是否启用 | false |
| `rate` | 滑点率 | 0.0001 (0.01%) |

**说明**: 模拟市价单与预期价格的差异，通常不启用

## 成本计算

### 买入成本

```
买入成本 = 手续费 + 滑点（可选）
         = 交易价值 × 手续费率 + 滑点
```

**默认配置** (3折手续费，不含滑点):
```
成本率 = 0.04275%
```

### 卖出成本

```
卖出成本 = 手续费 + 交易税 + 滑点（可选）
         = 交易价值 × (手续费率 + 税率) + 滑点
```

**默认配置** (3折手续费 + 当冲税，不含滑点):
```
成本率 = 0.04275% + 0.15% = 0.19275%
```

### 往返成本（买入 + 卖出）

**默认配置**:
```
往返成本率 = 0.04275% + 0.19275% = 0.2355%
```

**对比旧配置**:
- 旧配置: 0.1% (严重低估)
- 新配置: 0.2355% (正确)
- 差距: **2.35 倍**

## 实际案例

### 案例 1: 买入 1 张 @ 100 元

```
交易价值: 100,000 元
手续费: 42.75 元 (100,000 × 0.04275%)
交易税: 0 元 (买入不收税)
总成本: 42.75 元
成本率: 0.04275%
```

### 案例 2: 卖出 1 张 @ 100 元 (当冲)

```
交易价值: 100,000 元
手续费: 42.75 元 (100,000 × 0.04275%)
交易税: 150.00 元 (100,000 × 0.15%)
总成本: 192.75 元
成本率: 0.19275%
```

### 案例 3: 往返交易 (买进 → 卖出)

```
总成本: 42.75 + 192.75 = 235.50 元
成本率: 0.2355%
```

## 不同折扣对比

| 折扣 | 场景 | 手续费率 | 往返成本 |
|------|------|---------|---------|
| 无折扣 (1.0) | 一般散户 | 0.1425% | 0.585% |
| 6折 (0.6) | 电子券商 | 0.0855% | 0.471% |
| **3折 (0.3)** | **量化交易** | **0.04275%** | **0.2355%** ⭐ |
| 2折 (0.2) | 高频交易 | 0.0285% | 0.207% |

## 配置建议

### 推荐配置（当冲 + 量化交易）

```yaml
transaction_cost:
  commission:
    base_rate: 0.001425
    discount: 0.3           # 3折（量化交易可达成）
    min_fee: 20.0
  securities_tax:
    rate: 0.0015            # 当冲税率（延长至 2027/12/31）
  slippage:
    enabled: false          # 通常不启用
```

**往返成本**: 0.2355% ✅

### 保守配置（电子券商）

```yaml
transaction_cost:
  commission:
    discount: 0.6           # 6折（电子券商常见）
  securities_tax:
    rate: 0.003             # 一般税率
```

**往返成本**: 0.471%

### 最保守配置（一般散户）

```yaml
transaction_cost:
  commission:
    discount: 1.0           # 无折扣
  securities_tax:
    rate: 0.003             # 一般税率
```

**往返成本**: 0.585%

## 使用说明

### 1. 修改配置

编辑 `configs/sb3_deeplob_config.yaml`:

```yaml
env_config:
  transaction_cost:
    commission:
      discount: 0.3         # 调整折扣
    securities_tax:
      rate: 0.0015          # 调整税率
```

### 2. 验证配置

```python
from src.utils.yaml_manager import YAMLManager
from src.utils.tw_cost import TaiwanCost

# 加载配置
config = YAMLManager('configs/sb3_deeplob_config.yaml')
cost_config = config.env_config.transaction_cost.as_plain_object()

# 创建计算器
calc = TaiwanCost(cost_config)

# 查看成本率
print(f"Buy: {calc.get_buy_cost_rate() * 100:.4f}%")
print(f"Sell: {calc.get_sell_cost_rate() * 100:.4f}%")
print(f"Roundtrip: {calc.get_roundtrip_rate() * 100:.4f}%")
```

### 3. 重新训练

```bash
python scripts/train_sb3_deeplob.py --test
python scripts/train_sb3_deeplob.py
```

## 台股交易单位说明

**重要**: 台股交易单位为"张"
- **1 张 = 1000 股**
- 最小交易单位: 1 张

**示例**:
- 买 1 张 @ 100 元 = 100,000 元
- 买 10 张 @ 50 元 = 500,000 元

## 参考资料

- **台湾证券交易所**: https://www.twse.com.tw/
- **证券交易税**: 财政部规定
- **手续费上限**: 金管会规定 0.1425%
- **当冲优惠**: 延长至 2027/12/31

---

**文档版本**: v1.0
**最后更新**: 2025-10-26
**维护者**: SB3-DeepLOB Team
