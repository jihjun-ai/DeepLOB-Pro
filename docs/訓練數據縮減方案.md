# è¨“ç·´æ•¸æ“šç¸®æ¸›æ–¹æ¡ˆ

**å•é¡Œ**: è¨“ç·´æ•¸æ“šéå¤šï¼ˆ7,564,697 æ¨£æœ¬ â†’ 14,774 batches/epochï¼‰ï¼Œè¨“ç·´æ™‚é–“éé•·ï¼ˆ~6 å°æ™‚/40 epochsï¼‰

**ç›®æ¨™**: åœ¨ä¸å½±éŸ¿è¨“ç·´æˆæœçš„å‰æä¸‹ï¼Œç¸®æ¸›è¨“ç·´æ™‚é–“åˆ° 1.5-3 å°æ™‚

---

## ğŸ“Š ç•¶å‰ç‹€æ³

```
æ•¸æ“šä¾†æº: preprocessed_v5_1hz (1Hz é«˜é »æ•¸æ“š)
ç¸½æ¨£æœ¬æ•¸: 7,564,697
Batch size: 512
Batches/epoch: 14,774
è¨“ç·´é€Ÿåº¦: 28.17 it/s
æ™‚é–“/epoch: ~9 åˆ†é˜
ç¸½æ™‚é–“ (40 epochs): ~6 å°æ™‚
```

---

## ğŸ¯ ç¸®æ¸›æ–¹æ¡ˆå°æ¯”

| æ–¹æ¡ˆ | ä¿®æ”¹ä½ç½® | æ¨£æœ¬æ•¸ | æ™‚é–“/epoch | ç¸½æ™‚é–“ | æ•ˆæœå½±éŸ¿ | æ¨è–¦åº¦ |
|------|---------|--------|-----------|--------|---------|--------|
| **A: å¢å¤§ batch_size** | `train_v5.yaml` | 7.5M | 4.4 åˆ† | 2.9h | âœ… å¹¾ä¹ç„¡å½±éŸ¿ | â­â­â­â­â­ |
| **B: æ»‘çª—æ­¥é•·=5** | `extract_v6.py` | 1.5M | 1.8 åˆ† | 1.2h | âš ï¸ ç•¥å¾®é™ä½ | â­â­â­â­ |
| **C: tb_stride=20** | `config.yaml` | 3.8M | 4.4 åˆ† | 2.9h | âœ… ç„¡å½±éŸ¿ | â­â­â­ |
| **D: çµ„åˆ A+B** | å…©è™•ä¿®æ”¹ | 1.5M | 0.9 åˆ† | 0.6h | âš ï¸ ç•¥å¾®é™ä½ | â­â­â­â­â­ |

---

## æ–¹æ¡ˆ A: å¢å¤§ Batch Sizeï¼ˆæœ€ç°¡å–®ï¼‰â­â­â­â­â­

### åŸç†
- æ›´å¤§çš„ batch â†’ æ›´å°‘çš„è¿­ä»£æ¬¡æ•¸ â†’ æ›´å¿«çš„è¨“ç·´
- å°æ–¼ 7.5M æ¨£æœ¬ï¼Œbatch_size å¾ 512 â†’ 2048 å¯æ¸›å°‘ 4 å€è¿­ä»£

### ä¿®æ”¹æ–¹å¼

**ç·¨è¼¯ `configs/train_v5.yaml`**:
```yaml
dataloader:
  batch_size: 2048  # 512 â†’ 2048 (4å€åŠ é€Ÿ)
```

### æ•ˆæœé ä¼°
```
Batches/epoch: 14,774 â†’ 3,693 (æ¸›å°‘ 75%)
æ™‚é–“/epoch: 9 åˆ†é˜ â†’ 2.2 åˆ†é˜
ç¸½æ™‚é–“ (40 epochs): 6 å°æ™‚ â†’ 1.5 å°æ™‚ âœ…
```

### å„ªé»
- âœ… æœ€ç°¡å–®ï¼Œç„¡éœ€é‡æ–°ç”Ÿæˆæ•¸æ“š
- âœ… å¹¾ä¹ç„¡å‰¯ä½œç”¨ï¼ˆRTX 5090 32GB é¡¯å­˜è¶³å¤ ï¼‰
- âœ… æ›´å¤§ batch å¯èƒ½è®“æ¢¯åº¦ä¼°è¨ˆæ›´ç©©å®š

### ç¼ºé»
- âš ï¸ éœ€è¦æ›´å¤šé¡¯å­˜ï¼ˆä½† RTX 5090 32GB ç¶½ç¶½æœ‰é¤˜ï¼‰
- âš ï¸ å­¸ç¿’ç‡å¯èƒ½éœ€å¾®èª¿ï¼ˆå¯èƒ½éœ€æé«˜åˆ° 0.0001-0.0002ï¼‰

### å»ºè­°
**æ¨è–¦ batch_size=2048**ï¼ˆ4 å€åŠ é€Ÿï¼Œå¹³è¡¡æ•ˆæœèˆ‡é€Ÿåº¦ï¼‰

---

## æ–¹æ¡ˆ B: å¢åŠ æ»‘çª—æ­¥é•·ï¼ˆæœ€æœ‰æ•ˆï¼‰â­â­â­â­

### åŸç†
- ç•¶å‰ï¼šæ¯å€‹æ™‚é–“é»éƒ½å‰µå»ºä¸€å€‹æ¨£æœ¬ï¼ˆstride=1ï¼‰
- å„ªåŒ–ï¼šæ¯ 5 å€‹é»å‰µå»ºä¸€å€‹æ¨£æœ¬ï¼ˆstride=5ï¼‰
- æ¸›å°‘æ¨£æœ¬é‡ç–Šï¼Œä¿ç•™å¤šæ¨£æ€§

### ä¿®æ”¹æ–¹å¼

**ç·¨è¼¯ `scripts/extract_tw_stock_data_v6.py`**:

æ‰¾åˆ° Line 856:
```python
# åŸå§‹ï¼ˆæ¯å€‹é»éƒ½å‰µå»ºæ¨£æœ¬ï¼‰
for t in range(SEQ_LEN - 1, max_t):
    window_start = t - SEQ_LEN + 1
    # ...
```

ä¿®æ”¹ç‚ºï¼ˆæ–°å¢ `window_stride` åƒæ•¸ï¼‰:
```python
# å„ªåŒ–ï¼ˆæ¯ 5 å€‹é»å‰µå»ºä¸€å€‹æ¨£æœ¬ï¼‰
window_stride = config.get('window_stride', 5)  # å¯é…ç½®ï¼Œé è¨­ 5

for t in range(SEQ_LEN - 1, max_t, window_stride):
    window_start = t - SEQ_LEN + 1
    # ...
```

**åœ¨ `config_pro_v5_ml_optimal.yaml` æ–°å¢åƒæ•¸**:
```yaml
# è³‡æ–™è™•ç†åƒæ•¸
data:
  aggregation_factor: 10
  seq_len: 100
  window_stride: 5  # â† æ–°å¢ï¼šæ»‘çª—æ­¥é•·ï¼ˆé è¨­ 1ï¼Œå»ºè­° 5ï¼‰
```

### é‡æ–°ç”Ÿæˆæ•¸æ“š
```bash
python scripts\extract_tw_stock_data_v6.py ^
    --preprocessed-dir .\data\preprocessed_v5_1hz ^
    --output-dir .\data\processed_v6_stride5 ^
    --config .\configs\config_pro_v5_ml_optimal.yaml
```

### æ•ˆæœé ä¼°
```
æ¨£æœ¬æ•¸: 7,564,697 â†’ 1,512,939 (æ¸›å°‘ 80%)
Batches/epoch: 14,774 â†’ 2,954 (æ¸›å°‘ 80%)
æ™‚é–“/epoch: 9 åˆ†é˜ â†’ 1.7 åˆ†é˜
ç¸½æ™‚é–“ (40 epochs): 6 å°æ™‚ â†’ 1.1 å°æ™‚ âœ…
```

### å„ªé»
- âœ… å¤§å¹…æ¸›å°‘æ¨£æœ¬æ•¸ï¼ˆ5 å€æ¸›å°‘ï¼‰
- âœ… ä¿ç•™æ¨£æœ¬å¤šæ¨£æ€§ï¼ˆæ¯ 5 å€‹é»å– 1 å€‹ï¼‰
- âœ… æ¸›å°‘éåº¦é‡ç–Š

### ç¼ºé»
- âš ï¸ éœ€è¦é‡æ–°ç”Ÿæˆæ•¸æ“šï¼ˆ8-10 åˆ†é˜ï¼‰
- âš ï¸ ç•¥å¾®æå¤±ç´°ç¯€ï¼ˆä½†å° 1Hz æ•¸æ“šå½±éŸ¿ä¸å¤§ï¼‰

### å»ºè­°
**æ¨è–¦ window_stride=5**ï¼ˆæ¸›å°‘ 80% æ¨£æœ¬ï¼Œä¿ç•™è¶³å¤ å¤šæ¨£æ€§ï¼‰

---

## æ–¹æ¡ˆ C: å¢å¤§ tb_strideï¼ˆæ•ˆæœæœ‰é™ï¼‰â­â­â­

### åŸç†
- `tb_stride` åªæ§åˆ¶ Triple-Barrier è¨ˆç®—é »ç‡
- ä¸å½±éŸ¿æœ€çµ‚æ¨£æœ¬æ•¸ï¼ˆæ¨™ç±¤æœƒ ffill å¡«å……ï¼‰
- å·²ç¶“è¨­ç‚º 10ï¼Œå†å¢å¤§æ•ˆæœä¸æ˜é¡¯

### ä¿®æ”¹æ–¹å¼

**ç·¨è¼¯ `config_pro_v5_ml_optimal.yaml`**:
```yaml
tb_stride: 20  # 10 â†’ 20
```

### æ•ˆæœé ä¼°
```
æ¨£æœ¬æ•¸: ä¸è®Šï¼ˆ7,564,697ï¼‰
æ•¸æ“šç”Ÿæˆé€Ÿåº¦: ç•¥å¿« 10-20%
è¨“ç·´æ™‚é–“: ä¸è®Š
```

### çµè«–
- âŒ **ä¸æ¨è–¦**ï¼šå°è¨“ç·´é€Ÿåº¦ç„¡å¹«åŠ©ï¼ŒåªåŠ å¿«æ•¸æ“šç”Ÿæˆ

---

## æ–¹æ¡ˆ D: çµ„åˆå„ªåŒ–ï¼ˆæ¨è–¦ï¼‰â­â­â­â­â­

### ç­–ç•¥
åŒæ™‚ä½¿ç”¨æ–¹æ¡ˆ A + Bï¼Œé”åˆ°æœ€ä½³æ•ˆæœ

### ä¿®æ”¹æ­¥é©Ÿ

#### æ­¥é©Ÿ 1: ä¿®æ”¹æ»‘çª—æ­¥é•·ï¼ˆæ–°å¢åƒæ•¸ï¼‰

**ç·¨è¼¯ `scripts/extract_tw_stock_data_v6.py`** (Line 856):
```python
window_stride = config.get('window_stride', 5)
for t in range(SEQ_LEN - 1, max_t, window_stride):
```

**ç·¨è¼¯ `config_pro_v5_ml_optimal.yaml`**:
```yaml
data:
  window_stride: 5  # æ–°å¢
```

**é‡æ–°ç”Ÿæˆæ•¸æ“š**:
```bash
python scripts\extract_tw_stock_data_v6.py ^
    --preprocessed-dir .\data\preprocessed_v5_1hz ^
    --output-dir .\data\processed_v6_stride5 ^
    --config .\configs\config_pro_v5_ml_optimal.yaml
```

#### æ­¥é©Ÿ 2: å¢å¤§ batch size

**ç·¨è¼¯ `configs/train_v5.yaml`**:
```yaml
dataloader:
  batch_size: 2048  # 512 â†’ 2048
```

#### æ­¥é©Ÿ 3: è¨“ç·´

```bash
python scripts\train_deeplob_v5.py ^
    --config configs\train_v5.yaml ^
    --data-dir data\processed_v6_stride5\npz ^
    --epochs 40
```

### æ•ˆæœé ä¼°
```
æ¨£æœ¬æ•¸: 7,564,697 â†’ 1,512,939 (æ¸›å°‘ 80%)
Batches/epoch: 14,774 â†’ 738 (æ¸›å°‘ 95%)
æ™‚é–“/epoch: 9 åˆ†é˜ â†’ 0.4 åˆ†é˜
ç¸½æ™‚é–“ (40 epochs): 6 å°æ™‚ â†’ 0.3 å°æ™‚ (16 åˆ†é˜) âœ…âœ…âœ…
```

### å„ªé»
- âœ… è¨“ç·´æ™‚é–“æ¥µçŸ­ï¼ˆ16 åˆ†é˜ vs 6 å°æ™‚ï¼‰
- âœ… æ¨£æœ¬ä»ç„¶å……è¶³ï¼ˆ150 è¬æ¨£æœ¬ï¼‰
- âœ… ä¿ç•™æ•¸æ“šå¤šæ¨£æ€§

### ç¼ºé»
- âš ï¸ éœ€ä¿®æ”¹ä»£ç¢¼ + é‡æ–°ç”Ÿæˆæ•¸æ“š
- âš ï¸ ç•¥å¾®æå¤±ç´°ç¯€ï¼ˆä½†å½±éŸ¿å¾ˆå°ï¼‰

---

## ğŸ¯ æ¨è–¦åŸ·è¡Œæ–¹æ¡ˆ

### çŸ­æœŸå¿«é€Ÿæ–¹æ¡ˆï¼ˆ5 åˆ†é˜å…§ï¼‰â­â­â­â­â­

**åƒ…ä¿®æ”¹ batch_size**ï¼Œç„¡éœ€é‡æ–°ç”Ÿæˆæ•¸æ“š

```bash
# 1. ä¿®æ”¹ configs/train_v5.yaml
#    batch_size: 2048

# 2. ç›´æ¥è¨“ç·´
python scripts\train_deeplob_v5.py ^
    --config configs\train_v5.yaml ^
    --data-dir data\processed_v6\npz ^
    --epochs 40
```

**æ•ˆæœ**: 6 å°æ™‚ â†’ **1.5 å°æ™‚** âœ…

---

### é•·æœŸæœ€ä½³æ–¹æ¡ˆï¼ˆ30 åˆ†é˜è¨­ç½®ï¼‰â­â­â­â­â­

**ä¿®æ”¹ä»£ç¢¼ + é‡æ–°ç”Ÿæˆæ•¸æ“š**

```bash
# 1. ä¿®æ”¹ extract_tw_stock_data_v6.py (Line 856)
#    window_stride = config.get('window_stride', 5)
#    for t in range(SEQ_LEN - 1, max_t, window_stride):

# 2. ä¿®æ”¹ config_pro_v5_ml_optimal.yaml
#    data:
#      window_stride: 5

# 3. é‡æ–°ç”Ÿæˆæ•¸æ“šï¼ˆ8-10 åˆ†é˜ï¼‰
python scripts\extract_tw_stock_data_v6.py ^
    --preprocessed-dir .\data\preprocessed_v5_1hz ^
    --output-dir .\data\processed_v6_stride5 ^
    --config .\configs\config_pro_v5_ml_optimal.yaml

# 4. ä¿®æ”¹ train_v5.yaml
#    batch_size: 2048

# 5. è¨“ç·´ï¼ˆ16 åˆ†é˜ï¼‰
python scripts\train_deeplob_v5.py ^
    --config configs\train_v5.yaml ^
    --data-dir data\processed_v6_stride5\npz ^
    --epochs 40
```

**æ•ˆæœ**: 6 å°æ™‚ â†’ **0.3 å°æ™‚ (16 åˆ†é˜)** âœ…âœ…âœ…

---

## â“ å¸¸è¦‹å•é¡Œ

### Q1: å¢å¤§ batch_size æœƒå½±éŸ¿è¨“ç·´æ•ˆæœå—ï¼Ÿ
**A**: å¹¾ä¹ä¸æœƒã€‚å°æ–¼ 7.5M æ¨£æœ¬ï¼š
- batch_size=512: æ¢¯åº¦ä¼°è¨ˆè¼ƒä¸ç©©å®šï¼Œä½†æ›´æ–°é »ç¹
- batch_size=2048: æ¢¯åº¦ä¼°è¨ˆæ›´æº–ç¢ºï¼Œä½†æ›´æ–°è¼ƒå°‘
- **å»ºè­°**: åŒæ™‚ç•¥å¾®æé«˜å­¸ç¿’ç‡ï¼ˆ0.00005 â†’ 0.0001ï¼‰å¹³è¡¡

### Q2: window_stride=5 æœƒæå¤±å¤šå°‘ä¿¡æ¯ï¼Ÿ
**A**: å° 1Hz æ•¸æ“šå½±éŸ¿å¾ˆå°ï¼š
- åŸå§‹: æ¯å€‹ tick éƒ½æ˜¯æ¨£æœ¬ï¼ˆå¤§é‡é‡ç–Šï¼‰
- stride=5: æ¯ 5 ç§’ä¸€å€‹æ¨£æœ¬ï¼ˆä»ç„¶å¯†é›†ï¼‰
- **çµè«–**: 150 è¬æ¨£æœ¬è¶³å¤ è¨“ç·´ï¼Œæå¤±å¯å¿½ç•¥

### Q3: éœ€è¦åŒæ™‚èª¿æ•´å…¶ä»–åƒæ•¸å—ï¼Ÿ
**A**: å»ºè­°å¾®èª¿ï¼š
```yaml
# å¦‚æœä½¿ç”¨ batch_size=2048
optim:
  lr: 0.0001  # 0.00005 â†’ 0.0001 (batch æ›´å¤§ï¼Œå­¸ç¿’ç‡å¯ç•¥æé«˜)
```

### Q4: å¦‚ä½•é©—è­‰ç¸®æ¸›å¾Œæ•ˆæœæ²’è®Šå·®ï¼Ÿ
**A**: å°æ¯”æŒ‡æ¨™ï¼š
- Val F1 (Weighted): æ‡‰ç›¸è¿‘ï¼ˆÂ±0.02ï¼‰
- Val Loss: æ‡‰ç›¸è¿‘
- Train/Val Acc å·®è·: æ‡‰ç›¸è¿‘
- å¦‚æœç•¥æœ‰ä¸‹é™ï¼ˆ< 2%ï¼‰ï¼Œå±¬æ–¼æ­£å¸¸ç¯„åœ

---

## âœ… ç¸½çµ

| æ–¹æ¡ˆ | æ™‚é–“ç¯€çœ | ä¿®æ”¹æˆæœ¬ | æ•ˆæœå½±éŸ¿ | æ¨è–¦å ´æ™¯ |
|------|---------|---------|---------|---------|
| **A: batch_size=2048** | 75% | 1 åˆ†é˜ | å¹¾ä¹ç„¡ | å¿«é€Ÿæ¸¬è©¦ |
| **B: window_stride=5** | 81% | 20 åˆ†é˜ | ç•¥å¾® | æ­£å¼è¨“ç·´ |
| **D: A+B çµ„åˆ** | 95% | 30 åˆ†é˜ | ç•¥å¾® | æœ€ä½³é¸æ“‡ |

**ç«‹å³æ¨è–¦**: å…ˆç”¨æ–¹æ¡ˆ Aï¼ˆä¿®æ”¹ batch_sizeï¼‰å¿«é€Ÿé©—è­‰ï¼Œå¦‚æœæ•ˆæœå¯æ¥å—ï¼Œå†è€ƒæ…®æ–¹æ¡ˆ D é€²ä¸€æ­¥å„ªåŒ–ã€‚

---

**æœ€å¾Œæ›´æ–°**: 2025-10-22
**é©ç”¨å°ˆæ¡ˆ**: DeepLOB-Pro V6 (1Hz æ•¸æ“š)
