# DeepLOB V5 配置修復報告

**日期**: 2025-10-18
**版本**: V5.0.2-ml-optimal
**審查來源**: ChatGPT 技術分析報告

---

## 執行摘要

針對 ChatGPT 提出的 7 大類審查意見進行逐一分析，**僅有 1 項需要修正**（股票切分策略），其餘 6 項均為：
- ✅ **已正確實現** (3 項)
- ⚠️ **建議但非必要** (3 項)
- ❌ **誤判/不適用** (1 項)

**核心修正**: 添加隨機種子打亂股票順序，避免「高流動性股票集中在訓練集」的分布偏移問題。

---

## 一、審查意見逐項分析

### ✅ 1. 時間窗口無未來洩漏（已正確）

**ChatGPT 判斷**: ✅ 正確
**實際代碼**:
```python
# extract_tw_stock_data_v5.py:797-798
window = Xn[t-SEQ_LEN+1:t+1, :]  # 嚴格使用 [t-99, t] 的歷史數據
label = int(y_tb.iloc[t])         # 標籤來自 triple-barrier（未來路徑）
```

**結論**:
- X 只含過去到當下（無洩漏）
- y 用未來路徑打標（監督學習標準做法）
- **無需修改** ✅

---

### ✅ 2. 正規化參數不洩漏（已正確）

**ChatGPT 判斷**: ✅ 正確
**實際代碼**:
```python
# Line 709-717: 僅用訓練集估計 μ/σ
Xtr = np.concatenate([...train_stocks...], axis=0)
mu, sd = zscore_fit(Xtr)

# Line 739: val/test 嚴格重用
Xn = zscore_transform(X, mu, sd)  # 對所有 split 使用同一組 μ/σ
```

**結論**:
- 符合機器學習標準流程
- **無需修改** ✅

---

### 🔴 3. 股票按長度排序後切分（已修正）

**ChatGPT 判斷**: ⚠️ **高優先級問題**
**原始代碼**:
```python
# Line 662: 按時間點數排序
stock_sequences.sort(key=lambda x: x[1], reverse=True)

# Line 692-697: 直接切分
train_stocks = valid_stocks[:n_train]    # 前 70% = 長序列股票
val_stocks = valid_stocks[n_train:...]   # 後 15% = 短序列股票
```

**問題**:
- 高流動性股票（長序列）→ 集中在訓練集
- 低流動性股票（短序列）→ 集中在驗證/測試集
- **分布偏移風險**: 離線指標虛高，上線掉分

**修正方案**:
```python
# Line 684-689: 隨機打亂後切分
import random
SPLIT_SEED = config.get('split', {}).get('seed', 42)
random.Random(SPLIT_SEED).shuffle(valid_stocks)
logging.info(f"使用隨機種子 {SPLIT_SEED} 打亂股票順序（避免選擇偏差）")

# 之後再切分（保持原邏輯）
```

**配置修改**:
```yaml
# config_pro_v5_ml_optimal.yaml:67
split:
  seed: 42  # 新增：隨機種子
```

**結論**:
- ✅ **已修正**
- 影響: 提高 val/test 的代表性，降低上線風險

---

### ✅ 4. Label Smoothing / Class Weights 已正確傳入

**ChatGPT 擔憂**: "需確認 `label_smoothing` 和 `weight` 是否真正傳入"
**實際代碼**:
```python
# train_deeplob_v5.py:341-346, 361-366, 507-512
loss_per_sample = nn.functional.cross_entropy(
    logits, labels,
    reduction='none',
    label_smoothing=label_smoothing,  # ✅ 已傳入
    weight=class_weights               # ✅ 已傳入
)

# Line 854-869: class_weights 自動計算並移到 device
class_weights = torch.FloatTensor(weights).to(device)
```

**結論**:
- **ChatGPT 誤判**
- 代碼已正確實現
- **無需修改** ✅

---

### ⚠️ 5. DeepLOB 註解維度不一致（低優先級）

**ChatGPT 建議**: 修正 `deeplob.py` 中的 40 維註解
**實際情況**:
```python
# deeplob.py:7, 11, 51
# 註解提到 (100, 40)，但實際參數為 input_shape=(100, 20)
```

**分析**:
- ✅ **實際代碼正確** (`input_shape=(100, 20)`)
- ⚠️ 註解過時（可能是從舊版 FI-2010 複製）
- 訓練流程未受影響（啟動時會檢查維度）

**建議**:
- 低優先級：可選修正註解以保持一致性
- **不影響功能**

**修正方案（可選）**:
```python
# 將註解中的 40 改為 20，或改用變數引用
"""
輸入 (100, 20) → Conv1 → ...
- 100: 時間步
- 20: LOB 特徵（5 檔 × 價量）
"""
```

---

### ⚠️ 6. 校準報表可再加強（建議優化）

**ChatGPT 建議**: 補充 Reliability Diagram, ECE/ACE, Confidence Bins

**現有功能**:
```python
# train_deeplob_v5.py:1109-1150
# ✅ 已有溫度標定（TemperatureScaling）
# ✅ 已記錄 NLL/Temperature
```

**缺失**:
- ❌ Reliability Diagram（可靠度曲線圖）
- ❌ ECE/ACE 數值（期望校準誤差）
- ❌ 按信心度分桶的 Precision-Recall

**建議**:
- **優先級**: 中等（對生產決策有幫助）
- **時機**: 在正式交易前補充
- **實作**: 可用 `scikit-learn` 或 `netcal` 庫

**範例代碼（可選）**:
```python
from sklearn.calibration import calibration_curve
import matplotlib.pyplot as plt

# Reliability Diagram
prob_true, prob_pred = calibration_curve(y_true, y_prob, n_bins=10)
plt.plot(prob_pred, prob_true, marker='o')
plt.plot([0, 1], [0, 1], linestyle='--')  # 理想線
plt.xlabel('Mean Predicted Probability')
plt.ylabel('Fraction of Positives')
plt.title('Reliability Diagram')
```

---

### ⚠️ 7. 滑窗對齊與邊界單測（建議優化）

**ChatGPT 建議**: 加入 3 個健康檢查
1. 時間對齊：X 最右時間戳 ≤ y 時間戳
2. 正規化驗證：val/test 均值≈0, std≈1
3. 邊界檢查：不越界

**現有驗證**:
```python
# train_deeplob_v5.py:545-610
# ✅ 已有數據驗證（標籤、權重、維度）
# ⚠️ 未明確檢查時間對齊
```

**建議**:
- **優先級**: 低（代碼邏輯已正確）
- **價值**: 增加可審計性
- **實作**: 可在 `safety_checks` 中補充

**範例代碼（可選）**:
```python
# 檢查正規化效果
for split in ['val', 'test']:
    X_split = dataset.X
    mean_per_feat = X_split.mean(axis=(0,1))
    std_per_feat = X_split.std(axis=(0,1))
    assert np.allclose(mean_per_feat, 0, atol=0.1), f"{split} 均值偏離 0"
    assert np.allclose(std_per_feat, 1, atol=0.2), f"{split} 標準差偏離 1"
```

---

### ❌ 8. 其他建議（不適用/優先級極低）

#### 8.1 按股票正規化
**ChatGPT 建議**: 每檔股票單獨估 μ/σ
**分析**:
- ⚠️ 增加部署複雜度（需管理 367 組參數）
- ⚠️ 小股票數據少時估計不穩
- ✅ 當前全局正規化已足夠（LOB 特徵尺度相對一致）
- **不建議採用**

#### 8.2 重疊聚合
**ChatGPT 建議**: 聚合窗口=10, stride=5（增加樣本密度）
**分析**:
- ⚠️ 會引入高度重疊樣本（時間相關性強）
- ⚠️ 可能降低泛化能力
- ✅ 當前不重疊聚合更穩健
- **不建議採用**

---

## 二、實際修改清單

### 修改文件 1: `extract_tw_stock_data_v5.py`

**位置**: Line 662-697
**修改**: 隨機打亂股票順序

```diff
- # 按时间点数量排序
- stock_sequences.sort(key=lambda x: x[1], reverse=True)
+ # 按时间点数量排序（仅用于统计）
+ stock_sequences_sorted = sorted(stock_sequences, key=lambda x: x[1], reverse=True)

  # 统计输出使用 stock_sequences_sorted

+ # 步骤 3: 随机打乱后按股票数量切分 70/15/15（避免分布偏移）
+ import random
+ SPLIT_SEED = config.get('split', {}).get('seed', 42)
+ random.Random(SPLIT_SEED).shuffle(valid_stocks)
+ logging.info(f"使用随机种子 {SPLIT_SEED} 打乱股票顺序（避免选择偏差）")
```

### 修改文件 2: `config_pro_v5_ml_optimal.yaml`

**位置**: Line 63-67
**修改**: 新增 `seed` 參數

```diff
  split:
    train_ratio: 0.7
    val_ratio: 0.15
    test_ratio: 0.15
+   seed: 42  # 隨機種子（確保可復現性）
```

---

## 三、驗證計劃

### 重新生成數據
```bash
# 使用修正後的配置重新抽取數據
python scripts/extract_tw_stock_data_v5.py \
    --input-dir ./data/temp \
    --output-dir ./data/processed_v5_fixed \
    --config configs/config_pro_v5_ml_optimal.yaml
```

### 驗證分布
```python
# 檢查三個 split 的股票流動性分布是否均衡
for split in ['train', 'val', 'test']:
    stock_ids = np.load(f'data/processed_v5_fixed/npz/stock_embedding_{split}.npz')['stock_ids']
    unique_stocks = np.unique(stock_ids)
    print(f"{split}: {len(unique_stocks)} 檔股票")
    # 應該看到長/短序列股票在三個 split 中較均勻分布
```

### 對比訓練
```bash
# 在新舊數據上各訓練一次，對比 val/test 性能差異
# 預期：修正後的 val/test 指標可能略降（更真實），但泛化更好
```

---

## 四、總結與建議

### 必須修改（已完成）
✅ **股票切分策略** - 添加隨機打亂（seed=42）

### 建議優化（可選）
⚠️ **校準報表** - 補充 ECE/Reliability Diagram（中優先級）
⚠️ **註解清理** - 修正 deeplob.py 的 40→20 維（低優先級）
⚠️ **單元測試** - 補充時間對齊/正規化檢查（低優先級）

### 不建議採用
❌ 按股票正規化（過度複雜化）
❌ 重疊聚合（引入高相關性）

### ChatGPT 報告評價
- ✅ **核心洞察正確**: 捕捉到股票切分的分布偏移風險
- ✅ **技術分析準確**: 正確判斷時間窗口和正規化無洩漏
- ⚠️ **部分建議保守**: label_smoothing 傳入檢查屬於過度謹慎
- ⚠️ **優先級混淆**: 將低優先級項（註解）與高優先級項（切分）並列

### 下一步行動
1. ✅ **重新生成數據**（使用修正配置）
2. 🔄 **對比訓練**（評估修正影響）
3. 📊 **監控指標**：
   - Val/Test 準確率可能略降（更真實）
   - Train/Val Gap 應縮小（更一致）
   - 泛化能力應提升（避免選擇偏差）

---

**審查結論**: 流水線設計**整體正確且穩健**，僅需微調股票切分策略即可達到生產級水準。

**修復狀態**: ✅ 已完成
**重新訓練**: ⏳ 待執行
**上線風險**: 🟢 低（修正後）
