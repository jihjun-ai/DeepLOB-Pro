# æ³¢å‹•ç‡éæ¿¾åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ğŸ“‹ ç›®éŒ„
1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [å¯¦ä½œåŸç†](#å¯¦ä½œåŸç†)
3. [å®Œæ•´ä½¿ç”¨æµç¨‹](#å®Œæ•´ä½¿ç”¨æµç¨‹)
4. [åƒæ•¸èª¿æ•´å»ºè­°](#åƒæ•¸èª¿æ•´å»ºè­°)
5. [å¸¸è¦‹å•é¡Œ](#å¸¸è¦‹å•é¡Œ)

---

## åŠŸèƒ½æ¦‚è¿°

### å•é¡ŒèƒŒæ™¯
åœ¨åˆ†æ Triple-Barrier æ¨™ç±¤æ™‚ï¼Œç™¼ç¾**æ³¢å‹•ç‡éä½çš„è‚¡ç¥¨æ—¥**æœƒå°è‡´ï¼š
- PT/SL barrier é›£ä»¥è§¸åŠï¼ˆä¾‹å¦‚ 3.5Ïƒ å¤ªå¯¬ï¼‰
- å¤§é‡ time trigger â†’ ã€ŒæŒå¹³ã€æ¨™ç±¤éå¤šï¼ˆ>50%ï¼‰
- æ¨™ç±¤åˆ†å¸ƒä¸å‡è¡¡ï¼Œå½±éŸ¿æ¨¡å‹è¨“ç·´

### è§£æ±ºæ–¹æ¡ˆ
åœ¨æ•¸æ“šè™•ç†éšæ®µï¼ˆ`sliding_windows_v5`ï¼‰ç›´æ¥éæ¿¾æ‰æ³¢å‹•ç‡éä½çš„è‚¡ç¥¨æ—¥ï¼š
- âœ… **æºé ­è§£æ±º**ï¼šä¸ç”Ÿæˆä½è³ªé‡æ¨™ç±¤
- âœ… **ä¿æŒé‚è¼¯æ¸…æ™°**ï¼šä¸éœ€ä¿®æ”¹ `tb_labels` æ ¸å¿ƒé‚è¼¯
- âœ… **æ¨™ç±¤åˆ†å¸ƒå‡è¡¡**ï¼šä¿ç•™çš„æ•¸æ“šæ¨™ç±¤åˆ†å¸ƒæ›´åˆç†
- âœ… **éˆæ´»å¯èª¿**ï¼šå¯æ ¹æ“šå¯¦éš›æ•¸æ“šåˆ†å¸ƒèª¿æ•´é–¾å€¼

---

## å¯¦ä½œåŸç†

### éæ¿¾é‚è¼¯
```python
# åœ¨ sliding_windows_v5 â†’ build_split_v5 ä¸­
# è¨ˆç®—æ³¢å‹•ç‡å¾Œï¼Œç«‹å³æª¢æŸ¥
if vol_filter_enabled:
    vol_clean = vol.replace([np.inf, -np.inf], np.nan).dropna()
    daily_vol_mean = vol_clean.mean()
    
    if daily_vol_mean < min_vol_threshold:
        # è·³éé€™å€‹è‚¡ç¥¨æ—¥
        vol_filtered_days += 1
        continue
```

### éæ¿¾ä½ç½®
- **éšæ®µ**ï¼šåœ¨ `sliding_windows_v5` çš„é€æ—¥è™•ç†å¾ªç’°ä¸­
- **æ™‚æ©Ÿ**ï¼šè¨ˆç®—å®Œ EWMA æ³¢å‹•ç‡ä¹‹å¾Œï¼Œç”Ÿæˆ Triple-Barrier æ¨™ç±¤ä¹‹å‰
- **æ•ˆæœ**ï¼šè¢«éæ¿¾çš„è‚¡ç¥¨æ—¥ä¸æœƒç”¢ç”Ÿä»»ä½•è¨“ç·´æ¨£æœ¬

### èˆ‡ç¾æœ‰éœ‡ç›ªéæ¿¾çš„é—œä¿‚
ç³»çµ±æœ‰å…©å±¤éæ¿¾ï¼š

| éæ¿¾é¡å‹ | éšæ®µ | æŒ‡æ¨™ | é…ç½®é … |
|---------|------|------|--------|
| **éœ‡ç›ªéæ¿¾** | ä¸»ç¨‹å¼ï¼ˆè³‡æ–™èšåˆå¾Œï¼‰ | (high-low)/open | `intraday_volatility_filter` |
| **æ³¢å‹•ç‡éæ¿¾** â­ | sliding_windows_v5 | EWMA vol å¹³å‡å€¼ | `volatility_filter` |

å…©è€…å¯åŒæ™‚å•Ÿç”¨ï¼Œäº’è£œä½¿ç”¨ã€‚

---

## å®Œæ•´ä½¿ç”¨æµç¨‹

### Step 1ï¼šåˆ†æç•¶å‰æ•¸æ“šçš„æ³¢å‹•ç‡åˆ†å¸ƒ

```bash
python scripts/extract_tw_stock_data_v5.py \
    --input-dir ./data/temp \
    --output-dir ./data/volatility_analysis \
    --config configs/config_pro_v5_ml_optimal.yaml \
    --stats-only
```

**æŸ¥çœ‹å ±å‘Š**ï¼š
```bash
# æŸ¥çœ‹æ³¢å‹•ç‡çµ±è¨ˆ
cat ./data/volatility_analysis/volatility_summary.json

# æˆ–æŸ¥çœ‹è©³ç´° CSV
# ./data/volatility_analysis/volatility_stats.csv
```

**é—œéµè³‡è¨Š**ï¼š
- `range_pct.percentiles` - æ‰¾ P10ã€P25ã€P50
- `n_samples` - ç¸½æ¨£æœ¬æ•¸
- `top_10_volatile` - æœ€é«˜æ³¢å‹•ç‡çš„è‚¡ç¥¨æ—¥

### Step 2ï¼šæ±ºå®šéæ¿¾é–¾å€¼

æ ¹æ“š Step 1 çš„åˆ†æçµæœï¼š

```yaml
# ä¿å®ˆæ–¹æ¡ˆï¼ˆéæ¿¾å°‘ï¼Œä¿ç•™æ›´å¤šæ•¸æ“šï¼‰
volatility_filter:
  enabled: true
  min_daily_vol: 0.0003  # P10 çš„ 50%

# ä¸­ç­‰æ–¹æ¡ˆï¼ˆæ¨è–¦ï¼Œå¹³è¡¡éæ¿¾èˆ‡æ•¸æ“šé‡ï¼‰
volatility_filter:
  enabled: true
  min_daily_vol: 0.0005  # ç´„ P25

# æ¿€é€²æ–¹æ¡ˆï¼ˆéæ¿¾å¤šï¼Œåªä¿ç•™é«˜æ³¢å‹•ç‡ï¼‰
volatility_filter:
  enabled: true
  min_daily_vol: 0.001   # ç´„ P50
```

**æ±ºç­–åƒè€ƒ**ï¼š
- å¦‚æœç•¶å‰ã€ŒæŒå¹³ã€æ¨™ç±¤ >60% â†’ ä½¿ç”¨æ¿€é€²æ–¹æ¡ˆ
- å¦‚æœç•¶å‰ã€ŒæŒå¹³ã€æ¨™ç±¤ 40-60% â†’ ä½¿ç”¨ä¸­ç­‰æ–¹æ¡ˆ
- å¦‚æœç•¶å‰ã€ŒæŒå¹³ã€æ¨™ç±¤ <40% â†’ ä¸éœ€éæ¿¾æˆ–ä½¿ç”¨ä¿å®ˆæ–¹æ¡ˆ

### Step 3ï¼šç”Ÿæˆéæ¿¾å¾Œçš„æ•¸æ“š

```bash
python scripts/extract_tw_stock_data_v5.py \
    --input-dir ./data/temp \
    --output-dir ./data/processed_v5_vol_filtered \
    --config configs/config_pro_v5_vol_filtered.yaml
```

**é æœŸè¼¸å‡º**ï¼š
```
============================================================
V5 æ»‘çª—æµç¨‹å¼€å§‹ï¼ˆæŒ‰æ—¥å¤„ç†æ¨¡å¼ï¼‰ï¼Œå…± XXX ä¸ª symbol-day ç»„åˆ
æ—¥ç•Œçº¿ä¿æŠ¤: å¯ç”¨
æ³¢åŠ¨ç‡è¿‡æ»¤: å¯ç”¨ (é˜ˆå€¼: 0.050%)  â† ç¢ºèªå·²å•Ÿç”¨
============================================================

...

TRAIN æ€»è®¡: XXX ä¸ªæ ·æœ¬ (æ¥è‡ª YYY ä¸ª symbol-day)
è§¦å‘åŸå› åˆ†å¸ƒ: {'up': A, 'down': B, 'time': C}
æ³¢åŠ¨ç‡è¿‡æ»¤: ZZZ ä¸ªè‚¡ç¥¨æ—¥è¢«ç§»é™¤ (XX.X%)  â† éæ¿¾çµ±è¨ˆ
```

### Step 4ï¼šæª¢æŸ¥éæ¿¾æ•ˆæœ

```bash
# æŸ¥çœ‹ metadata
cat ./data/processed_v5_vol_filtered/npz/normalization_meta.json
```

**é—œéµæŒ‡æ¨™**ï¼š
```json
{
  "data_quality": {
    "volatility_filtered": 123,  // éæ¿¾çš„è‚¡ç¥¨æ—¥æ•¸
    "valid_windows": 45678       // æœ‰æ•ˆè¨“ç·´æ¨£æœ¬æ•¸
  },
  "data_split": {
    "results": {
      "train": {
        "label_dist": [10234, 12345, 11234],  // [ä¸‹è·Œ, æŒå¹³, ä¸Šæ¼²]
        // è¨ˆç®—æ¯”ä¾‹ï¼šæŒå¹³% = 12345 / (10234+12345+11234) * 100
      }
    }
  }
}
```

**åˆ¤æ–·æ¨™æº–**ï¼š
- âœ… **æˆåŠŸ**ï¼šæŒå¹³æ¨™ç±¤ 30-45%ï¼Œä¸‹è·Œ/ä¸Šæ¼²å„ 25-35%
- âš ï¸ **éœ€èª¿æ•´**ï¼šæŒå¹³ä» >50% â†’ æé«˜ `min_daily_vol`
- âš ï¸ **éæ¿¾å¤ªå¤š**ï¼šæŒå¹³ <20% â†’ é™ä½ `min_daily_vol`

### Step 5ï¼šè¿­ä»£å„ªåŒ–ï¼ˆå¯é¸ï¼‰

å¦‚æœ Step 4 çš„çµæœä¸ç†æƒ³ï¼š

1. **èª¿æ•´ `min_daily_vol`**
   ```yaml
   # å¢åŠ /æ¸›å°‘é–¾å€¼
   min_daily_vol: 0.0007  # å¾ 0.0005 æé«˜åˆ° 0.0007
   ```

2. **é…åˆèª¿æ•´ Triple-Barrier åƒæ•¸**
   ```yaml
   triple_barrier:
     pt_multiplier: 3.0    # å¾ 3.5 é™åˆ° 3.0ï¼ˆæ›´å®¹æ˜“è§¸ç™¼ï¼‰
     sl_multiplier: 3.0
     min_return: 0.002     # å¾ 0.0015 æé«˜åˆ° 0.002ï¼ˆæ›´åš´æ ¼ï¼‰
   ```

3. **é‡æ–°ç”Ÿæˆæ•¸æ“š**ï¼ˆä½¿ç”¨æ–°é…ç½®ï¼‰

---

## åƒæ•¸èª¿æ•´å»ºè­°

### `min_daily_vol` è¨­å®šæŒ‡å—

| é–¾å€¼ | ç™¾åˆ†æ¯” | é©ç”¨å ´æ™¯ | é æœŸéæ¿¾æ¯”ä¾‹ |
|------|--------|---------|-------------|
| 0.0002 | 0.02% | æ¥µä¿å®ˆï¼Œå¹¾ä¹ä¸éæ¿¾ | <5% |
| 0.0003 | 0.03% | ä¿å®ˆï¼Œåªéæ¿¾æ¥µä½æ³¢å‹•ç‡ | 5-15% |
| 0.0005 | 0.05% | **ä¸­ç­‰ï¼ˆæ¨è–¦ï¼‰** | 15-30% |
| 0.0007 | 0.07% | ç©æ¥µ | 30-50% |
| 0.001 | 0.1% | æ¿€é€²ï¼Œåªä¿ç•™é«˜æ³¢å‹•ç‡ | 50-70% |

### èˆ‡å…¶ä»–åƒæ•¸çš„é…åˆ

#### å ´æ™¯ 1ï¼šæŒå¹³æ¨™ç±¤éå¤šï¼ˆ>60%ï¼‰
```yaml
volatility_filter:
  min_daily_vol: 0.0007  # ç©æ¥µéæ¿¾

triple_barrier:
  pt_multiplier: 3.0     # ç¸®å° barrier
  sl_multiplier: 3.0
  min_return: 0.002      # æé«˜é–¾å€¼
```

#### å ´æ™¯ 2ï¼šæŒå¹³æ¨™ç±¤é©ä¸­ï¼ˆ40-50%ï¼‰
```yaml
volatility_filter:
  min_daily_vol: 0.0005  # ä¸­ç­‰éæ¿¾ï¼ˆæ¨è–¦ï¼‰

triple_barrier:
  pt_multiplier: 3.5     # ç¶­æŒåŸè¨­å®š
  sl_multiplier: 3.5
  min_return: 0.0015
```

#### å ´æ™¯ 3ï¼šæŒå¹³æ¨™ç±¤å·²åä½ï¼ˆ<30%ï¼‰
```yaml
volatility_filter:
  enabled: false         # é—œé–‰éæ¿¾

# æˆ–ä½¿ç”¨æ¥µä¿å®ˆè¨­å®š
volatility_filter:
  min_daily_vol: 0.0002
```

---

## å¸¸è¦‹å•é¡Œ

### Q1ï¼šéæ¿¾æœƒæå¤±å¤šå°‘æ•¸æ“šï¼Ÿ
**A**ï¼šå–æ±ºæ–¼ `min_daily_vol` è¨­å®šï¼š
- ä¿å®ˆè¨­å®šï¼ˆ0.0003ï¼‰ï¼šæå¤± 5-15% è‚¡ç¥¨æ—¥
- ä¸­ç­‰è¨­å®šï¼ˆ0.0005ï¼‰ï¼šæå¤± 15-30% è‚¡ç¥¨æ—¥
- æ¿€é€²è¨­å®šï¼ˆ0.001ï¼‰ï¼šæå¤± 50%+ è‚¡ç¥¨æ—¥

**é‡è¦**ï¼šæå¤±çš„æ˜¯**ä½è³ªé‡**çš„è‚¡ç¥¨æ—¥ï¼ˆæ¨™ç±¤åˆ†å¸ƒæ¥µåº¦ä¸å‡ï¼‰ï¼Œå°æ¨¡å‹è¨“ç·´åè€Œæœ‰åˆ©ã€‚

### Q2ï¼šå¦‚ä½•ç¢ºèªéæ¿¾æ˜¯å¦ç”Ÿæ•ˆï¼Ÿ
**A**ï¼šæª¢æŸ¥ä¸‰å€‹åœ°æ–¹ï¼š
1. **é‹è¡Œæ—¥èªŒ**ï¼šçœ‹åˆ° "æ³¢åŠ¨ç‡è¿‡æ»¤: X ä¸ªè‚¡ç¥¨æ—¥è¢«ç§»é™¤"
2. **normalization_meta.json**ï¼š`data_quality.volatility_filtered` æ•¸å€¼
3. **æ¨™ç±¤åˆ†å¸ƒ**ï¼š`data_split.results.*.label_dist` æ¯”ä¾‹

### Q3ï¼šéæ¿¾å¾Œæ¨™ç±¤åˆ†å¸ƒæ²’æ”¹å–„ï¼Ÿ
**A**ï¼šå¯èƒ½åŸå› ï¼š
1. **é–¾å€¼å¤ªä½**ï¼šæé«˜ `min_daily_vol`
2. **PT/SL å¤ªå¯¬**ï¼šé™ä½ `pt_multiplier` / `sl_multiplier`
3. **min_return å¤ªå°**ï¼šæé«˜ `min_return`

å»ºè­°ï¼šåŒæ™‚èª¿æ•´ä¸‰å€‹åƒæ•¸ï¼Œå¤šæ¬¡å¯¦é©—æ‰¾æœ€ä½³çµ„åˆã€‚

### Q4ï¼šå¯ä»¥åªç”¨éœ‡ç›ªéæ¿¾å—ï¼Ÿ
**A**ï¼šå¯ä»¥ï¼Œä½†å…©è€…ç›®çš„ä¸åŒï¼š
- **éœ‡ç›ªéæ¿¾**ï¼ˆ`intraday_volatility_filter`ï¼‰ï¼šåŸºæ–¼åƒ¹æ ¼ç¯„åœï¼Œåœ¨ä¸»ç¨‹å¼éšæ®µ
- **æ³¢å‹•ç‡éæ¿¾**ï¼ˆ`volatility_filter`ï¼‰ï¼šåŸºæ–¼ EWMA æ³¢å‹•ç‡ï¼Œåœ¨ sliding_windows éšæ®µ

å»ºè­°ï¼šå…©è€…é…åˆä½¿ç”¨æ•ˆæœæœ€ä½³ã€‚

### Q5ï¼šè¨“ç·´é›†å’Œæ¸¬è©¦é›†çš„éæ¿¾æœƒä¸ä¸€è‡´å—ï¼Ÿ
**A**ï¼šä¸æœƒã€‚éæ¿¾æ˜¯åœ¨**æŒ‰è‚¡ç¥¨åˆ‡åˆ†ä¹‹å¾Œ**é€²è¡Œçš„ï¼Œæ‰€æœ‰ split ä½¿ç”¨ç›¸åŒçš„é–¾å€¼å’Œé‚è¼¯ã€‚

### Q6ï¼šéæ¿¾å¾Œå¦‚ä½•è©•ä¼°æ¨¡å‹æ€§èƒ½ï¼Ÿ
**A**ï¼š
1. **æ¨™ç±¤åˆ†å¸ƒ**ï¼šæ‡‰æ›´å‡è¡¡ï¼ˆ30-40-30ï¼‰
2. **è¨“ç·´ç©©å®šæ€§**ï¼šloss ä¸‹é™æ›´å¹³æ»‘
3. **é©—è­‰é›†è¡¨ç¾**ï¼šæº–ç¢ºç‡/F1-score æå‡
4. **é¡åˆ¥ Recall**ï¼šå„é¡åˆ¥ Recall æ›´å‡è¡¡ï¼ˆé¿å…åªé æ¸¬ä¸€é¡ï¼‰

---

## å¯¦é©—è¨˜éŒ„æ¨¡æ¿

å»ºè­°è¨˜éŒ„æ¯æ¬¡å¯¦é©—çš„åƒæ•¸å’Œçµæœï¼Œä¾¿æ–¼å°æ¯”ï¼š

```markdown
## å¯¦é©— 1ï¼šä¸­ç­‰éæ¿¾
- é…ç½®ï¼š`config_pro_v5_vol_filtered.yaml`
- `min_daily_vol`: 0.0005
- `pt_multiplier`: 3.5
- `min_return`: 0.0015

**çµæœ**ï¼š
- éæ¿¾è‚¡ç¥¨æ—¥ï¼š123 å€‹ï¼ˆ15.2%ï¼‰
- è¨“ç·´æ¨£æœ¬ï¼š45,678 å€‹
- æ¨™ç±¤åˆ†å¸ƒï¼š[10234, 12345, 11234] â†’ [30.2%, 36.4%, 33.4%] âœ…
- è¨“ç·´æ•ˆæœï¼šæº–ç¢ºç‡ 62.3%ï¼ŒF1 0.58

---

## å¯¦é©— 2ï¼šç©æ¥µéæ¿¾
- é…ç½®ï¼šåŒä¸Š
- `min_daily_vol`: 0.0007 â† æé«˜
- å…¶ä»–åƒæ•¸åŒå¯¦é©— 1

**çµæœ**ï¼š
- éæ¿¾è‚¡ç¥¨æ—¥ï¼š245 å€‹ï¼ˆ30.3%ï¼‰
- è¨“ç·´æ¨£æœ¬ï¼š32,456 å€‹
- æ¨™ç±¤åˆ†å¸ƒï¼š[11234, 9876, 11346] â†’ [34.6%, 30.4%, 35.0%] âœ…âœ…
- è¨“ç·´æ•ˆæœï¼šæº–ç¢ºç‡ 65.1%ï¼ŒF1 0.61 â† æ”¹å–„ï¼
```

---

## ä¸‹ä¸€æ­¥å»ºè­°

1. **ç«‹å³è¡Œå‹•**ï¼š
   ```bash
   # å…ˆåˆ†æç•¶å‰æ•¸æ“š
   python scripts/extract_tw_stock_data_v5.py \
       --input-dir ./data/temp \
       --output-dir ./data/vol_analysis \
       --config configs/config_pro_v5_ml_optimal.yaml \
       --stats-only
   ```

2. **æŸ¥çœ‹å ±å‘Š**ï¼Œæ±ºå®šé–¾å€¼

3. **ç”Ÿæˆéæ¿¾å¾Œçš„æ•¸æ“š**

4. **å°æ¯”è¨“ç·´æ•ˆæœ**ï¼ˆåŸå§‹ vs éæ¿¾å¾Œï¼‰

5. **è¨˜éŒ„å¯¦é©—çµæœ**ï¼ŒæŒçºŒå„ªåŒ–

---

## ç¸½çµ

æ³¢å‹•ç‡éæ¿¾åŠŸèƒ½æ˜¯è§£æ±ºã€ŒæŒå¹³ã€æ¨™ç±¤éå¤šå•é¡Œçš„**æœ€ä½³å¯¦è¸æ–¹æ¡ˆ**ï¼š

âœ… **å„ªé»**ï¼š
- æºé ­è§£æ±ºå•é¡Œ
- é‚è¼¯æ¸…æ™°ç°¡å–®
- éˆæ´»å¯èª¿
- æå‡æ•¸æ“šè³ªé‡

âš ï¸ **æ³¨æ„**ï¼š
- æœƒæ¸›å°‘æ¨£æœ¬æ•¸ï¼ˆä½†æå‡è³ªé‡ï¼‰
- éœ€è¦å¯¦é©—æ‰¾æœ€ä½³é–¾å€¼
- å»ºè­°é…åˆ TB åƒæ•¸èª¿æ•´

ğŸ¯ **æ¨è–¦æµç¨‹**ï¼š
åˆ†æ â†’ è¨­é–¾å€¼ â†’ ç”Ÿæˆæ•¸æ“š â†’ æª¢æŸ¥æ•ˆæœ â†’ è¿­ä»£å„ªåŒ–

